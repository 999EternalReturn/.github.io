
<!--
================================================================================
  ç‰¹é›·æ£®è§„åˆ™æ€ªè°ˆ - è®­ç»ƒå‘˜ç”Ÿå­˜æŒ‡å—
  
  ä½œè€…: Eternal zz
  åˆ›æ„æ”¯æŒï¼ŒæŠ€æœ¯æ”¯æŒ
  Discord ID: eternalzz0840
  
  ç‰ˆæƒå£°æ˜:
  - ç¦æ­¢å•†ç”¨
  - ç¦æ­¢äºŒåˆ›
  - åªèƒ½åœ¨ç±»è„‘ã€æ—…ç¨‹äºŒä¼ 
  
  æœªç»ä½œè€…è®¸å¯ï¼Œä¸å¾—ç”¨äºä»»ä½•å•†ä¸šç”¨é€”æˆ–è¿›è¡ŒäºŒæ¬¡åˆ›ä½œ
================================================================================
-->
<!doctype html>

<html lang="zh-CN">

  <head>

    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>ç‰¹é›·æ£®å­¦é™¢æ€ªè°ˆ</title>

    <meta name="description" content="ç‰¹é›·æ£®å­¦é™¢æ€ªè°ˆ - ææ€–è§†è§‰å°è¯´ç•Œé¢" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link

      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Serif+SC:wght@400;500;600&display=swap"

      rel="stylesheet"

    />

    <link rel="stylesheet" href="/app.css" />



    <script>

      var e = Object.defineProperty,

        t = (t, n, s) => (

          ((t, n, s) => {

            n in t ? e(t, n, { enumerable: !0, configurable: !0, writable: !0, value: s }) : (t[n] = s);

          })(t, 'symbol' != typeof n ? n + '' : n, s),

          s

        );

      !(function () {

        const e = document.createElement('link').relList;

        if (!(e && e.supports && e.supports('modulepreload'))) {

          for (const e of document.querySelectorAll('link[rel="modulepreload"]')) t(e);

          new MutationObserver(e => {

            for (const n of e)

              if ('childList' === n.type)

                for (const e of n.addedNodes) 'LINK' === e.tagName && 'modulepreload' === e.rel && t(e);

          }).observe(document, { childList: !0, subtree: !0 });

        }

        function t(e) {

          if (e.ep) return;

          e.ep = !0;

          const t = (function (e) {

            const t = {};

            return (

              e.integrity && (t.integrity = e.integrity),

              e.referrerPolicy && (t.referrerPolicy = e.referrerPolicy),

              'use-credentials' === e.crossOrigin

                ? (t.credentials = 'include')

                : 'anonymous' === e.crossOrigin

                  ? (t.credentials = 'omit')

                  : (t.credentials = 'same-origin'),

              t

            );

          })(e);

          fetch(e.href, t);

        }

      })();

      const n = new (class {

        constructor() {

          // æ£€æŸ¥å…¨å±€å‡½æ•°æ˜¯å¦å¯ç”¨
          if (typeof window.eventEmit === 'undefined' || typeof window.eventOn === 'undefined') {
            console.warn('âš ï¸ MVUå…¨å±€å‡½æ•°æœªæ‰¾åˆ°ï¼Œå¯èƒ½å½±å“MVUåŠŸèƒ½');
            console.log('å¯ç”¨çš„å…¨å±€å‡½æ•°:', Object.keys(window).filter(key => typeof window[key] === 'function'));
          }

          // åˆå§‹åŒ–é©¬å¨˜è®°åå†Œå·²æ·»åŠ é›†åˆï¼Œé¿å…é‡å¤è®¡ç®—
          this.umaRosterAdded = new Set();
          
          // åˆå§‹åŒ–çŠ¶æ€åŠ¨ç”»æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤è§¦å‘
          this.statusAnimationActive = false;

          (t(this, 'updateInterval', null),

            t(this, 'isInitialized', !1),

            console.log('ğŸ® ç‰¹é›·æ£®å­¦é™¢æ€ªè°ˆMVUç•Œé¢ç®¡ç†å™¨å·²åˆ›å»º'));

        }

        async init() {

          if (!this.isInitialized) {

            if ((console.group('ğŸš€ ç‰¹é›·æ£®å­¦é™¢æ€ªè°ˆMVUç•Œé¢åˆå§‹åŒ–'), void 0 === window.TavernHelper))

              return (console.error('âŒ TavernHelperç¯å¢ƒæœªæ‰¾åˆ°'), void console.groupEnd());

            (console.log('âœ… TavernHelperç¯å¢ƒå·²æ‰¾åˆ°'),

              console.log('ğŸ”§ è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...'),

              this.setupEventListeners(),

              console.log('ğŸ”§ è®¾ç½®æ§åˆ¶å°å‘½ä»¤...'),

              this.setupConsoleCommands(),

              console.log('ğŸ”„ è®¾ç½®æµå¼æ›´æ–°ç›‘å¬...'),

              this.setupStreamListeners(),

              console.log('ğŸ”„ æ›´æ–°ç•Œé¢...'),

              await this.updateInterface(),

              console.log('â° å¯åŠ¨å›å¤æ—¶é—´å®šæ—¶å™¨...'),

              this.startReplyTimer(),

              (this.updateInterval = setInterval(async () => {

                await this.updateInterface();

              }, 2e3)),

              (this.isInitialized = !0),

              console.log('âœ… MVUç•Œé¢åˆå§‹åŒ–å®Œæˆ'),

              console.groupEnd());

          }

        }

        // æ–°å¢ï¼šMVUç¯å¢ƒè¯Šæ–­å’Œä¿®å¤å‡½æ•°
        debugMVUEnvironment() {
            console.group('ğŸ” MVUç¯å¢ƒè¯Šæ–­');
            
            // æ£€æŸ¥åŸºæœ¬å‡½æ•°
            console.log('window.eventEmit:', typeof window.eventEmit);
            console.log('window.eventOn:', typeof window.eventOn);
            console.log('getAllVariables:', typeof this.getAllVariables);
            
            // æ£€æŸ¥MVUå¯¹è±¡
            console.log('window.Mvu:', window.Mvu);
            console.log('window.mag_invoke_mvu:', typeof window.mag_invoke_mvu);
            
            // æ£€æŸ¥TavernHelperç¯å¢ƒ
            console.log('window.TavernHelper:', window.TavernHelper);
            
            // æ£€æŸ¥å½“å‰å˜é‡çŠ¶æ€
            try {
                const currentVars = this.getAllVariables();
                console.log('å½“å‰å˜é‡çŠ¶æ€:', currentVars);
            } catch (e) {
                console.error('è·å–å˜é‡å¤±è´¥:', e);
            }
            
            console.groupEnd();
        }

        // æ–°å¢ï¼šè®¾ç½®MVUäº‹ä»¶ç›‘å¬å™¨
        setupMVUListeners() {
            console.log('ğŸ”§ è®¾ç½®MVUäº‹ä»¶ç›‘å¬å™¨...');
            
            // ç›‘å¬MVUå˜é‡æ›´æ–°äº‹ä»¶
            if (typeof window.eventOn === 'function') {
                window.eventOn('mag_variable_updated', (statData, path, oldValue, newValue) => {
                    console.log('âœ… MVUå˜é‡æ›´æ–°äº‹ä»¶:', path, oldValue, 'â†’', newValue);
                });
                
                window.eventOn('mag_variable_update_ended', (variables) => {
                    console.log('âœ… MVUå˜é‡æ›´æ–°å®Œæˆäº‹ä»¶:', variables);
                });
                
                window.eventOn('mag_variable_update_started', (variables) => {
                    console.log('ğŸ”„ MVUå˜é‡æ›´æ–°å¼€å§‹äº‹ä»¶:', variables);
                });
                
                console.log('âœ… MVUäº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
            } else {
                console.warn('âš ï¸ window.eventOnå‡½æ•°ä¸å¯ç”¨ï¼Œæ— æ³•è®¾ç½®MVUäº‹ä»¶ç›‘å¬å™¨');
                console.log('å¯ç”¨çš„å…¨å±€å‡½æ•°:', Object.keys(window).filter(key => typeof window[key] === 'function'));
            }
        }

        setupEventListeners() {

          $(document).ready(() => {

            (console.log('ğŸ”§ ä½¿ç”¨jQueryè®¾ç½®äº‹ä»¶ç›‘å¬å™¨...'),

              $('#save-load-btn').on('click', () => {

                const e = document.getElementById('save-load-sound');

                (e && e.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e)), this.handleSaveLoad());

              }),

              $('#fullscreen-btn').on('click', () => this.toggleFullscreen()),

              $('#danger-btn').on('click', () => {

                const e = document.getElementById('danger-rules-sound');

                (e && e.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e)), this.handleDangerPeriod());

              }),

              $('#debug-btn').on('click', () => this.debugVariables()),

              $('#btn-send-action').on('click', async () => {

                await this.handleActionSubmit();

              }),

              $('#profile-expand').on('click', () => this.toggleProfile()),

              $('#journey-history-btn').on('click', () => this.handleHistory()),

              $('#manage-talents-btn').on('click', () => this.showTalentsModal()),

              $('#close-talents-btn').on('click', () => {

                this.closeTalentsModal();

              }),

              $('#talents-modal').on('click', (e) => {

                if (e.target.id === 'talents-modal') {

                  this.closeTalentsModal();

                }

              }),

              this.setupRulesModal(),

              this.setupLoadModal(),

              this.setupHistoryModal(),

              // è®¾ç½®MVUäº‹ä»¶ç›‘å¬å™¨
              this.setupMVUListeners(),

              document.addEventListener('fullscreenchange', () => this.handleFullscreenChange()),

              document.addEventListener('webkitfullscreenchange', () => this.handleFullscreenChange()),

              document.addEventListener('mozfullscreenchange', () => this.handleFullscreenChange()),

              document.addEventListener('MSFullscreenChange', () => this.handleFullscreenChange()),

              console.log('âœ… äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ'));

          });

        }

        async updateInterface() {

          try {

            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®

            const rightPanelContent = document.querySelector('.right-panel .panel-content');

            const leftPanelContent = document.querySelector('.left-panel .panel-content');

            const savedRightScrollTop = rightPanelContent ? rightPanelContent.scrollTop : 0;

            const savedLeftScrollTop = leftPanelContent ? leftPanelContent.scrollTop : 0;



            // ç«‹å³æ›´æ–°åŸºç¡€çŠ¶æ€

            (this.updateTrainerStatus(), this.updateUmaStatus(), this.updateTimeDisplay(), this.updateReplyTimer());



            const e = Date.now();

            const lastUpdate = parseInt(localStorage.getItem('teresen_last_full_update') || '0');

            const isFirstLoad = lastUpdate === 0;

            const shouldUpdate = isFirstLoad || e - lastUpdate > 1e4;



            if (shouldUpdate) {

              console.log('ğŸ”„ æ‰§è¡Œå®Œæ•´ç•Œé¢æ›´æ–°...');

              await this.updateStoryContent();

              this.updateInventory();

              this.updateRules();

              this.updateCurrencySystem();

              this.updateFestivalNotice();

              this.updateRulesCountdown();

              this.updateLocation();

              this.updateGachaCoin();

              localStorage.setItem('teresen_last_full_update', e.toString());

              console.log('âœ… å®Œæ•´ç•Œé¢æ›´æ–°å®Œæˆ');

            }



            // æ¢å¤æ»šåŠ¨ä½ç½®ï¼ˆä½¿ç”¨setTimeoutç¡®ä¿DOMæ›´æ–°å®Œæˆï¼‰

            setTimeout(() => {

              if (rightPanelContent && savedRightScrollTop > 0) {

                rightPanelContent.scrollTop = savedRightScrollTop;

              }

              if (leftPanelContent && savedLeftScrollTop > 0) {

                leftPanelContent.scrollTop = savedLeftScrollTop;

              }

            }, 0);

          } catch (e) {

            console.error('æ›´æ–°ç•Œé¢æ—¶å‡ºé”™:', e);

          }

        }



        // æ–°å¢ï¼šå‚è€ƒé¡¹ç›®çš„updateDynamicDataæ–¹æ³•ï¼Œç¡®ä¿æ‰€æœ‰åŠ¨æ€æ•°æ®éƒ½æ›´æ–°

        async updateDynamicData() {

          try {

            console.log('ğŸ”„ å¼€å§‹æ›´æ–°åŠ¨æ€æ•°æ®...');



            // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰å…³é”®ç•Œé¢å…ƒç´ 

            this.updateTrainerStatus();

            this.updateUmaStatus();

            this.updateTimeDisplay();

            this.updateReplyTimer();



            // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰é¢æ¿å†…å®¹

            await this.updateStoryContent();

            this.updateInventory();

            this.updateRules();

            this.updateCurrencySystem();

            this.updateFestivalNotice();

            this.updateRulesCountdown();

            this.updateLocation();

            this.updateGachaCoin();



            console.log('âœ… åŠ¨æ€æ•°æ®æ›´æ–°å®Œæˆ');

          } catch (error) {

            console.error('âŒ æ›´æ–°åŠ¨æ€æ•°æ®æ—¶å‡ºé”™:', error);

          }

        }

        getAllVariables() {
          // é‡è¦ï¼šä¼˜å…ˆä½¿ç”¨MVUè¿”å›çš„æœ€æ–°æ•°æ®
          if (this.currentMvuState && this.currentMvuState.stat_data) {
            console.log('âœ… ä½¿ç”¨MVUè¿”å›çš„æœ€æ–°æ•°æ®');
            return this.currentMvuState;
          }

          if ((console.group('ğŸ” è·å–å˜é‡è°ƒè¯•ä¿¡æ¯'), 'function' == typeof getAllVariables)) {

            console.log('âœ… getAllVariableså‡½æ•°å­˜åœ¨ï¼Œæ­£åœ¨è°ƒç”¨...');

            const e = getAllVariables();

            return (

              console.log('ğŸ“Š è·å–åˆ°çš„å˜é‡æ•°æ®:', e),

              e && e.stat_data

                ? (console.log('âœ… æ‰¾åˆ°stat_dataç»“æ„'),

                  console.log('ğŸƒ è®­ç»ƒå‘˜æ•°æ®:', e.stat_data.è®­ç»ƒå‘˜),

                  console.log('ğŸŒ ä¸–ç•Œæ•°æ®:', e.stat_data.ä¸–ç•Œ),

                  console.log('ğŸ é©¬å¨˜æ•°æ®:', e.stat_data.é©¬å¨˜),

                  e.stat_data.è§„åˆ™ && console.log('ğŸ“œ è§„åˆ™æ•°æ®:', e.stat_data.è§„åˆ™),

                  e.stat_data.å¤–ç¥ && console.log('ğŸ‘¹ å¤–ç¥æ•°æ®:', e.stat_data.å¤–ç¥))

                : (console.warn('âš ï¸ æœªæ‰¾åˆ°stat_dataç»“æ„'), console.log('ğŸ” å®Œæ•´è¿”å›ç»“æœ:', e)),

              console.groupEnd(),

              e

            );

          }

          return (

            console.error('âŒ getAllVariableså‡½æ•°ä¸å­˜åœ¨'),

            console.log(

              'ğŸ” å½“å‰å…¨å±€å‡½æ•°:',

              Object.keys(window).filter(e => 'function' == typeof window[e]),

            ),

            console.groupEnd(),

            {}

          );

        }

        // æ–°å¢ï¼šç»Ÿä¸€çš„UIæ¸²æŸ“å‡½æ•°
        renderUI(data) {
            if (!data) {
                console.warn('RenderUI è°ƒç”¨å¤±è´¥ï¼šæ²¡æœ‰æä¾›æ•°æ®ã€‚');
                return;
            }
            
            console.log('ğŸ”„ å¼€å§‹æ¸²æŸ“UIï¼Œæ•°æ®:', data);
            
            try {
                // é‡è¦ï¼šå…ˆæ›´æ–°this.currentMvuStateï¼Œç¡®ä¿åç»­å‡½æ•°ä½¿ç”¨æœ€æ–°æ•°æ®
                if (this.currentMvuState && this.currentMvuState.stat_data) {
                    console.log('âœ… ä½¿ç”¨MVUè¿”å›çš„æœ€æ–°æ•°æ®æ¸²æŸ“UI');
                    // å¼ºåˆ¶æ›´æ–°getAllVariablesçš„ç¼“å­˜
                    this._forceRefreshVariables();
                }
                
                // æ›´æ–°è®­ç»ƒå‘˜çŠ¶æ€
                this.updateTrainerStatus();
                
                // æ›´æ–°é©¬å¨˜çŠ¶æ€
                this.updateUmaStatus();
                
                // æ›´æ–°æ—¶é—´æ˜¾ç¤º
                this.updateTimeDisplay();
                
                // æ›´æ–°å›å¤è®¡æ—¶å™¨
                this.updateReplyTimer();
                
                // æ›´æ–°æ•…äº‹å†…å®¹
                this.updateStoryContent();
                
                // æ›´æ–°å…¶ä»–ç•Œé¢å…ƒç´ 
                this.updateInventory();
                this.updateRules();
                this.updateCurrencySystem();
                this.updateFestivalNotice();
                this.updateRulesCountdown();
                this.updateLocation();
                this.updateGachaCoin();
                
                console.log('âœ… UIæ¸²æŸ“å®Œæˆ');
            } catch (error) {
                console.error('âŒ UIæ¸²æŸ“å¤±è´¥:', error);
            }
        }

        // æ–°å¢ï¼šå¼ºåˆ¶åˆ·æ–°å˜é‡çŠ¶æ€ï¼Œä½¿ç”¨MVUè¿”å›çš„æœ€æ–°æ•°æ®
        _forceRefreshVariables() {
            try {
                console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°å˜é‡çŠ¶æ€...');
                
                // å¦‚æœMVUè¿”å›äº†æ–°çŠ¶æ€ï¼Œå¼ºåˆ¶æ›´æ–°getAllVariablesçš„ç¼“å­˜
                if (this.currentMvuState && this.currentMvuState.stat_data) {
                    console.log('âœ… æ£€æµ‹åˆ°MVUæ–°çŠ¶æ€ï¼Œå¼ºåˆ¶åˆ·æ–°å˜é‡');
                    
                    // è¿™é‡Œå¯ä»¥æ·»åŠ é€»è¾‘æ¥å¼ºåˆ¶åˆ·æ–°TavernHelperçš„å˜é‡ç¼“å­˜
                    // æˆ–è€…ç›´æ¥ä½¿ç”¨this.currentMvuStateä¸­çš„æ•°æ®
                    
                    console.log('ğŸ“Š MVUæ–°çŠ¶æ€æ•°æ®:', this.currentMvuState.stat_data);
                }
            } catch (error) {
                console.error('âŒ å¼ºåˆ¶åˆ·æ–°å˜é‡å¤±è´¥:', error);
            }
        }

        updateTrainerStatus() {

          const e = this.getAllVariables(),

            t = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.ä½“åŠ›[0]', 100),

            n = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.ç†æ™º[0]', 100),

            s = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.è¿æ°”[0]', 50),

            o = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°[0]', 0),

            b = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.èƒŒæ™¯[0]', 'æ— '),

            talent = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name[0]', 'æ— '),

            crystals = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶[0]', 0);



          // æ›´æ–°è¿›åº¦æ¡é¢œè‰²

          this.updateProgressBar('stamina-bar', 'stamina-value', t, this.getStaminaColor(t));

          this.updateProgressBar('sanity-bar', 'sanity-value', n, this.getSanityColor(n));

          this.updateProgressBar('luck-bar', 'luck-value', s);



          const a = document.getElementById('trainer-status'),

            l = document.getElementById('days-in-park'),

            bg = document.getElementById('trainer-background'),

            tal = document.getElementById('trainer-talent'),

            cry = document.getElementById('trainer-crystals');



          // æ›´æ–°çŠ¶æ€æ–‡æœ¬å’Œæ ·å¼

          if (a) {

            const statusText = this.getTrainerStatusText(n, t);

            a.textContent = statusText;

            a.className = `value ${this.getTrainerStatusClass(n, t)}`;

          }



          // æ›´æ–°åœ¨æ ¡å¤©æ•°

          if (l) {

            l.textContent = `${o}å¤©`;

          }



          // æ›´æ–°è®­ç»ƒå‘˜èƒŒæ™¯

          if (bg) {

            bg.textContent = b;

          }



          // æ›´æ–°è®­ç»ƒå‘˜å¤©èµ‹

          if (tal) {

            tal.textContent = talent;

          }



          // æ›´æ–°ç•¸å½¢æƒ…æ„Ÿç»“æ™¶

          if (cry) {

            cry.textContent = crystals;

          }

        }

        updateUmaStatus() {

          const e = document.getElementById('uma-status');

          if (!e) return;

          const t = this.getAllVariables();

          console.log('ğŸ” æ‰€æœ‰å˜é‡:', t);

          const n = this.getVariable(t, 'stat_data.é©¬å¨˜', {});

          if ((console.log('ğŸ é©¬å¨˜æ•°æ®:', n), !n || 0 === Object.keys(n).length))

            return void (e.innerHTML = '<div class="empty-uma">æš‚æ— é©¬å¨˜æ•°æ®</div>');



          // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨uma-contentï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º

          let umaContent = e.querySelector('.uma-content');

          if (!umaContent) {

            e.innerHTML = '<div class="uma-content"></div>';

            umaContent = e.querySelector('.uma-content');

          }



          // æ›´æ–°ç°æœ‰çš„é©¬å¨˜é¡¹ç›®ï¼Œè€Œä¸æ˜¯é‡æ–°ç”Ÿæˆæ•´ä¸ªHTML

          Object.keys(n).forEach((umaName, index) => {
            // è‡ªåŠ¨æ·»åŠ åˆ°é©¬å¨˜è®°åå†Œï¼ˆåªåœ¨é¦–æ¬¡é‡åˆ°æ—¶æ·»åŠ ï¼‰
            if (window.teresenDebug && window.teresenDebug.addUmaToRoster && !this.umaRosterAdded.has(umaName)) {
              window.teresenDebug.addUmaToRoster(umaName, {
                notes: `é¦–æ¬¡é‡åˆ°: ${new Date().toLocaleString('zh-CN')}`
              });
              this.umaRosterAdded.add(umaName);
            }

            const n = this.getVariable(t, `stat_data.é©¬å¨˜.${umaName}.å¥½æ„Ÿåº¦[0]`, 20),

              o = this.getVariable(t, `stat_data.é©¬å¨˜.${umaName}.çŠ¶æ€[0]`, 'æ­£å¸¸'),

              a = this.getUmaDescription(umaName, n, o),

              l = this.getUmaStatusClass(o),

              r = Math.max(1, Math.floor(n / 20)),

              i = this.getUmaAvatar(umaName),

              c = this.getVariable(t, 'stat_data.ä¸–ç•Œ.å½“å‰æ—¶é—´[0]', '06:00'),

              d = this.getTimeDangerLevel(c),

              g = this.getVariable(t, `stat_data.é©¬å¨˜.${umaName}.ç‹¬å åº¦[0]`, 0),

              u = this.getAvatarStyle(g, d);

            (console.log(`ğŸ ${umaName} - å¥½æ„Ÿåº¦: ${n}, å¿ƒæ•°: ${r}, ç‹¬å åº¦: ${g}`),

              console.log(`ğŸ’– ${umaName} çˆ±å¿ƒè®¡ç®—: ${n} / 20 = ${n / 20}, Math.floor = ${r}`),

              console.log(`ğŸ“Š ${umaName} çŠ¶æ€: ${o}, çŠ¶æ€ç±»: ${l}`),

              console.log(`ğŸ¨ ${umaName} å¤´åƒæ ·å¼: ${u}`));



            // æŸ¥æ‰¾æˆ–åˆ›å»ºé©¬å¨˜é¡¹ç›®

            let umaItem = umaContent.children[index];

            if (!umaItem) {

              umaItem = document.createElement('div');

              umaItem.className = 'uma-item';

              umaContent.appendChild(umaItem);

            }



            // æ ¹æ®å¥½æ„Ÿåº¦å’Œç‹¬å åº¦è®¡ç®—åŠ¨æ€æ ·å¼

            const nameColor = this.getUmaNameColor(n, g);

            const statusColor = this.getUmaStatusColor(o, g, index);

            const statusBackground = this.getStatusBackgroundColor(o, g, index);



            // æ›´æ–°é©¬å¨˜é¡¹ç›®çš„å†…å®¹

            umaItem.innerHTML = `

              <div class="uma-header">

                                  <div class="uma-info">

                    ${i ? `<img src="${i}" alt="${umaName}" class="uma-avatar" style="${u}">` : ''}

                    <div class="uma-text-info">

                      <div class="uma-name" style="color: ${nameColor}">${umaName}</div>
                      <div class="uma-status-text" style="color: ${statusColor}">${o}</div>

                    </div>

                  </div>

              </div>

              <div class="uma-desc">${a}</div>

              <div class="uma-hearts">

                ${this.generateHeartIcons(r)}

              </div>

            `;



            // è®¾ç½®åŸºç¡€èƒŒæ™¯è‰²

            umaItem.style.setProperty('background', '#fdfbf7', 'important');

            umaItem.style.setProperty('background-color', '#fdfbf7', 'important');



            // æ ¹æ®ç‹¬å åº¦æ·»åŠ JavaScriptç»˜åˆ¶çš„èŠ±æœµ

            if (g > 30) {

              // åˆ›å»ºcanvaså…ƒç´ æ¥ç»˜åˆ¶èŠ±æœµ

              const canvas = document.createElement('canvas');

              canvas.width = 200;

              canvas.height = 200;

              canvas.style.cssText = `

                position: absolute;

                top: 50%;

                right: -20px;

                transform: translateY(-50%);

                width: 80px;

                height: 80px;

                pointer-events: none;

                z-index: 1;

                opacity: 0.4;

                filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.6));

              `;

              

              const ctx = canvas.getContext('2d');

              const progress = g / 100;

              

              // ç»˜åˆ¶èŠ±æœµ - å‚è€ƒèƒŒæ™¯å›¾ç‰‡çš„æ ·å¼

              ctx.save();

              ctx.translate(100, 100);

              

              // æ ¹æ®ç‹¬å åº¦ç¡®å®šé¢œè‰²å’Œæ ·å¼

              let flowerColor, petalCount, petalSize;

              if (g > 90) {

                // 90-100%: æ·±çº¢è‰²å¤æ‚èŠ±æœµ

                flowerColor = '#8B0000';

                petalCount = 8;

                petalSize = 25;

              } else if (g > 80) {

                // 80-90%: çº¢è‰²èŠ±æœµ

                flowerColor = '#DC143C';

                petalCount = 7;

                petalSize = 25;

              } else if (g > 70) {

                // 70-80%: æµ…çº¢è‰²èŠ±æœµ

                flowerColor = '#EF4444';

                petalCount = 6;

                petalSize = 25;

              } else if (g > 60) {

                // 60-70%: ç²‰çº¢è‰²èŠ±æœµ

                flowerColor = '#F87171';

                petalCount = 6;

                petalSize = 25;

              } else if (g > 50) {

                // 50-60%: æµ…ç²‰è‰²èŠ±æœµ

                flowerColor = '#FCA5A5';

                petalCount = 5;

                petalSize = 25;

              } else if (g > 40) {

                // 40-50%: ç™½è‰²èŠ±æœµ

                flowerColor = '#FFFFFF';

                petalCount = 5;

                petalSize = 25;

              } else {

                // 30-40%: å¾ˆæ·¡çš„ç™½è‰²èŠ±æœµ

                flowerColor = '#FFFFFF';

                petalCount = 4;

                petalSize = 25;

              }

              

              // ç»˜åˆ¶èŠ±ç“£ - ä½¿ç”¨æ›´è‡ªç„¶çš„æ›²çº¿

              for (let i = 0; i < petalCount; i++) {

                ctx.save();

                ctx.rotate((Math.PI * 2 / petalCount) * i);

                

                ctx.beginPath();

                ctx.moveTo(0, 0);

                // ä½¿ç”¨è´å¡å°”æ›²çº¿åˆ›å»ºæ›´è‡ªç„¶çš„èŠ±ç“£å½¢çŠ¶

                ctx.bezierCurveTo(

                  petalSize * 0.3, -petalSize * 0.4,

                  petalSize * 0.7, -petalSize * 0.3,

                  petalSize * 0.8, 0

                );

                ctx.bezierCurveTo(

                  petalSize * 0.7, petalSize * 0.3,

                  petalSize * 0.3, petalSize * 0.4,

                  0, 0

                );

                

                ctx.fillStyle = flowerColor;

                ctx.fill();

                

                // æ·»åŠ èŠ±ç“£è¾¹ç¼˜çš„ç»†èŠ‚

                ctx.strokeStyle = flowerColor;

                ctx.lineWidth = 1;

                ctx.stroke();

                

                ctx.restore();

              }

              

              // ç»˜åˆ¶èŠ±å¿ƒ

              ctx.beginPath();

              ctx.arc(0, 0, 8, 0, Math.PI * 2);

              ctx.fillStyle = flowerColor;

              ctx.fill();

              

              // æ·»åŠ èŠ±å¿ƒç»†èŠ‚

              ctx.beginPath();

              ctx.arc(0, 0, 4, 0, Math.PI * 2);

              ctx.fillStyle = '#FFF';

              ctx.fill();

              

              ctx.restore();

              

              // å°†èŠ±æœµæ·»åŠ åˆ°æè¿°åŒºåŸŸçš„æœ€å³è¾¹

              const descElement = umaItem.querySelector('.uma-desc');

              if (descElement) {

                descElement.style.position = 'relative';

                descElement.appendChild(canvas);

              } else {

                // å¦‚æœæ‰¾ä¸åˆ°æè¿°å…ƒç´ ï¼Œåˆ™æ·»åŠ åˆ°æ•´ä¸ªå¡ç‰‡

                umaItem.style.position = 'relative';

                umaItem.appendChild(canvas);

              }

            }

          });



          // ç§»é™¤å¤šä½™çš„é©¬å¨˜é¡¹ç›®

          while (umaContent.children.length > Object.keys(n).length) {

            umaContent.removeChild(umaContent.lastChild);

          }



          // æ›´æ–°QTEåŒºåŸŸçŠ¶æ€

          this.updateQTESection();

        }

        // æ–°å¢ï¼šè·å–çŠ¶æ€è£…é¥°å›¾æ ‡
        getStatusDecoration(status, exclusiveLevel) {
          const decorations = {
            'æ­£å¸¸': 'ğŸŒ¸',      // æ¨±èŠ± - ä»£è¡¨æ­£å¸¸çŠ¶æ€
            'ç‹¬å ': 'ğŸŒ¹',      // ç«ç‘° - ä»£è¡¨ç‹¬å çŠ¶æ€
            'å¤±è¸ª': 'ğŸŒ™',      // æœˆäº® - ä»£è¡¨å¤±è¸ªçŠ¶æ€
            'æ··ä¹±': 'ğŸŒ€',      // æ¼©æ¶¡ - ä»£è¡¨æ··ä¹±çŠ¶æ€
            'è­¦æˆ’': 'âš ï¸',      // è­¦å‘Š - ä»£è¡¨è­¦æˆ’çŠ¶æ€
            'ç—…å¨‡': 'ğŸ’€',      // éª·é«… - ä»£è¡¨ç—…å¨‡çŠ¶æ€
            'default': 'âœ¨'    // é»˜è®¤è£…é¥°
          };
          
          // æ ¹æ®ç‹¬å åº¦è°ƒæ•´è£…é¥°
          if (exclusiveLevel > 80) {
            return 'ğŸ”¥'; // é«˜ç‹¬å åº¦ç”¨ç«ç„°
          } else if (exclusiveLevel > 60) {
            return 'â­'; // ä¸­é«˜ç‹¬å åº¦ç”¨æ˜Ÿæ˜Ÿ
          } else if (exclusiveLevel > 40) {
            return 'ğŸ’'; // ä¸­ç‹¬å åº¦ç”¨é’»çŸ³
          }
          
          return decorations[status] || decorations['default'];
        }

        getUmaAvatar(e) {

          return (

            {

              çˆ±ä¸½æ•°ç : 'https://files.catbox.moe/d70ku1.png',

              çˆ±ä¸½é€Ÿå­: 'https://files.catbox.moe/3r2gqv.png',

              çˆ±æ…•ç»‡å§¬: 'https://files.catbox.moe/wc144f.png',

              çˆ±å¦‚å¾€æ˜”: 'https://files.catbox.moe/j7set1.png',

              å…«é‡æ— æ•Œ: 'https://files.catbox.moe/fuvyvk.png',

              åŒ—éƒ¨ç„é©¹: 'https://files.catbox.moe/d7990k.png',

              åŒ—æ¸¯ç«å±±: 'https://files.catbox.moe/21rq96.png',

              è‰ä¸Šé£: 'https://files.catbox.moe/jevm3a.png',

              è¶…çº§å°æµ·æ¹¾: 'https://files.catbox.moe/x3ee0m.png',

              æˆç”°ç™½ä»: 'https://files.catbox.moe/75oai9.png',

              æˆç”°è·¯: 'https://files.catbox.moe/90ws3a.png',

              åˆ›å‡: 'https://files.catbox.moe/19o3se.png',

              åˆ›ä¸–é©¹: 'https://files.catbox.moe/1xs8sb.png',

              æ˜¥ç”°ä¹Œæ‹‰æ‹‰: 'https://files.catbox.moe/nvz9k4.png',

              å¤§å’Œèµ¤éª¥: 'https://files.catbox.moe/8ffgfq.png',

              å¤§é¸£å¤§æ”¾: 'https://files.catbox.moe/unxq4t.png',

              å¤§æ ‘å¿«è½¦: 'https://files.catbox.moe/5jg2l4.png',

              å¤§æ‹“å¤ªé˜³ç¥: 'https://files.catbox.moe/c7z8tt.png',

              å¾…å…¼ç¦æ¥: 'https://files.catbox.moe/v4dt95.png',

              å¸ç‹å…‰ç¯: 'https://files.catbox.moe/b04n2e.png',

              ç¬¬ä¸€çº¢å®çŸ³: 'https://files.catbox.moe/j5as90.png',

              ä¸œæµ·å¸ç‹: 'https://files.catbox.moe/r0i1vk.png',

              ä¸œå•†å˜é©: 'https://files.catbox.moe/02229w.png',

              å¤šæ—ºè¾¾: 'https://files.catbox.moe/8smudh.png',

              ä¼ç‰¹åŠ : 'https://files.catbox.moe/mef00p.png',

              é«˜å°šéªé€¸: 'https://files.catbox.moe/jp4src.png',

              è‘›åŸç‹ç‰Œ: 'https://files.catbox.moe/twqi3m.png',

              è´µå¦‡äºº: 'https://files.catbox.moe/9myg2p.png',

              å¥½æ­Œå‰§: 'https://files.catbox.moe/ymxboj.png',

              è’æ¼ è‹±é›„: 'https://files.catbox.moe/y61wwa.png',

              é»„é‡‘åŸå¸‚: 'https://files.catbox.moe/832mml.png',

              é»„é‡‘èˆ¹: 'https://files.catbox.moe/puxu1y.png',

              é»„é‡‘å·¨åŒ : 'https://files.catbox.moe/lg6d5i.png',

              æå³°: 'https://files.catbox.moe/j282j7.png',

              é‡‘é•‡ä¹‹å…‰: 'https://files.catbox.moe/4lx5nv.png',

              éªå·æ‰‹çº²: 'https://files.catbox.moe/7apiow.png',

              å‡¯æ—‹èŠ­è•¾: 'https://files.catbox.moe/rdldum.png',

              é‡Œè§å…‰é’»: 'https://files.catbox.moe/meq8kw.png',

              é‡Œè§çš‡å† : 'https://files.catbox.moe/mvmeuq.png',

              è±é’»å¥‡å®: 'https://files.catbox.moe/xm3tws.png',

              é²é“å¤«è±¡å¾: 'https://files.catbox.moe/zogjie.png',

              æ›¼åŸèŒ¶åº§: 'https://files.catbox.moe/8s8ow2.png',

              ç¾å¦™å§¿åŠ¿: 'https://files.catbox.moe/j4gt6b.png',

              ç¾æµ¦æ³¢æ—: 'https://files.catbox.moe/1dtwml.png',

              æ¢¦ä¹‹æ—…: 'https://files.catbox.moe/1k3mhi.png',

              è¿·äººæ™¯è‡´: 'https://files.catbox.moe/8x3cjc.png',

              ç±³æµ´: 'https://files.catbox.moe/c3gtgi.png',

              åå°†æ€’æ¶›: 'https://files.catbox.moe/xwghd4.png',

              æ‘©è€¶é‡ç‚®: 'https://files.catbox.moe/czbbvd.png',

              è°‹å‹‡å…¼å¤‡: 'https://files.catbox.moe/eq4zkw.png',

              ç›®ç™½é˜¿å°”ä¸¹: 'https://files.catbox.moe/ob99q8.png',

              ç›®ç™½å¤šä¼¯: 'https://files.catbox.moe/gbvkte.png',

              ç›®ç™½é«˜å³°: 'https://files.catbox.moe/iysgye.png',

              ç›®ç™½å…‰æ˜: 'https://files.catbox.moe/8d1iwy.png',

              ç›®ç™½éº¦æ˜†: 'https://files.catbox.moe/tpep4q.png',

              ç›®ç™½å–„ä¿¡: 'https://files.catbox.moe/p7t876.png',

              å¥‡é”éª: 'https://files.catbox.moe/6asj2q.png',

              æ°”æ§½: 'https://files.catbox.moe/bk7n8x.png',

              åƒæ˜ä»£è¡¨: 'https://files.catbox.moe/0q627d.png',

              å¼ºå‡»: 'https://files.catbox.moe/vzxfrt.png',

              é’äº‘å¤©ç©º: 'https://files.catbox.moe/5xrxk5.png',

              ç§‹å·å¼¥ç”Ÿ: 'https://files.catbox.moe/2mr9zz.png',

              è£è¿›é—ªè€€: 'https://files.catbox.moe/87lcsh.png',

              æ£®æ—å®ç©´: 'https://files.catbox.moe/50rq7n.png',

              ç¥é¹°: 'https://files.catbox.moe/1bch4y.png',

              åŒæ¶¡è½®: 'https://files.catbox.moe/ffi15d.png',

              ç‰¹åˆ«å‘¨: 'https://files.catbox.moe/waylx3.png',

              å¤©ç‹¼æ˜Ÿè±¡å¾: 'https://files.catbox.moe/457y2f.png',

              ä¸¸å–„æ–¯åŸº: 'https://files.catbox.moe/jujcy2.png',

              æ— å£°é“ƒé¹¿: 'https://files.catbox.moe/s6pnkl.png',

              è¥¿é‡èŠ±: 'https://files.catbox.moe/4qzhsz.png',

              å°æ —å¸½: 'https://files.catbox.moe/nmgyj9.png',

              å°æ—å‰å¥‡: 'https://files.catbox.moe/sd03xi.png',

              æ–°å®‡å®™: 'https://files.catbox.moe/zaad8r.png',

              æç›®: 'https://files.catbox.moe/vejrmc.png',

              æ¨±èŠ±åƒä»£ç‹: 'https://files.catbox.moe/a3g3gf.png',

              ç‰è—»åå­—: 'https://files.catbox.moe/5g6z60.png',

              çœŸå¼“å¿«è½¦: 'https://files.catbox.moe/unihzk.png',

              çœŸæœºä¼¶: 'https://files.catbox.moe/5y8jxf.png',

              ä¸­å±±åº†å…¸: 'https://files.catbox.moe/x8az97.png',

              å‘¨æ—¥å®é™: 'https://files.catbox.moe/uccqyf.png',

              å“èŠ™: 'https://files.catbox.moe/syhdp7.png',

              è¾¾åˆ©é˜¿æ‹‰ä¼¯: 'https://files.catbox.moe/c2ldl4.png',

              é«˜å¤šèŠ¬é˜¿æ‹‰ä¼¯: 'https://files.catbox.moe/x2unca.png',

              é»„é‡‘æ—…ç¨‹: 'https://files.catbox.moe/ebrxrn.png',

              è‰¾å°¼æ–¯é£ç¥: 'https://files.catbox.moe/nnd19a.png',

              å¯Œå£«å¥‡çŸ³: 'https://files.catbox.moe/2p60gy.png',

              è±äºšé©¬é€Š: 'https://files.catbox.moe/xeeyrl.png',

              èƒœåˆ©å¥–åˆ¸: 'https://files.catbox.moe/lnhtai.png',

            }[e] || null

          );

        }

        getAvatarStyle(e, t) {

          return `width: 58.44px; height: 64px; border-radius: 0.5rem; object-fit: cover;`;

        }



        // æ ¹æ®å¥½æ„Ÿåº¦å’Œç‹¬å åº¦è®¡ç®—åå­—é¢œè‰²

        getUmaNameColor(favorability, exclusivity) {

          // é«˜ç‹¬å åº¦æ—¶æ˜¾ç¤ºçº¢è‰²ç³»

          if (exclusivity > 90) return '#dc2626'; // æ·±çº¢è‰²

          if (exclusivity > 80) return '#ef4444'; // çº¢è‰²

          if (exclusivity > 70) return '#f87171'; // æµ…çº¢è‰²



          // é«˜å¥½æ„Ÿåº¦æ—¶æ˜¾ç¤ºç²‰è‰²ç³»

          if (favorability > 80) return '#ec4899'; // ç²‰è‰²

          if (favorability > 60) return '#f472b6'; // æµ…ç²‰è‰²

          if (favorability > 40) return '#f9a8d4'; // æ›´æµ…ç²‰è‰²



          // é»˜è®¤é¢œè‰²

          return '#8b6914'; // é‡‘è‰²

        }



        // çŠ¶æ€æ–‡å­—é¢œè‰²å›ºå®šä¸ºç™½è‰²

        getUmaStatusColor(status, exclusivity, index = 0) {

          return '#ffffff'; // å›ºå®šç™½è‰²

        }



        // æ ¹æ®å¡ç‰‡ç´¢å¼•è®¡ç®—çŠ¶æ€å¾½ç« èƒŒæ™¯è‰²

        getStatusBackgroundColor(status, exclusivity, index = 0) {

          // æ ¹æ®å¡ç‰‡æ’åºåˆ†å¸ƒèƒŒæ™¯è‰²ï¼Œä¸æ–‡å­—é¢œè‰²å½¢æˆå¯¹æ¯”

          const backgrounds = [

            'rgba(239, 68, 68, 0.15)', // æµ…çº¢è‰²èƒŒæ™¯

            'rgba(59, 130, 246, 0.15)', // æµ…è“è‰²èƒŒæ™¯

            'rgba(34, 197, 94, 0.15)', // æµ…ç»¿è‰²èƒŒæ™¯

            'rgba(251, 191, 36, 0.15)', // æµ…é»„è‰²èƒŒæ™¯

            'rgba(139, 92, 246, 0.15)', // æµ…ç´«è‰²èƒŒæ™¯

            'rgba(249, 115, 22, 0.15)', // æµ…æ©™è‰²èƒŒæ™¯

            'rgba(6, 182, 212, 0.15)', // æµ…é’è‰²èƒŒæ™¯

            'rgba(236, 72, 153, 0.15)', // æµ…ç²‰è‰²èƒŒæ™¯

            'rgba(132, 204, 22, 0.15)', // æµ…é’ç»¿è‰²èƒŒæ™¯

            'rgba(245, 158, 11, 0.15)', // æµ…ç¥ç€è‰²èƒŒæ™¯

          ];

          return backgrounds[index % backgrounds.length];

        }



        updateCurrencySystem() {

          const e = this.getAllVariables(),

            t = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.å®éªŒæ•°æ®ç‚¹[0]', 0),

            n = document.getElementById('currency-value');

          n && (n.textContent = t.toString());

        }

        updateFestivalNotice() {

          const e = this.getAllVariables(),

            t = this.getVariable(e, 'stat_data.ä¸–ç•Œ.å½“å‰èŠ‚æ—¥[0]', ''),

            s = document.getElementById('festival-notice'),

            o = document.getElementById('festival-text');

          s &&

            o &&

            (t && t !== '' && t !== null && t !== 'null'

              ? ((o.textContent = `${t}`), (s.style.display = 'flex'))

              : ((o.textContent = 'å¹³å¹³æ— å¥‡çš„ä¸€å¤©'), (s.style.display = 'flex')));

        }

        updateRulesCountdown() {

          const e = this.getAllVariables(),

            t = this.getVariable(e, 'stat_data.ä¸–ç•Œ.è§„åˆ™åˆ·æ–°æ—¥[0]', 0),

            n = document.getElementById('rules-countdown'),

            s = document.getElementById('countdown-text');

          n &&

            s &&

            (t > 0

              ? ((s.textContent = `è§„åˆ™åˆ·æ–°: ${t}å¤©å`), (n.style.display = 'flex'))

              : ((s.textContent = 'è§„åˆ™ä»Šæ—¥åˆ·æ–°'), (n.style.display = 'flex')));

        }

        updateReplyTimer() {

          try {

            const e = document.getElementById('reply-timer'),

              t = document.getElementById('reply-timer-text');

            if (!e || !t) return;

            const n = localStorage.getItem('teresen_waiting_for_reply'),

              s = localStorage.getItem('teresen_reply_start_time');

            if ('true' === n && s) {

              const n = parseInt(s),

                o = new Date().getTime() - n,

                a = Math.floor(o / 6e4),

                l = Math.floor((o % 6e4) / 1e3);

              ((t.textContent = `Eternal zzç å­—ä¸­: ${a.toString().padStart(2, '0')}:${l.toString().padStart(2, '0')}`),

                (e.className = o >= 3e5 ? 'reply-timer danger' : o >= 18e4 ? 'reply-timer warning' : 'reply-timer'),

                (e.style.display = 'flex'));

            } else {

              const n = localStorage.getItem('teresen_last_reply_time');

              const evaluation = localStorage.getItem('teresen_last_reply_evaluation') || '';

              if (n) {

                const s = parseInt(n),

                  o = Math.floor(s / 6e4),

                  a = Math.floor((s % 6e4) / 1e3);

                const timeText = `${o.toString().padStart(2, '0')}:${a.toString().padStart(2, '0')}`;

                const displayText = evaluation

                  ? `${timeText}ï¼ŒEçœ¼ç›¯å¸§ï¼š${evaluation}`

                  : `${timeText}`;

                ((t.textContent = displayText), (e.className = 'reply-timer'), (e.style.display = 'flex'));

              } else this.hideReplyTimer();

            }

          } catch (e) {

            (console.error('æ›´æ–°å›å¤æ—¶é—´è®¡ç®—å¤±è´¥:', e), this.hideReplyTimer());

          }

        }

        hideReplyTimer() {

          const e = document.getElementById('reply-timer');

          e && (e.style.display = 'none');

        }

        startReplyTimer() {

          setInterval(() => {

            this.updateReplyTimer();

          }, 1e3);

        }

        setupStreamListeners() {

          try {

            if ('undefined' != typeof eventOn && void 0 !== window.iframe_events) {

              const e = window.iframe_events;

              (eventOn(e.GENERATION_STARTED, () => {

                (console.log('ğŸš€ AIå¼€å§‹ç”Ÿæˆå›å¤'), this.startReplyTiming());

              }),

                eventOn(e.STREAM_TOKEN_RECEIVED_FULLY, e => {

                  this.updateInterface();

                }),

                eventOn(e.GENERATION_ENDED, e => {

                  (console.log('âœ… AIå›å¤ç”Ÿæˆå®Œæˆ'), this.endReplyTimer(), this.updateInterface());

                  // AIå›å¤å®Œæˆåï¼Œè®©ä¸­å¤®é¢æ¿æ»šåŠ¨åˆ°é¡¶éƒ¨

                  setTimeout(() => {

                    const centerPanel = document.querySelector('.center-panel');

                    if (centerPanel) {

                      centerPanel.scrollTop = 0;

                      console.log('ğŸ“œ ä¸­å¤®é¢æ¿å·²æ»šåŠ¨åˆ°é¡¶éƒ¨');

                    }

                  }, 100);



                  // AIå›å¤å®Œæˆåï¼Œæ£€æµ‹æ˜¯å¦éœ€è¦æ˜¾ç¤ºQTEï¼ˆç®€åŒ–ç‰ˆï¼‰

                  setTimeout(() => {

                    try {

                      console.log('ğŸ” æ£€æµ‹QTEè§¦å‘æ¡ä»¶...');



                      // æ–¹æ³•1ï¼šé€šè¿‡TavernHelper APIè·å–æœ€æ–°AIæ¶ˆæ¯

                      let aiContent = '';

                      if (typeof TavernHelper !== 'undefined' && TavernHelper.getChatMessages) {

                        try {

                          const messages = TavernHelper.getChatMessages();

                          const aiMessages = messages.filter(msg => msg.role === 'assistant');

                          if (aiMessages.length > 0) {

                            const lastMessage = aiMessages[aiMessages.length - 1];

                            aiContent = lastMessage.content || '';

                            console.log('ğŸ” é€šè¿‡APIè·å–AIå†…å®¹ï¼Œé•¿åº¦:', aiContent.length);

                          }

                        } catch (apiError) {

                          console.warn('APIè·å–å¤±è´¥ï¼Œä½¿ç”¨DOMæ–¹æ³•:', apiError);

                        }

                      }



                      // æ–¹æ³•2ï¼šå¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨DOMæ–¹æ³•

                      if (!aiContent) {

                        aiContent =

                          $('#chat_container .mes_text_ai').last().text() ||

                          $('#chat_container .mes_text').last().text() ||

                          '';

                        console.log('ğŸ” é€šè¿‡DOMè·å–AIå†…å®¹ï¼Œé•¿åº¦:', aiContent.length);

                      }



                      console.log('ğŸ” AIå†…å®¹å‰100å­—ç¬¦:', aiContent.substring(0, 100));



                      if (aiContent && this.containsBindingKeywords(aiContent)) {

                        $('#qte-section').show();

                        console.log('ğŸ® QTEå·²æ˜¾ç¤º');

                      } else {

                        $('#qte-section').hide();

                        console.log('ğŸ® QTEå·²éšè—');

                      }

                    } catch (error) {

                      console.error('âŒ QTEæ£€æµ‹å¤±è´¥:', error);

                    }

                  }, 1500);

                }),

                console.log('âœ… æµå¼æ›´æ–°ç›‘å¬å™¨è®¾ç½®å®Œæˆ'));

            } else

              (console.warn('âš ï¸ æµå¼äº‹ä»¶APIä¸å¯ç”¨ï¼Œä½¿ç”¨ä¼ ç»Ÿæ›´æ–°æ–¹å¼'),

                $('#btn-send-action').on('click', () => {

                  (console.log('ğŸš€ å¤‡ç”¨æ–¹æ¡ˆï¼šå¼€å§‹è®¡æ—¶'), this.startReplyTiming());

                }));

          } catch (e) {

            console.error('âŒ è®¾ç½®æµå¼ç›‘å¬å™¨å¤±è´¥:', e);

          }

        }

        startReplyTiming() {

          const e = new Date().getTime();

          (localStorage.setItem('teresen_reply_start_time', e.toString()),

            localStorage.setItem('teresen_waiting_for_reply', 'true'),

            console.log('â±ï¸ å¼€å§‹è®¡æ—¶:', new Date(e).toLocaleString()));

        }

        endReplyTimer() {

          try {

            const e = localStorage.getItem('teresen_reply_start_time'),

              t = localStorage.getItem('teresen_waiting_for_reply');

            if (e && 'true' === t) {

              const t = parseInt(e),

                n = new Date().getTime() - t;

              const seconds = Math.floor(n / 1e3);



              // æ ¹æ®å›å¤æ—¶é—´ç”Ÿæˆè¯„ä»·

              let evaluation = '';

              if (seconds <= 20) {

                evaluation = 'ç¥ï¼';

              } else if (seconds <= 30) {

                evaluation = 'å¾ˆå¿«ï¼';

              } else if (seconds <= 40) {

                evaluation = 'å¿«ï¼';

              } else if (seconds <= 50) {

                evaluation = 'è¿˜è¡Œï¼';

              } else if (seconds <= 60) {

                evaluation = 'ä¸€èˆ¬ï¼';

              } else if (seconds <= 90) {

                evaluation = 'æ…¢ï¼';

              } else if (seconds <= 120) {

                evaluation = 'å¾ˆæ…¢ï¼';

              } else {

                evaluation = 'å¤ªæ…¢äº†ï¼';

              }



              (localStorage.setItem('teresen_last_reply_time', n.toString()),

                localStorage.setItem('teresen_waiting_for_reply', 'false'),

                localStorage.setItem('teresen_last_reply_evaluation', evaluation),

                console.log(`âœ… å›å¤ç”Ÿæˆå®Œæˆï¼Œè€—æ—¶: ${seconds}ç§’ï¼ŒEçœ¼ç›¯å¸§ï¼š${evaluation}`),

                this.updateReplyTimer());

            }

          } catch (e) {

            console.error('ç»“æŸè®¡æ—¶å¤±è´¥:', e);

          }

        }

        async updateStoryContent() {

          try {

            const t = this.getAllVariables();

            let n = this.getVariable(t, 'stat_data.ä¸–ç•Œ.å½“å‰æ­£æ–‡[0]', '');

            if (!n && 'function' == typeof getChatMessages)

              try {

                const e = await getChatMessages(0);

                e && e.length > 0 && e[0].message && (n = e[0].message);

              } catch (e) {

                console.warn('è·å–0å±‚æ¶ˆæ¯å¤±è´¥:', e);

              }



            // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹

            n ||

              (n =

                'ä½ åˆšåˆšæ¥åˆ°ç‰¹é›·æ£®å­¦é™¢ï¼Œä½œä¸ºä¸€åæ–°æ™‹è®­ç»ƒå‘˜ï¼Œä½ è¢«åˆ†é…åˆ°äº†è¿™æ‰€è‘—åçš„èµ›é©¬å¨˜å­¦é™¢ã€‚å­¦é™¢é‡Œå……æ»¡äº†ç¥ç§˜çš„æ°”æ¯ï¼Œä½ æ„Ÿè§‰åˆ°è¿™é‡Œä¼¼ä¹éšè—ç€ä»€ä¹ˆä¸ä¸ºäººçŸ¥çš„ç§˜å¯†...\n\næ·±å¤œçš„è®­ç»ƒåœºæ€»æ˜¯æ ¼å¤–å¯‚é™...ä½ ç«™åœ¨è®­ç»ƒåœºçš„é˜´å½±ä¸­ï¼Œæœˆå…‰é€è¿‡äº‘å±‚æ´’åœ¨è·‘é“ä¸Šã€‚ä»Šæ™šçš„è®­ç»ƒå·²ç»ç»“æŸï¼Œä½†ä½ å´æ„Ÿè§‰åˆ°æœ‰ä»€ä¹ˆä¸å¯¹åŠ²çš„åœ°æ–¹ã€‚\n\nç©ºæ°”ä¸­å¼¥æ¼«ç€ä¸€ç§å¥‡æ€ªçš„æ°”æ¯ï¼Œä»¿ä½›æœ‰ä»€ä¹ˆä¸œè¥¿åœ¨æš—ä¸­çª¥è§†ç€ä½ ã€‚ä½ æƒ³èµ·äº†æœ€è¿‘æµä¼ çš„é‚£äº›ä¼ è¨€â€”â€”å…³äºæ·±å¤œè®­ç»ƒåœºä¸Šå‡ºç°çš„ç¥ç§˜èº«å½±ï¼Œå…³äºé‚£äº›æ¶ˆå¤±çš„è®­ç»ƒå‘˜...\n\nä½ çš„æ‰‹ä¸è‡ªè§‰åœ°æ¡ç´§äº†æ‰‹ä¸­çš„ç§’è¡¨ï¼Œè¿™æ˜¯ä½ ä½œä¸ºè®­ç»ƒå‘˜æœ€é‡è¦çš„å·¥å…·ã€‚ä½†ç°åœ¨ï¼Œå®ƒä¼¼ä¹å˜å¾—å¼‚å¸¸æ²‰é‡ã€‚ä½ æƒ³èµ·äº†å¥¹...é‚£ä¸ªæ€»æ˜¯åœ¨ä½ æ¢¦ä¸­å‡ºç°çš„èº«å½±ã€‚\n\nè¿œå¤„ä¼ æ¥äº†é©¬è¹„å£°ï¼Œä½†è¿™ä¸ªæ—¶é—´ä¸åº”è¯¥æœ‰ä»»ä½•èµ›é©¬å¨˜åœ¨è®­ç»ƒã€‚å£°éŸ³è¶Šæ¥è¶Šè¿‘ï¼Œä½ æ„Ÿåˆ°ä¸€é˜µå¯’æ„çˆ¬ä¸Šè„ŠèƒŒã€‚ä½†åŒæ—¶ï¼Œä½ çš„å¿ƒä¸­æ¶Œèµ·äº†ä¸€ç§å¥‡æ€ªçš„æœŸå¾…...\n\n"è®­ç»ƒå‘˜..."ä¸€ä¸ªç†Ÿæ‚‰çš„å£°éŸ³åœ¨é£ä¸­é£˜è¡ï¼Œæ˜¯å¥¹çš„å£°éŸ³ã€‚ä½ çŸ¥é“ä½ åº”è¯¥ç¦»å¼€ï¼Œä½†ä½ çš„åŒè„šå´ä¸å¬ä½¿å”¤ã€‚\n\nåœ¨ä½ é¢å‰ï¼Œæœ‰å‡ ä¸ªé€‰æ‹©æ‘†åœ¨çœ¼å‰...');



            // æå– <content></content> æ ‡ç­¾ä¸­çš„å†…å®¹

            const contentMatch = n.match(/<content>(.*?)<\/content>/s);

            if (contentMatch) {

              n = contentMatch[1].trim();

              console.log('âœ… ä»<content></content>æ ‡ç­¾ä¸­æå–å†…å®¹æˆåŠŸ');

            } else {

              console.log('ğŸ“ æœªæ‰¾åˆ°<content></content>æ ‡ç­¾ï¼Œä½¿ç”¨åŸå§‹å†…å®¹');

            }

            // åº”ç”¨å»å…«è‚¡æ­£åˆ™è„šæœ¬

            n = this.applyAntiBoilerplateRules(n);

            const s = document.getElementById('story-content');

            s && (s.innerHTML = `<p class="story-text">${n}</p><span class="typewriter-cursor">|</span>`);

          } catch (e) {

            console.log('æ— æ³•è·å–æ­£æ–‡å†…å®¹:', e);

          }

        }

        applyAntiBoilerplateRules(content) {
          if (!content || typeof content !== 'string') return content;
          
          let processed = content;
          
          // åŸºç¡€æ€»åˆ™ - åˆ é™¤ç‰¹å®šè¯æ±‡
          processed = processed.replace(/((?:ç»æœ›|éº»æœ¨|å‹¾èµ·|ä¸€ä¸(?:ä¸)|å°é—­|åƒµä½|ææƒ§|ææ…Œ|æƒ§æ€•|éœ‡æƒŠ|ç¾è€»|å±ˆè¾±|ç—…æ€|å´©æºƒ|å››è‚¢ç™¾éª¸|cá»‘gáº¯ng|subtly|yet|æ»šçƒ«çš„å²©æµ†|ç”Ÿç†(?:çš„|æ€§|å±‚é¢|æœ¬èƒ½)|å‹æŠ‘|ä¸ä¼¼äººå£°|æœºæ¢°åœ°|é‡å…½|å¹¼å…½|æ¯’è›‡|è—¤è”“|ç¼ ç»•|è‚‰åˆƒ|å°–é”|å†°å†·|éš¾ä»¥ç½®ä¿¡|ä¸å®¹(?:ç½®ç–‘|ç½®å–™)|æ³›ç™½|ä»–çŸ¥é“|å¥¹çŸ¥é“|æ¿’ä¸´å¤±æ§|æ„å‘³æ·±é•¿|é‚ªé­…|é‚ªç¬‘|ååƒå…¥è…¹|æµ·å•¸|é—ªç€|é—ªçƒ|ä½å¼|å”‡èˆŒ|ç ”ç£¨|éª¨è¡€|éª¨è¡€ä¹‹ä¸­|èºå€™|æè‡´|å¼§åº¦|å°(?:å…½|å¦–ç²¾|éªšè´§|å¯çˆ±|æåº¦|ä¸œè¥¿|ç‹ç‹¸|é‡çŒ«)|å¼“(?:èµ·|ç€))[åœ°ä¸çš„å¾—]?\**)/g, '  ');
          
          // åˆ é™¤æ€»åˆ™ - åˆ é™¤ç‰¹å®šè¡¨è¾¾
          processed = processed.replace(/ä¸ä¼¼äººå£°(çš„|åœ°|å¾—)?|(æ¨ä¸|æƒ³è¦).*?å¡è¿›å»[,\\.ï¼Œã€‚]?|ä¸å®¹[\u4e00-\u9fff]{2}(çš„|åœ°|å¾—)/g, '');
          
          // è­¦è§‰æ›¿æ¢
          processed = processed.replace(/(è­¦è§‰|è­¦è§‰)/g, this.getRandomReplacement(['ç•™å¿ƒ', 'ç¨ä½œç•™æ„', 'æ³¨æ„']));
          
          // é¤è¶³æ›¿æ¢
          processed = processed.replace(/(é¤è¶³)/g, 'æ»¡è¶³');
          
          // é‡å…½ç³»æ›¿æ¢
          processed = processed.replace(/(å°å…½|å¹¼å…½)/g, this.getRandomReplacement(['åƒå°çŒ«', 'ç‡ç›´', 'æœ¬èƒ½è€Œæ€¥åˆ‡', 'åƒå°ç‹—', 'çº¯ç²¹å‡­ç€æ„Ÿè§‰', 'æ‡µæ‡µæ‡‚æ‡‚']));
          
          // è‚‰åˆƒæ›¿æ¢
          processed = processed.replace(/(è‚‰åˆƒ|è‚‰èŒ)/g, this.getRandomReplacement(['è‚‰æŸ±', 'é˜³å…·', 'é˜´èŒ', 'é¸¡å·´', 'å·¨ç‰©', 'é¾™æ ¹']));
          
          // ç—‰æŒ›æ›¿æ¢
          processed = processed.replace(/(ç—‰æŒ›)/g, this.getRandomReplacement(['æŠ½æ', 'å¼ºåŠ›æ”¶ç¼©', 'è‚Œè‚‰ç´§å¼ ']));
          
          // ç”¬é“æ›¿æ¢
          processed = processed.replace(/(ç”¬é“)/g, 'é€šé“');
          
          // ç”Ÿç†ç³»æ›¿æ¢
          processed = processed.replace(/(ç”Ÿç†æ€§|ç”Ÿç†ä¸Š|ç”Ÿç†å±‚é¢)/g, this.getRandomReplacement(['æœ¬èƒ½çš„', 'æºè‡ªèº«ä½“çš„']));
          
          // ç‹¡é» æ›¿æ¢
          processed = processed.replace(/(ç‹¡é» )/g, this.getRandomReplacement(['å¤çµç²¾æ€ª', 'è°ƒçš®', 'ä¿ƒç‹­']));
          
          // ç­é¡¶æ›¿æ¢
          processed = processed.replace(/(ç­é¡¶)/g, this.getRandomReplacement(['å¼ºçƒˆ', 'æ— è¾¹', 'éš¾ä»¥è¨€å–»']));
          
          // æœºæ¢°åœ°æ›¿æ¢
          processed = processed.replace(/(æœºæ¢°åœ°)/g, this.getRandomReplacement(['å•è°ƒåœ°', 'ä¸»åŠ¨åœ°']));
          
          // æ‰­æ›²æ›¿æ¢
          processed = processed.replace(/(æ‰­æ›²)/g, this.getRandomReplacement(['åˆ«æ ·', 'ä¸å‡¡', 'ç‹¬ç‰¹', 'ç‰¹æ®Š']));
          
          // å°é—­æ›¿æ¢
          processed = processed.replace(/(å°é—­)/g, this.getRandomReplacement(['ç•¥æœ‰çŠ¹è±«', 'è‹¥æœ‰æ‰€æ€', 'çŸ­æš‚æ²‰é»˜']));
          
          // å››è‚¢ç™¾éª¸æ›¿æ¢
          processed = processed.replace(/(å››è‚¢ç™¾éª¸)/g, this.getRandomReplacement(['å…¨èº«', 'å‘¨èº«', 'ä»å¤´åˆ°è„š', 'æ•´ä¸ªèº«ä½“']));
          
          // å–Ÿå¹æ›¿æ¢
          processed = processed.replace(/(å–Ÿå¹)/g, this.getRandomReplacement(['å¹æ¯', 'æ„Ÿå¹']));
          
          // å¼å«ç±»æ›¿æ¢
          processed = processed.replace(/(ä½å¼)/g, this.getRandomReplacement(['é—·å“¼', 'ä½å–˜', 'å–‰éŸ³', 'ç²—é‡çš„å‘¼å¸', 'ä½å¼']));
          
          // å‹æ›¿æ¢
          processed = processed.replace(/(å‹)/g, 'çŒ›');
          
          // å…¨ç„¶æ›¿æ¢
          processed = processed.replace(/(å…¨ç„¶)/g, this.getRandomReplacement(['çº¯ç²¹', 'å®Œå…¨', 'å…¨èº«å¿ƒ']));
          
          // ä¸æ˜“å¯Ÿè§‰æ›¿æ¢
          processed = processed.replace(/(ä¸æ˜“å¯Ÿè§‰)/g, this.getRandomReplacement(['éš¾ä»¥å¯Ÿè§‰', 'ç»†å¾®', 'éšçº¦', 'éš¾ä»¥è§‰å¯Ÿ']));
          
          // ä¸€ä¸æ›¿æ¢
          processed = processed.replace(/(ä¸€ä¸ä¸|ä¸€ä¸(?!ä¸è‹Ÿ))/g, this.getRandomReplacement(['äº›å¾®', 'äº›è®¸', 'ä¸€ç‚¹', 'ä¸€ä¸']));
          
          // å¤–è¯­è¯æ±‡æ›¿æ¢
          processed = processed.replace(/(Ğ²Ğ»Ğ°Ğ¶Ğ½Ğ¾Ğ¹)/g, this.getRandomReplacement(['æ¹¿æ¶¦', 'æ³›æ»¥', 'æ³¥æ³']));
          processed = processed.replace(/(vÃ©n)/g, 'é™è„‰');
          processed = processed.replace(/(subtly)/g, this.getRandomReplacement(['å¾®å¦™çš„', 'ç²¾å¦™çš„']));
          processed = processed.replace(/(strangely)/g, 'å¥‡æ€ª');
          processed = processed.replace(/(cá»‘gáº¯ng)/g, this.getRandomReplacement(['åŠªåŠ›åœ°', 'å°½åŠ›åœ°', 'åŠ›å›¾']));
          
          // æŠ•çŸ³ç³»åˆ é™¤ - åˆ é™¤å„ç§æŠ•çŸ³ç›¸å…³çš„è¡¨è¾¾
          processed = processed.replace(/(?:[,ï¼Œ]\s*)?(?:(?:å¦‚åŒ|ä»¿ä½›|çŠ¹å¦‚|åƒ)\s+)?[^.ã€‚ï¼ï¼Ÿ>:ï¼š""\n]*?(?:æ‰è½|æ‰å…¥|æ‰è¿›|æŠ›å…¥|æŠ›è¿›|æŠ›è½|è½å…¥|æŠ•è¿›|æŠ•å…¥|ä¸¢è¿›|ä¸¢å…¥|æ”¾å…¥|æŠ•ä¸‹)[^,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n]*?(?:(?:é£|é“å—|ç§å­|é“œå—|é‡‘å—|å†°å—|çŸ³å¤´|çŸ³å­|å¤§çŸ³|å·¨çŸ³|ç‚¸å¼¹|é¹…åµçŸ³|æ¸…æ²¹|ç³–æœ|æ»´æ°´|æµ·ç»µ|æµ“å¢¨|é—ªç”µ|å‚¬åŒ–å‰‚|å†·æ°´|é’¥åŒ™|æ°´æ»´|å†°æ°´|å†°å±±)[^,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n]*?[,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n][^,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n]*?æ¶Ÿæ¼ª[)ï¼‰]?|(?:é£|é“å—|ç§å­|é“œå—|é‡‘å—|å†°å—|çŸ³å¤´|çŸ³å­|å¤§çŸ³|å·¨çŸ³|ç‚¸å¼¹|é¹…åµçŸ³|æ¸…æ²¹|ç³–æœ|æ»´æ°´|æµ·ç»µ|æµ“å¢¨|é—ªç”µ|å‚¬åŒ–å‰‚|å†·æ°´|é’¥åŒ™|æ°´æ»´|å†°æ°´|å†°å±±)[)ï¼‰]?|[,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n][^,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n]*?æ¶Ÿæ¼ª[)ï¼‰]?|[,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n])/g, '');
          
          // å…¶ä»–å¸¸è§æ›¿æ¢
          processed = processed.replace(/(ç»æœ›|éº»æœ¨|å´©æºƒ)/g, 'å¤±è½');
          processed = processed.replace(/(ææƒ§|ææ…Œ|æƒ§æ€•)/g, 'å®³æ€•');
          processed = processed.replace(/(éœ‡æƒŠ|éš¾ä»¥ç½®ä¿¡)/g, 'æƒŠè®¶');
          processed = processed.replace(/(ç¾è€»|å±ˆè¾±)/g, 'ç¾æ„§');
          
          // æ–‡æœ¬æ ¼å¼ç¾åŒ–
          processed = processed.replace(/â€œ([^â€]+)â€/g, (match, p1) => {
              return `<span class="dialogue-text">${match}</span>`;
          });          
          processed = processed.replace(/\[([^\]]+)\]/g, (match, p1) => {
              return `<span class="psychology-text">${match}</span>`;
          });
          processed = processed.replace(/\*\*([^*]+)\*\*/g, (match, p1) => {
              return `<span class="scenery-text">${match}</span>`;
          });
          
          return processed;
        }

        getRandomReplacement(options) {
          if (!Array.isArray(options) || options.length === 0) return options;
          return options[Math.floor(Math.random() * options.length)];
        }

        async syncMVUToMessage() {

          try {

            if ('function' == typeof getChatMessages && 'undefined' != typeof TavernHelper) {

              const e = await getChatMessages(0);

              if (e && e.length > 0) {

                const t = e[0],

                  n = this.getAllVariables();

                ((t.data = n),

                  await TavernHelper.setChatMessages([t], { refresh: 'none' }),

                  console.log('âœ… MVUçŠ¶æ€å·²åŒæ­¥åˆ°0å±‚æ¶ˆæ¯'));

              }

            }

          } catch (e) {

            console.error('âŒ åŒæ­¥MVUçŠ¶æ€å¤±è´¥:', e);

          }

        }

        updateTimeDisplay() {

          const e = this.getAllVariables(),

            t = this.getVariable(e, 'stat_data.ä¸–ç•Œ.å½“å‰æ—¶é—´[0]', '06:00'),

            n = this.getVariable(e, 'stat_data.ä¸–ç•Œ.å½“å‰æ—¥æœŸ[0]', '2024-01-01'),

            s = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.ä½ç½®[0]', 'è®­ç»ƒå‘˜å®¿èˆ'),

            o = document.getElementById('current-time');

          o && (o.textContent = `ğŸ“ ${s} | ğŸ• ${n} - ${t}`);

        }

        getTimeDangerLevel(e) {

          const t = parseInt(e.split(':')[0]);

          return t >= 6 && t < 8

            ? 'safe'

            : t >= 8 && t < 12

              ? 'low'

              : t >= 12 && t < 17

                ? 'medium'

                : t >= 17 && t < 20

                  ? 'high'

                  : 'extreme';

        }

        getDangerLevelText(e) {

          switch (e) {

            case 'safe':

              return 'ç›¸å¯¹å®‰å…¨æœŸ';

            case 'low':

              return 'ä¸­ç­‰é£é™©æœŸ';

            case 'medium':

              return 'è¾ƒé«˜é£é™©æœŸ';

            case 'high':

              return 'é«˜é£é™©æœŸ';

            case 'extreme':

              return 'æåº¦å±é™©æœŸ';

            default:

              return 'æœªçŸ¥æ—¶æ®µ';

          }

        }

        getDangerLevelDetails(e) {

          switch (e) {

            case 'safe':

              return '<strong>æ—©æ™¨ 6:00-8:00ï¼šç›¸å¯¹å®‰å…¨æœŸ</strong>\n\n<div class="danger-stars">å±é™©ç­‰çº§ï¼šâ˜…â˜†â˜†â˜†â˜†</div>\n\né©¬å¨˜æ¬²æœ›å¤„äºåˆé†’çŠ¶æ€ï¼Œè¡¨ç°ç›¸å¯¹æ¸©å’Œ\n\n<div class="danger-suggestion">\n<strong>ä¸»è¦é£é™©ï¼š</strong>æ‹’ç»"æ—©å®‰é—®å€™"å¯èƒ½å¼•å‘çš„éš”ç¦»è­¦å‘Š\n</div>\n\n<div class="danger-suggestion">\n<strong>å»ºè®®ï¼š</strong>æ¥å—æ‰€æœ‰å½¢å¼çš„æ—©æ™¨äº’åŠ¨ï¼Œä¿æŒåŸºæœ¬ç¤¼ä»ª\n</div>\n\næ­¤é˜¶æ®µæ˜¯æ”¶é›†ä¿¡æ¯å’Œå»ºç«‹æ—¥å¸¸routineçš„æœ€ä½³æ—¶æœº';

            case 'low':

              return '<strong>ä¸Šåˆ 8:00-12:00ï¼šä¸­ç­‰é£é™©æœŸ</strong>\n\n<div class="danger-stars">å±é™©ç­‰çº§ï¼šâ˜…â˜…â˜†â˜†â˜†</div>\n\né©¬å¨˜å¼€å§‹ç«äº‰æ³¨æ„åŠ›ï¼Œå¦’æ„å¼€å§‹ç§¯ç´¯\n\n<div class="danger-suggestion">\n<strong>ä¸»è¦é£é™©ï¼š</strong>è¡¨ç°å‡ºæ˜æ˜¾åå¥½ä¼šæ¿€åŒ–é©¬å¨˜é—´çš„ç«äº‰\n</div>\n\n<div class="danger-suggestion">\n<strong>å»ºè®®ï¼š</strong>ä¿æŒç»å¯¹å…¬æ­£çš„æ€åº¦ï¼Œå¹³å‡åˆ†é…å…³æ³¨åº¦\n</div>\n\næ³¨æ„è§‚å¯Ÿé©¬å¨˜é—´çš„å¾®å¦™äº’åŠ¨ï¼Œé¢„åˆ¤å¯èƒ½å†²çª';

            case 'medium':

              return '<strong>åˆå 12:00-17:00ï¼šè¾ƒé«˜é£é™©æœŸ</strong>\n\n<div class="danger-stars">å±é™©ç­‰çº§ï¼šâ˜…â˜…â˜…â˜†â˜†</div>\n\né©¬å¨˜å¼€å§‹æ¸—é€ä¸ªäººç©ºé—´ï¼Œç‹¬å åº¦å¼€å§‹æå‡\n\n<div class="danger-suggestion">\n<strong>ä¸»è¦é£é™©ï¼š</strong>è¿‡åº¦æ¥å—ååŠ©ä¼šå¯¼è‡´æŸä½é©¬å¨˜ç‹¬å åº¦æ€¥å‰§ä¸Šå‡\n</div>\n\n<div class="danger-suggestion">\n<strong>å»ºè®®ï¼š</strong>é€‚åº¦æ¥å—å¸®åŠ©ä½†ä¿æŒè·ç¦»ï¼Œé¿å…å½¢æˆå›ºå®šæ¨¡å¼\n</div>\n\næ³¨æ„ä¿æŠ¤ä¸ªäººç‰©å“å’Œç©ºé—´ä¸è¢«è¿‡åº¦ä¾µå ';

            case 'high':

              return '<strong>å‚æ™š 17:00-20:00ï¼šé«˜é£é™©æœŸ</strong>\n\n<div class="danger-stars">å±é™©ç­‰çº§ï¼šâ˜…â˜…â˜…â˜…â˜†</div>\n\né©¬å¨˜æ¬²æœ›è¾¾åˆ°å³°å€¼ï¼Œå¯»æ±‚æ·±åº¦äº²å¯†äº’åŠ¨\n\n<div class="danger-suggestion">\n<strong>æé«˜é£é™©ï¼š</strong>æ‹’ç»ä¼šå¼•å‘è¡¥å¿æ€§ç´¢å–ï¼Œæ¥å—ä¼šå¯¼è‡´è¿‡åº¦äº²å¯†\n</div>\n\n<div class="danger-suggestion">\n<strong>å»ºè®®ï¼š</strong>è°¨æ…é€‰æ‹©äº’åŠ¨å¯¹è±¡ï¼Œè®¾å®šæ˜ç¡®è¾¹ç•Œ\n</div>\n\nå‡†å¤‡åº”å¯¹å¯èƒ½è§¦å‘çš„å¤œæ™šç‰¹æ®Šäº‹ä»¶';

            case 'extreme':

              return '<strong>å¤œæ™š 20:00-6:00ï¼šæåº¦å±é™©æœŸ</strong>\n\n<div class="danger-stars">å±é™©ç­‰çº§ï¼šâ˜…â˜…â˜…â˜…â˜…</div>\n\né©¬å¨˜è¤ªå»æ‰€æœ‰ä¼ªè£…ï¼Œå±•ç°æœ€åŸå§‹çš„ç‹©çŒæœ¬èƒ½\n\n<div class="danger-suggestion">\n<strong>æç«¯å±é™©ï¼š</strong>è§„åˆ™ç•Œé™æ¨¡ç³Šï¼Œæ¬²æœ›å®Œå…¨é‡Šæ”¾\n</div>\n\n<div class="danger-suggestion">\n<strong>å»ºè®®ï¼š</strong>å°½é‡é¿å…å•ç‹¬è¡ŒåŠ¨ï¼Œä¿æŒé«˜åº¦è­¦è§‰\n</div>\n\nå¿…é¡»éšèº«æºå¸¦ç”Ÿå­˜é“å…·ï¼Œåšå¥½åº”æ€¥å‡†å¤‡\næ­¤é˜¶æ®µç”Ÿå­˜æ¦‚ç‡æœ€ä½ï¼Œéœ€è¦æœ€å¤§ç¨‹åº¦çš„è°¨æ…\n\n<div class="danger-suggestion" style="background: rgba(220, 38, 38, 0.1); border-left-color: #dc2626;">\n<strong>ã€ç‰¹åˆ«è­¦å‘Šã€‘</strong>å¤œæ™šæ—¶æ®µæ˜¯ç”Ÿå­˜æŒ‘æˆ˜æœ€å¤§çš„é˜¶æ®µï¼Œé©¬å¨˜ä»¬çš„æ¬²æœ›ä¸å†å—åˆ°ä»»ä½•çº¦æŸï¼Œå»ºè®®è®­ç»ƒå‘˜åœ¨æ­¤æ—¶é—´æ®µå°½é‡å‡å°‘å¤–å‡ºï¼Œé”å¥½æˆ¿é—¨ï¼Œå¹¶å‡†å¤‡å¥½åº”å¯¹å„ç§çªå‘çŠ¶å†µçš„ç”Ÿå­˜é“å…·ã€‚\n</div>';

            default:

              return 'æœªçŸ¥æ—¶æ®µï¼Œè¯·ä¿æŒè­¦æƒ•';

          }

        }

        updateInventory() {

          const e = this.getAllVariables();

          console.group('ğŸ” æ›´æ–°ç‰©å“æ è°ƒè¯•');

          const t = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.ç‰©å“æ ', {});

          console.log('ç‰©å“æ åŸå§‹æ•°æ®:', t);



          console.log('ç‰©å“æ å¯¹è±¡:', t);

          const s = document.getElementById('inventory-list');

          if ((console.log('ç‰©å“æ å®¹å™¨:', s), !s))

            return (console.error('âŒ æ‰¾ä¸åˆ°ç‰©å“æ å®¹å™¨'), void console.groupEnd());



          // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®

          const savedInventoryScrollTop = s ? s.scrollTop : 0;



          if (!t || 0 === Object.keys(t).length) {

            console.warn('âš ï¸ ç‰©å“æ ä¸ºç©º');

            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç©ºçŠ¶æ€æ˜¾ç¤º

            const existingEmpty = s.querySelector('.empty-inventory');

            if (!existingEmpty) {

              s.innerHTML = '<div class="empty-inventory">æš‚æ— é“å…·</div>';

            }

            console.groupEnd();

            return;

          }



          // è·å–å½“å‰æ‰€æœ‰é“å…·é¡¹ç›®

          const currentItems = Array.from(s.querySelectorAll('.inventory-item'));

          const itemNames = Object.keys(t);



          // æ›´æ–°ç°æœ‰é“å…·é¡¹ç›®

          itemNames.forEach((itemName, index) => {

            const itemData = t[itemName];

            let itemElement = currentItems[index];



            // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„

            if (!itemElement) {

              itemElement = document.createElement('div');

              itemElement.className = 'inventory-item';

              itemElement.setAttribute('data-item-index', index);

              s.appendChild(itemElement);

            }



            // æ›´æ–°é“å…·å†…å®¹

            if (typeof itemData === 'object' && itemData.æè¿°) {

              itemElement.innerHTML = `

                <div class="item-header">

                  <div class="item-name">${itemName}</div>

                </div>

              `;

            } else {

              itemElement.innerHTML = `<span>${itemName}</span>`;

            }

          });



          // åˆ é™¤å¤šä½™çš„é“å…·é¡¹ç›®

          for (let i = itemNames.length; i < currentItems.length; i++) {

            currentItems[i].remove();

          }



          // ç§»é™¤ç©ºçŠ¶æ€æ˜¾ç¤º

          const emptyElement = s.querySelector('.empty-inventory');

          if (emptyElement) {

            emptyElement.remove();

          }

          setTimeout(() => {

            $('.item-header')

              .off('click')

              .on('click', function (e) {

                e.preventDefault();

                e.stopPropagation();

                console.log('é“å…·è¢«ç‚¹å‡»äº†ï¼');

                const itemIndex = $(this).closest('.inventory-item').data('item-index');

                const itemData = t[Object.keys(t)[itemIndex]];

                if (itemData && itemData.æè¿°) {

                  console.log('é“å…·ç´¢å¼•:', itemIndex);

                  console.log('é“å…·æ•°æ®:', itemData);

                  $('.item-detail-popup').remove();

                  const popup = $(

                    `\n               <div class="item-detail-popup">\n                 <div class="item-name">${Object.keys(t)[itemIndex]}</div>\n                 <div class="item-desc">${itemData.æè¿°}</div>\n                 <div class="item-effect">æ•ˆæœ: ${itemData.æ•ˆæœ}</div>\n                 <div class="item-info-row">\n                   <div class="item-rarity rarity-${itemData.ç¨€æœ‰åº¦}">${itemData.ç¨€æœ‰åº¦}</div>\n                   <div class="item-actions">\n                     <button class="item-use-btn" title="ä½¿ç”¨">ğŸ¯</button>\n                     <button class="item-discard-btn" title="ä¸¢å¼ƒ">ğŸ—‘ï¸</button>\n                     <button class="item-lock-btn" title="é”å®š">ğŸ”’</button>\n                     <button class="item-gift-btn" title="èµ é€">ğŸ</button>\n                   </div>\n                 </div>\n               </div>\n             `,

                  );

                  $('body').append(popup);

                  const element = $(this)[0];

                  if (element && popup.length > 0) {

                    const rect = element.getBoundingClientRect(),

                      popupHeight = popup.outerHeight() || 0;

                    popup.css({ position: 'fixed', top: rect.top - popupHeight - 10, left: rect.left, zIndex: 9999 });

                  }

                  $(document).one('click', function (e) {

                    $(e.target).closest('.item-detail-popup').length || $('.item-detail-popup').remove();

                  });



                  // ç»‘å®šé“å…·æ“ä½œæŒ‰é’®äº‹ä»¶

                  popup.find('.item-use-btn').on('click', function () {

                    const itemName = Object.keys(t)[itemIndex];

                    addPendingAction('use', itemName);

                    $('.item-detail-popup').remove();

                  });



                  popup.find('.item-discard-btn').on('click', function () {

                    const itemName = Object.keys(t)[itemIndex];

                    addPendingAction('discard', itemName);

                    $('.item-detail-popup').remove();

                  });



                  popup.find('.item-lock-btn').on('click', function () {

                    const itemName = Object.keys(t)[itemIndex];

                    toggleItemLock(itemName, $(this));

                  });



                  popup.find('.item-gift-btn').on('click', function () {

                    const itemName = Object.keys(t)[itemIndex];

                    startGiftSelection(itemName);

                    $('.item-detail-popup').remove();

                  });

                }

              });

          }, 100);



          console.groupEnd();

        }

        updateRules() {

          this.updateRulesModal();

        }

        updateRulesModal() {

          const fixedRules = [

            'ä½ æ˜¯è¿™é‡Œå”¯ä¸€çš„äººç±»è®­ç»ƒå‘˜ï¼Œè¯·ä¸è¦æ‹’ç»é©¬å¨˜',
            'è¯·å¤œæ™šä¸è¦å•ç‹¬å¾…åœ¨å®¿èˆ',
            'ä½œä¸ºè®­ç»ƒå‘˜ï¼Œä½ éœ€è¦ç»„å»ºä¸€ä¸ªé©¬å¨˜å›¢é˜Ÿï¼Œå¹¶å¸¦é¢†å¥¹ä»¬å‚åŠ æ¯”èµ›',
            'åœ¨å­¦é™¢å¤–é¢è‹¥å¯Ÿè§‰åˆ°è¢«å°¾éšï¼Œè¯·ç«‹å³å‰å¾€ç›®ç™½åŸå’Œé»„é‡‘å®¶æ—çš„å±…æ‰€',
            'ä½ å¯ä»¥å®Œå…¨ç›¸ä¿¡ä½ çš„æœ€ä½³æ­æ¡£ï¼Œè‹¥æ˜¯ä¸æœ€ä½³æ­æ¡£åŒè¡Œï¼Œå¯ä»¥ä¸éµå®ˆä»¥ä¸Šè§„åˆ™',

          ];

          
          // æ›´æ–°å›ºå®šè§„åˆ™
          const fixedRulesList = document.getElementById('fixed-rules-list');

          if (fixedRulesList) {

            let fixedRulesHtml = '';

            fixedRules.forEach((rule, index) => {

              fixedRulesHtml += `\n          <div class="rule-item-handwritten">\n            <span class="rule-number-handwritten">${index + 1}.</span>\n            <span class="rule-text-handwritten">${rule}</span>\n          </div>\n        `;

            });

            fixedRulesList.innerHTML = fixedRulesHtml;

          }

          
          // æ›´æ–°ç”¨æˆ·è®°å½•çš„è§„åˆ™
          this.updateUserRules();
          
          // ç¡®ä¿è§„åˆ™è®°å½•æŒ‰é’®äº‹ä»¶ç»‘å®š
          setTimeout(() => {
            $('#add-rule-btn').off('click').on('click', () => {
              console.log('ğŸ¯ æ·»åŠ è§„åˆ™æŒ‰é’®è¢«ç‚¹å‡»');
              this.addRule();
            });
            $('#clear-rules-btn').off('click').on('click', () => {
              console.log('ğŸ¯ æ¸…ç©ºè§„åˆ™æŒ‰é’®è¢«ç‚¹å‡»');
              this.clearAllRules();
            });
          }, 100);
        }
        
        // è·å–ç”¨æˆ·è®°å½•çš„è§„åˆ™
        getUserRules() {
          const savedRules = localStorage.getItem('teresen-user-rules');
          return savedRules ? JSON.parse(savedRules) : [];
        }
        
        // ä¿å­˜ç”¨æˆ·è®°å½•çš„è§„åˆ™
        saveUserRules(rules) {
          localStorage.setItem('teresen-user-rules', JSON.stringify(rules));
        }
        
        // æ›´æ–°ç”¨æˆ·è§„åˆ™æ˜¾ç¤º
        updateUserRules() {
          const userRules = this.getUserRules();
          const randomRulesList = document.getElementById('random-rules-list');

          
          if (randomRulesList) {

            let randomRulesHtml = '';

            
            if (userRules.length === 0) {
              randomRulesHtml = '<div class="empty-rules">æš‚æ— è®°å½•çš„è§„åˆ™ï¼Œç‚¹å‡»"æ·»åŠ è§„åˆ™"å¼€å§‹è®°å½•</div>';
            } else {
              userRules.forEach((rule, index) => {
                randomRulesHtml += `\n          <div class="rule-item-handwritten rule-item-editable" data-rule-index="${index}">\n            <span class="rule-number-handwritten">${index + 6}.</span>\n            <span class="rule-text-handwritten">${rule}</span>\n            <button class="rule-edit-btn" onclick="window.teresenDebug.editRule(${index})" title="ç¼–è¾‘è§„åˆ™">âœï¸</button>\n            <button class="rule-delete-btn" onclick="window.teresenDebug.deleteRule(${index})" title="åˆ é™¤è§„åˆ™">ğŸ—‘ï¸</button>\n          </div>\n        `;
              });
            }
            
            randomRulesList.innerHTML = randomRulesHtml;

          }

        }

        
        // æ·»åŠ æ–°è§„åˆ™
        addRule() {
          const userRules = this.getUserRules();
          if (userRules.length >= 7) {
            alert('æœ€å¤šåªèƒ½è®°å½•7æ¡è§„åˆ™ï¼');
            return;
          }
          
          const newRule = prompt('è¯·è¾“å…¥å‘ç°çš„è§„åˆ™ï¼š');
          if (newRule && newRule.trim()) {
            userRules.push(newRule.trim());
            this.saveUserRules(userRules);
            this.updateUserRules();
          }
        }
        
        // ç¼–è¾‘è§„åˆ™
        editRule(index) {
          const userRules = this.getUserRules();
          if (index >= 0 && index < userRules.length) {
            const newRule = prompt('ç¼–è¾‘è§„åˆ™ï¼š', userRules[index]);
            if (newRule !== null) {
              userRules[index] = newRule.trim();
              this.saveUserRules(userRules);
              this.updateUserRules();
            }
          }
        }
        
        // åˆ é™¤è§„åˆ™
        deleteRule(index) {
          const userRules = this.getUserRules();
          if (index >= 0 && index < userRules.length) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) {
              userRules.splice(index, 1);
              this.saveUserRules(userRules);
              this.updateUserRules();
            }
          }
        }
        
        // æ¸…ç©ºæ‰€æœ‰è§„åˆ™
        clearAllRules() {
          if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•çš„è§„åˆ™å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            this.saveUserRules([]);
            this.updateUserRules();
          }
        }
        updateProgressBar(e, t, n, color) {

          const s = document.getElementById(e),

            o = document.getElementById(t);

          if (s) {

            const e = Math.min(100, Math.max(0, n));

            s.style.width = `${e}%`;

            s.className = 'progress-fill';



            // åº”ç”¨é¢œè‰²

            if (color) {

              s.style.background = color;

            } else {

              // é»˜è®¤é¢œè‰²é€»è¾‘

              e < 30 ? s.classList.add('danger') : e < 60 && s.classList.add('warning');

            }

          }

          o && (o.textContent = n.toString());

        }

        getVariable(e, t, n) {

          try {

            const s = t.split(/\.|\[|\]/).filter(e => '' !== e);

            let o = e;

            (console.group(`ğŸ” è·å–å˜é‡: ${t}`), console.log('ğŸ“Š èµ·å§‹å¯¹è±¡:', e));

            for (let e = 0; e < s.length; e++) {

              const t = s[e];

              if ((console.log(`ğŸ” è®¿é—®é”®: ${t}`), !o || 'object' != typeof o))

                return (console.warn(`âŒ è·¯å¾„ä¸­æ–­ï¼Œè¿”å›é»˜è®¤å€¼: ${n}`), console.groupEnd(), n);

              if (e + 1 < s.length && !isNaN(parseInt(s[e + 1]))) {

                if (!Array.isArray(o[t])) return (console.warn(`âŒ ä¸æ˜¯æ•°ç»„ï¼Œè¿”å›é»˜è®¤å€¼: ${n}`), console.groupEnd(), n);

                {

                  const n = parseInt(s[e + 1]);

                  ((o = o[t][n]), e++, console.log(`âœ… æ•°ç»„è®¿é—® [${n}]:`, o));

                }

              } else ((o = o[t]), console.log('âœ… æ‰¾åˆ°å€¼:', o));

            }

            const a = void 0 !== o ? o : n;

            return (console.log(`ğŸ¯ æœ€ç»ˆç»“æœ: ${a}`), console.groupEnd(), a);

          } catch (s) {

            return (console.error(`âŒ è·å–å˜é‡å‡ºé”™: ${t}`, s), console.groupEnd(), n);

          }

        }

        getTrainerStatusText(sanity, stamina) {

          if (sanity >= 80 && stamina >= 80) return 'ç»å¥½è°ƒ';

          if (sanity >= 60 && stamina >= 60) return 'å¥½è°ƒ';

          if (sanity >= 40 && stamina >= 40) return 'æ™®é€š';

          if (sanity >= 20 && stamina >= 20) return 'ä¸è°ƒ';

          return 'ç»ä¸è°ƒ';

        }

        getTrainerStatusClass(sanity, stamina) {

          if (sanity >= 80 && stamina >= 80) return 'status-excellent';

          if (sanity >= 60 && stamina >= 60) return 'status-good';

          if (sanity >= 40 && stamina >= 40) return 'status-normal';

          if (sanity >= 20 && stamina >= 20) return 'status-bad';

          return 'status-terrible';

        }

        getStaminaColor(stamina) {

          if (stamina >= 80) return 'linear-gradient(90deg, #10b981 0%, #34d399 100%)';

          if (stamina >= 60) return 'linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%)';

          if (stamina >= 40) return 'linear-gradient(90deg, #f97316 0%, #fb923c 100%)';

          if (stamina >= 20) return 'linear-gradient(90deg, #dc2626 0%, #ef4444 100%)';

          return 'linear-gradient(90deg, #7f1d1d 0%, #dc2626 100%)';

        }

        getSanityColor(sanity) {

          if (sanity >= 80) return 'linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%)';

          if (sanity >= 60) return 'linear-gradient(90deg, #8b5cf6 0%, #a78bfa 100%)';

          if (sanity >= 40) return 'linear-gradient(90deg, #ec4899 0%, #f472b6 100%)';

          if (sanity >= 20) return 'linear-gradient(90deg, #dc2626 0%, #ef4444 100%)';

          return 'linear-gradient(90deg, #7f1d1d 0%, #dc2626 100%)';

        }

        getUmaDescription(e, t, n) {

          return 'è¢«é™„èº«' === n

            ? 'è¢«æŸç§åŠ›é‡æ§åˆ¶ç€...'

            : 'å¤±è¸ª' === n

              ? 'ä¸çŸ¥å»å‘...'

              : t >= 80

                ? 'å¯¹ä½ éå¸¸ä¿¡ä»»'

                : t >= 60

                  ? 'å¯¹ä½ æ¯”è¾ƒå‹å¥½'

                  : t >= 40

                    ? 'å¯¹ä½ æœ‰äº›æˆ’å¤‡'

                    : t >= 20

                      ? 'å¯¹ä½ ä¿æŒè·ç¦»'

                      : 'å¯¹ä½ å¾ˆé™Œç”Ÿ';

        }

        getUmaStatusClass(e) {

          switch (e) {

            case 'æ­£å¸¸':

            default:

              return 'normal';

            case 'ç—…å¨‡':

              return 'yandere';

            case 'è¢«é™„èº«':

              return 'possessed';

            case 'å¤±è¸ª':

              return 'missing';

          }

        }

        generateHeartIcons(e) {

          let t = '';

          console.log(`ğŸ’– ç”Ÿæˆå¿ƒå½¢å›¾æ ‡ï¼Œæ•°é‡: ${e}`);

          const n = Math.max(1, Math.min(5, e));

          console.log(`ğŸ’– å®é™…æ˜¾ç¤ºæ•°é‡: ${n}`);

          for (let s = 0; s < n; s++) t += '<span class="heart">â¤</span>';

          return (console.log(`ğŸ’– ç”Ÿæˆçš„å¿ƒå½¢HTML: ${t}`), t);

        }

        toggleItemDetails(e) {

          const t = document.getElementById(`item-details-${e}`),

            n = document.querySelector(`[data-item-index="${e}"] .item-toggle`);

          if (t && n) {

            if ('none' !== t.style.display) ((t.style.display = 'none'), (n.textContent = 'â–¼'));

            else {

              const sound = document.getElementById('item-detail-sound');

              if (sound) {

                sound.currentTime = 0;

                sound.play().catch(err => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', err));

              }

              (t.style.display = 'block'),

              (n.textContent = 'â–²');

            }

          }

        }

        toggleRules(e) {

          const t = document.getElementById(`${e}-rules-content`),

            n = document.querySelector(`[onclick="window.teresenDebug.toggleRules('${e}')"] .rules-toggle`);

          if (t && n) {

            'none' !== t.style.display

              ? ((t.style.display = 'none'), (n.textContent = 'â–¼'))

              : ((t.style.display = 'block'), (n.textContent = 'â–²'));

          }

        }

        toggleUmaSection() {

          const e = document.getElementById('uma-content'),

            t = document.querySelector('.uma-toggle');

          if (e && t) {

            'none' !== e.style.display

              ? ((e.style.display = 'none'), (t.textContent = 'â–¼'))

              : ((e.style.display = 'block'), (t.textContent = 'â–²'));

          }

        }

        toggleProfile() {

          const e = document.getElementById('profile-basic'),

            t = document.getElementById('profile-detail');

          e &&

            t &&

            ('none' === t.style.display

              ? ((e.style.display = 'none'), (t.style.display = 'block'))

              : ((e.style.display = 'block'), (t.style.display = 'none')));

        }

        toggleJourney() {

          const e = document.getElementById('journey-basic'),

            t = document.getElementById('journey-detail');

          e &&

            t &&

            ('none' === t.style.display

              ? ((e.style.display = 'none'), (t.style.display = 'block'))

              : ((e.style.display = 'block'), (t.style.display = 'none')));

        }

        async handleSaveLoad() {

          try {

            console.log('ğŸ’¾ æ‰“å¼€å­˜æ¡£ç®¡ç†å™¨...');

            this.openSaveManagerModal();

          } catch (e) {

            console.error('âŒ æ‰“å¼€å­˜æ¡£ç®¡ç†å™¨å¤±è´¥:', e);

          }

        }

        toggleFullscreen() {

          const e = document.querySelector('.connected-panels'),

            t = document.getElementById('fullscreen-btn');

          e &&

            t &&

            (document.fullscreenElement

              ? document.exitFullscreen

                ? document.exitFullscreen()

                : document.webkitExitFullscreen

                  ? document.webkitExitFullscreen()

                  : document.mozCancelFullScreen

                    ? document.mozCancelFullScreen()

                    : document.msExitFullscreen && document.msExitFullscreen()

              : e.requestFullscreen

                ? e.requestFullscreen()

                : e.webkitRequestFullscreen

                  ? e.webkitRequestFullscreen()

                  : e.mozRequestFullScreen

                    ? e.mozRequestFullScreen()

                    : e.msRequestFullscreen && e.msRequestFullscreen());

        }

        handleFullscreenChange() {

          const e = document.querySelector('.connected-panels'),

            t = document.getElementById('fullscreen-btn');

          if (!e || !t) return;

          !!(

            document.fullscreenElement ||

            document.webkitFullscreenElement ||

            document.mozFullScreenElement ||

            document.msFullscreenElement

          )

            ? (e.classList.add('fullscreen-active'),

              (t.innerHTML =

                '\n        <svg class="icon" fill="currentColor" viewBox="0 0 20 20">\n          <path d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z" />\n        </svg>\n        <span>é€€å‡ºå…¨å±</span>\n      '),

              console.log('ğŸ–¥ï¸ è¿›å…¥å…¨å±æ¨¡å¼'))

            : (e.classList.remove('fullscreen-active'),

              (t.innerHTML =

                '\n        <svg class="icon" fill="currentColor" viewBox="0 0 20 20">\n          <path d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z" />\n        </svg>\n        <span>å…¨å±</span>\n      '),

              console.log('ğŸ–¥ï¸ é€€å‡ºå…¨å±æ¨¡å¼'));

        }

        async handleSave(e = 'local') {

          try {

            console.log(`ğŸ’¾ å¼€å§‹${'local' === e ? 'æœ¬åœ°' : 'ä¸–ç•Œä¹¦'}å­˜æ¡£...`);



            // è·å–å½“å‰æ¸¸æˆçŠ¶æ€

            const gameState = this.getAllVariables();

            const chatMessages = await getChatMessages(0);

            const currentMessage = chatMessages && chatMessages.length > 0 ? chatMessages[0].message : '';



            // æ„å»ºå­˜æ¡£æ•°æ®

            const saveData = {

              timestamp: Date.now(),

              saveName: `æ‰‹åŠ¨å­˜æ¡£_${new Date().toLocaleString('zh-CN')}`,

              type: 'manual',

              data: {

                variables: gameState,

                message: currentMessage,

                chatHistory: await this.getChatHistory(),

                timestamp: Date.now(),

              },

            };



            if (e === 'local') {

              // ä¿å­˜åˆ°æœ¬åœ°

              localStorage.setItem('teresen-save', JSON.stringify(saveData));

              console.log('âœ… æœ¬åœ°å­˜æ¡£æˆåŠŸ:', saveData);

              alert('æœ¬åœ°å­˜æ¡£æˆåŠŸï¼');

            } else {

              // ä¿å­˜åˆ°ä¸–ç•Œä¹¦

              await this.saveToWorldbook(saveData);

              await this.saveJourneyToWorldbook();

              console.log('âœ… ä¸–ç•Œä¹¦å­˜æ¡£æˆåŠŸ');

              alert('ä¸–ç•Œä¹¦å­˜æ¡£æˆåŠŸï¼');

            }



            // å…³é—­å­˜æ¡£ç•Œé¢

            $('#load-modal').hide();

          } catch (error) {

            console.error('âŒ å­˜æ¡£å¤±è´¥:', error);

            alert('å­˜æ¡£å¤±è´¥ï¼');

          }

        }

        async handleHistory() {

          try {

            // æ’­æ”¾äººç‰©å†ç¨‹éŸ³æ•ˆ
            const sound = document.getElementById('journey-history-sound');
            if (sound) {
              sound.currentTime = 0;
              sound.play().catch(e => console.log('æ’­æ”¾äººç‰©å†ç¨‹éŸ³æ•ˆå¤±è´¥:', e));
            }

            (console.log('ğŸ“š æ‰“å¼€å†å²è®°å½•ç•Œé¢...'), $('#history-modal').show(), await this.updateHistoryModal());

          } catch (e) {

            console.error('âŒ æ‰“å¼€å†å²è®°å½•ç•Œé¢å¤±è´¥:', e);

          }

        }

        handleDangerPeriod() {

          console.log('å±é™©æ—¶æ®µæŒ‰é’®è¢«ç‚¹å‡»');

          
          // æ’­æ”¾å±é™©æ—¶æ®µç¿»é¡µå£°éŸ³
          const sound = document.getElementById('danger-rules-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
          }
          
          const e = this.getAllVariables(),

            t = this.getVariable(e, 'stat_data.ä¸–ç•Œ.å½“å‰æ—¶é—´[0]', '06:00'),

            n = this.getTimeDangerLevel(t),

            s = this.getDangerLevelText(n),

            o = this.getDangerLevelDetails(n),

            a = document.createElement('div');

          ((a.className = 'danger-modal'),

            (a.innerHTML = `\n      <div class="danger-modal-content">\n        <div class="danger-modal-header">\n          <h3>ã€è®­ç»ƒå‘˜æ—¶æ®µç”Ÿå­˜æŒ‡å—ã€‘</h3>\n          <span class="danger-modal-close">&times;</span>\n        </div>\n        <div class="danger-modal-body">\n          <div class="danger-current-period">\n            <strong>å½“å‰æ—¶æ®µï¼š${s}</strong>\n          </div>\n          <div class="danger-details-content">\n            ${o}\n          </div>\n        </div>\n      </div>\n    `),

            document.body.appendChild(a));

          const l = a.querySelector('.danger-modal-close');

          (l &&

            l.addEventListener('click', () => {

              document.body.removeChild(a);

            }),

            a.addEventListener('click', e => {

              e.target === a && document.body.removeChild(a);

            }));

        }

        debugVariables() {

          console.log('ğŸ” è°ƒè¯•å˜é‡æŒ‰é’®è¢«ç‚¹å‡»');

          const e = this.getAllVariables();

          (console.log('ğŸ“Š æ‰€æœ‰å˜é‡æ•°æ®:', e),

            e && e.stat_data

              ? (console.log('âœ… æ‰¾åˆ°stat_dataç»“æ„'),

                console.log('ğŸƒ è®­ç»ƒå‘˜æ•°æ®:', e.stat_data.è®­ç»ƒå‘˜),

                console.log('ğŸŒ ä¸–ç•Œæ•°æ®:', e.stat_data.ä¸–ç•Œ),

                console.log('ğŸ é©¬å¨˜æ•°æ®:', e.stat_data.é©¬å¨˜),

                e.stat_data.é©¬å¨˜ &&

                  (console.log('ğŸ” é©¬å¨˜æ•°æ®è¯¦æƒ…:'),

                  Object.keys(e.stat_data.é©¬å¨˜).forEach(t => {

                    const n = e.stat_data.é©¬å¨˜[t];

                    (console.log(`ğŸ ${t}:`, n),

                      n.å¥½æ„Ÿåº¦ && console.log(`  ğŸ’– ${t} å¥½æ„Ÿåº¦:`, n.å¥½æ„Ÿåº¦),

                      n.ç‹¬å åº¦ && console.log(`  ğŸ”¥ ${t} ç‹¬å åº¦:`, n.ç‹¬å åº¦),

                      n.çŠ¶æ€ && console.log(`  ğŸ“Š ${t} çŠ¶æ€:`, n.çŠ¶æ€));

                  })),

                e.stat_data.è§„åˆ™ && console.log('ğŸ“œ è§„åˆ™æ•°æ®:', e.stat_data.è§„åˆ™))

              : (console.warn('âš ï¸ æœªæ‰¾åˆ°stat_dataç»“æ„'), console.log('ğŸ” å®Œæ•´è¿”å›ç»“æœ:', e)),

            console.log('ğŸ® å½“å‰ç•Œé¢çŠ¶æ€:'),

            console.log('  - é©¬å¨˜å®¹å™¨:', document.getElementById('uma-status')),

            console.log('  - æ—¶é—´æ˜¾ç¤º:', document.getElementById('current-time')),

            console.log('  - è®­ç»ƒå‘˜çŠ¶æ€:', document.getElementById('trainer-status')));

        }

        async handleActionSubmit() {

          const e = document.getElementById('action-input');

          if (!e || !e.value.trim()) return;

          const userMessage = e.value.trim();

          console.log('ğŸ¯ æäº¤è¡ŒåŠ¨:', userMessage);



          try {

            // 1. æ•´åˆæŒ‡ä»¤å’Œç”¨æˆ·è¾“å…¥

            let commandText = '';

            if (window.pendingActions && window.pendingActions.length > 0) {

              commandText += '[è®­ç»ƒå‘˜é“å…·è¡ŒåŠ¨æŒ‡ä»¤]\n';
              commandText += 'è®­ç»ƒå‘˜å‡†å¤‡æ‰§è¡Œä»¥ä¸‹é“å…·ç›¸å…³è¡ŒåŠ¨ï¼š\n\n';
              window.pendingActions.forEach((cmd, index) => {

                let actionText = '';
                let actionDescription = '';
                switch (cmd.action) {
                  case 'use':
                    actionText = `ä½¿ç”¨é“å…· [${cmd.itemName}]`;
                    actionDescription = `è®­ç»ƒå‘˜æƒ³è¦ä½¿ç”¨è¿™ä¸ªé“å…·ï¼Œè¯·æ ¹æ®é“å…·çš„æ•ˆæœå’Œå½“å‰æƒ…å†µæè¿°ä½¿ç”¨è¿‡ç¨‹ã€‚`;
                    break;
                  case 'discard':
                    actionText = `ä¸¢å¼ƒé“å…· [${cmd.itemName}]`;
                    actionDescription = `è®­ç»ƒå‘˜å†³å®šä¸¢å¼ƒè¿™ä¸ªé“å…·ï¼Œè¯·æè¿°ä¸¢å¼ƒçš„è¿‡ç¨‹å’Œå¯èƒ½çš„å½±å“ã€‚`;
                    break;
                  case 'gift':
                    actionText = `èµ é€é“å…· [${cmd.itemName}] ç»™ [${cmd.characterName || cmd.target}]`;
                    actionDescription = `è®­ç»ƒå‘˜æƒ³è¦å°†è¿™ä¸ªé“å…·èµ é€ç»™ç›®æ ‡è§’è‰²ï¼Œè¯·æè¿°èµ é€è¿‡ç¨‹å’Œå¯¹æ–¹çš„ååº”ã€‚`;
                    break;
                  case 'lock':
                    actionText = `é”å®šé“å…· [${cmd.itemName}]`;
                    actionDescription = `è®­ç»ƒå‘˜æƒ³è¦é”å®šè¿™ä¸ªé“å…·é˜²æ­¢æ„å¤–ä½¿ç”¨ï¼Œè¯·æè¿°é”å®šè¿‡ç¨‹ã€‚`;
                    break;
                  case 'skill':
                    const skillInfo = cmd.skillType ? `ä½¿ç”¨æŠ€èƒ½ [${cmd.skillType}]` : 'ä½¿ç”¨æŠ€èƒ½';
                    const targetInfo = cmd.target === 'self' ? 'å¯¹è‡ªå·±' : (cmd.characterName ? `å¯¹ ${cmd.characterName}` : 'å¯¹ç›®æ ‡');
                    actionText = `${skillInfo} ${targetInfo}`;
                    actionDescription = `è®­ç»ƒå‘˜æƒ³è¦ä½¿ç”¨å¤©èµ‹æŠ€èƒ½ï¼Œè¯·æ ¹æ®æŠ€èƒ½ç±»å‹å’Œç›®æ ‡æè¿°ä½¿ç”¨è¿‡ç¨‹ã€‚`;
                    break;
                  default:
                    actionText = `æ‰§è¡Œæ“ä½œ [${cmd.action}]`;
                    actionDescription = `è®­ç»ƒå‘˜æƒ³è¦æ‰§è¡Œè¿™ä¸ªæ“ä½œï¼Œè¯·æè¿°æ‰§è¡Œè¿‡ç¨‹ã€‚`;
                }
                
                commandText += `è¡ŒåŠ¨${index + 1}: ${actionText}\n`;
                commandText += `è¯´æ˜: ${actionDescription}\n`;
                
                // æ·»åŠ é“å…·è¯¦ç»†ä¿¡æ¯
                if (cmd.itemName && cmd.action !== 'skill') {
                  commandText += `é“å…·åç§°: ${cmd.itemName}\n`;
                  if (cmd.itemData) {
                    commandText += `é“å…·æè¿°: ${cmd.itemData.æè¿° || 'æ— æè¿°'}\n`;
                    commandText += `é“å…·æ•ˆæœ: ${cmd.itemData.æ•ˆæœ || 'æ— æ•ˆæœè¯´æ˜'}\n`;
                    commandText += `é“å…·ç¨€æœ‰åº¦: ${cmd.itemData.ç¨€æœ‰åº¦ || 'æ™®é€š'}\n`;
                  }
                }
                
                // æ·»åŠ æŠ€èƒ½è¯¦ç»†ä¿¡æ¯
                if (cmd.action === 'skill' && cmd.skillType) {
                  commandText += `æŠ€èƒ½ç±»å‹: ${cmd.skillType}\n`;
                  commandText += `å¤§å¤©èµ‹: ${cmd.majorTalent || 'æœªçŸ¥'}\n`;
                  if (cmd.target) {
                    commandText += `ä½¿ç”¨ç›®æ ‡: ${cmd.target === 'self' ? 'è‡ªå·±' : cmd.characterName || 'æœªæŒ‡å®š'}\n`;
                  }
                }
                
                commandText += '\n';
              });
              
              commandText += 'è¯·æ ¹æ®ä»¥ä¸ŠæŒ‡ä»¤è¯¦ç»†æè¿°è®­ç»ƒå‘˜çš„è¡ŒåŠ¨è¿‡ç¨‹ï¼ŒåŒ…æ‹¬é“å…·ä½¿ç”¨çš„å…·ä½“æ•ˆæœã€ç›®æ ‡è§’è‰²çš„ååº”ã€ä»¥åŠå¯èƒ½äº§ç”Ÿçš„å½±å“ã€‚\n\n';

            }



            // 2. æ„å»ºåˆå¹¶å†…å®¹

            let combinedContent = '';

            if (commandText) {

              combinedContent += commandText + '\n';

            }

            if (userMessage) {

              combinedContent += `<userinput>\n${userMessage}\n</userinput>`;

            }



            if (!combinedContent) {

              console.warn('âš ï¸ æ²¡æœ‰å†…å®¹å¯å‘é€');

              return;

            }



            // 3. ä¿å­˜ç”¨æˆ·è¾“å…¥ï¼Œä½†ä¸è¦†ç›–AIå‰§æƒ…å†…å®¹

            // æˆ‘ä»¬åªä¿å­˜ç”¨æˆ·è¾“å…¥åˆ°å˜é‡ä¸­ï¼Œç­‰å¾…AIå›å¤åå†æ›´æ–°æ¶ˆæ¯

            this.lastUserInput = combinedContent;



            // 4. ç”¨æˆ·è¾“å…¥åï¼Œç­‰å¾…AIå›å¤



            // 5. ç”ŸæˆAIå›å¤

            if ('undefined' != typeof TavernHelper && TavernHelper.generate) {

              const generateConfig = {

                injects: [

                  {

                    role: 'user',

                    content: combinedContent,

                    position: 'in_chat',

                    depth: 0,

                    should_scan: true,

                  },

                ],

                should_stream: true,

              };



              try {

                console.log('ğŸš€ å¼€å§‹æµå¼ç”Ÿæˆ...');

                const aiResponse = await TavernHelper.generate(generateConfig);

                console.log('âœ… AIç”Ÿæˆå®Œæˆ:', aiResponse);



                // 6. æ›´æ–°AIå›å¤ï¼ˆå‚è€ƒé¡¹ç›®æ¨¡å¼ï¼‰

                if ('function' == typeof getChatMessages) {

                  const chatMessages = await getChatMessages(0);

                  if (chatMessages && chatMessages.length > 0) {

                    const firstMessage = chatMessages[0];



                    // ä¿å­˜å½“å‰çš„å˜é‡çŠ¶æ€åˆ°æ¶ˆæ¯çš„dataå­—æ®µ

                    const currentVariables = this.getAllVariables();

                    firstMessage.data = currentVariables;



                    // ç›´æ¥æ›¿æ¢æ¶ˆæ¯å†…å®¹ï¼Œåªæ˜¾ç¤ºAIå›å¤ï¼Œä¸åŒ…å«ç”¨æˆ·è¾“å…¥

                    firstMessage.message = aiResponse;



                    if ('undefined' != typeof TavernHelper && TavernHelper.setChatMessages) {

                      await TavernHelper.setChatMessages([firstMessage], { refresh: 'none' });

                      console.log('âœ… 0å±‚æ¶ˆæ¯å·²æ›´æ–°ä¸ºAIå›å¤ï¼ˆå‚è€ƒé¡¹ç›®æ¨¡å¼ï¼Œä¸åˆ·æ–°é¡µé¢ï¼‰');

                    }

                  }

                }



                // 7. æ›´æ–°å˜é‡çŠ¶æ€å’Œç•Œé¢
                let mvuSucceeded = false; // ç§»åˆ°å¤–éƒ¨ï¼Œç¡®ä¿ä½œç”¨åŸŸæ­£ç¡®

                // è¯Šæ–­MVUç¯å¢ƒ
                this.debugMVUEnvironment();

                if ('function' == typeof window.eventEmit) {

                  const currentVariables = this.getAllVariables();

                  console.log('ğŸ”„ å‡†å¤‡è§¦å‘MVUæ›´æ–°äº‹ä»¶...');

                  console.log('ğŸ“Š å½“å‰å˜é‡æ•°æ®:', currentVariables);

                  const updateScript = aiResponse;
                  const inputData = { 
                      old_variables: this.currentMvuState || currentVariables 
                  };
                  
                  try {
                      // å¢åŠ è¶…æ—¶æœºåˆ¶ï¼Œé˜²æ­¢ eventEmit å¡æ­»
                      const mvuPromise = window.eventEmit('mag_invoke_mvu', updateScript, inputData);
                      const timeoutPromise = new Promise((_, reject) => 
                          setTimeout(() => reject(new Error('MVU event timeout')), 3000)
                      );
                      
                      await Promise.race([mvuPromise, timeoutPromise]);
                      console.log('âœ… MVUè°ƒç”¨æˆåŠŸï¼Œç­‰å¾…ç»“æœ...');
                      
                      // æ£€æŸ¥MVUæ˜¯å¦è¿”å›æ–°çŠ¶æ€
                      if (inputData.new_variables) {
                          console.log('âœ… MVUè¿”å›æ–°çŠ¶æ€:', inputData.new_variables);
                          this.currentMvuState = inputData.new_variables;
                          // é‡æ–°æ¸²æŸ“UI
                          this.renderUI(this.currentMvuState.stat_data);
                          mvuSucceeded = true;
                      } else {
                          console.log('âš ï¸ MVUæ²¡æœ‰è¿”å›æ–°çŠ¶æ€');
                      }
                  } catch (error) {
                      console.error('âŒ MVUè°ƒç”¨å¤±è´¥:', error);
                  }

                  if (mvuSucceeded) {
                      console.log('âœ… MVUæ›´æ–°æˆåŠŸï¼Œå˜é‡çŠ¶æ€å·²æ›´æ–°');
                  } else {
                      console.log('âš ï¸ MVUæ›´æ–°å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘');
                  }

                } else {

                  console.warn('âš ï¸ eventEmitå‡½æ•°ä¸å¯ç”¨ï¼Œæ— æ³•è§¦å‘MVUæ›´æ–°');

                  // å¼ºåˆ¶æ›´æ–°MVUæ•°æ®

                  console.log('ğŸ”„ å°è¯•å¼ºåˆ¶æ›´æ–°MVUæ•°æ®...');

                  try {

                    if (typeof window.mag_invoke_mvu === 'function') {

                      const currentVariables = this.getAllVariables();

                      window.mag_invoke_mvu(JSON.stringify(currentVariables));

                      console.log('âœ… é€šè¿‡window.mag_invoke_mvuå¼ºåˆ¶æ›´æ–°æˆåŠŸ');

                    } else {

                      console.warn('âš ï¸ window.mag_invoke_mvuå‡½æ•°ä¹Ÿä¸å¯ç”¨');

                    }

                  } catch (error) {

                    console.error('âŒ å¼ºåˆ¶æ›´æ–°MVUå¤±è´¥:', error);

                  }

                }



                // 8. é™é»˜ä¿å­˜åˆ°ç¬¬0å±‚ï¼Œå®ç°åŒå±‚æ¸¸ç©
                if (mvuSucceeded && this.currentMvuState) {
                    try {
                        let messages = await getChatMessages('0');
                        if (messages && messages.length > 0) {
                            const messageZero = messages[0];
                            
                            // æ›´æ–°ç¬¬0å±‚æ¶ˆæ¯ï¼Œæ”¯æŒåŒå±‚æ¸¸ç©
                            messageZero.message = aiResponse;
                            messageZero.data = this.currentMvuState;
                            
                            if ('undefined' != typeof TavernHelper && TavernHelper.setChatMessages) {
                                await TavernHelper.setChatMessages([messageZero], { refresh: 'none' });
                                console.log('âœ… å·²é™é»˜æ›´æ–°ç¬¬0å±‚æ¶ˆæ¯ï¼Œæ”¯æŒåŒå±‚æ¸¸ç©');
                            }
                        } else {
                            console.warn('âš ï¸ æœªæ‰¾åˆ°ç¬¬0å±‚æ¶ˆæ¯ï¼Œæ— æ³•æ›´æ–°');
                        }
                    } catch (e) {
                        console.warn('âš ï¸ æ›´æ–°ç¬¬0å±‚æ¶ˆæ¯å¤±è´¥:', e);
                    }
                }

                // 9. æ¸…ç©ºæŒ‡ä»¤é˜Ÿåˆ—

                if (window.pendingActions) {

                  window.pendingActions = [];

                  window.savePendingActions && window.savePendingActions();

                  window.updateActionIcons && window.updateActionIcons();

                }



                // 10. è‡ªåŠ¨å­˜æ¡£AIå›å¤

                try {

                  await this.autoSaveAfterAIResponse(aiResponse, combinedContent);

                } catch (saveError) {

                  console.warn('è‡ªåŠ¨å­˜æ¡£å¤±è´¥:', saveError);

                }



                // 11. ç«‹å³ç»“æŸè®¡æ—¶å™¨

                this.endReplyTimer();

              } catch (error) {

                console.error('âŒ AIç”Ÿæˆå¤±è´¥:', error);

                this.endReplyTimer();

              } finally {
                // æœ€ç»ˆä¿®å¤ï¼šåœ¨æ‰€æœ‰æ“ä½œå®Œæˆåï¼Œä¸»åŠ¨ã€å¯é åœ°åˆ·æ–°UIï¼Œé¿å…ä»»ä½•äº‹ä»¶å†²çª
                try {
                    await this.updateDynamicData();
                    console.log('âœ… æœ€ç»ˆUIåˆ·æ–°å®Œæˆ');
                } catch (finalError) {
                    console.warn('âš ï¸ æœ€ç»ˆUIåˆ·æ–°å¤±è´¥:', finalError);
                }
              }

            }



            // ç•Œé¢å·²åœ¨AIå›å¤åæ›´æ–°ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤è°ƒç”¨

          } catch (error) {

            console.error('âŒ äº¤äº’å¤±è´¥:', error);

          } finally {

            // å‚è€ƒé¡¹ç›®æ¨¡å¼ï¼šåœ¨æ‰€æœ‰æ“ä½œå®Œæˆåï¼Œä¸»åŠ¨ã€å¯é åœ°åˆ·æ–°UI

            await this.updateDynamicData();

            console.log('âœ… æœ€ç»ˆç•Œé¢æ›´æ–°å®Œæˆï¼ˆå‚è€ƒé¡¹ç›®æ¨¡å¼ï¼‰');

          }



          e.value = '';

        }

        setupRulesModal() {

          ($('#view-rules-btn').on('click', () => {

            console.log('ğŸ¯ æŸ¥çœ‹è§„åˆ™æŒ‰é’®è¢«ç‚¹å‡»ï¼');

            const e = document.getElementById('rules-modal'),

              t = document.getElementById('danger-rules-sound');
            e && t

              ? (console.log('âœ… æ˜¾ç¤ºè§„åˆ™æ¨¡æ€æ¡†'),

                t.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e)),

                (e.style.display = 'flex'),

                this.updateRulesModal())

              : console.error('âŒ æ¨¡æ€æ¡†æˆ–éŸ³æ•ˆå…ƒç´ æœªæ‰¾åˆ°');

          }),

            $('#close-rules-btn').on('click', () => {

              $('#rules-modal').hide();

            }),

            $('#rules-modal').on('click', e => {

              e.target === e.currentTarget && $('#rules-modal').hide();

            }),

            // éŸ³ä¹æ§åˆ¶åŠŸèƒ½
            this.setupMusicControls(),
            
            // è§„åˆ™è®°å½•åŠŸèƒ½äº‹ä»¶ç»‘å®š
            $('#add-rule-btn').on('click', () => {
              this.addRule();
            }),
            $('#clear-rules-btn').on('click', () => {
              this.clearAllRules();
            }));

        }















        setupConsoleCommands() {

          try {

            ((window.teresenDebug = {

              showAllVariables: () => this.showAllVariables(),

              showTrainerStatus: () => this.showTrainerStatus(),

              showUmaStatus: () => this.showUmaStatus(),

              showWorldInfo: () => this.showWorldInfo(),

              showRules: () => this.showRules(),

              help: () => this.showConsoleHelp(),

              toggleItemDetails: e => this.toggleItemDetails(e),

              toggleRules: e => this.toggleRules(e),

              toggleUmaSection: () => this.toggleUmaSection(),

              checkCrystals: () => this.checkCrystals(),

              // æ–°å¤©èµ‹ç³»ç»Ÿ

              showTalentsModal: () => this.showTalentsModal(),

              switchTalentPage: page => this.switchTalentPage(page),

              prevTalentPage: () => this.prevTalentPage(),

              nextTalentPage: () => this.nextTalentPage(),

              selectTalentOption: (level, optionIndex) => this.selectTalentOption(level, optionIndex),

              testMvuInjection: () => this.testMvuInjection(),

              checkMvuStatus: () => this.checkMvuStatus(),

              showItemPopup: (e, t) => this.showItemPopup(e, t),

              loadLocalSave: () => this.loadLocalSave(),

              loadWorldbookSave: e => this.loadWorldbookSave(e),

              loadAutoSave: e => this.loadAutoSave(e),

              triggerQTE: e => this.triggerQTE(e),

              updateQTESection: () => this.updateQTESection(),

              manualCheckQTE: () => this.manualCheckQTE(),

              startReplyTiming: () => this.startReplyTiming(),

              endReplyTimer: () => this.endReplyTimer(),

              debugSaves: () => this.debugSaves(),

              debugCommands: () => this.debugCommands(),

              debugAutoSaves: () => this.debugAutoSaves(),

              // è§„åˆ™è®°å½•åŠŸèƒ½
              addRule: (index) => this.addRule(),
              editRule: (index) => this.editRule(index),
              deleteRule: (index) => this.deleteRule(index),
              clearAllRules: () => this.clearAllRules(),
              getUserRules: () => this.getUserRules(),
              
              // é©¬å¨˜è®°åå†ŒåŠŸèƒ½
              openUmaRoster: () => this.openUmaRoster(),
              addUmaToRoster: (umaName) => this.addUmaToRoster(umaName),
              getUmaRoster: () => this.getUmaRoster(),
              
              // çŠ¶æ€åˆ¤å®šåŠ¨ç”»ç³»ç»Ÿ
              checkStatusTriggers: () => this.checkStatusTriggers(),
              triggerStatusAnimation: (stamina, sanity) => this.triggerStatusAnimation(stamina, sanity),
              
              // å¡”ç½—å åœç³»ç»Ÿé€šè¿‡TarotDivinationSystemç±»è‡ªåŠ¨ç»‘å®šï¼Œæ— éœ€é¢å¤–æ¥å£
              
              // æµ‹è¯•åŠŸèƒ½
              testTarotDivination: () => this.testTarotDivination(),
            }),

              console.log('ğŸ® ç‰¹é›·æ£®å­¦é™¢æ€ªè°ˆè°ƒè¯•å‘½ä»¤å·²åŠ è½½ï¼'),

              console.log('ğŸ’¡ è¾“å…¥ teresenDebug.help() æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤'),

              console.log('ğŸ” è°ƒè¯•å¯¹è±¡:', window.teresenDebug));

          } catch (e) {

            console.error('âŒ è®¾ç½®æ§åˆ¶å°å‘½ä»¤æ—¶å‡ºé”™:', e);

          }

        }



        showAllVariables() {

          const e = this.getAllVariables();

          (console.group('ğŸ“Š æ‰€æœ‰å˜é‡ä¿¡æ¯'),

            console.log('å®Œæ•´å˜é‡å¯¹è±¡:', e),

            e.stat_data

              ? (console.group('ğŸƒ è®­ç»ƒå‘˜ä¿¡æ¯'),

                console.table(e.stat_data.è®­ç»ƒå‘˜),

                console.groupEnd(),

                console.group('ğŸŒ ä¸–ç•Œä¿¡æ¯'),

                console.table(e.stat_data.ä¸–ç•Œ),

                console.groupEnd(),

                console.group('ğŸ èµ›é©¬å¨˜ä¿¡æ¯'),

                console.table(e.stat_data.é©¬å¨˜),

                console.groupEnd(),

                e.stat_data.è§„åˆ™ && (console.group('ğŸ“œ è§„åˆ™ä¿¡æ¯'), console.table(e.stat_data.è§„åˆ™), console.groupEnd()),

                e.stat_data.å¤–ç¥ && (console.group('ğŸ‘¹ å¤–ç¥ä¿¡æ¯'), console.table(e.stat_data.å¤–ç¥), console.groupEnd()))

              : console.warn('âš ï¸ æœªæ‰¾åˆ°stat_dataç»“æ„'),

            console.groupEnd());

        }

        showTrainerStatus() {

          var e;

          const t = this.getAllVariables();

          (console.group('ğŸƒ è®­ç»ƒå‘˜çŠ¶æ€è¯¦æƒ…'),

            (null == (e = t.stat_data) ? void 0 : e.è®­ç»ƒå‘˜)

              ? (t.stat_data.è®­ç»ƒå‘˜,

                console.log('ä½“åŠ›:', this.getVariable(t, 'stat_data.è®­ç»ƒå‘˜.ä½“åŠ›[0]', 'N/A')),

                console.log('ç†æ™º:', this.getVariable(t, 'stat_data.è®­ç»ƒå‘˜.ç†æ™º[0]', 'N/A')),

                console.log('è¿æ°”:', this.getVariable(t, 'stat_data.è®­ç»ƒå‘˜.è¿æ°”[0]', 'N/A')),

                console.log('ä½ç½®:', this.getVariable(t, 'stat_data.è®­ç»ƒå‘˜.ä½ç½®[0]', 'N/A')),

                console.log('åœ¨æ ¡å¤©æ•°:', this.getVariable(t, 'stat_data.è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°[0]', 'N/A')),

                console.log('ç‰©å“æ :', this.getVariable(t, 'stat_data.è®­ç»ƒå‘˜.ç‰©å“æ [0]', 'N/A')))

              : console.warn('âš ï¸ æœªæ‰¾åˆ°è®­ç»ƒå‘˜æ•°æ®'),

            console.groupEnd());

        }

        showUmaStatus() {

          const e = this.getAllVariables();

          console.group('ğŸ èµ›é©¬å¨˜çŠ¶æ€è¯¦æƒ…');

          (['ä¸œæµ·å¸ç‹', 'çˆ±å¦‚å¾€æ˜”', 'ç‰¹åˆ«å‘¨', 'æ— å£°é“ƒé¹¿', 'ç¦æ¥', 'çˆ±ä¸½é€Ÿå­'].forEach(t => {

            console.group(`${t} çŠ¶æ€`);

            const n = this.getVariable(e, `stat_data.é©¬å¨˜.${t}.å¥½æ„Ÿåº¦[0]`, 'N/A'),

              s = this.getVariable(e, `stat_data.é©¬å¨˜.${t}.çŠ¶æ€[0]`, 'N/A');

            (console.log('å¥½æ„Ÿåº¦:', n),

              console.log('çŠ¶æ€:', s),

              console.log('æè¿°:', this.getUmaDescription(t, Number(n) || 0, s)),

              console.groupEnd());

          }),

            console.groupEnd());

        }

        showWorldInfo() {

          var e;

          const t = this.getAllVariables();

          (console.group('ğŸŒ ä¸–ç•Œä¿¡æ¯è¯¦æƒ…'),

            (null == (e = t.stat_data) ? void 0 : e.ä¸–ç•Œ)

              ? (console.log('å½“å‰æ—¶é—´:', this.getVariable(t, 'stat_data.ä¸–ç•Œ.å½“å‰æ—¶é—´[0]', 'N/A')),

                console.log('å½“å‰æ—¥æœŸ:', this.getVariable(t, 'stat_data.ä¸–ç•Œ.å½“å‰æ—¥æœŸ[0]', 'N/A')),

                console.log('å½“å‰æ­£æ–‡:', this.getVariable(t, 'stat_data.ä¸–ç•Œ.å½“å‰æ­£æ–‡[0]', 'N/A')),

                console.log('ç¦å¿Œè§„åˆ™:', this.getVariable(t, 'stat_data.ä¸–ç•Œ.ç¦å¿Œè§„åˆ™[0]', 'N/A')))

              : console.warn('âš ï¸ æœªæ‰¾åˆ°ä¸–ç•Œæ•°æ®'),

            console.groupEnd());

        }

        // é©¬å¨˜è®°åå†ŒåŠŸèƒ½å®ç°
        openUmaRoster() {
          if (window.umaRosterSystem) {
            window.umaRosterSystem.openUmaRoster();
          } else {
            console.error('é©¬å¨˜è®°åå†Œç³»ç»Ÿæœªåˆå§‹åŒ–');
          }
        }

        addUmaToRoster(umaName, details = {}) {
          if (window.umaRosterSystem) {
            return window.umaRosterSystem.addUmaToRoster(umaName, details);
          } else {
            console.error('é©¬å¨˜è®°åå†Œç³»ç»Ÿæœªåˆå§‹åŒ–');
            return false;
          }
        }

        getUmaRoster() {
          if (window.umaRosterSystem) {
            return window.umaRosterSystem.getUmaRoster();
          } else {
            console.error('é©¬å¨˜è®°åå†Œç³»ç»Ÿæœªåˆå§‹åŒ–');
            return {};
          }
        }

        showRules() {

          var e;

          const t = this.getAllVariables();

          if ((console.group('ğŸ“œ è§„åˆ™ä¿¡æ¯è¯¦æƒ…'), null == (e = t.stat_data) ? void 0 : e.è§„åˆ™)) {

            console.group('å›ºå®šè§„åˆ™');

            const e = this.getVariable(t, 'stat_data.è§„åˆ™.å›ºå®šè§„åˆ™[0]', []);

            (Array.isArray(e) &&

              e.forEach((e, t) => {

                console.log(`${t + 1}. ${e}`);

              }),

              console.groupEnd(),

              console.group('éšæœºè§„åˆ™'));

            const n = this.getVariable(t, 'stat_data.è§„åˆ™.éšæœºè§„åˆ™[0]', []);

            (Array.isArray(n) &&

              n.forEach((e, t) => {

                console.log(`${t + 1}. ${e}`);

              }),

              console.groupEnd(),

              console.log('è¿åæ¬¡æ•°:', this.getVariable(t, 'stat_data.è§„åˆ™.è¿åæ¬¡æ•°[0]', 'N/A')));

          } else console.warn('âš ï¸ æœªæ‰¾åˆ°è§„åˆ™æ•°æ®');

          console.groupEnd();

        }

        updateLocation() {}

        updateGachaCoin() {

          const e = this.getAllVariables(),

            t = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.æ‰­è›‹å¸[0]', 0),

            n = document.getElementById('gacha-coin-text');

          n && (n.textContent = `æ‰­è›‹å¸: ${t}`);

        }




        updateJourneyModal() {

          const e = this.getAllVariables(),

            t = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.å†ç¨‹', []),

            n = document.getElementById('journey-list-modal');

          if (n)

            if (Array.isArray(t) && t.length > 0) {

              let e = '';

              (t.forEach((t, n) => {

                e += `\n            <div class="journey-entry">\n              <div class="journey-header">\n                <span class="journey-day">ç¬¬${t.å¤©æ•° || n + 1}å¤©</span>\n                <span class="journey-status ${t.çŠ¶æ€ || 'normal'}">${t.çŠ¶æ€ || 'æ­£å¸¸'}</span>\n              </div>\n              <div class="journey-event">${t.äº‹ä»¶ || 'æœªçŸ¥äº‹ä»¶'}</div>\n              <div class="journey-desc">${t.æè¿° || 'æš‚æ— æè¿°'}</div>\n            </div>\n          `;

              }),

                (n.innerHTML = e));

            } else n.innerHTML = '<div class="empty-inventory">æš‚æ— å†ç¨‹è®°å½•</div>';

        }

        setupLoadModal() {

          ($('#close-load-btn').on('click', () => {

            $('#load-modal').hide();

          }),

            $('#load-modal').on('click', e => {

              e.target === e.currentTarget && $('#load-modal').hide();

            }));

        }

        setupHistoryModal() {

          ($('#close-history-btn').on('click', () => {

            $('#history-modal').hide();

          }),

            $('#history-modal').on('click', e => {

              e.target === e.currentTarget && $('#history-modal').hide();

            }));

        }

        async updateLoadModal() {

          try {

            console.log('ğŸ’¾ æ›´æ–°å­˜æ¡£ç•Œé¢...');



            const localSavesList = document.getElementById('local-saves-list');

            const worldbookSavesList = document.getElementById('worldbook-saves-list');



            // 1. æ›´æ–°æœ¬åœ°å­˜æ¡£åˆ—è¡¨

            if (localSavesList) {

              let localSaveHtml = '';



              // æ˜¾ç¤ºæ‰‹åŠ¨æœ¬åœ°å­˜æ¡£

              const localSave = localStorage.getItem('teresen-save');

              if (localSave) {

                try {

                  const saveData = JSON.parse(localSave);

                  localSaveHtml += `

                    <div class="save-item manual-save-item" onclick="window.teresenDebug.loadLocalSave()">

                      <div class="save-name">${saveData.saveName || 'æœ¬åœ°å­˜æ¡£'}</div>

                      <div class="save-time">${new Date(saveData.timestamp).toLocaleString('zh-CN')}</div>

                      <div class="save-type">æ‰‹åŠ¨å­˜æ¡£</div>

                    </div>

                  `;

                } catch (error) {

                  console.warn('è§£ææœ¬åœ°å­˜æ¡£å¤±è´¥:', error);

                }

              }



              // æ˜¾ç¤ºè‡ªåŠ¨å­˜æ¡£

              const autoSaves = this.getAutoSaves();

              console.log('æ‰¾åˆ°è‡ªåŠ¨å­˜æ¡£:', autoSaves.length, 'ä¸ª');

              if (autoSaves.length > 0) {

                autoSaves.forEach(save => {

                  // æå–<content></content>æ ‡ç­¾å†…çš„å†…å®¹ä½œä¸ºæ˜¾ç¤ºæ–‡æœ¬

                  let displayContent = 'è‡ªåŠ¨å­˜æ¡£';

                  if (save.data.message_content) {

                    const contentMatch = save.data.message_content.match(/<content>(.*?)<\/content>/s);

                    if (contentMatch) {

                      displayContent =

                        contentMatch[1].trim().substring(0, 50) + (contentMatch[1].length > 50 ? '...' : '');

                    } else {

                      displayContent =

                        save.data.message_content.substring(0, 50) +

                        (save.data.message_content.length > 50 ? '...' : '');

                    }

                  }



                  localSaveHtml += `

                    <div class="save-item auto-save-item" onclick="window.teresenDebug.loadAutoSave('${save.key}')">

                      <div class="save-name">${save.data.save_name || 'è‡ªåŠ¨å­˜æ¡£'}</div>

                      <div class="save-content">${displayContent}</div>

                      <div class="save-time">${new Date(save.data.timestamp).toLocaleString('zh-CN')}</div>

                      <div class="save-type">è‡ªåŠ¨å­˜æ¡£</div>

                    </div>

                  `;

                });

              }



              localSavesList.innerHTML = localSaveHtml || '<div class="empty-save">æš‚æ— æœ¬åœ°å­˜æ¡£</div>';

              console.log('æœ¬åœ°å­˜æ¡£åˆ—è¡¨å·²æ›´æ–°');

            }



            // 2. æ›´æ–°ä¸–ç•Œä¹¦å­˜æ¡£åˆ—è¡¨

            if (worldbookSavesList) {

              const worldbookEntries = await this.getWorldbookEntries();

              let worldbookHtml = '';



              if (worldbookEntries && worldbookEntries.length > 0) {

                worldbookEntries.forEach(entry => {

                  if (entry.title && entry.title.includes('å­˜æ¡£')) {

                    worldbookHtml += `

                      <div class="save-item worldbook-save-item" onclick="window.teresenDebug.loadWorldbookSave('${entry.title}')">

                        <div class="save-name">${entry.title}</div>

                        <div class="save-time">${entry.content ? new Date(entry.content).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´'}</div>

                        <div class="save-type">ä¸–ç•Œä¹¦å­˜æ¡£</div>

                      </div>

                    `;

                  }

                });

              }



              worldbookSavesList.innerHTML = worldbookHtml || '<div class="empty-save">æš‚æ— ä¸–ç•Œä¹¦å­˜æ¡£</div>';

              console.log('ä¸–ç•Œä¹¦å­˜æ¡£åˆ—è¡¨å·²æ›´æ–°');

            }



            // 3. è®¾ç½®å­˜æ¡£æŒ‰é’®ï¼ˆåªè®¾ç½®ä¸€æ¬¡ï¼‰

            this.setupSaveButtons();

          } catch (error) {

            console.error('âŒ æ›´æ–°å­˜æ¡£ç•Œé¢å¤±è´¥:', error);

          }

        }



        // è®¾ç½®å­˜æ¡£æŒ‰é’®ï¼ˆé¿å…é‡å¤åˆ›å»ºï¼‰

        setupSaveButtons() {

          try {

            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨æŒ‰é’®

            const existingButtons = document.querySelectorAll('.save-button');

            if (existingButtons.length > 0) {

              console.log('å­˜æ¡£æŒ‰é’®å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º');

              return;

            }



            const loadSection = document.querySelector('.load-section');

            if (!loadSection) {

              console.warn('æœªæ‰¾åˆ°å­˜æ¡£åŒºåŸŸ');

              return;

            }



            // åˆ›å»ºæœ¬åœ°å­˜æ¡£æŒ‰é’®

            const localSaveBtn = document.createElement('button');

            localSaveBtn.className = 'save-button subtle-hover';

            localSaveBtn.innerHTML = `

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h-1v5.586l-2.293-2.293z" />

              </svg>

              <span>ä¿å­˜åˆ°æœ¬åœ°</span>

            `;

            localSaveBtn.onclick = () => this.handleSave('local');



            // åˆ›å»ºä¸–ç•Œä¹¦å­˜æ¡£æŒ‰é’®

            const worldbookSaveBtn = document.createElement('button');

            worldbookSaveBtn.className = 'save-button subtle-hover';

            worldbookSaveBtn.innerHTML = `

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h-1v5.586l-2.293-2.293z" />

              </svg>

              <span>ä¿å­˜åˆ°ä¸–ç•Œä¹¦</span>

            `;

            worldbookSaveBtn.onclick = () => this.handleSave('worldbook');



            // åˆ›å»ºæŒ‰é’®å®¹å™¨

            const buttonContainer = document.createElement('div');

            buttonContainer.style.cssText = 'margin-top: 1rem; display: flex; gap: 0.5rem;';

            buttonContainer.appendChild(localSaveBtn);

            buttonContainer.appendChild(worldbookSaveBtn);



            loadSection.appendChild(buttonContainer);

            console.log('å­˜æ¡£æŒ‰é’®å·²åˆ›å»º');

          } catch (error) {

            console.error('è®¾ç½®å­˜æ¡£æŒ‰é’®å¤±è´¥:', error);

          }

        }

        async updateHistoryModal() {

          try {

            const e = document.getElementById('current-journey-list');

            if (e) {

              const t = await this.getWorldbookEntries();

              let n = '';

              (t &&

                t.length > 0 &&

                t.forEach(e => {

                  if (e.title && e.title.includes('ä¸ªäººå†ç¨‹'))

                    try {

                      const t = JSON.parse(e.content || '[]');

                      Array.isArray(t) &&

                        t.forEach((e, t) => {

                          n += `\n                      <div class="journey-entry">\n                        <div class="journey-header">\n                          <span class="journey-day">ç¬¬${e.å¤©æ•° || t + 1}å¤©</span>\n                          <span class="journey-status ${e.çŠ¶æ€ || 'normal'}">${e.çŠ¶æ€ || 'æ­£å¸¸'}</span>\n                        </div>\n                        <div class="journey-event">${e.äº‹ä»¶ || 'æœªçŸ¥äº‹ä»¶'}</div>\n                        <div class="journey-desc">${e.æè¿° || 'æš‚æ— æè¿°'}</div>\n                      </div>\n                    `;

                        });

                    } catch (t) {

                      console.warn('è§£æä¸ªäººå†ç¨‹æ•°æ®å¤±è´¥:', t);

                    }

                }),

                (e.innerHTML = n || '<div class="empty-journey">æš‚æ— äººç‰©å†ç¨‹</div>'));

            }

          } catch (e) {

            console.error('âŒ æ›´æ–°å†å²è®°å½•ç•Œé¢å¤±è´¥:', e);

          }

        }

        async saveToWorldbook(e) {

          try {

            if ('undefined' != typeof TavernHelper && TavernHelper.createLorebookEntries) {

              const t = {

                title: e.saveName,

                content: e.timestamp,

                category: 'å­˜æ¡£',

                keywords: ['å­˜æ¡£', 'ç‰¹é›·æ£®', 'è®­ç»ƒå‘˜'],

                force_activation: !1,

                selective: !1,

                display_index: 0,

                probability: 100,

                exclude_recursion: !1,

                use_extra: !1,

                extra: JSON.stringify(e),

              };

              (await TavernHelper.createLorebookEntries([t]), console.log('âœ… å­˜æ¡£å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦'));

            }

          } catch (t) {

            console.error('âŒ ä¿å­˜åˆ°ä¸–ç•Œä¹¦å¤±è´¥:', t);

          }

        }

        async saveJourneyToWorldbook() {

          try {

            const e = this.getAllVariables(),

              t = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.å†ç¨‹', []);

            if (

              Array.isArray(t) &&

              t.length > 0 &&

              'undefined' != typeof TavernHelper &&

              TavernHelper.createLorebookEntries

            ) {

              const e = {

                title: 'ä¸ªäººå†ç¨‹',

                content: JSON.stringify(t),

                category: 'å†ç¨‹',

                keywords: ['å†ç¨‹', 'ç‰¹é›·æ£®', 'è®­ç»ƒå‘˜', 'ä¸ªäººå†ç¨‹'],

                force_activation: !1,

                selective: !1,

                display_index: 0,

                probability: 100,

                exclude_recursion: !1,

                use_extra: !1,

                extra: '',

              };

              (await TavernHelper.createLorebookEntries([e]), console.log('âœ… æœ¬ä¸–å†ç¨‹å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦'));

            }

          } catch (e) {

            console.error('âŒ ä¿å­˜æœ¬ä¸–å†ç¨‹åˆ°ä¸–ç•Œä¹¦å¤±è´¥:', e);

          }

        }

        async getWorldbookEntries() {

          try {

            return 'undefined' != typeof TavernHelper && TavernHelper.getLorebookEntries

              ? await TavernHelper.getLorebookEntries()

              : [];

          } catch (e) {

            return (console.error('âŒ è·å–ä¸–ç•Œä¹¦æ¡ç›®å¤±è´¥:', e), []);

          }

        }

        async loadLocalSave() {

          try {

            console.log('ğŸ“‚ åŠ è½½æœ¬åœ°å­˜æ¡£...');

            const saveData = localStorage.getItem('teresen-save');

            if (!saveData) {

              throw new Error('æœ¬åœ°å­˜æ¡£ä¸å­˜åœ¨');

            }



            const save = JSON.parse(saveData);

            console.log('æœ¬åœ°å­˜æ¡£æ•°æ®:', save);



            // æ¢å¤æ¸¸æˆçŠ¶æ€

            if (save.data && save.data.variables && 'function' == typeof eventEmit) {

              // ç›´æ¥è®¾ç½®å˜é‡ï¼Œä¸è°ƒç”¨MVU
              this.currentMvuState = save.data.variables;
              this.renderUI(this.currentMvuState.stat_data);

              console.log('âœ… æ¸¸æˆçŠ¶æ€å·²æ¢å¤');

            }



            // æ¢å¤èŠå¤©å†å²

            if (

              save.data &&

              save.data.message &&

              'function' == typeof getChatMessages &&

              'undefined' != typeof TavernHelper &&

              TavernHelper.setChatMessages

            ) {

              const chatMessages = await getChatMessages(0);

              if (chatMessages && chatMessages.length > 0) {

                chatMessages[0].message = save.data.message;

                await TavernHelper.setChatMessages([chatMessages[0]], { refresh: 'none' });

                console.log('âœ… èŠå¤©å†å²å·²æ¢å¤');

              }

            }



            await this.updateInterface();

            $('#load-modal').hide();

            console.log('âœ… æœ¬åœ°å­˜æ¡£åŠ è½½æˆåŠŸ');

            alert('æœ¬åœ°å­˜æ¡£åŠ è½½æˆåŠŸï¼');

          } catch (error) {

            console.error('âŒ è¯»å–æœ¬åœ°å­˜æ¡£å¤±è´¥:', error);

            alert('è¯»å–å­˜æ¡£å¤±è´¥ï¼');

          }

        }

        async loadWorldbookSave(e) {

          try {

            const t = (await this.getWorldbookEntries()).find(t => t.title === e);

            if (t && t.extra) {

              const e = JSON.parse(t.extra);

              (await this.loadSaveData(e), $('#load-modal').hide());

            }

          } catch (t) {

            (console.error('âŒ è¯»å–ä¸–ç•Œä¹¦å­˜æ¡£å¤±è´¥:', t), alert('è¯»å–å­˜æ¡£å¤±è´¥ï¼'));

          }

        }

        async loadSaveData(e) {

          try {

            if (

              (e.variables &&

                'function' == typeof eventEmit &&

                (eventEmit('mag_invoke_mvu'), console.log('âœ… MVUå˜é‡å·²æ›´æ–°')),

              e.message && 'function' == typeof getChatMessages)

            ) {

              const t = await getChatMessages(0);

              t &&

                t.length > 0 &&

                ((t[0].message = e.message),

                'undefined' != typeof TavernHelper &&

                  TavernHelper.setChatMessages &&

                  (await TavernHelper.setChatMessages([t[0]], { refresh: 'none' }), console.log('âœ… 0å±‚æ¶ˆæ¯å·²æ›´æ–°')));

            }

            (await this.updateInterface(), console.log('âœ… å­˜æ¡£åŠ è½½æˆåŠŸ'), alert('å­˜æ¡£åŠ è½½æˆåŠŸï¼'));

          } catch (t) {

            (console.error('âŒ åŠ è½½å­˜æ¡£æ•°æ®å¤±è´¥:', t), alert('åŠ è½½å­˜æ¡£å¤±è´¥ï¼'));

          }

        }



        // æ–°å¢ï¼šAIå›å¤åè‡ªåŠ¨å­˜æ¡£

        async autoSaveAfterAIResponse(aiResponse, userInput) {

          try {

            console.log('ğŸ’¾ å¼€å§‹è‡ªåŠ¨å­˜æ¡£AIå›å¤...');



            const currentVariables = this.getAllVariables();

            const chatMessages = await getChatMessages(0);

            const currentMessage = chatMessages && chatMessages.length > 0 ? chatMessages[0].message : '';



            const timestamp = Date.now();

            const saveData = {

              timestamp: timestamp,

              save_name: `è‡ªåŠ¨å­˜æ¡£_${new Date().toLocaleString('zh-CN')}`,

              mvu_data: currentVariables,

              message_content: currentMessage,

              type: 'auto',

            };



            // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºkeyï¼Œä¿å­˜å¤šä¸ªè‡ªåŠ¨å­˜æ¡£

            const saveKey = `teresen-auto-save-${timestamp}`;

            localStorage.setItem(saveKey, JSON.stringify(saveData));



            // åŒæ—¶ä¿å­˜æœ€æ–°çš„è‡ªåŠ¨å­˜æ¡£å¼•ç”¨

            localStorage.setItem('teresen_auto_save', JSON.stringify(saveData));

            console.log('âœ… è‡ªåŠ¨å­˜æ¡£æˆåŠŸ');



            // æ˜¾ç¤ºè‡ªåŠ¨å­˜æ¡£é€šçŸ¥

            this.showAutoSaveNotification();



            // æ¸…ç†æ—§çš„è‡ªåŠ¨å­˜æ¡£ï¼ˆä¿ç•™æœ€æ–°çš„10ä¸ªï¼‰

            this.cleanupOldAutoSaves();



            // ä¿å­˜æœ€åå‘é€çš„æŒ‡ä»¤ï¼Œç”¨äºé‡æ–°ç”Ÿæˆ

            this.lastSentPrompt = userInput;

            // é©¬å¨˜AIæ£€æµ‹åŠŸèƒ½å·²ç§»é™¤

          } catch (error) {

            console.error('âŒ è‡ªåŠ¨å­˜æ¡£å¤±è´¥:', error);

            throw error;

          }

        }



        // æ¸…ç†æ—§çš„è‡ªåŠ¨å­˜æ¡£

        cleanupOldAutoSaves() {

          try {

            console.log('ğŸ§¹ å¼€å§‹æ¸…ç†æ—§è‡ªåŠ¨å­˜æ¡£...');

            const autoSaveKeys = [];

            for (let i = 0; i < localStorage.length; i++) {

              const key = localStorage.key(i);

              if (key && key.startsWith('teresen-auto-save-')) {

                autoSaveKeys.push(key);

              }

            }



            console.log(`ğŸ“Š æ‰¾åˆ° ${autoSaveKeys.length} ä¸ªè‡ªåŠ¨å­˜æ¡£`);



            // åªæœ‰å½“å­˜æ¡£æ•°é‡è¶…è¿‡15ä¸ªæ—¶æ‰æ¸…ç†

            if (autoSaveKeys.length > 15) {

              // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œä¿ç•™æœ€æ–°çš„10ä¸ª

              autoSaveKeys.sort().reverse();

              const keysToRemove = autoSaveKeys.slice(10);



              console.log(`ğŸ—‘ï¸ éœ€è¦æ¸…ç† ${keysToRemove.length} ä¸ªæ—§å­˜æ¡£`);

              keysToRemove.forEach(key => {

                localStorage.removeItem(key);

                console.log('ğŸ—‘ï¸ æ¸…ç†æ—§è‡ªåŠ¨å­˜æ¡£:', key);

              });

            } else {

              console.log('âœ… è‡ªåŠ¨å­˜æ¡£æ•°é‡æ­£å¸¸ï¼Œæ— éœ€æ¸…ç†');

            }

          } catch (error) {

            console.warn('æ¸…ç†æ—§è‡ªåŠ¨å­˜æ¡£å¤±è´¥:', error);

          }

        }



        // æ˜¾ç¤ºè‡ªåŠ¨å­˜æ¡£é€šçŸ¥

        showAutoSaveNotification() {

          try {

            // åˆ›å»ºé€šçŸ¥å…ƒç´ 

            const notification = document.createElement('div');

            notification.id = 'auto-save-notification';

            notification.innerHTML = 'ğŸ’¾ Eå®å·²ä¸ºæ‚¨è‡ªåŠ¨å­˜æ¡£';

            notification.style.cssText = `

              position: fixed;

              top: 20px;

              right: 20px;

              background: rgba(34, 197, 94, 0.9);

              color: white;

              padding: 8px 16px;

              border-radius: 6px;

              font-size: 12px;

              font-weight: bold;

              z-index: 10000;

              opacity: 0;

              transform: translateX(100%);

              transition: all 0.3s ease;

              pointer-events: none;

            `;



            document.body.appendChild(notification);



            // æ˜¾ç¤ºåŠ¨ç”»

            setTimeout(() => {

              notification.style.opacity = '1';

              notification.style.transform = 'translateX(0)';

            }, 100);



            // 3ç§’åéšè—

            setTimeout(() => {

              notification.style.opacity = '0';

              notification.style.transform = 'translateX(100%)';

              setTimeout(() => {

                if (notification.parentNode) {

                  notification.parentNode.removeChild(notification);

                }

              }, 300);

            }, 3000);

          } catch (error) {

            console.warn('æ˜¾ç¤ºè‡ªåŠ¨å­˜æ¡£é€šçŸ¥å¤±è´¥:', error);

          }

        }



        // æ£€æµ‹AIå›å¤ä¸­çš„é©¬å¨˜åå­—
        detectUmaInAIResponse(aiResponse) {
          try {
            console.log('ğŸ” å¼€å§‹æ£€æµ‹AIå›å¤ä¸­çš„é©¬å¨˜åå­—...');
            
            // é©¬å¨˜åå­—åˆ—è¡¨
            const umaNames = [
              'ä¸œæµ·å¸ç‹', 'çˆ±å¦‚å¾€æ˜”', 'ç‰¹åˆ«å‘¨', 'æ— å£°é“ƒé¹¿', 'ç¦æ¥', 'çˆ±ä¸½é€Ÿå­',
              'ç›®ç™½å…‰æ˜', 'ç›®ç™½éº¦æ˜†', 'ç›®ç™½å–„ä¿¡', 'ç›®ç™½å¤šä¼¯', 'ç›®ç™½èµ–æ©',
              'å°æ —å¸½', 'ç‰è—»åå­—', 'è¶…çº§å°æµ·æ¹¾', 'æ¨±èŠ±è¿›ç‹', 'èƒœåˆ©å¥–åˆ¸',
              'æˆç”°ç™½ä»', 'çµç¶æ™¨å…‰', 'é‡ç‚®', 'æ›¼åŸèŒ¶åº§', 'å¥½æ­Œå‰§',
              'çˆ±ä¸½æ•°ç ', 'ç©ºä¸­ç¥å®«', 'æ˜Ÿäº‘å¤©ç©º', 'è‰ä¸Šé£', 'ç¥é¹°',
              'åå°†æ€’æ¶›', 'ç›®ç™½é›·æ©', 'ç›®ç™½é˜¿å°”ä¸¹', 'ç›®ç™½é«˜å³°',
              'å¤§å’Œèµ¤éª¥', 'ä¼ç‰¹åŠ ', 'å¤§æ‹“å¤ªé˜³ç¥', 'é»„é‡‘èˆ¹', 'é»„é‡‘åŸå¸‚',
              'ä¸­å±±åº†å…¸', 'ä¸­å±±å…‰è¾‰', 'ä¸­å±±éª‘å£«', 'ä¸­å±±è‹±é›„',
              'ç¾æµ¦æ³¢æ—', 'ç±³æµ´', 'æ˜¥ä¸½', 'ä¹Œæ‹‰æ‹‰', 'å¾…å…¼ç¦æ¥',
              'å¾…å…¼è¯—æ­Œå‰§', 'å¾…å…¼å²å®¾æ²™', 'å¾…å…¼å²å®¾æ²™äºŒä¸–',
              'å¾…å…¼å²å®¾æ²™ä¸‰ä¸–', 'å¾…å…¼å²å®¾æ²™å››ä¸–', 'å¾…å…¼å²å®¾æ²™äº”ä¸–'
            ];
            
            // æ£€æµ‹AIå›å¤ä¸­æ˜¯å¦åŒ…å«é©¬å¨˜åå­—
            const detectedUmas = [];
            umaNames.forEach(umaName => {
              if (aiResponse.includes(umaName)) {
                detectedUmas.push(umaName);
                console.log(`ğŸ æ£€æµ‹åˆ°é©¬å¨˜: ${umaName}`);
              }
            });
            
            // å°†æ£€æµ‹åˆ°çš„é©¬å¨˜æ·»åŠ åˆ°è®°åå†Œ
            if (detectedUmas.length > 0) {
              detectedUmas.forEach(umaName => {
                if (window.teresenDebug && window.teresenDebug.addUmaToRoster) {
                  window.teresenDebug.addUmaToRoster(umaName, {
                    notes: `åœ¨AIå›å¤ä¸­æ£€æµ‹åˆ°: ${new Date().toLocaleString('zh-CN')}`
                  });
                }
              });
              console.log(`ğŸ“– å·²å°† ${detectedUmas.length} ä¸ªé©¬å¨˜æ·»åŠ åˆ°è®°åå†Œ`);
            } else {
              console.log('ğŸ” æœªæ£€æµ‹åˆ°é©¬å¨˜åå­—');
            }
            
          } catch (error) {
            console.error('æ£€æµ‹é©¬å¨˜åå­—å¤±è´¥:', error);
          }
        }

        // è·å–èŠå¤©å†å²

        async getChatHistory() {

          try {

            if ('function' == typeof getChatMessages) {

              const messages = await getChatMessages(0);

              return messages || [];

            }

            return [];

          } catch (error) {

            console.warn('è·å–èŠå¤©å†å²å¤±è´¥:', error);

            return [];

          }

        }



        // å‰ç«¯æ£€æµ‹QTEåŠŸèƒ½

        updateQTESection() {

          try {

            // å‰ç«¯æ£€æµ‹QTEè§¦å‘æ¡ä»¶

            const shouldShowQTE = this.detectQTECondition();



            const qteSection = document.getElementById('qte-section');

            if (!qteSection) {

              console.warn('âŒ æ‰¾ä¸åˆ°QTEåŒºåŸŸå…ƒç´ ');

              return;

            }



            if (shouldShowQTE) {

              // æ˜¾ç¤ºQTEåŒºåŸŸ

              qteSection.style.display = 'block';



              // æ›´æ–°æè¿°æ–‡æœ¬

              const description = qteSection.querySelector('.qte-description');

              if (description) {

                description.textContent = 'ä½ è¢«é©¬å¨˜æŸç¼šäº†ï¼é€‰æ‹©ä½ çš„è¡ŒåŠ¨...';

              }



              console.log('ğŸ® QTEåŒºåŸŸå·²æ˜¾ç¤ºï¼ˆå‰ç«¯æ£€æµ‹ï¼‰');

            } else {

              // éšè—QTEåŒºåŸŸ

              qteSection.style.display = 'none';

              console.log('ğŸ® QTEåŒºåŸŸå·²éšè—');

            }

          } catch (error) {

            console.error('âŒ æ›´æ–°QTEåŒºåŸŸå¤±è´¥:', error);

          }

        }



        // æ£€æµ‹QTEè§¦å‘æ¡ä»¶

        detectQTECondition() {

          try {

            // æ£€æŸ¥AIå›å¤å†…å®¹

            const aiText = this.getLastAIText();

            console.log('ğŸ” è·å–åˆ°çš„AIæ–‡æœ¬:', aiText ? aiText.substring(0, 100) + '...' : 'ç©ºæ–‡æœ¬');



            if (aiText && this.containsBindingKeywords(aiText)) {

              console.log('ğŸ” æ£€æµ‹åˆ°æŸç¼šå…³é”®è¯ï¼Œè§¦å‘QTE');

              return true;

            } else {

              console.log('ğŸ” æœªæ£€æµ‹åˆ°æŸç¼šå…³é”®è¯ï¼Œä¸è§¦å‘QTE');

            }



            return false;

          } catch (error) {

            console.error('âŒ æ£€æµ‹QTEæ¡ä»¶å¤±è´¥:', error);

            return false;

          }

        }



        // è·å–æœ€åä¸€æ¡AIå›å¤æ–‡æœ¬

        getLastAIText() {

          try {

            // æ–¹æ³•1ï¼šé€šè¿‡TavernHelper API

            if (typeof TavernHelper !== 'undefined' && TavernHelper.getChatMessages) {

              const messages = TavernHelper.getChatMessages();

              const aiMessages = messages.filter(msg => msg.role === 'assistant');

              const lastMessage = aiMessages[aiMessages.length - 1];

              if (lastMessage && lastMessage.content) {

                console.log('ğŸ” è·å–AIæ–‡æœ¬æˆåŠŸï¼Œé•¿åº¦:', lastMessage.content.length);

                return lastMessage.content;

              }

            }



            // æ–¹æ³•2ï¼šé€šè¿‡DOMå…ƒç´ æŸ¥æ‰¾

            const aiResponseElements = document.querySelectorAll('.mes_text, .mes_text_ai, .ai-response');

            if (aiResponseElements.length > 0) {

              const lastElement = aiResponseElements[aiResponseElements.length - 1];

              const text = lastElement.textContent || lastElement.innerText || '';

              console.log('ğŸ” è·å–AIæ–‡æœ¬æˆåŠŸï¼Œé•¿åº¦:', text.length);

              return text;

            }



            // æ–¹æ³•3ï¼šé€šè¿‡èŠå¤©å®¹å™¨æŸ¥æ‰¾

            const chatContainer = document.querySelector('#chat_container, .chat-container');

            if (chatContainer) {

              const aiMessages = chatContainer.querySelectorAll('.mes_text, .mes_text_ai');

              if (aiMessages.length > 0) {

                const lastMessage = aiMessages[aiMessages.length - 1];

                const text = lastMessage.textContent || lastMessage.innerText || '';

                console.log('ğŸ” è·å–AIæ–‡æœ¬æˆåŠŸï¼Œé•¿åº¦:', text.length);

                return text;

              }

            }



            console.log('ğŸ” è·å–AIæ–‡æœ¬å¤±è´¥');

            return '';

          } catch (error) {

            console.warn('è·å–AIæ–‡æœ¬å¤±è´¥:', error);

            return '';

          }

        }



        // æ‰‹åŠ¨æ£€æµ‹QTEï¼ˆç”¨äºè°ƒè¯•ï¼‰

        manualCheckQTE() {

          console.log('ğŸ” æ‰‹åŠ¨æ£€æµ‹QTE...');

          this.checkQTEFromCurrentContent();

        }



        // ç›´æ¥ä»å½“å‰é¡µé¢å†…å®¹æ£€æµ‹QTE

        checkQTEFromCurrentContent() {

          try {

            // è·å–å½“å‰é¡µé¢çš„AIå›å¤å†…å®¹

            const aiContent =

              $('#chat_container .mes_text_ai').last().text() ||

              $('#chat_container .mes_text').last().text() ||

              $('.ai-response').last().text() ||

              '';



            console.log('ğŸ” å½“å‰AIå†…å®¹é•¿åº¦:', aiContent.length);



            if (aiContent && this.containsBindingKeywords(aiContent)) {

              console.log('ğŸ” æ£€æµ‹åˆ°æŸç¼šå…³é”®è¯ï¼Œæ˜¾ç¤ºQTE');

              $('#qte-section').show();

              $('#qte-section .qte-description').text('ä½ è¢«é©¬å¨˜æŸç¼šäº†ï¼é€‰æ‹©ä½ çš„è¡ŒåŠ¨...');

            } else {

              console.log('ğŸ” æœªæ£€æµ‹åˆ°æŸç¼šå…³é”®è¯ï¼Œéšè—QTE');

              $('#qte-section').hide();

            }

          } catch (error) {

            console.error('âŒ æ£€æµ‹QTEå¤±è´¥:', error);

          }

        }



        // æ£€æŸ¥æ˜¯å¦åŒ…å«æŸç¼šå…³é”®è¯

        containsBindingKeywords(text) {

          const keywords = [

            // åŸºç¡€æŸç¼šè¯æ±‡

            'æŸç¼š',

            'æŠ±ä½',

            'æŠ“ä½',

            'æ‚ä½',

            'ç´§æŠ±',

            'å›°ä½',

            'å‹åˆ¶',

            'ç¬¼ç½©',

            'ç¦é”¢',

            'é”ä½',

            'ä¾µå ',

            'å¼ºç¡¬',

            'å µä½',

            'å›´ä½',

            'åœˆä½',

            'ç¼ ä½',

            'ç»‘ä½',

            'æŒ‰ä½',

            'å‹ä½',

            'æ‰£ä½',

            'å¤¹ä½',

            'å¡ä½',

            'å¡åœ¨',

            'é™·åœ¨',

            'å›°åœ¨',



            // ç›´æ¥é’ˆå¯¹è®­ç»ƒå‘˜çš„è¯æ±‡

            'æŠŠä½ å‹åœ¨',

            'ä¸å®¹åæŠ—',

            'æ— æ³•æŒ£è„±',

            'æŠŠä½ å›°ä½',

            'æŠŠä½ å‹åˆ¶',

            'ç´§ç´§æŠ±ä½',

            'æŠŠä½ æŠ±ä½',

            'æ‚ä½ä½ ',

            'æŠ“ä½ä½ ',

            'å›°ä½ä½ ',

            'å‹åˆ¶ä½ ',

            'æŠŠä½ é”ä½',

            'æŠŠä½ ä¾µå ',

            'æŠŠä½ å›´ä½',

            'æŠŠä½ åœˆä½',

            'æŠŠä½ ç¼ ä½',

            'æŠŠä½ ç»‘ä½',

            'æŠŠä½ æŒ‰ä½',

            'æŠŠä½ å‹ä½',

            'æŠŠä½ æ‰£ä½',

            'æŠŠä½ å¤¹ä½',



            // åŠ¨ä½œæè¿°è¯æ±‡

            'æ‰‘å‘ä½ ',

            'æ‰‘å€’ä½ ',

            'æ‰‘åœ¨ä½ ',

            'å‹åœ¨ä½ ',

            'å‹å‘ä½ ',

            'å‹ä½ä½ ',

            'æŠ±ä½ä½ ',

            'æ‚ä½ä½ ',

            'æŠ“ä½ä½ ',

            'å›°ä½ä½ ',

            'å‹åˆ¶ä½ ',

            'é”ä½ä½ ',

            'ä¾µå ä½ ',

            'å›´ä½ä½ ',

            'åœˆä½ä½ ',

            'ç¼ ä½ä½ ',

            'ç»‘ä½ä½ ',

            'æŒ‰ä½ä½ ',

            'æ‰£ä½ä½ ',

            'å¤¹ä½ä½ ',

            'å¡ä½ä½ ',

            'é™·ä½ä½ ',

            'å›°ä½ä½ ',

            'å‹ä½ä½ ',



            // çŠ¶æ€æè¿°è¯æ±‡

            'åŠ¨å¼¹ä¸å¾—',

            'æ— æ³•ç§»åŠ¨',

            'æ— æ³•æŒ£è„±',

            'æ— æ³•åæŠ—',

            'æ— æ³•é€ƒè„±',

            'æ— æ³•æ‘†è„±',

            'æ— æ³•ç¦»å¼€',

            'æ— æ³•è„±èº«',

            'æ— æ³•è„±é€ƒ',

            'æ— æ³•è„±å›°',

            'æ— æ³•è„±å‡º',

            'æ— æ³•è„±å¼€',

            'æ— æ³•è„±æ‰',

            'æ— æ³•è„±ä¸‹',

            'æ— æ³•è„±ä¸‹',



            // å¼ºåº¦æè¿°è¯æ±‡

            'æ­»æ­»',

            'ç´§ç´§',

            'ç‰¢ç‰¢',

            'ç‰¢ç‰¢åœ°',

            'æ­»æ­»åœ°',

            'ç´§ç´§åœ°',

            'æ­»æ­»æŠ±ä½',

            'ç´§ç´§æŠ±ä½',

            'ç‰¢ç‰¢æŠ±ä½',

            'æ­»æ­»æŠ“ä½',

            'ç´§ç´§æŠ“ä½',

            'ç‰¢ç‰¢æŠ“ä½',

            'æ­»æ­»å›°ä½',

            'ç´§ç´§å›°ä½',

            'ç‰¢ç‰¢å›°ä½',

            'æ­»æ­»å‹åˆ¶',

            'ç´§ç´§å‹åˆ¶',

            'ç‰¢ç‰¢å‹åˆ¶',

            'æ­»æ­»é”ä½',

            'ç´§ç´§é”ä½',

            'ç‰¢ç‰¢é”ä½',



            // æƒ…æ„Ÿè‰²å½©è¯æ±‡

            'ä¸å®¹åæŠ—',

            'ä¸å®¹æ‹’ç»',

            'ä¸å®¹é€ƒè„±',

            'ä¸å®¹ç¦»å¼€',

            'ä¸å®¹è„±èº«',

            'å¼ºè¿«',

            'å¼ºåˆ¶',

            'å¼ºè¿«ä½ ',

            'å¼ºåˆ¶ä½ ',

            'é€¼è¿«',

            'é€¼è¿«ä½ ',

            'å¨èƒ',

            'å¨èƒä½ ',

            'æå“',

            'æå“ä½ ',

            'å¨é€¼',

            'å¨é€¼ä½ ',



            // ç‰¹æ®Šåœºæ™¯è¯æ±‡

            'å£å’š',

            'å£å’šä½ ',

            'æŠŠä½ å£å’š',

            'å£å’šåœ¨å¢™ä¸Š',

            'æŠŠä½ å£å’šåœ¨å¢™ä¸Š',

            'æ¨å€’',

            'æ¨å€’ä½ ',

            'æŠŠä½ æ¨å€’',

            'æ¨å€’åœ¨',

            'æŠŠä½ æ¨å€’åœ¨',

            'å‹å€’',

            'å‹å€’ä½ ',

            'æŠŠä½ å‹å€’',

            'å‹å€’åœ¨åœ°ä¸Š',

            'æŠŠä½ å‹å€’åœ¨åœ°ä¸Š',



            // é©¬å¨˜ç‰¹æœ‰è¯æ±‡

            'é©¬å¨˜çš„åŠ›é‡',

            'èµ›é©¬å¨˜çš„åŠ›é‡',

            'é©¬å¨˜çš„åŠ›æ°”',

            'èµ›é©¬å¨˜çš„åŠ›æ°”',

            'é©¬å¨˜çš„æ‹¥æŠ±',

            'èµ›é©¬å¨˜çš„æ‹¥æŠ±',

            'é©¬å¨˜çš„æ€€æŠ±',

            'èµ›é©¬å¨˜çš„æ€€æŠ±',

            'é©¬å¨˜çš„æŸç¼š',

            'èµ›é©¬å¨˜çš„æŸç¼š',

            'é©¬å¨˜çš„å‹åˆ¶',

            'èµ›é©¬å¨˜çš„å‹åˆ¶',



            // èº«ä½“éƒ¨ä½è¯æ±‡

            'æŠŠä½ å‹åœ¨èº«ä¸‹',

            'æŠŠä½ å‹åœ¨ä¸‹é¢',

            'æŠŠä½ å‹åœ¨èº«ä¸‹',

            'æŠŠä½ å‹åœ¨èº«ä¸‹',

            'æŠŠä½ æŠ±åœ¨æ€€é‡Œ',

            'æŠŠä½ æ‚åœ¨æ€€é‡Œ',

            'æŠŠä½ å›°åœ¨æ€€é‡Œ',

            'æŠŠä½ é”åœ¨æ€€é‡Œ',

            'æŠŠä½ å‹åœ¨å¢™ä¸Š',

            'æŠŠä½ å›°åœ¨å¢™ä¸Š',

            'æŠŠä½ é”åœ¨å¢™ä¸Š',

            'æŠŠä½ å‹åœ¨é—¨ä¸Š',

            'æŠŠä½ å›°åœ¨é—¨ä¸Š',

            'æŠŠä½ é”åœ¨é—¨ä¸Š',

            'æŠŠä½ å‹åœ¨åºŠä¸Š',

            'æŠŠä½ å›°åœ¨åºŠä¸Š',

            'æŠŠä½ é”åœ¨åºŠä¸Š',

            'æŠŠä½ å‹åœ¨æ²™å‘ä¸Š',

            'æŠŠä½ å›°åœ¨æ²™å‘ä¸Š',

            'æŠŠä½ é”åœ¨æ²™å‘ä¸Š',



            // æ—¶é—´æŒç»­è¯æ±‡

            'ä¸€ç›´',

            'ä¸€ç›´æŠ±ç€',

            'ä¸€ç›´æ‚ç€',

            'ä¸€ç›´æŠ“ç€',

            'ä¸€ç›´å›°ç€',

            'ä¸€ç›´å‹ç€',

            'ä¸€ç›´é”ç€',

            'ä¸€ç›´æŒ‰ç€',

            'ä¸€ç›´æ‰£ç€',

            'ä¸€ç›´å¤¹ç€',

            'æŒç»­',

            'æŒç»­æŠ±ç€',

            'æŒç»­æ‚ç€',

            'æŒç»­æŠ“ç€',

            'æŒç»­å›°ç€',

            'æŒç»­å‹ç€',

            'æŒç»­é”ç€',

            'æŒç»­æŒ‰ç€',

            'æŒç»­æ‰£ç€',

            'æŒç»­å¤¹ç€',



            // ç¨‹åº¦å‰¯è¯

            'å®Œå…¨',

            'å®Œå…¨æŸç¼š',

            'å®Œå…¨æŠ±ä½',

            'å®Œå…¨æŠ“ä½',

            'å®Œå…¨å›°ä½',

            'å®Œå…¨å‹åˆ¶',

            'å®Œå…¨é”ä½',

            'å®Œå…¨ä¾µå ',

            'å®Œå…¨å›´ä½',

            'å®Œå…¨åœˆä½',

            'å½»åº•',

            'å½»åº•æŸç¼š',

            'å½»åº•æŠ±ä½',

            'å½»åº•æŠ“ä½',

            'å½»åº•å›°ä½',

            'å½»åº•å‹åˆ¶',

            'å½»åº•é”ä½',

            'å½»åº•ä¾µå ',

            'å½»åº•å›´ä½',

            'å½»åº•åœˆä½',



            // å¦å®šæ€§è¯æ±‡

            'ä¸è®©ä½ ',

            'ä¸è®©ä½ åŠ¨',

            'ä¸è®©ä½ èµ°',

            'ä¸è®©ä½ ç¦»å¼€',

            'ä¸è®©ä½ é€ƒè„±',

            'ä¸è®©ä½ æŒ£è„±',

            'ä¸è®©ä½ åæŠ—',

            'ä¸è®©ä½ æ‹’ç»',

            'ä¸è®©ä½ è„±èº«',

            'é˜»æ­¢ä½ ',

            'é˜»æ­¢ä½ åŠ¨',

            'é˜»æ­¢ä½ èµ°',

            'é˜»æ­¢ä½ ç¦»å¼€',

            'é˜»æ­¢ä½ é€ƒè„±',

            'é˜»æ­¢ä½ æŒ£è„±',

            'é˜»æ­¢ä½ åæŠ—',

            'é˜»æ­¢ä½ æ‹’ç»',

            'é˜»æ­¢ä½ è„±èº«',



            // å‘½ä»¤æ€§è¯æ±‡

            'ä¸è®¸åŠ¨',

            'ä¸è®¸èµ°',

            'ä¸è®¸ç¦»å¼€',

            'ä¸è®¸é€ƒè„±',

            'ä¸è®¸æŒ£è„±',

            'ä¸è®¸åæŠ—',

            'ä¸è®¸æ‹’ç»',

            'ä¸è®¸è„±èº«',

            'ä¸å‡†åŠ¨',

            'ä¸å‡†èµ°',

            'ä¸å‡†ç¦»å¼€',

            'ä¸å‡†é€ƒè„±',

            'ä¸å‡†æŒ£è„±',

            'ä¸å‡†åæŠ—',

            'ä¸å‡†æ‹’ç»',

            'ä¸å‡†è„±èº«',

            'ä¸èƒ½åŠ¨',

            'ä¸èƒ½èµ°',

            'ä¸èƒ½ç¦»å¼€',

            'ä¸èƒ½é€ƒè„±',

            'ä¸èƒ½æŒ£è„±',

            'ä¸èƒ½åæŠ—',

            'ä¸èƒ½æ‹’ç»',

            'ä¸èƒ½è„±èº«',

          ];



          // æ£€æµ‹åŒ¹é…çš„å…³é”®è¯

          const matchedKeywords = keywords.filter(keyword => text.includes(keyword));

          if (matchedKeywords.length > 0) {

            console.log('ğŸ” åŒ¹é…åˆ°çš„å…³é”®è¯:', matchedKeywords);

            return true;

          } else {

            console.log('ğŸ” æœªåŒ¹é…åˆ°ä»»ä½•å…³é”®è¯');

            return false;

          }

        }



        // è§¦å‘QTEåŠ¨ä½œ

        // è§¦å‘è¶£å‘³QTE

        // è§¦å‘è¶£å‘³QTEï¼ˆä½¿ç”¨jQueryï¼‰

        async triggerQTE(action) {

          try {

            console.log(`ğŸ® è§¦å‘è¶£å‘³QTE: ${action}`);



            let qteCommand = '';



            if (action === 'struggle') {

              // å¥‹åŠ›æŒ£æ‰

              qteCommand = `å¥‹åŠ›æŒ£æ‰ï¼Œå°è¯•æŒ£è„±æŸç¼š`;

            } else if (action === 'submit') {

              // ä¸åæŠ—

              qteCommand = `é€‰æ‹©ä¸åæŠ—ï¼Œæ¥å—ç°çŠ¶`;

            }



            if (qteCommand) {

              // å°†QTEå‘½ä»¤å¡«å…¥è¾“å…¥æ¡†

              $('#action-input').val(qteCommand);

              console.log('âœ… è¶£å‘³QTEå‘½ä»¤å·²å¡«å…¥è¾“å…¥æ¡†:', qteCommand);

            }



            // éšè—QTEåŒºåŸŸ

            this.checkQTEFromCurrentContent();

          } catch (error) {

            console.error('âŒ è§¦å‘è¶£å‘³QTEå¤±è´¥:', error);

          }

        }



        // è·å–è‡ªåŠ¨å­˜æ¡£åˆ—è¡¨

        getAutoSaves() {

          const autoSaves = [];

          try {

            console.log('ğŸ” å¼€å§‹è·å–è‡ªåŠ¨å­˜æ¡£åˆ—è¡¨...');

            for (let i = 0; i < localStorage.length; i++) {

              const key = localStorage.key(i);

              if (key && key.startsWith('teresen-auto-save-')) {

                const data = localStorage.getItem(key);

                if (data) {

                  try {

                    const saveData = JSON.parse(data);

                    autoSaves.push({

                      key: key,

                      data: saveData,

                    });

                    console.log(

                      `ğŸ“ æ‰¾åˆ°è‡ªåŠ¨å­˜æ¡£: ${key}, æ—¶é—´: ${new Date(saveData.timestamp).toLocaleString('zh-CN')}`,

                    );

                  } catch (parseError) {

                    console.warn(`âŒ è§£æè‡ªåŠ¨å­˜æ¡£å¤±è´¥: ${key}`, parseError);

                  }

                }

              }

            }

            // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œæœ€æ–°çš„åœ¨å‰

            autoSaves.sort((a, b) => b.data.timestamp - a.data.timestamp);

            console.log(`ğŸ“Š æ€»å…±æ‰¾åˆ° ${autoSaves.length} ä¸ªè‡ªåŠ¨å­˜æ¡£`);

            // è¿”å›æœ€è¿‘10ä¸ª

            const result = autoSaves.slice(0, 10);

            console.log(`ğŸ“‹ è¿”å›æœ€è¿‘ ${result.length} ä¸ªè‡ªåŠ¨å­˜æ¡£`);

            return result;

          } catch (error) {

            console.warn('è·å–è‡ªåŠ¨å­˜æ¡£åˆ—è¡¨å¤±è´¥:', error);

            return [];

          }

        }



        // åŠ è½½è‡ªåŠ¨å­˜æ¡£

        async loadAutoSave(saveKey) {

          try {

            console.log('ğŸ“‚ åŠ è½½è‡ªåŠ¨å­˜æ¡£:', saveKey);

            const saveData = localStorage.getItem(saveKey);

            if (!saveData) {

              throw new Error('è‡ªåŠ¨å­˜æ¡£ä¸å­˜åœ¨');

            }



            const save = JSON.parse(saveData);



            // æ¢å¤èŠå¤©å†å²

            if (save.data.chatHistory && save.data.chatHistory.length > 0) {

              const lastMessage = save.data.chatHistory[save.data.chatHistory.length - 1];

              if (

                'function' == typeof getChatMessages &&

                'undefined' != typeof TavernHelper &&

                TavernHelper.setChatMessages

              ) {

                await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });

                console.log('âœ… èŠå¤©å†å²å·²æ¢å¤');

              }

            }



            // æ¢å¤æ¸¸æˆçŠ¶æ€

            if (save.data.gameState && 'function' == typeof eventEmit) {

              // ç›´æ¥è®¾ç½®å˜é‡ï¼Œä¸è°ƒç”¨MVU
              this.currentMvuState = save.data.gameState;
              this.renderUI(this.currentMvuState.stat_data);

              console.log('âœ… æ¸¸æˆçŠ¶æ€å·²æ¢å¤');

            }



            await this.updateInterface();

            $('#load-modal').hide();

            console.log('âœ… è‡ªåŠ¨å­˜æ¡£åŠ è½½æˆåŠŸ');

            alert('è‡ªåŠ¨å­˜æ¡£åŠ è½½æˆåŠŸï¼');

          } catch (error) {

            console.error('âŒ åŠ è½½è‡ªåŠ¨å­˜æ¡£å¤±è´¥:', error);

            alert('åŠ è½½è‡ªåŠ¨å­˜æ¡£å¤±è´¥ï¼');

          }

        }



        // è°ƒè¯•å­˜æ¡£åŠŸèƒ½

        debugSaves() {

          console.log('ğŸ” è°ƒè¯•å­˜æ¡£åŠŸèƒ½...');



          // æ£€æŸ¥æ‰€æœ‰localStorageä¸­çš„å­˜æ¡£

          const allSaves = [];

          for (let i = 0; i < localStorage.length; i++) {

            const key = localStorage.key(i);

            if (key && (key === 'teresen-save' || key.startsWith('teresen-auto-save-'))) {

              try {

                const data = localStorage.getItem(key);

                const save = JSON.parse(data);

                allSaves.push({

                  key: key,

                  save: save,

                });

              } catch (error) {

                console.warn('è§£æå­˜æ¡£å¤±è´¥:', key, error);

              }

            }

          }



          console.log('ğŸ“Š æ‰€æœ‰å­˜æ¡£:', allSaves);



          // æ˜¾ç¤ºå­˜æ¡£ç»Ÿè®¡

          const manualSaves = allSaves.filter(s => s.key === 'teresen-save');

          const autoSaves = allSaves.filter(s => s.key.startsWith('teresen-auto-save-'));



          console.log('ğŸ“‹ å­˜æ¡£ç»Ÿè®¡:');

          console.log('  æ‰‹åŠ¨å­˜æ¡£:', manualSaves.length, 'ä¸ª');

          console.log('  è‡ªåŠ¨å­˜æ¡£:', autoSaves.length, 'ä¸ª');



          // æ˜¾ç¤ºæ¯ä¸ªå­˜æ¡£çš„è¯¦ç»†ä¿¡æ¯

          allSaves.forEach((saveInfo, index) => {

            console.group(`å­˜æ¡£ ${index + 1}: ${saveInfo.key}`);

            console.log('å­˜æ¡£æ•°æ®:', saveInfo.save);

            if (saveInfo.save.data) {

              console.log('å­˜æ¡£æ—¶é—´:', new Date(saveInfo.save.timestamp).toLocaleString('zh-CN'));

              console.log('å­˜æ¡£åç§°:', saveInfo.save.saveName);

              console.log('å­˜æ¡£ç±»å‹:', saveInfo.save.type);

            }

            console.groupEnd();

          });



          // æµ‹è¯•è‡ªåŠ¨å­˜æ¡£åˆ—è¡¨åŠŸèƒ½

          const autoSavesList = this.getAutoSaves();

          console.log('ğŸ”§ è‡ªåŠ¨å­˜æ¡£åˆ—è¡¨åŠŸèƒ½æµ‹è¯•:', autoSavesList);

        }



        // è°ƒè¯•æŒ‡ä»¤äº¤äº’ç³»ç»Ÿ

        debugCommands() {

          console.log('âš¡ è°ƒè¯•æŒ‡ä»¤äº¤äº’ç³»ç»Ÿ...');



          // æ£€æŸ¥è¾“å…¥æ¡†

          const actionInput = document.getElementById('action-input');

          console.log('æŒ‡ä»¤è¾“å…¥æ¡†:', actionInput);



          // æ£€æŸ¥å‘é€æŒ‰é’®

          const sendBtn = document.querySelector('.send-button, #send-btn, button[onclick*="handleActionSubmit"]');

          console.log('å‘é€æŒ‰é’®:', sendBtn);



          // æ£€æŸ¥æœ€åå‘é€çš„æŒ‡ä»¤

          console.log('æœ€åå‘é€çš„æŒ‡ä»¤:', this.lastSentPrompt);



          // æ£€æŸ¥èŠå¤©å†å²

          const chatContainer = document.getElementById('chat_container');

          console.log('èŠå¤©å®¹å™¨:', chatContainer);

        }



        // è°ƒè¯•è‡ªåŠ¨å­˜æ¡£ç³»ç»Ÿ

        debugAutoSaves() {

          console.log('ğŸ’¾ è°ƒè¯•è‡ªåŠ¨å­˜æ¡£ç³»ç»Ÿ...');



          // æ£€æŸ¥æ‰€æœ‰localStorageä¸­çš„è‡ªåŠ¨å­˜æ¡£

          const allAutoSaves = [];

          for (let i = 0; i < localStorage.length; i++) {

            const key = localStorage.key(i);

            if (key && key.startsWith('teresen-auto-save-')) {

              try {

                const data = localStorage.getItem(key);

                const saveData = JSON.parse(data);

                allAutoSaves.push({

                  key: key,

                  timestamp: saveData.timestamp,

                  time: new Date(saveData.timestamp).toLocaleString('zh-CN'),

                  saveName: saveData.saveName,

                });

              } catch (error) {

                console.warn(`è§£æå­˜æ¡£å¤±è´¥: ${key}`, error);

              }

            }

          }



          // æŒ‰æ—¶é—´æ’åº

          allAutoSaves.sort((a, b) => b.timestamp - a.timestamp);



          console.log('ğŸ“Š æ‰€æœ‰è‡ªåŠ¨å­˜æ¡£:');

          allAutoSaves.forEach((save, index) => {

            console.log(`${index + 1}. ${save.key} - ${save.time} - ${save.saveName}`);

          });



          console.log(`ğŸ“ˆ æ€»è®¡: ${allAutoSaves.length} ä¸ªè‡ªåŠ¨å­˜æ¡£`);



          // æµ‹è¯•getAutoSavesæ–¹æ³•

          const recentSaves = this.getAutoSaves();

          console.log('ğŸ“‹ getAutoSavesè¿”å›:', recentSaves.length, 'ä¸ª');

        }



        // æ–°å¢ï¼šç®€å•å­˜æ¡£ç³»ç»Ÿ

        async saveGame(slotId = 'slot_1') {

          try {

            const saveName = prompt('è¯·è¾“å…¥å­˜æ¡£åç§°:');

            if (!saveName) return;



            const currentVariables = this.getAllVariables();

            const chatMessages = await getChatMessages(0);

            const currentMessage = chatMessages && chatMessages.length > 0 ? chatMessages[0].message : '';



            const saveData = {

              timestamp: Date.now(),

              save_name: saveName,

              mvu_data: currentVariables,

              message_content: currentMessage,

              type: 'manual',

            };



            localStorage.setItem(`teresen_save_${slotId}`, JSON.stringify(saveData));

            alert('å­˜æ¡£æˆåŠŸï¼');

          } catch (error) {

            console.error('å­˜æ¡£å¤±è´¥:', error);

            alert('å­˜æ¡£å¤±è´¥ï¼');

          }

        }



        async loadGame(slotId = 'slot_1') {

          try {

            const savedData = localStorage.getItem(`teresen_save_${slotId}`);

            if (!savedData) {

              alert('å­˜æ¡£ä¸å­˜åœ¨ï¼');

              return;

            }



            const saveData = JSON.parse(savedData);



            // æ¢å¤å˜é‡çŠ¶æ€

            if (saveData.mvu_data) {

              // ç›´æ¥è®¾ç½®å˜é‡ï¼Œä¸è°ƒç”¨MVU
              this.currentMvuState = saveData.mvu_data;
              this.renderUI(this.currentMvuState.stat_data);

            }



            // æ¢å¤èŠå¤©æ¶ˆæ¯

            if (saveData.message_content) {

              const chatMessages = await getChatMessages(0);

              if (chatMessages && chatMessages.length > 0) {

                const firstMessage = chatMessages[0];

                firstMessage.message = saveData.message_content;

                firstMessage.data = saveData.mvu_data;

                await TavernHelper.setChatMessages([firstMessage], { refresh: 'none' });

              }

            }



            // æ›´æ–°ç•Œé¢

            await this.updateDynamicData();



            alert('è¯»æ¡£æˆåŠŸï¼');

          } catch (error) {

            console.error('è¯»æ¡£å¤±è´¥:', error);

            alert('è¯»æ¡£å¤±è´¥ï¼');

          }

        }



        // æ–°å¤©èµ‹ç³»ç»Ÿå‡½æ•°

        showTalentsModal() {

          // æ’­æ”¾å¤©èµ‹ç®¡ç†å£°éŸ³
          const sound = document.getElementById('talent-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
          }
          
          const modal = document.getElementById('talents-modal');

          if (modal) {

            modal.style.display = 'flex';

            modal.style.justifyContent = 'center';

            modal.style.alignItems = 'center';

            // åˆå§‹åŒ–ç¿»é¡µç³»ç»Ÿ

            this.currentTalentPage = 0;

            this.updatePageIndicator();

            this.updatePageButtons();

            this.updateTalentsModal();

            

            // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬

            this.addKeyboardListeners();

          }

        }



        updateTalentsModal() {

          this.updateCurrentTalents();

          this.updateTalentOptions();

          this.updateUpgradeHistory();

          this.updateCurrentPageOptions();

        }



        updateCurrentTalents() {

          const container = document.getElementById('current-talents-list');

          if (!container) return;



          try {

            let majorTalent = 'æ— ';

            let crystals = 0;

            let acquiredTalents = [];



            // ä»MVUå˜é‡è¯»å–æ•°æ®

            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {

              const mvuData = Mvu.getMvuData({ type: 'chat' });

              majorTalent = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name[0]', { default_value: 'æ— ' });

              crystals = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶[0]', { default_value: 0 });



              // è¯»å–å·²è·å¾—çš„å¤©èµ‹

              const levels = ['èŒèŠ½', 'ç”Ÿé•¿', 'ç•¸å˜', 'æƒæŸ„', 'æ·±æ¸Š'];

              levels.forEach(level => {

                const talent = Mvu.getMvuVariable(mvuData, `è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.${level}[0]`, { default_value: null });

                if (talent) {

                  acquiredTalents.push({

                    level: level,

                    title: talent

                  });

                }

              });

            } else {

              // é™çº§åˆ°åŸæœ‰æ–¹æ³•

              const variables = this.getAllVariables();

              majorTalent = this.getVariable(variables, 'stat_data.è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name[0]', 'æ— ');

              crystals = this.getVariable(variables, 'stat_data.è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶[0]', 0);

            }



            // è·å–å¤§å¤©èµ‹æè¿°è¯

            const talentInfo = this.getMajorTalentDescription(majorTalent);

            

            let html = `

              <div style="max-width: 800px; margin: 0 auto;">

                <!-- å¤§å¤©èµ‹ä¿¡æ¯å¡ç‰‡ -->

                <div style="background: linear-gradient(135deg, rgba(139, 69, 19, 0.1), rgba(139, 69, 19, 0.05)); border: 2px solid rgba(139, 69, 19, 0.3); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">

                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    
                    <h4 style="color: #8b4513; font-size: 18px; font-weight: bold; display: flex; align-items: center; gap: 8px;">

                      <span style="font-size: 20px;">ğŸ­</span>

                      ${talentInfo.name}

                    </h4>

                    <!-- ç»“æ™¶æ˜¾ç¤º -->
                    <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.12), rgba(168, 85, 247, 0.06)); border: 1px solid rgba(168, 85, 247, 0.4); border-radius: 8px; padding: 8px 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                      <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="font-size: 12px;">ğŸ’</span>
                        <span style="color: #a855f7; font-size: 12px; font-weight: 600;">ç»“æ™¶</span>
                        <span style="color: #a855f7; font-size: 14px; font-weight: bold;">${crystals}</span>
                      </div>
                    </div>

                  </div>

                  <div style="color: #8b4513; font-size: 14px; line-height: 1.6; margin-bottom: 16px; text-align: center; font-style: italic;">

                    ${talentInfo.description}

                  </div>

                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

                    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(34, 197, 94, 0.03)); border: 2px solid rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 16px; position: relative; overflow: hidden;">

                      <!-- æ‰­æ›²çš„è£…é¥°çº¿æ¡ -->

                      <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.6), transparent);"></div>

                      <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.6), transparent);"></div>

                      

                      <div style="color: #15803d; font-size: 14px; font-weight: 700; margin-bottom: 8px; text-shadow: 0 1px 2px rgba(34, 197, 94, 0.3); letter-spacing: 0.5px;">åŠ›é‡ä¹‹æº</div>

                      <div style="color: #1a1a1a; font-size: 13px; line-height: 1.6; font-weight: 500; text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);">${talentInfo.positive}</div>

                    </div>

                    <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(239, 68, 68, 0.03)); border: 2px solid rgba(239, 68, 68, 0.4); border-radius: 12px; padding: 16px; position: relative; overflow: hidden;">

                      <!-- æ‰­æ›²çš„è£…é¥°çº¿æ¡ -->

                      <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.6), transparent);"></div>

                      <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.6), transparent);"></div>

                      

                      <div style="color: #dc2626; font-size: 14px; font-weight: 700; margin-bottom: 8px; text-shadow: 0 1px 2px rgba(239, 68, 68, 0.3); letter-spacing: 0.5px;">ä»£ä»·ä¹‹ç—•</div>

                      <div style="color: #1a1a1a; font-size: 13px; line-height: 1.6; font-weight: 500; text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);">${talentInfo.negative}</div>

                    </div>

                  </div>

                </div>



              </div>

            `;



            // æ˜¾ç¤ºå·²è·å¾—çš„å¤©èµ‹

            if (acquiredTalents.length > 0) {

              html += `

                <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">

                  <h4 style="color: #22c55e; font-size: 18px; font-weight: bold; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; text-align: center; justify-content: center;">

                    <span style="font-size: 20px;">ğŸŒŸ</span>

                    å·²è·å¾—å¤©èµ‹

                  </h4>

                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">

              `;

              acquiredTalents.forEach(talent => {

                html += `

                  <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08)); border: 2px solid rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 16px; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 8px rgba(0,0,0,0.1)'">

                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">

                      <span style="color: #22c55e; font-size: 14px; font-weight: bold; background: rgba(34, 197, 94, 0.25); padding: 6px 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${talent.level}</span>

                      <span style="color: #22c55e; font-size: 12px; opacity: 0.9; font-weight: 500;">âœ¨ å·²æ¿€æ´»</span>

                    </div>

                    <div style="color: #2d1b1b; font-size: 14px; line-height: 1.5; font-weight: 500;">${talent.title}</div>

                  </div>

                `;

              });

              html += `

                  </div>

                </div>

              `;

            } else {

              html += `

                <div style="background: linear-gradient(135deg, rgba(139, 69, 19, 0.08), rgba(139, 69, 19, 0.04)); border: 2px solid rgba(139, 69, 19, 0.25); border-radius: 16px; padding: 40px; text-align: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;">



                  

                  <div style="font-size: 36px; margin-bottom: 16px; opacity: 0.8; filter: drop-shadow(0 2px 4px rgba(139, 69, 19, 0.3));">ğŸ“–</div>

                  <div style="color: #8b4513; font-size: 16px; font-weight: 600; margin-bottom: 8px; text-shadow: 0 1px 2px rgba(139, 69, 19, 0.2);">å¤©èµ‹ä¹‹ä¹¦</div>

                  <div style="color: #666666; font-size: 14px; font-style: italic; margin-bottom: 8px; opacity: 0.8;">æš‚æ— å·²è·å¾—å¤©èµ‹</div>

                  <div style="color: #8b4513; font-size: 13px; opacity: 0.7;">è¯·ç¿»é¡µæŸ¥çœ‹å¯å‡çº§çš„å¤©èµ‹é€‰é¡¹</div>

                </div>

              `;

            }



            container.innerHTML = html;

          } catch (error) {

            console.error('æ›´æ–°å½“å‰å¤©èµ‹æ˜¾ç¤ºå¤±è´¥:', error);

            container.innerHTML = '<div style="text-align: center; color: #666666; font-style: italic; padding: 50px;">åŠ è½½å¤±è´¥</div>';

          }

        }



        updateTalentOptions() {

          const levels = ['seed', 'growth', 'mutation', 'authority', 'abyss'];

          levels.forEach(level => {

            this.updateTalentLevelOptions(level);

          });

        }



        updateTalentLevelOptions(level) {

          const container = document.getElementById(`${level}-options`);

          if (!container) return;



          const levelData = this.getTalentData(level);

          if (!levelData) return;



          // æ£€æŸ¥å‰ç½®æ¡ä»¶ï¼šä¸Šä¸€å±‚æ˜¯å¦å·²æ³¨å…¥å¤©èµ‹

          const isLevelUnlocked = this.isLevelUnlocked(level);

          

          if (!isLevelUnlocked) {

            // å¦‚æœå±‚çº§æœªè§£é”ï¼Œæ˜¾ç¤ºé”å®šçŠ¶æ€

            const previousLevel = this.getPreviousLevel(level);

            const previousLevelChinese = this.getLevelChineseName(previousLevel);

            container.innerHTML = `

              <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; background: linear-gradient(135deg, rgba(107, 114, 128, 0.1), rgba(107, 114, 128, 0.05)); border: 2px dashed rgba(107, 114, 128, 0.3); border-radius: 12px;">

                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”’</div>

                <h4 style="color: #6b7280; font-size: 16px; font-weight: bold; margin-bottom: 8px;">å±‚çº§æœªè§£é”</h4>

                <p style="color: #9ca3af; font-size: 14px; line-height: 1.5; margin: 0;">éœ€è¦å…ˆå®Œæˆ <span style="color: #8b4513; font-weight: bold;">${previousLevelChinese}</span> å±‚çº§çš„å¤©èµ‹é€‰æ‹©</p>

                <p style="color: #9ca3af; font-size: 12px; margin-top: 8px; font-style: italic;">è¯·è¿”å›ä¸Šä¸€é¡µé€‰æ‹©å¤©èµ‹</p>

              </div>

            `;

            return;

          }



          let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';

          levelData.options.forEach((option, index) => {

            const isAcquired = this.isTalentAcquired(level, index);

            const cost = this.getTalentCost(level);

            html += `

              <div style="background: ${isAcquired ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08))' : 'linear-gradient(135deg, rgba(139, 69, 19, 0.12), rgba(139, 69, 19, 0.06))'}; border: 2px solid ${isAcquired ? 'rgba(34, 197, 94, 0.4)' : 'rgba(139, 69, 19, 0.3)'}; border-radius: 10px; padding: 14px; cursor: pointer; transition: all 0.3s; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 20px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 12px rgba(0,0,0,0.15)'" onclick="window.teresenDebug.selectTalentOption('${level}', ${index})">

                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">

                  <h4 style="color: ${isAcquired ? '#22c55e' : '#8b4513'}; font-size: 15px; font-weight: bold; margin: 0; flex: 1; text-shadow: 0 1px 2px rgba(255,255,255,0.8);">${option.title}</h4>

                  <span style="color: ${isAcquired ? '#22c55e' : '#8b4513'}; font-size: 11px; font-weight: bold; background: ${isAcquired ? 'rgba(34, 197, 94, 0.25)' : 'rgba(139, 69, 19, 0.2)'}; padding: 5px 10px; border-radius: 8px; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${isAcquired ? 'âœ… å·²è·å¾—' : 'ğŸ’ ' + cost}</span>

                </div>

                <p style="color: #2d1b1b; font-size: 13px; line-height: 1.5; margin: 0 0 10px 0; font-weight: 500;">${option.description}</p>

                <div style="background: ${isAcquired ? 'rgba(34, 197, 94, 0.1)' : 'rgba(139, 69, 19, 0.08)'}; border: 1px solid ${isAcquired ? 'rgba(34, 197, 94, 0.3)' : 'rgba(139, 69, 19, 0.2)'}; border-radius: 8px; padding: 8px 10px; text-align: center;">

                  <span style="color: ${isAcquired ? '#22c55e' : '#8b4513'}; font-size: 12px; font-weight: bold; text-shadow: 0 1px 1px rgba(255,255,255,0.5);">${option.effects}</span>

                </div>

              </div>

            `;

          });

          html += '</div>';



          container.innerHTML = html;

        }



        // æ ¹æ®é¡µé¢ç´¢å¼•è·å–å¯¹åº”çš„å±‚çº§

        getLevelByPageIndex(pageIndex) {

          const levelMap = {

            0: null, // å½“å‰å¤©èµ‹é¡µé¢

            1: 'seed',

            2: 'growth', 

            3: 'mutation',

            4: 'authority',

            5: 'abyss',

            6: null // å‡çº§è®°å½•é¡µé¢

          };

          return levelMap[pageIndex];

        }



        // è·å–å¤©èµ‹æ¶ˆè€—

        getTalentCost(level) {

          const costMap = {

            'seed': 3,

            'growth': 12,

            'mutation': 25,

            'authority': 40,

            'abyss': 70

          };

          return costMap[level] || 0;

        }



        // æ›´æ–°å½“å‰é¡µé¢çš„é€‰é¡¹

        updateCurrentPageOptions() {

          const level = this.getLevelByPageIndex(this.currentTalentPage);

          if (level) {

            this.updateTalentLevelOptions(level);

          }

        }



        getTalentData(level) {

          // è·å–å½“å‰é€‰æ‹©çš„å¤§å¤©èµ‹æ–¹å‘

          let majorTalent = 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰';

          try {

            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {

              const mvuData = Mvu.getMvuData({ type: 'chat' });

              majorTalent = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name[0]', { default_value: 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰' });

            }

          } catch (error) {

            console.warn('è·å–å¤§å¤©èµ‹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);

          }



          // æ ¹æ®å¤§å¤©èµ‹æ–¹å‘è¿”å›å¯¹åº”çš„å¤©èµ‹æ•°æ®

          const talentData = {

            seed: {

              prompt: "ä½ åªæ˜¯åœ¨ç»å¢ƒä¸­ï¼Œæ— æ„è¯†åœ°æŠ“ä½äº†æ±‚ç”Ÿçš„ç¨»è‰ã€‚è¿™ä»½åŠ›é‡å¾®å¼±ã€ä¸å—æ§åˆ¶ï¼Œæ˜¯ä½ åœ¨è¿™åˆ«æ ·ä¸–ç•Œä¸­å‘å‡ºçš„ç¬¬ä¸€å£°å¾®å¼±çš„å•¼å“­ã€‚",

              options: this.getTalentOptionsByMajor(majorTalent, 'seed')

            },

            growth: {

              prompt: "ä½ å¼€å§‹ç†è§£å¹¶æœ‰æ„è¯†åœ°è¿ç”¨è¿™ä»½åŠ›é‡ï¼Œå°†å…¶ä½œä¸ºè§£å†³é—®é¢˜çš„å·¥å…·ã€‚ä½ ä»è¢«åŠ¨çš„å—å®³è€…ï¼Œè½¬å˜ä¸ºä¸€ä¸ªèƒ½åœ¨æ£‹ç›˜ä¸Šè°¨æ…è½å­çš„å‚ä¸è€…ã€‚",

              options: this.getTalentOptionsByMajor(majorTalent, 'growth')

            },

            mutation: {

              prompt: "åŠ›é‡å¼€å§‹åè¿‡æ¥å½±å“ä½ çš„å¿ƒæ™ºå’Œè¡Œä¸ºã€‚ä½ è·å¾—äº†æ›´å¼ºå¤§çš„èƒ½åŠ›ï¼Œä½†ä¹Ÿæ„Ÿå—åˆ°äº†å…¶èƒŒåé‚£ä»¤äººæˆ˜æ —çš„ç”œç¾ä¸ç–¯ç‹‚ã€‚",

              options: this.getTalentOptionsByMajor(majorTalent, 'mutation')

            },

            authority: {

              prompt: "åœ¨ç»å†äº†å†…å¿ƒçš„æŒ£æ‰åï¼Œä½ åšå‡ºäº†é€‰æ‹©ã€‚ä½ ä¸å†è§†å…¶ä¸ºè¯…å’’ï¼Œè€Œæ˜¯å¼€å§‹äº«å—è¿™ä»½åŠ›é‡ï¼Œå¹¶ä¸»åŠ¨å°†å…¶é”»é€ æˆå±äºè‡ªå·±çš„'æƒæŸ„'ã€‚",

              options: this.getTalentOptionsByMajor(majorTalent, 'authority')

            },

            abyss: {

              prompt: "ä½ èµ°åˆ°äº†è¿™æ¡è·¯çš„ç»ˆç‚¹ã€‚ä½ ä¸æ‰€é€‰çš„'ä¸å‡¡ä¹‹çˆ±'å½»åº•èä¸ºä¸€ä½“ï¼Œæˆä¸ºäº†ä¸€ä¸ªæ–°çš„'æ¦‚å¿µ'ã€ä¸€ä¸ªæ–°çš„'è§„åˆ™æ€ªè°ˆ'ã€‚",

              options: this.getTalentOptionsByMajor(majorTalent, 'abyss')

            }

          };



          return talentData[level];

        }



        isTalentAcquired(level, optionIndex) {

          try {

            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {

              const mvuData = Mvu.getMvuData({ type: 'chat' });

              const levelChineseName = this.getLevelChineseName(level);

              const currentTalent = Mvu.getMvuVariable(mvuData, `è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.${levelChineseName}[0]`, { default_value: null });

              

              if (currentTalent) {

                const levelData = this.getTalentData(level);

                if (levelData && levelData.options[optionIndex]) {

                  // ç°åœ¨æ³¨å…¥çš„æ˜¯æè¿°ï¼Œæ‰€ä»¥æ¯”è¾ƒæè¿°å†…å®¹

                  return currentTalent === levelData.options[optionIndex].description;

                }

              }

            }

            return false;

          } catch (error) {

            console.error('æ£€æŸ¥å¤©èµ‹çŠ¶æ€å¤±è´¥:', error);

            return false;

          }

        }



        async selectTalentOption(level, optionIndex) {

          try {

            console.log('ğŸ” å¼€å§‹å¤©èµ‹é€‰æ‹©æµç¨‹...');

            

            const levelData = this.getTalentData(level);

            if (!levelData || !levelData.options[optionIndex]) {

              console.error('âŒ å¤©èµ‹æ•°æ®ä¸å­˜åœ¨:', { level, optionIndex });

              return;

            }



            const option = levelData.options[optionIndex];

            console.log('ğŸ“‹ é€‰æ‹©çš„å¤©èµ‹:', option);

            

            // æ£€æŸ¥MVU APIæ˜¯å¦å¯ç”¨

            if (typeof Mvu === 'undefined') {

              console.error('âŒ MVUå¯¹è±¡æœªå®šä¹‰');

              alert('MVUç³»ç»ŸæœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');

              return;

            }

            

            if (!Mvu.getMvuData || !Mvu.setMvuVariable || !Mvu.replaceMvuData) {

              console.error('âŒ MVU APIå‡½æ•°ä¸å­˜åœ¨:', {

                getMvuData: !!Mvu.getMvuData,

                setMvuVariable: !!Mvu.setMvuVariable,

                replaceMvuData: !!Mvu.replaceMvuData

              });

              alert('MVU APIä¸å®Œæ•´ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');

              return;

            }



            // è·å–MVUæ•°æ®

            const mvuData = Mvu.getMvuData({ type: 'chat' });

            console.log('ğŸ“Š MVUæ•°æ®è·å–æˆåŠŸ:', mvuData ? 'æ˜¯' : 'å¦');

            

            // æ£€æŸ¥å±‚çº§æ˜¯å¦å·²æœ‰é€‰æ‹©

            const levelChineseName = this.getLevelChineseName(level);

            const currentTalent = Mvu.getMvuVariable(mvuData, `è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.${levelChineseName}[0]`, { default_value: null });

            console.log('ğŸ” å½“å‰å±‚çº§å¤©èµ‹:', { levelChineseName, currentTalent });

            

            if (currentTalent && currentTalent !== '') {

              alert(`è¯¥å±‚çº§å·²æœ‰é€‰æ‹©ï¼š${currentTalent}\næ¯ä¸ªå±‚çº§åªèƒ½é€‰æ‹©ä¸€ä¸ªå¤©èµ‹ï¼`);

              return;

            }



            // æ£€æŸ¥ç»“æ™¶æ˜¯å¦è¶³å¤Ÿ

            const cost = this.getTalentCost(level);

            const currentCrystals = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶[0]', { default_value: 0 });

            console.log('ğŸ’ ç»“æ™¶æ£€æŸ¥:', { cost, currentCrystals });

            

            if (currentCrystals < cost) {

              alert(`ç»“æ™¶ä¸è¶³ï¼éœ€è¦ ${cost} ä¸ªç»“æ™¶ï¼Œå½“å‰åªæœ‰ ${currentCrystals} ä¸ª`);

              return;

            }



            // ç¡®è®¤é€‰æ‹©

            const confirmed = confirm(`ç¡®å®šè¦è·å¾—å¤©èµ‹ "${option.title}" å—ï¼Ÿ\n\næè¿°: ${option.description}\n\næ•ˆæœ: ${option.effects}\n\næ¶ˆè€—: ${cost} ä¸ªç»“æ™¶`);

            if (!confirmed) return;



            console.log('âœ… ç”¨æˆ·ç¡®è®¤é€‰æ‹©ï¼Œå¼€å§‹æ³¨å…¥...');

            

            // æ‰£é™¤ç»“æ™¶

            const newCrystals = currentCrystals - cost;

            console.log('ğŸ’° æ‰£é™¤ç»“æ™¶:', { currentCrystals, cost, newCrystals });

            

            await Mvu.setMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶[0]', newCrystals, {

              reason: 'å¤©èµ‹æ¶ˆè€—',

              is_recursive: true,

            });

            console.log('âœ… ç»“æ™¶æ‰£é™¤æˆåŠŸ');

            

            // æ³¨å…¥å¤©èµ‹é€‰æ‹©åˆ°MVUå˜é‡ - æ³¨å…¥å¤©èµ‹æè¿°

            const talentPath = `è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.${levelChineseName}[0]`;

            console.log('ğŸ¯ æ³¨å…¥å¤©èµ‹è·¯å¾„:', talentPath);

            

            // æ³¨å…¥å¤©èµ‹çš„æè¿°å†…å®¹

            await Mvu.setMvuVariable(mvuData, talentPath, option.description, {

              reason: `å¤©èµ‹å‡çº§: ${level}å±‚çº§`,

              is_recursive: true,

            });

            console.log('âœ… å¤©èµ‹æ³¨å…¥æˆåŠŸï¼Œæ³¨å…¥æè¿°:', option.description);



            // ä¿å­˜æ›´æ–°åçš„æ•°æ®

            await Mvu.replaceMvuData(mvuData, { type: 'chat' });

            console.log('âœ… MVUæ•°æ®ä¿å­˜æˆåŠŸ');



            console.log(`ğŸ‰ å¤©èµ‹æ³¨å…¥å®Œæˆ: ${talentPath} = ${option.title}ï¼Œæ¶ˆè€— ${cost} ä¸ªç»“æ™¶`);

            

            // æ›´æ–°æ˜¾ç¤º

            this.updateTalentsModal();

            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æŠ€èƒ½ç³»ç»Ÿï¼ˆç‰¹åˆ«æ˜¯èŒèŠ½å¤©èµ‹è§£é”æ—¶ï¼‰
            if (window.skillSystem && level === 'seed') {
              console.log('ğŸ¯ èŒèŠ½å¤©èµ‹è§£é”ï¼Œæ›´æ–°æŠ€èƒ½ç³»ç»Ÿ...');
              window.skillSystem.checkSkillUnlock();
            }
            

            alert(`æ­å–œè·å¾—å¤©èµ‹: ${option.title}ï¼\næ¶ˆè€—äº† ${cost} ä¸ªç»“æ™¶ï¼Œå‰©ä½™ ${newCrystals} ä¸ª`);

          } catch (error) {

            console.error('âŒ å¤©èµ‹æ³¨å…¥å¤±è´¥:', error);

            console.error('é”™è¯¯è¯¦æƒ…:', {

              message: error.message,

              stack: error.stack,

              level,

              optionIndex

            });

            alert(`å¤©èµ‹æ³¨å…¥å¤±è´¥: ${error.message}\nè¯·æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯`);

          }

        }



        getLevelChineseName(level) {

          const levelMap = {

            'seed': 'èŒèŠ½',

            'growth': 'ç”Ÿé•¿', 

            'mutation': 'ç•¸å˜',

            'authority': 'æƒæŸ„',

            'abyss': 'æ·±æ¸Š'

          };

          return levelMap[level] || level;

        }



        // è·å–ä¸Šä¸€å±‚çº§

        getPreviousLevel(level) {

          const levelOrder = ['seed', 'growth', 'mutation', 'authority', 'abyss'];

          const currentIndex = levelOrder.indexOf(level);

          if (currentIndex <= 0) return null; // ç¬¬ä¸€å±‚æ²¡æœ‰å‰ç½®æ¡ä»¶

          return levelOrder[currentIndex - 1];

        }



        // æ£€æŸ¥å±‚çº§æ˜¯å¦å·²è§£é”

        isLevelUnlocked(level) {

          // ç¬¬ä¸€å±‚ï¼ˆèŒèŠ½ï¼‰æ€»æ˜¯è§£é”çš„

          if (level === 'seed') return true;

          

          // æ£€æŸ¥ä¸Šä¸€å±‚çº§æ˜¯å¦å·²æ³¨å…¥å¤©èµ‹

          const previousLevel = this.getPreviousLevel(level);

          if (!previousLevel) return true;

          

          try {

            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {

              const mvuData = Mvu.getMvuData({ type: 'chat' });

              const previousLevelChinese = this.getLevelChineseName(previousLevel);

              const previousTalent = Mvu.getMvuVariable(mvuData, `è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.${previousLevelChinese}[0]`, { default_value: null });

              

              // å¦‚æœä¸Šä¸€å±‚çº§æœ‰å¤©èµ‹æ³¨å…¥ï¼Œåˆ™å½“å‰å±‚çº§è§£é”

              return previousTalent && previousTalent !== '';

            }

            return false;

          } catch (error) {

            console.error('æ£€æŸ¥å±‚çº§è§£é”çŠ¶æ€å¤±è´¥:', error);

            return false;

          }

        }



        // æ ¹æ®å¤§å¤©èµ‹æ–¹å‘è·å–å¯¹åº”çš„å¤©èµ‹é€‰é¡¹

        getTalentOptionsByMajor(majorTalent, level) {

          const talentOptions = {

            'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰': {

              seed: [

                { title: "é˜²å¾¡å»¶ä¼¸", description: "ä½ å¯¹'çˆ±äºº'çš„å æœ‰æ¬²ï¼Œä½¿å…¶åœ¨ä½ èº«è¾¹æ—¶ä¹Ÿèƒ½è·å¾—ä½ é˜²å¾¡åŠ›æå‡æ•ˆæœçš„25%ã€‚", effects: "é˜²å¾¡åŠ›+25%" },

                { title: "è§„åˆ™å»¶ä¼¸", description: "å½“ä½ ä¸'çˆ±äºº'å…±åŒè§£è¯»è§„åˆ™æ—¶ï¼Œçœ‹ç©¿æ¼æ´çš„å‡ ç‡å°å¹…æå‡ã€‚", effects: "è§„åˆ™æ´å¯Ÿ+15%" },

                { title: "é”é“¾å»¶ä¼¸", description: "æ— å½¢é”é“¾çš„æ„ŸçŸ¥èŒƒå›´æ‰©å¤§ï¼Œèƒ½è®©ä½ æ¨¡ç³Šæ„Ÿåº”åˆ°'çˆ±äºº'çš„å¤§è‡´æ–¹ä½ã€‚", effects: "æ„ŸçŸ¥èŒƒå›´+20%" }

              ],

              growth: [

                { title: "é˜²å¾¡å¼ºåŒ–", description: "æå‡é˜²å¾¡åŠ›çš„æŒç»­æ—¶é—´å¢åŠ 50%ï¼Œä½†ç»“æŸå'ä¼¤ç—•'å¸¦æ¥çš„ç—›è‹¦ä¼šåŠ å€ã€‚", effects: "æŒç»­æ—¶é—´+50%" },

                { title: "è§„åˆ™å¼ºåŒ–", description: "ä½ å¯ä»¥ä¸»åŠ¨æ¶ˆè€—ç²¾ç¥ï¼Œå¼ºåˆ¶çœ‹ç ´ä¸€åˆ™ç®€å•è§„åˆ™çš„æ¼æ´ï¼Œä½†è§†é‡ä¼šæš‚æ—¶å˜å¾—æ›´ç‹­çª„ã€‚", effects: "è§„åˆ™æ´å¯Ÿ+30%" },

                { title: "é”é“¾å¼ºåŒ–", description: "ä½ å¯ä»¥æ¶ˆè€—ä½“åŠ›ï¼Œå…·ç°åŒ–ä¸€é“çŸ­æš‚çš„å®ä½“é”é“¾ï¼Œç”¨äºç»Šå€’ç›®æ ‡æˆ–æ‹‰å–è½»é‡ç‰©ä½“ã€‚", effects: "é”é“¾å…·ç°åŒ–" }

              ],

              mutation: [

                { title: "é˜²å¾¡ç•¸å˜", description: "é˜²å¾¡åŠ›æå‡å˜ä¸ºè¢«åŠ¨è§¦å‘ï¼Œä½†åªæœ‰å½“ä½ æˆ–'çˆ±äºº'å—åˆ°ä¼¤å®³æ—¶æ‰ä¼šç”Ÿæ•ˆï¼Œä¸”ä½ ä¼šæ¸´æœ›è¿™ç§è§¦å‘ã€‚", effects: "è¢«åŠ¨é˜²å¾¡" },

                { title: "è§„åˆ™ç•¸å˜", description: "ä½ å¼€å§‹èƒ½çœ‹åˆ°äººé™…å…³ç³»ä¸­çš„'è§„åˆ™æ¼æ´'ï¼Œè®©ä½ æ›´å®¹æ˜“æ“çºµä»–äººï¼Œä½†ä½ å¯¹ä»–äººçš„ä¿¡ä»»æ„Ÿæ°¸ä¹…é™ä½ã€‚", effects: "ç¤¾äº¤æ´å¯Ÿ" },

                { title: "é”é“¾ç•¸å˜", description: "é”é“¾ä¼šä¸è‡ªè§‰åœ°ç¼ ç»•åœ¨ä½ å’Œ'çˆ±äºº'èº«ä¸Šï¼Œè‹¥è·ç¦»è¿‡è¿œï¼ŒåŒæ–¹éƒ½ä¼šæ„Ÿåˆ°æŸç¼šçš„åˆºç—›ï¼ˆåå™¬è‡ªèº«ï¼‰ã€‚", effects: "é”é“¾æŸç¼š" }

              ],

              authority: [

                { title: "é˜²å¾¡æƒæŸ„", description: "ä½ å¯ä»¥å®£å‘Šä¸€ä¸ªåŠå¾„5ç±³çš„'ç‹¬å é¢†åŸŸ'ï¼Œé¢†åŸŸå†…ä½ çš„é˜²å¾¡åŠ›æå‡æ•ˆæœå¯¹æ‰€æœ‰æ•Œäººäº§ç”Ÿæ’æ–¥åŠ›ã€‚", effects: "ç‹¬å é¢†åŸŸ" },

                { title: "è§„åˆ™æƒæŸ„", description: "ä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªå·²è¢«çœ‹ç©¿çš„è§„åˆ™æ¼æ´ï¼Œå¹¶æš‚æ—¶å°†å…¶'å…³é—­'ï¼Œé˜»æ­¢å…¶ä»–äººåˆ©ç”¨ã€‚", effects: "è§„åˆ™å°é”" },

                { title: "é”é“¾æƒæŸ„", description: "ä½ å¯ä»¥å°†æ— å½¢é”é“¾'é”šå®š'åœ¨ä¸€ä¸ªç›®æ ‡èº«ä¸Šï¼Œä½¿å…¶æ‰€æœ‰è¡ŒåŠ¨æ£€å®šå—åˆ°è´Ÿé¢å½±å“ï¼Œç›´åˆ°å…¶è„±ç¦»ä½ çš„æ„ŸçŸ¥èŒƒå›´ã€‚", effects: "é”é“¾é”šå®š" }

              ],

              abyss: [

                { title: "é˜²å¾¡æ·±æ¸Š", description: "ä½ çš„èº«ä½“ä¸'çˆ±äºº'çš„å‘½è¿ç»‘å®šï¼Œåªè¦å¥¹å­˜æ´»ï¼Œä½ çš„ç‰©ç†é˜²å¾¡å°±ä¸ä¼šè¢«å½»åº•å‡»æºƒï¼Œä»£ä»·æ˜¯ä½ å°†å¤±å»ç‹¬ç«‹çš„'è‡ªæˆ‘'æ„è¯†ã€‚", effects: "å‘½è¿ç»‘å®š" },

                { title: "è§„åˆ™æ·±æ¸Š", description: "ä½ æˆä¸ºè§„åˆ™çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥é‡å†™ä¸€æ¡ä½ å·²å®Œå…¨çœ‹é€çš„ç®€å•è§„åˆ™ï¼Œä»£ä»·æ˜¯ä½ çš„å­˜åœ¨æœ¬èº«ä¹Ÿè¢«è¿™æ¡æ–°è§„åˆ™æ°¸ä¹…æŸç¼šã€‚", effects: "è§„åˆ™é‡å†™" },

                { title: "é”é“¾æ·±æ¸Š", description: "ä½ ä¸'çˆ±äºº'è¢«æ°¸æ’çš„é”é“¾è¿æ¥ï¼Œå…±äº«ç”Ÿå‘½ä¸åŠ›é‡ï¼Œä½†ä¹Ÿæ°¸è¿œæ— æ³•åˆ†ç¦»ï¼Œæˆä¸ºä¸€ä¸ªå…±ç”Ÿçš„æ•´ä½“ã€‚", effects: "æ°¸æ’é”é“¾" }

              ]

            },

            'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰': {

              seed: [

                { title: "è§„åˆ™å»¶ä¼¸", description: "å½“ä½ é˜…è¯»è§„åˆ™æ—¶ï¼Œæœ‰å‡ ç‡çœ‹åˆ°ä¸€å¥è¢«'è°è¨€'é¢å¤–æ ‡è®°å‡ºçš„ã€æœ€å®¹æ˜“è¢«ä¿®æ”¹çš„è¯å¥ã€‚", effects: "è§„åˆ™æ ‡è®°" },

                { title: "æƒ…æ„Ÿå»¶ä¼¸", description: "ä½ æ’’çš„ç¬¬ä¸€ä¸ªæ— ä¼¤å¤§é›…çš„è°è¨€ï¼Œä¼šè®©ä½ æ•£å‘å‡ºå¾®å¼±çš„ã€ä»¤äººå®‰å¿ƒçš„æ°”æ¯ã€‚", effects: "å®‰å¿ƒæ°”æ¯" },

                { title: "å½±å­å»¶ä¼¸", description: "ä½ çš„å½±å­åœ¨å…‰çº¿æœ€æš—æ—¶ä¼šè½»å¾®æ™ƒåŠ¨ï¼Œä»¿ä½›åœ¨æ¨¡ä»¿ä¸€ä¸ªä¸å­˜åœ¨çš„åŠ¨ä½œã€‚", effects: "å½±å­æ™ƒåŠ¨" }

              ],

              growth: [

                { title: "è§„åˆ™å¼ºåŒ–", description: "ä½ å¯ä»¥æŒ‡å®šè§„åˆ™æè¿°ä¸­çš„ä¸€ä¸ªè¯ï¼Œç”¨ä¸€ä¸ªåŒä¹‰è¯è¿›è¡Œä¸´æ—¶æ›¿æ¢ï¼ŒæŒç»­1åˆ†é’Ÿã€‚", effects: "è§„åˆ™æ›¿æ¢" },

                { title: "æƒ…æ„Ÿå¼ºåŒ–", description: "ä½ å¯ä»¥å°†ä¸€ä¸ªç®€å•çš„è°è¨€ï¼ˆå¦‚'æˆ‘å¾ˆå¥½'ï¼‰å…·è±¡åŒ–ï¼Œæ³¨å…¥ç›®æ ‡ä½“å†…ï¼Œä½¿å…¶æš‚æ—¶å¿½ç•¥ä½ çš„è´Ÿé¢çŠ¶æ€ã€‚", effects: "è°è¨€å…·è±¡" },

                { title: "å½±å­å¼ºåŒ–", description: "ä½ å¯ä»¥å‘½ä»¤ä½ çš„å½±å­åšå‡ºä¸€ä¸ªç®€å•çš„ã€æ— å®ä½“çš„åŠ¨ä½œï¼ˆå¦‚æŒ¥æ‰‹ï¼‰ï¼Œä»¥å¸å¼•æ³¨æ„åŠ›ã€‚", effects: "å½±å­æ§åˆ¶" }

              ],

              mutation: [

                { title: "è§„åˆ™ç•¸å˜", description: "ä½ ä¿®æ”¹è§„åˆ™æ—¶ï¼Œæœ‰å‡ ç‡å¯¼è‡´è¯¥è§„åˆ™çš„å¦ä¸€éƒ¨åˆ†å˜å¾—æ›´åŠ ä¸¥è‹›ï¼ˆè§„åˆ™ä¸ç¨³å®šåå™¬ï¼‰ã€‚", effects: "è§„åˆ™åå™¬" },

                { title: "æƒ…æ„Ÿç•¸å˜", description: "å¦‚æœä½ å…·è±¡åŒ–çš„æƒ…æ„Ÿè°è¨€è¢«è¯†ç ´ï¼Œå…¶éº»ç—¹æ•ˆæœä¼šç«‹åˆ»è½¬å˜ä¸ºåˆºç—›ç›®æ ‡çš„ç²¾ç¥æ¯’è¯ã€‚", effects: "è°è¨€æ¯’è¯" },

                { title: "å½±å­ç•¸å˜", description: "å½±å­æ‰¿å—ä¼¤å®³åï¼Œä½ æœ¬äººä¼šåœ¨24å°æ—¶å†…éšæœºå‡ºç°ä¸€å¤„ä¸å½±å­å—ä¼¤éƒ¨ä½å¯¹åº”çš„æ·¤é’ï¼ˆä¼¤å®³å åŠ å‰å…†ï¼‰ã€‚", effects: "ä¼¤å®³åé¦ˆ" }

              ],

              authority: [

                { title: "è§„åˆ™æƒæŸ„", description: "ä½ å¯ä»¥ç¼–é€ ä¸€å¥å…¨æ–°çš„ã€çœ‹ä¼¼åˆç†çš„è§„åˆ™ï¼Œå¹¶å°†å…¶ä¸´æ—¶æ·»åŠ è¿›ç°æœ‰çš„è§„åˆ™æ–‡æœ¬ä¸­ã€‚", effects: "è§„åˆ™ç¼–é€ " },

                { title: "æƒ…æ„ŸæƒæŸ„", description: "ä½ å¯ä»¥ç¼–é€ ä¸€ç§å¤æ‚çš„'å¤åˆæƒ…æ„Ÿ'ï¼ˆå¦‚'å–œæ‚¦çš„æ‚²ä¼¤'ï¼‰ï¼Œéº»ç—¹å¯¹æ‰‹æ›´é«˜é˜¶çš„é€»è¾‘åˆ¤æ–­ã€‚", effects: "å¤åˆæƒ…æ„Ÿ" },

                { title: "å½±å­æƒæŸ„", description: "ä½ å¯ä»¥åˆ›é€ ä¸€ä¸ªèƒ½ç¦»å¼€ä½ èº«ä½“ã€æŒç»­10ç§’çš„è™šå‡å½±å­ï¼Œç”¨äºæ‰¿å—ä¸€æ¬¡æŒ‡å‘æ€§æ”»å‡»ã€‚", effects: "è™šå‡å½±å­" }

              ],

              abyss: [

                { title: "è§„åˆ™æ·±æ¸Š", description: "ä½ æˆä¸ºäº†'è¡Œèµ°çš„è°è¨€'ï¼Œä½ è¯´å‡ºçš„è¯åœ¨çŸ­æ—¶é—´å†…ä¼šè¢«ä»–äººä¸‹æ„è¯†åœ°å½“ä½œ'è§„åˆ™'æ¥éµå®ˆï¼Œä»£ä»·æ˜¯ä½ è‡ªå·±ä¹Ÿæ— æ³•åˆ†è¾¨çœŸå®ä¸è™šå‡ã€‚", effects: "è¡Œèµ°è°è¨€" },

                { title: "æƒ…æ„Ÿæ·±æ¸Š", description: "ä½ ç¼–é€ çš„æƒ…æ„Ÿå¯ä»¥æ°¸ä¹…åœ°æ”¹å˜ä¸€ä¸ªäººçš„æ€§æ ¼åŸºçŸ³ï¼Œä»£ä»·æ˜¯ä½ è¯´å‡ºçš„æ‰€æœ‰è°è¨€æœ€ç»ˆéƒ½ä¼šåœ¨ä½ èº«ä¸Šç‰¹æ®Šå…·ç°åŒ–ä¸ºæ–°çš„å±é™©ã€‚", effects: "æ€§æ ¼é‡å¡‘" },

                { title: "å½±å­æ·±æ¸Š", description: "ä½ å¯ä»¥ä¸ä½ çš„å½±å­äº’æ¢ä½ç½®ï¼Œè®©å…¶æ‰¿å—æ‰€æœ‰ä¼¤å®³ï¼Œä½†å½±å­æœ€ç»ˆçˆ†å‘æ—¶ï¼Œæ‰€æœ‰ç´¯ç§¯ä¼¤å®³å°†ä¸€æ¬¡æ€§è¿”è¿˜ç»™ä½ ã€‚", effects: "å½±å­äº’æ¢" }

              ]

            },

            'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰': {

              seed: [

                { title: "æƒ…ç»ªå»¶ä¼¸", description: "å½“ä½ æ„Ÿåˆ°å¼ºçƒˆçš„æ‚²ä¼¤æ—¶ï¼Œå‘¨å›´çš„æ•Œæ„ç›®æ ‡ä¼šæ„Ÿå—åˆ°è½»å¾®çš„è¿·æƒ‘ï¼Œæ”»å‡»ç²¾å‡†åº¦å°å¹…ä¸‹é™ã€‚", effects: "æ‚²ä¼¤è¿·æƒ‘" },

                { title: "çŒ®ç¥­å»¶ä¼¸", description: "ä½ æœ€çè§†çš„ä¸€æ®µè®°å¿†ï¼Œå…¶è½®å»“ä¼šå˜å¾—æ¨¡ç³Šï¼Œä½œä¸ºä»£ä»·ï¼Œä½ å¯¹è§„åˆ™çš„ä¿®æ”¹æŠ—æ€§å¾®é‡æå‡ã€‚", effects: "è®°å¿†æ¨¡ç³Š" },

                { title: "åˆ†èº«å»¶ä¼¸", description: "ä½ èƒ½æ„Ÿè§‰åˆ°ä¸€ä¸ªä¸ä½ ç›¸è²Œç›¸ä¼¼çš„'å¹»å½±'å­˜åœ¨äºæŸå¤„ï¼Œä½†æ— æ³•ä¸ä¹‹äº¤æµæˆ–æ§åˆ¶ã€‚", effects: "å¹»å½±æ„ŸçŸ¥" }

              ],

              growth: [

                { title: "æƒ…ç»ªé‡Šæ”¾", description: "ä½ å¯ä»¥ä¸»åŠ¨é‡Šæ”¾ä¸€æ®µç—›è‹¦çš„æƒ…ç»ªï¼Œä»¤ä¸€ä¸ªæŒ‡å®šç›®æ ‡æš‚æ—¶ï¼ˆçº¦5ç§’ï¼‰ä¸§å¤±æ”»å‡»æ€§ï¼Œä»£ä»·æ˜¯è¯¥æ®µæƒ…ç»ªå¯¹åº”çš„è®°å¿†ä¼šäº§ç”Ÿè£‚ç—•ã€‚", effects: "æƒ…ç»ªé‡Šæ”¾" },

                { title: "ç”Ÿå‘½çŒ®ç¥­", description: "ä½ å¯ä»¥æ¶ˆè€—å°‘é‡ç”Ÿå‘½åŠ›ï¼ˆè¡¨ç°ä¸ºä¸€é“æ— æ³•æ„ˆåˆçš„å°ä¼¤å£ï¼‰ï¼Œæ¥'æ“¦é™¤'è§„åˆ™æ–‡æœ¬ä¸­çš„ä¸€ä¸ªéå…³é”®è¯ã€‚", effects: "ç”Ÿå‘½çŒ®ç¥­" },

                { title: "åˆ†èº«å…·ç°", description: "ä½ å¯ä»¥æ¶ˆè€—å¤§é‡ä½“åŠ›ï¼Œå°†'å¹»å½±'çŸ­æš‚åœ°åœ¨æŒ‡å®šä½ç½®å…·ç°åŒ–1ç§’ï¼Œç”¨äºæ ¼æŒ¡æˆ–è¿·æƒ‘ã€‚", effects: "åˆ†èº«å…·ç°" }

              ],

              mutation: [

                { title: "æƒ…ç»ªç•¸å˜", description: "ä½ é‡Šæ”¾çš„æƒ…ç»ªå¼€å§‹å¸¦æœ‰è…èš€æ€§ï¼Œæ•Œäººå¤±å»æ”»å‡»æ€§çš„åŒæ—¶ï¼Œå…¶ç†æ™ºä¹Ÿä¼šè¢«è½»å¾®ä¾µèš€ï¼Œä½†ä½ çš„ç²¾ç¥åŠ›ä¸Šé™ä¼šå› æ­¤æ°¸ä¹…é™ä½ã€‚", effects: "æƒ…ç»ªè…èš€" },

                { title: "è§„åˆ™ç•¸å˜", description: "ä½ æ¶ˆè€—è®°å¿†ä¿®æ”¹è¿‡çš„è§„åˆ™ï¼Œåœ¨å¤±æ•ˆåä¼šä»¥æ›´éš¾ç†è§£çš„å½¢å¼å›å½’ï¼Œå¢åŠ å…¶ç ´è§£éš¾åº¦ã€‚", effects: "è§„åˆ™å›å½’" },

                { title: "åˆ†èº«ç•¸å˜", description: "ä½ çš„åˆ†èº«å¼€å§‹æ‹¥æœ‰å¾®å¼±çš„è‡ªæˆ‘æ„è¯†ï¼Œæœ‰æ—¶ä¼šåšå‡ºè¿èƒŒä½ å‘½ä»¤çš„ç»†å¾®åŠ¨ä½œï¼Œå…¶æ‰¿å—çš„ç—›è‹¦ä¼šè½»å¾®åé¦ˆåˆ°ä½ èº«ä¸Šã€‚", effects: "åˆ†èº«æ„è¯†" }

              ],

              authority: [

                { title: "æƒ…ç»ªæƒæŸ„", description: "ä½ å¯ä»¥å°†'ç»æœ›'è¿™ç§æƒ…ç»ªèµ‹äºˆä¸€ç‰‡åŒºåŸŸï¼Œæ‰€æœ‰è¿›å…¥è¯¥åŒºåŸŸçš„æ•Œäººéƒ½å°†å—åˆ°æŒç»­çš„æ„å¿—å‰Šå¼±ã€‚", effects: "ç»æœ›é¢†åŸŸ" },

                { title: "è®°å¿†æƒæŸ„", description: "ä½ å¯ä»¥å½»åº•çŒ®ç¥­ä¸€æ®µå®Œæ•´çš„è®°å¿†ï¼Œä»¥æ­¤ä¸ºä»£ä»·ï¼Œå¼ºè¡Œä¿®æ”¹ä¸€æ¡ç®€å•è§„åˆ™çš„æ ¸å¿ƒé€»è¾‘ã€‚", effects: "è®°å¿†çŒ®ç¥­" },

                { title: "åˆ†èº«æƒæŸ„", description: "ä½ å¯ä»¥å…·ç°åŒ–ä¸€ä¸ªèƒ½æŒç»­å­˜åœ¨1åˆ†é’Ÿçš„åˆ†èº«ï¼Œå¹¶èµ‹äºˆå…¶ä¸€ä¸ªæ˜ç¡®çš„æŒ‡ä»¤ï¼Œä½†åˆ†èº«è¢«æ‘§æ¯æ—¶ï¼Œä½ ä¼šæ‰¿å—å…¶æ‰€å—ä¼¤å®³çš„50%ã€‚", effects: "æŒä¹…åˆ†èº«" }

              ],

              abyss: [

                { title: "æƒ…ç»ªæ·±æ¸Š", description: "ä½ æˆä¸ºäº†'ç‰ºç‰²'çš„åŒ–èº«ï¼Œä½ çš„å­˜åœ¨æœ¬èº«å°±ä¼šè®©å‘¨å›´çš„ç”Ÿå‘½ä½“ä¸§å¤±æ–—äº‰æ¬²æœ›ï¼Œä»£ä»·æ˜¯ä½ è‡ªèº«çš„æƒ…æ„Ÿä¹Ÿéšä¹‹å®Œå…¨æ¶ˆäº¡ã€‚", effects: "ç‰ºç‰²åŒ–èº«" },

                { title: "è§„åˆ™æ·±æ¸Š", description: "ä½ å¯ä»¥å°†è‡ªå·±çš„ä¸€éƒ¨åˆ†ç”Ÿå‘½åŠ›æ°¸ä¹…æ³¨å…¥ä¸€æ¡è§„åˆ™ï¼Œä½¿å…¶ä¸ºä½ æ‰€ç”¨ï¼Œä½†ä½ çš„å­˜åœ¨ä¹Ÿä¸è¯¥è§„åˆ™ç»‘å®šï¼Œè§„åˆ™è¢«ç ´è§£æ—¶ä½ ä¼šé­å—é‡åˆ›ã€‚", effects: "è§„åˆ™ç»‘å®š" },

                { title: "åˆ†èº«æ·±æ¸Š", description: "ä½ å¯ä»¥åˆ›é€ ä¸€ä¸ªä¸ä½ å®Œå…¨ç›¸åŒçš„åˆ†èº«ï¼Œå…±äº«æ„Ÿå®˜ä¸ç”Ÿå‘½ï¼Œä½†åˆ†èº«æ­»äº¡æ—¶ï¼Œä½ ä¹Ÿä¼šä¸€åŒæ­»äº¡ã€‚", effects: "ç”Ÿå‘½å…±äº«" }

              ]

            },

            'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰': {

              seed: [

                { title: "æš—ç¤ºå»¶ä¼¸", description: "ä½ èƒ½è¢«åŠ¨åœ°æ„ŸçŸ¥åˆ°å‘¨å›´äººç¾¤ä¸­ï¼Œè°çš„æ„å¿—æœ€è–„å¼±ï¼Œæ›´å®¹æ˜“æ¥å—å¿ƒç†æš—ç¤ºã€‚", effects: "æ„å¿—æ„ŸçŸ¥" },

                { title: "æ“æ§å»¶ä¼¸", description: "ä½ èƒ½æ¨¡ç³Šåœ°æ„Ÿåº”åˆ°é™„è¿‘æ˜¯å¦å­˜åœ¨åˆšåˆšå¤±å»æˆ˜æ–—æ„å¿—ã€é€‚åˆè¢«æ“æ§çš„æ®‹å…µã€‚", effects: "æ®‹å…µæ„ŸçŸ¥" },

                { title: "å¸æ”¶å»¶ä¼¸", description: "ä½ èƒ½åˆ†è¾¨å‡ºNPCå¯¹ä½ æ•£å‘çš„'çˆ±æ„'çš„å¼ºå¼±ï¼Œä½†è¿™ç§æ„ŸçŸ¥è®©ä½ è§‰å¾—å†°å†·ã€‚", effects: "çˆ±æ„æ„ŸçŸ¥" }

              ],

              growth: [

                { title: "æš—ç¤ºå¼ºåŒ–", description: "ä½ å¯ä»¥å¯¹ä¸€ä¸ªNPCæ¤å…¥ä¸€ä¸ªç®€å•çš„è¯è¯­æš—ç¤ºï¼Œä¾‹å¦‚'é—å¿˜'æˆ–'ä¿¡ä»»'ã€‚", effects: "è¯è¯­æš—ç¤º" },

                { title: "æ“æ§å¼ºåŒ–", description: "ä½ å¯ä»¥æ“æ§ä¸€ä¸ªåˆšè¢«ä½ å‡»è´¥çš„å°å‹æ•Œäººä¸ºä½ æˆ˜æ–—ï¼ŒæŒç»­æ—¶é—´ä¸€åˆ†é’Ÿã€‚", effects: "æ•Œäººæ“æ§" },

                { title: "å¸æ”¶å¼ºåŒ–", description: "ä½ å¯ä»¥å¸æ”¶ä¸€åNPCè‡ªæ„¿ç»™äºˆçš„'çˆ±æ„'ï¼Œå°å¹…å¼ºåŒ–ä½ çš„ä¸€é¡¹èº«ä½“èƒ½åŠ›ã€‚", effects: "çˆ±æ„å¸æ”¶" }

              ],

              mutation: [

                { title: "æš—ç¤ºç•¸å˜", description: "ä½ æ¤å…¥çš„æš—ç¤ºæ•ˆæœå¢å¼ºï¼Œä½†ä½œä¸ºä»£ä»·ï¼Œä½ è‡ªèº«çš„æƒ…æ„Ÿä¼šå˜å¾—éº»æœ¨ã€‚", effects: "æš—ç¤ºå¢å¼º" },

                { title: "æ“æ§ç•¸å˜", description: "è¢«æ“æ§çš„æ•Œäººè‹¥æ„è¯†åˆ°è‡ªå·±è¢«æ“çºµï¼Œä¼šç«‹åˆ»æŒ£è„±æ§åˆ¶å¹¶å¯¹ä½ å‘åŠ¨ä¸€æ¬¡æ€§çš„å¼ºçƒˆåå‡»ã€‚", effects: "æ“æ§åå™¬" },

                { title: "å¸æ”¶ç•¸å˜", description: "å¸æ”¶çš„'çˆ±æ„'ä¼šåœ¨ä½ èº«ä¸Šç•™ä¸‹ä¸€ä¸ªæ— æ³•æ¶ˆé™¤çš„ç‰¹æ®Šå°è®°ï¼Œæˆä¸ºä½ çš„ä¸€ä¸ªå¼±ç‚¹ã€‚", effects: "çˆ±æ„å°è®°" }

              ],

              authority: [

                { title: "æš—ç¤ºæƒæŸ„", description: "ä½ å¯ä»¥å¯¹NPCä¸‹è¾¾ä¸€å¥å®Œæ•´çš„ã€éè‡ªæ€æ€§çš„æŒ‡ä»¤ï¼Œåªè¦å…¶æ„å¿—åŠ›ä½äºä½ ã€‚", effects: "å®Œæ•´æŒ‡ä»¤" },

                { title: "æ“æ§æƒæŸ„", description: "ä½ å¯ä»¥åŒæ—¶æ“æ§ä¸¤åè¢«å‡»è´¥çš„æ•Œäººï¼Œä½†æœŸé—´ä½ å¿…é¡»ä¿æŒä¸“æ³¨ï¼Œæ— æ³•ç§»åŠ¨æˆ–æ”»å‡»ã€‚", effects: "åŒé‡æ“æ§" },

                { title: "å¸æ”¶æƒæŸ„", description: "ä½ å¯ä»¥å¼ºè¡Œå¸æ”¶NPCçš„'çˆ±æ„'ï¼Œå¹¶æ ¹æ®å…¶ç‰¹è´¨è·å¾—ä¸€é¡¹ä¸´æ—¶çš„ç‰¹æ®Šèƒ½åŠ›ã€‚", effects: "å¼ºåˆ¶å¸æ”¶" }

              ],

              abyss: [

                { title: "æš—ç¤ºæ·±æ¸Š", description: "ä½ çš„å­˜åœ¨æœ¬èº«å°±æˆä¸ºä¸€ç§å¿ƒç†æš—ç¤ºï¼Œå¼±è€…ä¼šä¸è‡ªè§‰åœ°æœä»ä½ ï¼Œä½†ä½ ä¹Ÿå°†å½»åº•å¤±å»æ‰€æœ‰ä¸ªäººæƒ…æ„Ÿã€‚", effects: "å­˜åœ¨æš—ç¤º" },

                { title: "æ“æ§æ·±æ¸Š", description: "ä½ å¯ä»¥å°†æ„è¯†å®Œå…¨æ³¨å…¥ä¸€ä¸ªå¼ºå¤§çš„æ•Œäººä½“å†…è¿›è¡Œæ“æ§ï¼Œä½†è‹¥å…¶è¢«æ‘§æ¯ï¼Œä½ çš„ç²¾ç¥ä¹Ÿä¼šé­å—é‡åˆ›ã€‚", effects: "æ„è¯†æ³¨å…¥" },

                { title: "å¸æ”¶æ·±æ¸Š", description: "ä½ ä¸€æ¬¡æ€§å¸æ”¶å¤§é‡'çˆ±æ„'è·å¾—å¼ºå¤§åŠ›é‡ï¼Œä½†è¿™ä»½çˆ±ä¼šç«‹åˆ»è½¬åŒ–ä¸ºè‡´å‘½çš„æ¨æ„ï¼Œæˆä¸ºé”å®šä½ çš„è¯…å’’ã€‚", effects: "çˆ±æ„è¯…å’’" }

              ]

            },

            'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰': {

              seed: [

                { title: "ç›”ç”²å»¶ä¼¸", description: "å½“ä½ å¹»æƒ³'è¢«ä¿æŠ¤'æ—¶ï¼Œä½ çš„çš®è‚¤ä¼šçŸ­æš‚åœ°æ³›èµ·ä¸€å±‚å¾®ä¸å¯è§çš„é’»çŸ³å…‰æ³½ã€‚", effects: "é’»çŸ³å…‰æ³½" },

                { title: "æˆ’æŒ‡å»¶ä¼¸", description: "å½“ä½ å¯¹æŸäººäº§ç”Ÿå¼ºçƒˆçš„'æ‰¿è¯º'å¹»æƒ³æ—¶ï¼Œä½ çš„æŒ‡å°–ä¼šæ„Ÿåˆ°äº›å¾®å†°å‡‰çš„æŸç¼šæ„Ÿã€‚", effects: "æ‰¿è¯ºæŸç¼š" },

                { title: "NPCå»¶ä¼¸", description: "åœ¨ä½ æåº¦å­¤ç‹¬æ—¶ï¼Œä½ ä¼šå¬åˆ°ä¸€ä¸ªæ¨¡ç³Šè€Œå®Œç¾çš„ã€åªå­˜åœ¨äºä½ è„‘æµ·ä¸­çš„å£°éŸ³åœ¨å®‰æ…°ä½ ã€‚", effects: "å®Œç¾å£°éŸ³" }

              ],

              growth: [

                { title: "ç›”ç”²å…·ç°", description: "ä½ å¯ä»¥æ¶ˆè€—ç²¾ç¥åŠ›ï¼Œåœ¨ä½ èº«ä½“çš„æŸä¸ªéƒ¨ä½å…·ç°åŒ–ä¸€å—è½»å‹ç›”ç”²ï¼Œç”¨äºæ ¼æŒ¡ä¸€æ¬¡æ”»å‡»ã€‚", effects: "è½»å‹ç›”ç”²" },

                { title: "æˆ’æŒ‡å…·ç°", description: "ä½ å¯ä»¥å…·ç°åŒ–ä¸€æšè™šå¹»çš„æˆ’æŒ‡æˆ´åœ¨æ‰‹ä¸Šï¼Œå®ƒèƒ½è®©ä½ åœ¨è¿›è¡Œè¯´æœæˆ–äº¤æ¶‰æ—¶ï¼Œè¨€è¯­æ›´å…·åˆ†é‡ã€‚", effects: "è™šå¹»æˆ’æŒ‡" },

                { title: "NPCå…·ç°", description: "ä½ å¯ä»¥çŸ­æš‚å…·ç°åŒ–ä¸€ä¸ªå®Œç¾çš„ã€åŠé€æ˜çš„NPCå¹»å½±ï¼Œç”¨äºå¸å¼•æ•Œäººçš„æ³¨æ„åŠ›ã€‚", effects: "å®Œç¾å¹»å½±" }

              ],

              mutation: [

                { title: "ç›”ç”²ç•¸å˜", description: "å…·ç°åŒ–çš„ç›”ç”²å¼€å§‹å¯¹ä½ äº§ç”Ÿ'çˆ±æ„'ï¼Œåªæœ‰å½“ä½ ä¹Ÿå¯¹å…¶æŠ¥ä»¥'çˆ±æ„'æ—¶ï¼Œå®ƒæ‰ä¼šä¸ºä½ å¸æ”¶ä¼¤å®³ã€‚", effects: "ç›”ç”²çˆ±æ„" },

                { title: "æˆ’æŒ‡ç•¸å˜", description: "å¦‚æœä½ è¿èƒŒäº†æˆ´ä¸Šæˆ’æŒ‡æ—¶è®¸ä¸‹çš„æ‰¿è¯ºï¼Œæˆ’æŒ‡ä¼šåŒ–ä¸ºä¸€é“çœŸå®çš„æ·é”ï¼ŒæŸç¼šä½ çš„æ‰‹è…•ã€‚", effects: "æ‰¿è¯ºæ·é”" },

                { title: "NPCç•¸å˜", description: "å…·ç°åŒ–çš„å®Œç¾NPCå¼€å§‹æ¶ˆè€—ä½ çœŸå®çš„'çˆ±æ„'æ¥ç»´æŒå½¢æ€ï¼Œå¹¶ä¼šå«‰å¦’ä½ ä¸å…¶ä»–çœŸå®äººç±»çš„äº¤å¾€ã€‚", effects: "NPCå«‰å¦’" }

              ],

              authority: [

                { title: "ç›”ç”²æƒæŸ„", description: "ä½ å¯ä»¥å…·ç°åŒ–ä¸€å¥—è¦†ç›–å…¨èº«çš„ç›”ç”²ï¼Œä½†ç›”ç”²ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œä¸æ–­å˜é‡ï¼Œæœ€ç»ˆé™åˆ¶ä½ çš„è¡ŒåŠ¨ã€‚", effects: "å…¨èº«ç›”ç”²" },

                { title: "æˆ’æŒ‡æƒæŸ„", description: "ä½ å¯ä»¥å…·ç°åŒ–ä¸€æšæ‹¥æœ‰å¼ºå¤§åŠ›é‡çš„æˆ’æŒ‡ï¼Œä½†å®ƒçš„åŠ›é‡å®Œå…¨å–å†³äºä½ å¯¹'ç†æƒ³ä¹‹çˆ±'çš„ä¿¡å¿µå¼ºåº¦ã€‚", effects: "åŠ›é‡æˆ’æŒ‡" },

                { title: "NPCæƒæŸ„", description: "ä½ å¯ä»¥å…·ç°åŒ–ä¸€ä¸ªæ‹¥æœ‰å®ä½“å’Œç®€å•è‡ªä¸»èƒ½åŠ›çš„å®Œç¾NPCï¼Œä»–ä¼šæ— æ¡ä»¶å¸®åŠ©ä½ ï¼Œä½†æ— æ³•ç†è§£ä»»ä½•çœŸå®çš„æƒ…æ„Ÿã€‚", effects: "å®ä½“NPC" }

              ],

              abyss: [

                { title: "ç›”ç”²æ·±æ¸Š", description: "å…·ç°åŒ–çš„ç›”ç”²ä¸ä½ çš„è¡€è‚‰å½»åº•èåˆï¼Œä¸ºä½ æä¾›æ°¸æ’çš„ä¿æŠ¤ï¼Œä»£ä»·æ˜¯ä½ ä¹Ÿæˆä¸ºäº†è¿™å‰¯ç›”ç”²çš„å›šå¾’ï¼Œæ°¸è¿œæ— æ³•è„±ä¸‹ã€‚", effects: "è¡€è‚‰èåˆ" },

                { title: "æˆ’æŒ‡æ·±æ¸Š", description: "ä½ å°†è‡ªå·±çš„çµé­‚ä¸æˆ’æŒ‡ç»‘å®šï¼Œè·å¾—äº†ä¿®æ”¹ç°å®çš„åŠ›é‡ï¼Œä½†ä½ è‡ªèº«çš„å­˜åœ¨ä¹Ÿå˜å¾—å¦‚å¹»æƒ³èˆ¬è™šæ— ï¼Œé€æ¸è¢«ä¸–ç•Œé—å¿˜ã€‚", effects: "çµé­‚ç»‘å®š" },

                { title: "NPCæ·±æ¸Š", description: "ä½ å…·ç°åŒ–çš„å®Œç¾NPCå–ä»£äº†ä½ åœ¨ç°å®ä¸­çš„ä½ç½®ï¼Œè€Œä½ åˆ™æˆä¸ºäº†ä»–å¹»æƒ³ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œæ´»åœ¨ä»–ä¸ºä½ æ„å»ºçš„ç†æƒ³ä¸–ç•Œé‡Œã€‚", effects: "ä½ç½®äº’æ¢" }

              ]

            },

            'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰': {

              seed: [

                { title: "å¥‘çº¦èŒèŠ½", description: "ä½ èƒ½å¬åˆ°ç©ºé—´è£‚ç¼ä¸­ä¼ æ¥çš„ã€ä½æ²‰çš„'è§„åˆ™æ€ªè°ˆ'çš„å‘“è¯­ï¼Œå®ƒä»¬åœ¨å¼•è¯±ä½ ç­¾è®¢å¥‘çº¦ã€‚", effects: "æ€ªè°ˆå‘“è¯­" },

                { title: "å…±é¸£èŒèŠ½", description: "å½“ä½ ä¸ä¸€ä¸ªNPCäº§ç”Ÿå¼ºçƒˆæƒ…ç»ªäº¤é›†æ—¶ï¼Œä½ èƒ½çŸ­æš‚åœ°ï¼ˆçº¦1ç§’ï¼‰æ„Ÿå—åˆ°å¯¹æ–¹æ­¤åˆ»æœ€æ ¸å¿ƒçš„æƒ…ç»ªã€‚", effects: "æƒ…ç»ªå…±é¸£" },

                { title: "æ··åˆèŒèŠ½", description: "ä½ å¯¹æ‰€æœ‰'çˆ±æ„'çš„æ„ŸçŸ¥éƒ½å¸¦æœ‰ä¸€ç§ä¸å’Œè°çš„ç‹¬ç‰¹æ„Ÿï¼Œä»¿ä½›å®ƒä»¬æ˜¯æŸç§æ›´å±é™©äº‹ç‰©çš„ä¼ªè£…ã€‚", effects: "ç‹¬ç‰¹æ„ŸçŸ¥" }

              ],

              growth: [

                { title: "å¥‘çº¦ç­¾è®¢", description: "ä½ å¯ä»¥çŒ®ç¥­è‡ªå·±çš„ä¸€é¡¹æ„Ÿå®˜ï¼ˆå¦‚å—…è§‰ã€è‰²è§‰ï¼‰ä½œä¸ºä»£ä»·ï¼Œä¸ä¸€ä¸ªä½é˜¶è§„åˆ™æ€ªè°ˆç­¾è®¢ä¸´æ—¶å¥‘çº¦ï¼Œè·å¾—ä¸€æ¬¡æ€§çš„ã€å¾®å°çš„ç°å®åˆ«æ ·èƒ½åŠ›ã€‚", effects: "æ„Ÿå®˜çŒ®ç¥­" },

                { title: "å…±é¸£å¤åˆ¶", description: "ä½ å¯ä»¥ä¸»åŠ¨ä¸ä¸€åNPCè¿›è¡Œæƒ…ç»ªå…±é¸£ï¼Œéšæœºå¤åˆ¶å…¶ä¸€é¡¹æœ€åŸºç¡€çš„éæˆ˜æ–—èƒ½åŠ›ï¼ŒæŒç»­5åˆ†é’Ÿã€‚", effects: "èƒ½åŠ›å¤åˆ¶" },

                { title: "æƒ…æ„Ÿäº¤æ˜“", description: "ä½ å¯ä»¥å°†ä¸€ä»½çœŸå®çš„'çˆ±æ„'ä½œä¸ºå•†å“ï¼Œä¸å…¶ä»–å­˜åœ¨äº¤æ˜“ï¼Œæ¢å–ä¸€ä¸ªæ— æ³•é¢„æµ‹æ•ˆæœçš„'ç¥ç¦'æˆ–'è¯…å’’'ã€‚", effects: "çˆ±æ„äº¤æ˜“" }

              ],

              mutation: [

                { title: "å¥‘çº¦ç•¸å˜", description: "å¥‘çº¦çš„åŠ›é‡å¼€å§‹ä¾µèš€ä½ çš„è®¤çŸ¥ï¼Œä½ çœ‹åˆ°çš„ç°å®ä¸–ç•Œä¼šéšæœºå‡ºç°ç¬¦åˆæ€ªè°ˆé€»è¾‘çš„ã€æ— å®³çš„å¹»è§‰ã€‚", effects: "è®¤çŸ¥ä¾µèš€" },

                { title: "å…±é¸£ç•¸å˜", description: "å…±é¸£ç»“æŸæ—¶ï¼Œä½ ä¸ä»…è¦æ‰¿å—å¯¹æ–¹çš„æ‰€æœ‰ç—›è‹¦ï¼Œå…¶æœ€å¼ºçƒˆçš„ä¸€ç§è´Ÿé¢æƒ…ç»ªè¿˜ä¼šåœ¨ä½ å¿ƒä¸­æ®‹ç•™ä¸€å°æ—¶ã€‚", effects: "ç—›è‹¦æ®‹ç•™" },

                { title: "ä»£ä»·å¼‚åŒ–", description: "ä½ ä¸ºè·å¾—åŠ›é‡è€Œä»˜å‡ºçš„'ä»£ä»·'ï¼ˆå¦‚å¤±å»çš„æ„Ÿå®˜ï¼‰ï¼Œä¼šä»¥ä¸€ç§ç‹¬ç‰¹çš„å½¢å¼åœ¨ä½ èº«ä½“å‘¨å›´é‡ç°ï¼Œå½¢æˆä¸€ä¸ªå¯è§çš„ã€ä»¤äººä¸å®‰çš„å…‰ç¯ã€‚", effects: "ä»£ä»·å…‰ç¯" }

              ],

              authority: [

                { title: "å¥‘çº¦æƒæŸ„", description: "ä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªå¼ºå¤§çš„è§„åˆ™æ€ªè°ˆï¼Œé€šè¿‡çŒ®ç¥­ä¸€é¡¹æ°¸ä¹…çš„èº«ä½“èƒ½åŠ›ï¼ˆå¦‚å¥”è·‘èƒ½åŠ›ï¼‰ï¼Œæ¢å–ä¸€æ¬¡ç¬é—´é€†è½¬å±€åŠ¿çš„å·¨å¤§åŠ›é‡ã€‚", effects: "èƒ½åŠ›çŒ®ç¥­" },

                { title: "å…±é¸£æƒæŸ„", description: "ä½ å¯ä»¥æŒ‡å®šå¤åˆ¶NPCçš„ä¸€é¡¹å¼ºå¤§èƒ½åŠ›ï¼Œä½†ä½œä¸ºä»£ä»·ï¼Œä½ çš„äººæ ¼ä¼šæš‚æ—¶è¢«å¯¹æ–¹çš„æ€§æ ¼ç‰¹è´¨æ‰€è¦†ç›–ã€‚", effects: "äººæ ¼è¦†ç›–" },

                { title: "ä¸å‡¡è§„åˆ™", description: "ä½ å¯ä»¥å°†ä¸¤ç§ä¸ç›¸å…³çš„'çˆ±æ„'èƒ½åŠ›è¿›è¡Œæ··åˆï¼Œåˆ›é€ å‡ºä¸€ä¸ªå…¨æ–°çš„ã€æ•ˆæœå¼ºå¤§ä½†å®Œå…¨ä¸å¯æ§çš„ä¸€æ¬¡æ€§æŠ€èƒ½ã€‚", effects: "èƒ½åŠ›æ··åˆ" }

              ],

              abyss: [

                { title: "å¥‘çº¦æ·±æ¸Š", description: "ä½ å°†è‡ªå·±ä½œä¸ºæœ€ç»ˆçš„ç¥­å“ï¼Œä¸ä¸€ä¸ªè§„åˆ™æ€ªè°ˆæœ¬èº«èä¸ºä¸€ä½“ï¼Œæˆä¸ºæ–°çš„æ€ªè°ˆï¼Œæ‹¥æœ‰åˆ¶å®šè§„åˆ™çš„åŠ›é‡ï¼Œä½†å½»åº•å¤±å»äººæ€§ã€‚", effects: "æ€ªè°ˆèåˆ" },

                { title: "å…±é¸£æ·±æ¸Š", description: "ä½ å¯ä»¥ä¸ä¸€ä¸ªç›®æ ‡è¿›è¡Œæ°¸ä¹…çš„æƒ…ç»ªå…±é¸£ï¼Œå®Œå…¨å¤åˆ¶å…¶æ‰€æœ‰èƒ½åŠ›ä¸è®°å¿†ï¼Œä½†ä½ çš„'è‡ªæˆ‘'ä¹Ÿå°†è¢«å¯¹æ–¹å®Œå…¨åŒåŒ–ï¼Œæˆä¸ºå…¶å½±å­ã€‚", effects: "å®Œå…¨åŒåŒ–" },

                { title: "æ··æ²ŒåŒ–èº«", description: "ä½ æˆä¸ºäº†'ç‹¬ç‰¹ä¹‹çˆ±'çš„åŒ–èº«ï¼Œèƒ½å¤Ÿéšæ„ç»„åˆæ‰€æœ‰çˆ±æ„èƒ½åŠ›ï¼Œä½†æ¯ä¸€æ¬¡ä½¿ç”¨éƒ½ä¼šè®©ä½ çš„å­˜åœ¨æœ¬èº«å˜å¾—æ›´åŠ æ··ä¹±å’Œä¸å¯åçŠ¶ï¼Œæœ€ç»ˆèµ°å‘å½»åº•çš„ç†µå¢ä¸æ¶ˆæ•£ã€‚", effects: "æ··æ²ŒåŒ–èº«" }

              ]

            }

          };



          return talentOptions[majorTalent]?.[level] || talentOptions['å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰'][level];

        }



        // å¤§å¤©èµ‹æè¿°è¯æ˜ å°„

        getMajorTalentDescription(majorTalent) {

          const descriptions = {

            'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰': {

              name: 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰',

              description: 'é€šè¿‡ç‹¬å å’Œæ§åˆ¶æ¥å¼ºåŒ–è‡ªèº«ã€‚åŠ›é‡æºäºå¯¹æŸç‰©çš„å¼ºçƒˆå æœ‰æ¬²ã€‚',

              positive: 'èƒ½å¤Ÿçœ‹ç©¿è§„åˆ™æ¼æ´ï¼Œæ‰¾åˆ°éšè—å¼±ç‚¹ï¼›çŸ­æ—¶é—´å†…å¤§å¹…æå‡é˜²å¾¡åŠ›ï¼›å…·ç°åŒ–æ— å½¢é”é“¾é”å®šç›®æ ‡ã€‚',

              negative: 'èƒ½åŠ›è¶Šå¼ºï¼Œå¯¹"çˆ±äºº"çš„ä¾èµ–å’ŒæŸç¼šè¶Šæ·±ï¼Œæœ€ç»ˆå¤±å»è‡ªæˆ‘ï¼›è§†é‡å˜å¾—ç‹­çª„ï¼›æ¯æ¬¡ä½¿ç”¨ç•™ä¸‹"ä¼¤ç—•"ï¼›é”é“¾ä¼šåå™¬è‡ªèº«ã€‚'

            },

            'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰': {

              name: 'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰',

              description: 'å°†è°è¨€å’Œæ¬ºéª—è½¬åŒ–ä¸ºç°å®ã€‚åŠ›é‡æ˜¯ä¸ç¨³å®šçš„ï¼Œéšç€æ¬ºéª—è€Œæ”¹å˜ã€‚',

              positive: 'æš‚æ—¶ä¿®æ”¹è§„åˆ™æè¿°ä½¿å…¶æœ‰åˆ©ï¼›å°†è°è¨€å…·è±¡åŒ–ä¸ºéº»ç—¹æ•Œäººçš„æƒ…æ„Ÿï¼›åˆ›é€ è™šå‡"å½±å­"æ‰¿å—ä¼¤å®³ã€‚',

              negative: 'æ‰€è¯´çš„ä¸€åˆ‡è°è¨€éƒ½ä¼šæ‰­æ›²å…·ç°åŒ–æˆä¸ºæ–°çš„å±é™©ï¼›è§„åˆ™å˜å¾—ä¸ç¨³å®šå¯èƒ½åå™¬ï¼›è°è¨€è¢«è¯†ç ´æ—¶æƒ…æ„Ÿå˜ä¸ºè‡´å‘½æ¯’è¯ï¼›å½±å­æ‰¿å—çš„ä¼¤å®³ä¼šå åŠ çˆ†å‘ã€‚'

            },

            'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰': {

              name: 'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰',

              description: 'é€šè¿‡è‡ªæˆ‘ç‰ºç‰²æ¥å½±å“ä»–äººæˆ–ç¯å¢ƒã€‚åŠ›é‡æ˜¯æ— ç§çš„ï¼Œå´ä»¥è‡ªå·±çš„"å¤±å»"ä¸ºä»£ä»·ã€‚',

              positive: 'é‡Šæ”¾æƒ…ç»ªä½¿æ•Œäººå¤±å»æ”»å‡»æ€§ï¼›æ¶ˆè€—ç”Ÿå‘½æˆ–è®°å¿†ä¿®æ”¹è§„åˆ™ï¼›å…·ç°åŒ–åˆ†èº«æ‰§è¡Œä»»åŠ¡ã€‚',

              negative: 'æ¯ä¸€æ¬¡ç‰ºç‰²éƒ½ä¼šæ°¸ä¹…å‰Šå¼±è‡ªèº«ï¼›ç²¾ç¥åŠ›ä¸Šé™æ°¸ä¹…é™ä½ï¼›ä¿®æ”¹çš„è§„åˆ™ä¼šä»¥æ›´å¼ºå½¢æ€å›å½’ï¼›åˆ†èº«è¢«æ‘§æ¯æ—¶ä¸€åŒæ­»äº¡ã€‚'

            },

            'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰': {

              name: 'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰',

              description: 'é€šè¿‡ç²¾ç¥æ§åˆ¶å’Œæƒ…æ„Ÿæ“çºµæ¥å¥´å½¹ä»–äººã€‚åŠ›é‡æºäºå¯¹ä»–äººçš„ç»å¯¹æ§åˆ¶ã€‚',

              positive: 'ç»™NPCæ–½åŠ å¿ƒç†æš—ç¤ºä½¿å…¶æœä»ï¼›æ“æ§è¢«å‡»è´¥çš„æ•Œäººä¸ºä½ æˆ˜æ–—ï¼›å¸æ”¶NPC"çˆ±æ„"è·å¾—ç‰¹æ®Šèƒ½åŠ›ã€‚',

              negative: 'æ§åˆ¶çš„è¶Šå¤šè‡ªèº«æƒ…æ„Ÿè¶Šéº»æœ¨ï¼›NPCæ„è¯†åˆ°è¢«æ“çºµæ—¶å¼•å‘å¼ºçƒˆåå™¬ï¼›å¿…é¡»ä¸“æ³¨æ“æ§æ— æ³•ä½¿ç”¨å…¶ä»–èƒ½åŠ›ï¼›å¸æ”¶çš„"çˆ±æ„"ç•™ä¸‹æ‰­æ›²å°è®°æˆä¸ºå¼±ç‚¹ã€‚'

            },

            'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰': {

              name: 'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰',

              description: 'å°†æƒ³è±¡ä¸­çš„å®Œç¾ä¹‹çˆ±å…·ç°åŒ–ä¸ºå®ç‰©ã€‚åŠ›é‡æ¥æºäºå¯¹å®Œç¾çš„å¹»æƒ³ã€‚',

              positive: 'å…·ç°åŒ–è½»å‹ç›”ç”²å¸æ”¶ä¼¤å®³ï¼›å…·ç°åŒ–æˆ’æŒ‡è·å¾—å¼ºå¤§åŠ›é‡ï¼›å…·ç°åŒ–å®Œç¾NPCæ— æ¡ä»¶å¸®åŠ©ã€‚',

              negative: 'å…·ç°åŒ–ç‰©å“åªå¯¹"çˆ±æ„"ååº”å¹¶é€æ¸å–ä»£ç°å®ï¼›ç›”ç”²é€æ¸å˜é‡é™åˆ¶è¡ŒåŠ¨ï¼›è¿èƒŒæ‰¿è¯ºæˆ’æŒ‡åŒ–ä¸ºæ·é”ï¼›å®Œç¾NPCæ¶ˆè€—å¤§é‡"çˆ±"ä¸”æ— æ³•ç†è§£çœŸå®æƒ…æ„Ÿã€‚'

            },

            'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰': {

              name: 'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰',

              description: 'æ‹¥æœ‰ç‹¬ä¸€æ— äºŒçš„ã€è¶…è¶Šå¸¸è§„çš„æ‰­æ›²èƒ½åŠ›ã€‚åŠ›é‡æ˜¯ä¸å¯é¢„çŸ¥çš„ï¼Œé€šå¸¸æ˜¯ä»¥ä¸Šäº”ç§çˆ±æ„çš„æ··åˆæˆ–å˜å¼‚ã€‚',

              positive: 'ä¸å¼ºå¤§è§„åˆ™æ€ªè°ˆç­¾è®¢å¥‘çº¦è·å¾—ç¬é—´å·¨å¤§åŠ›é‡ï¼›ä¸NPCæƒ…ç»ªå…±é¸£å¤åˆ¶å…¶èƒ½åŠ›ã€‚',

              negative: 'èƒ½åŠ›ä¼´éšæœ€ä¸å¯æ§çš„é£é™©å’Œæœ€æ·±çš„å¼‚åŒ–ï¼›å¿…é¡»ä»¥æŸéƒ¨åˆ†ä¸ºä»£ä»·ï¼›å…±é¸£ç»“æŸæ—¶æ‰¿å—æ‰€æœ‰ç—›è‹¦ã€‚'

            }

          };

          return descriptions[majorTalent] || descriptions['å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰'];

        }



        // è·å–å½“å‰é€‰æ‹©çš„å¤§å¤©èµ‹æ–¹å‘

        getCurrentMajorTalent() {

          try {

            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {

              const mvuData = Mvu.getMvuData({ type: 'chat' });

              return Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name[0]', { default_value: 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰' });

            }

          } catch (error) {

            console.warn('è·å–å¤§å¤©èµ‹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);

          }

          return 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰';

        }



        updateUpgradeHistory() {

          const container = document.getElementById('upgrade-history');

          if (!container) return;



          try {

            let acquiredTalents = [];



            // ä»MVUå˜é‡è¯»å–å·²è·å¾—çš„å¤©èµ‹

            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {

              const mvuData = Mvu.getMvuData({ type: 'chat' });

              const levels = ['èŒèŠ½', 'ç”Ÿé•¿', 'ç•¸å˜', 'æƒæŸ„', 'æ·±æ¸Š'];

              

              levels.forEach(level => {

                const talent = Mvu.getMvuVariable(mvuData, `è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.${level}[0]`, { default_value: null });

                if (talent) {

                  acquiredTalents.push({

                    level: level,

                    title: talent

                  });

                }

              });

            }



            if (acquiredTalents.length === 0) {

              container.innerHTML = '<div style="text-align: center; color: #666666; font-style: italic; padding: 50px;">æš‚æ— å‡çº§è®°å½•</div>';

              return;

            }



            let html = '';

            acquiredTalents.forEach((talent, index) => {

              html += `

                <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 10px;">

                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">

                    <span style="color: #22c55e; font-size: 16px; font-weight: bold;">${talent.level} - ${talent.title}</span>

                  </div>

                </div>

              `;

            });



            container.innerHTML = html;

          } catch (error) {

            console.error('æ›´æ–°å‡çº§è®°å½•å¤±è´¥:', error);

            container.innerHTML = '<div style="text-align: center; color: #666666; font-style: italic; padding: 50px;">åŠ è½½å¤±è´¥</div>';

          }

        }



        // å½“å‰é¡µé¢ç´¢å¼•

        currentTalentPage = 0;

        

        // é¡µé¢æ ‡é¢˜æ•°ç»„

        talentPageTitles = [

          'ğŸ“– å½“å‰å¤©èµ‹',

          'ğŸŒ± èŒèŠ½',

          'ğŸŒ¿ ç”Ÿé•¿', 

          'ğŸŒ€ ç•¸å˜',

          'ğŸ‘‘ æƒæŸ„',

          'ğŸŒŒ æ·±æ¸Š',

          'ğŸ“š å‡çº§è®°å½•'

        ];



        switchTalentPage(page) {

          // æ’­æ”¾ç¿»é¡µå£°éŸ³
          const sound = document.getElementById('page-flip-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('ç¿»é¡µéŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
          }
          
          // éšè—æ‰€æœ‰é¡µé¢

          const pages = document.querySelectorAll('.book-page');

          pages.forEach(p => p.style.display = 'none');



          // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€

          const buttons = document.querySelectorAll('.page-btn');

          buttons.forEach(btn => {

            btn.classList.remove('active');

            btn.style.background = 'rgba(139, 69, 19, 0.3)';

            btn.style.border = '2px solid rgba(139, 69, 19, 0.5)';

            btn.style.color = '#8b4513';

          });



          // æ˜¾ç¤ºé€‰ä¸­çš„é¡µé¢

          const targetPage = document.getElementById(`page-${page}-content`);

          if (targetPage) {

            targetPage.style.display = 'block';

          }



          // æ¿€æ´»é€‰ä¸­çš„æŒ‰é’®

          const targetBtn = document.getElementById(`page-${page}`);

          if (targetBtn) {

            targetBtn.classList.add('active');

            targetBtn.style.background = 'linear-gradient(135deg, #8b4513, #a0522d)';

            targetBtn.style.border = '2px solid #8b4513';

            targetBtn.style.color = '#ffffff';

          }

        }



        // ç¿»é¡µåˆ°æŒ‡å®šé¡µé¢

        goToTalentPage(pageIndex) {

          if (pageIndex < 0 || pageIndex >= this.talentPageTitles.length) return;

          
          // æ’­æ”¾ç¿»é¡µå£°éŸ³
          const sound = document.getElementById('page-flip-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('ç¿»é¡µéŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
          }
          

          this.currentTalentPage = pageIndex;

          

          // æ›´æ–°å®¹å™¨ä½ç½®

          const container = document.getElementById('book-pages-container');

          if (container) {

            container.style.transform = `translateX(-${pageIndex * 100}%)`;

          }

          

          // æ›´æ–°é¡µé¢æŒ‡ç¤ºå™¨

          this.updatePageIndicator();

          

          // æ›´æ–°æŒ‰é’®çŠ¶æ€

          this.updatePageButtons();

          

          // æ›´æ–°å½“å‰é¡µé¢çš„é€‰é¡¹

          this.updateCurrentPageOptions();

        }



        // ä¸Šä¸€é¡µ

        prevTalentPage() {

          if (this.currentTalentPage > 0) {

            // æ’­æ”¾ç¿»é¡µå£°éŸ³
            const sound = document.getElementById('page-flip-sound');
            if (sound) {
              sound.currentTime = 0;
              sound.play().catch(e => console.log('ç¿»é¡µéŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
            }
            this.goToTalentPage(this.currentTalentPage - 1);

          }

        }



        // ä¸‹ä¸€é¡µ

        nextTalentPage() {

          if (this.currentTalentPage < this.talentPageTitles.length - 1) {

            const nextPage = this.currentTalentPage + 1;

            const nextLevel = this.getLevelByPageIndex(nextPage);

            

            // æ£€æŸ¥ä¸‹ä¸€å±‚çº§æ˜¯å¦å·²è§£é”

            if (nextLevel && !this.isLevelUnlocked(nextLevel)) {

              const previousLevel = this.getPreviousLevel(nextLevel);

              const previousLevelChinese = this.getLevelChineseName(previousLevel);

              alert(`æ— æ³•è®¿é—®è¯¥å±‚çº§ï¼\n\néœ€è¦å…ˆå®Œæˆ ${previousLevelChinese} å±‚çº§çš„å¤©èµ‹é€‰æ‹©ã€‚\n\nè¯·è¿”å›ä¸Šä¸€é¡µé€‰æ‹©å¤©èµ‹ã€‚`);

              return;

            }

            

            // æ’­æ”¾ç¿»é¡µå£°éŸ³
            const sound = document.getElementById('page-flip-sound');
            if (sound) {
              sound.currentTime = 0;
              sound.play().catch(e => console.log('ç¿»é¡µéŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
            }
            this.goToTalentPage(nextPage);

          }

        }



        // æ›´æ–°é¡µé¢æŒ‡ç¤ºå™¨

        updatePageIndicator() {

          const titleElement = document.getElementById('current-page-title');

          const numberElement = document.getElementById('page-number');

          

          if (titleElement) {

            titleElement.textContent = this.talentPageTitles[this.currentTalentPage];

          }

          

          if (numberElement) {

            numberElement.textContent = `ç¬¬ ${this.currentTalentPage + 1} é¡µ / å…± ${this.talentPageTitles.length} é¡µ`;

          }

        }



        // æ›´æ–°ç¿»é¡µæŒ‰é’®çŠ¶æ€

        updatePageButtons() {

          const prevBtn = document.getElementById('prev-page-btn');

          const nextBtn = document.getElementById('next-page-btn');

          

          if (prevBtn) {

            prevBtn.disabled = this.currentTalentPage === 0;

            prevBtn.style.opacity = this.currentTalentPage === 0 ? '0.5' : '1';

          }

          

          if (nextBtn) {

            const nextPage = this.currentTalentPage + 1;

            const nextLevel = this.getLevelByPageIndex(nextPage);

            

            // æ£€æŸ¥ä¸‹ä¸€å±‚çº§æ˜¯å¦å·²è§£é”

            const isNextLevelUnlocked = !nextLevel || this.isLevelUnlocked(nextLevel);

            const isLastPage = this.currentTalentPage === this.talentPageTitles.length - 1;

            

            nextBtn.disabled = isLastPage || !isNextLevelUnlocked;

            nextBtn.style.opacity = (isLastPage || !isNextLevelUnlocked) ? '0.5' : '1';

            

            // å¦‚æœä¸‹ä¸€å±‚çº§æœªè§£é”ï¼Œæ·»åŠ æç¤º

            if (!isLastPage && !isNextLevelUnlocked) {

              nextBtn.title = `éœ€è¦å…ˆå®Œæˆ ${this.getLevelChineseName(this.getPreviousLevel(nextLevel))} å±‚çº§`;

            } else {

              nextBtn.title = '';

            }

          }

        }



        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬

        addKeyboardListeners() {

          this.keyboardHandler = (e) => {

            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {

              e.preventDefault();

              this.prevTalentPage();

            } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {

              e.preventDefault();

              this.nextTalentPage();

            } else if (e.key === 'Escape') {

              e.preventDefault();

              this.closeTalentsModal();

            }

          };

          

          document.addEventListener('keydown', this.keyboardHandler);

        }



        // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬

        removeKeyboardListeners() {

          if (this.keyboardHandler) {

            document.removeEventListener('keydown', this.keyboardHandler);

            this.keyboardHandler = null;

          }

        }



        // å…³é—­å¤©èµ‹æ¨¡æ€æ¡†

        closeTalentsModal() {

          const modal = document.getElementById('talents-modal');

          if (modal) {

            modal.style.display = 'none';

            modal.style.justifyContent = '';

            modal.style.alignItems = '';

            this.removeKeyboardListeners();

          }

        }



        // æµ‹è¯•MVUæ³¨å…¥åŠŸèƒ½

        async testMvuInjection() {

          try {

            console.log('ğŸ§ª æµ‹è¯•MVUæ³¨å…¥åŠŸèƒ½...');

            

            if (typeof Mvu !== 'undefined' && Mvu.setMvuVariable) {

              const mvuData = Mvu.getMvuData({ type: 'chat' });

              

              // æµ‹è¯•æ³¨å…¥ä¸€ä¸ªå¤©èµ‹

              await Mvu.setMvuVariable(mvuData, 'è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.èŒèŠ½[0]', 'æµ‹è¯•å¤©èµ‹', {

                reason: 'æµ‹è¯•æ³¨å…¥',

                is_recursive: true,

              });



              await Mvu.replaceMvuData(mvuData, { type: 'chat' });

              

              console.log('âœ… MVUæ³¨å…¥æµ‹è¯•æˆåŠŸï¼');

              alert('MVUæ³¨å…¥æµ‹è¯•æˆåŠŸï¼è¯·æ£€æŸ¥å¤©èµ‹ç•Œé¢');

            } else {

              console.warn('âš ï¸ MVU API ä¸å¯ç”¨');

              alert('MVU API ä¸å¯ç”¨');

            }

          } catch (error) {

            console.error('âŒ MVUæ³¨å…¥æµ‹è¯•å¤±è´¥:', error);

            alert('MVUæ³¨å…¥æµ‹è¯•å¤±è´¥: ' + error.message);

          }

        }



        // æ£€æŸ¥MVUçŠ¶æ€

        checkMvuStatus() {

          console.log('ğŸ” æ£€æŸ¥MVUçŠ¶æ€...');

          

          // æ£€æŸ¥MVUå¯¹è±¡

          console.log('ğŸ“Š MVUå¯¹è±¡:', typeof Mvu);

          if (typeof Mvu !== 'undefined') {

            console.log('âœ… MVUå¯¹è±¡å­˜åœ¨');

            console.log('ğŸ“‹ MVUå‡½æ•°:', {

              getMvuData: typeof Mvu.getMvuData,

              setMvuVariable: typeof Mvu.setMvuVariable,

              replaceMvuData: typeof Mvu.replaceMvuData,

              getMvuVariable: typeof Mvu.getMvuVariable

            });

          } else {

            console.error('âŒ MVUå¯¹è±¡ä¸å­˜åœ¨');

          }



          // å°è¯•è·å–MVUæ•°æ®

          try {

            const mvuData = Mvu.getMvuData({ type: 'chat' });

            console.log('ğŸ“Š MVUæ•°æ®è·å–:', mvuData ? 'æˆåŠŸ' : 'å¤±è´¥');

            console.log('ğŸ“‹ MVUæ•°æ®å†…å®¹:', mvuData);

          } catch (error) {

            console.error('âŒ MVUæ•°æ®è·å–å¤±è´¥:', error);

          }



          // æ£€æŸ¥å½“å‰ç»“æ™¶æ•°é‡

          try {

            const mvuData = Mvu.getMvuData({ type: 'chat' });

            const crystals = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶[0]', { default_value: 0 });

            console.log('ğŸ’ å½“å‰ç»“æ™¶æ•°é‡:', crystals);

          } catch (error) {

            console.error('âŒ ç»“æ™¶æ•°é‡è·å–å¤±è´¥:', error);

          }



          alert('MVUçŠ¶æ€æ£€æŸ¥å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');

        }



        // æ–°å¢ï¼šé‡æ–°ç”ŸæˆAIå›ç­”

        async rerollAIResponse() {

          try {

            if (!this.lastSentPrompt) {

              alert('æ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€æ¡æŒ‡ä»¤ï¼');

              return;

            }



            // åŠ è½½è‡ªåŠ¨å­˜æ¡£

            const autoSaveData = localStorage.getItem('teresen_auto_save');

            if (autoSaveData) {

              const saveData = JSON.parse(autoSaveData);

              if (saveData.mvu_data) {

                // ç›´æ¥è®¾ç½®å˜é‡ï¼Œä¸è°ƒç”¨MVU
                this.currentMvuState = saveData.mvu_data;
                this.renderUI(this.currentMvuState.stat_data);

              }

            }



            // é‡æ–°å‘é€ä¸Šä¸€æ¡æŒ‡ä»¤

            const actionInput = document.getElementById('action-input');

            if (actionInput) {

              actionInput.value = this.lastSentPrompt;

              await this.handleActionSubmit();

            }



            alert('æ­£åœ¨é‡æ–°ç”ŸæˆAIå›ç­”...');

          } catch (error) {

            console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);

            alert('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼');

          }

        }



        // æ–°å¢ï¼šå®Œæ•´çš„å­˜æ¡£ç®¡ç†å™¨æ¨¡æ€æ¡†

        openSaveManagerModal() {

          const modalId = 'saveManagerModal';

          if (document.getElementById(modalId)) {

            return; // å·²æ‰“å¼€

          }



          const html = `

              <div id="${modalId}" class="rules-modal" style="display: flex;">

                <div class="rules-modal-content" style="max-width: 900px; width: 95%; max-height: 80vh;">

                  <div class="rules-modal-header">

                    <h2 class="rules-title">ç‰¹é›·æ£®å­¦é™¢ Â· å­˜æ¡£ç®¡ç†</h2>

                    <button class="close-rules-btn" id="closeSaveManager">Ã—</button>

                  </div>

                  <div class="rules-modal-body">

                    <div class="save-manager-toolbar" style="margin-bottom: 20px; display: flex; gap: 10px; padding: 15px; background: rgba(139, 105, 20, 0.1); border: 1px solid rgba(139, 105, 20, 0.3); border-radius: 6px;">

                      <button class="save-button" id="createSaveNow" style="background: linear-gradient(135deg, #2d1b1b, #3d2b2b); border: 1px solid #8b0000; color: #e8d5d5; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;">

                        <span style="font-size: 16px;">ğŸ’¾</span>

                        <span>ç«‹å³å­˜æ¡£</span>

                      </button>

                      <button class="save-button" id="refreshSaveList" style="background: linear-gradient(135deg, #2d1b1b, #3d2b2b); border: 1px solid #8b0000; color: #e8d5d5; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;">

                        <span style="font-size: 16px;">ğŸ”„</span>

                        <span>åˆ·æ–°åˆ—è¡¨</span>

                      </button>

                      <button class="save-button" id="rerollAIResponse" style="background: linear-gradient(135deg, #2d1b1b, #3d2b2b); border: 1px solid #8b0000; color: #e8d5d5; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;">

                        <span style="font-size: 16px;">ğŸ²</span>

                        <span>é‡æ–°ç”ŸæˆAIå›ç­”</span>

                      </button>

                    </div>

                    <div class="save-manager-sections" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

                      <div class="save-manager-section" style="background: rgba(139, 105, 20, 0.05); border: 1px solid rgba(139, 105, 20, 0.2); border-radius: 6px; padding: 15px;">

                        <h3 class="rules-section-title">ğŸ”„ è‡ªåŠ¨å­˜æ¡£</h3>

                        <div id="auto-save-container" class="save-manager-list" style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(139, 105, 20, 0.3); border-radius: 6px; padding: 10px; background: rgba(139, 105, 20, 0.05);"></div>

                      </div>

                      <div class="save-manager-section" style="background: rgba(139, 105, 20, 0.05); border: 1px solid rgba(139, 105, 20, 0.2); border-radius: 6px; padding: 15px;">

                        <h3 class="rules-section-title">ğŸ’¾ æ‰‹åŠ¨å­˜æ¡£</h3>

                        <div id="manual-save-container" class="save-manager-list" style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(139, 105, 20, 0.3); border-radius: 6px; padding: 10px; background: rgba(139, 105, 20, 0.05);"></div>

                      </div>

                    </div>

                  </div>

                </div>

              </div>

            `;



          document.body.insertAdjacentHTML('beforeend', html);



          // ç»‘å®šå…³é—­äº‹ä»¶

          document.getElementById('closeSaveManager').addEventListener('click', () => {

            document.getElementById(modalId).remove();

          });



          // ç‚¹å‡»èƒŒæ™¯å…³é—­

          document.getElementById(modalId).addEventListener('click', e => {

            if (e.target.id === modalId) {

              document.getElementById(modalId).remove();

            }

          });



          // ç»‘å®šæŒ‰é’®äº‹ä»¶

          document.getElementById('createSaveNow').addEventListener('click', async () => {

            await this.createSaveWithPrompt();

            this.loadSaveList();

          });



          document.getElementById('refreshSaveList').addEventListener('click', () => {

            this.loadSaveList();

          });



          document.getElementById('rerollAIResponse').addEventListener('click', async () => {

            await this.performReroll();

            document.getElementById(modalId).remove();

          });



          // åŠ è½½å­˜æ¡£åˆ—è¡¨

          this.loadSaveList();

        }



        // æ–°å¢ï¼šåˆ›å»ºå­˜æ¡£ï¼ˆå¸¦æç¤ºï¼‰

        async createSaveWithPrompt() {

          const saveName = prompt('è¯·è¾“å…¥å­˜æ¡£åç§°:');

          if (!saveName) return;



          try {

            const currentVariables = this.getAllVariables();

            const chatMessages = await getChatMessages(0);

            const currentMessage = chatMessages && chatMessages.length > 0 ? chatMessages[0].message : '';



            const saveData = {

              timestamp: Date.now(),

              save_name: saveName,

              mvu_data: currentVariables,

              message_content: currentMessage,

              type: 'manual',

            };



            // ç”Ÿæˆå”¯ä¸€ID

            const saveId = `save_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            localStorage.setItem(`teresen_${saveId}`, JSON.stringify(saveData));



            alert('å­˜æ¡£æˆåŠŸï¼');

          } catch (error) {

            console.error('å­˜æ¡£å¤±è´¥:', error);

            alert('å­˜æ¡£å¤±è´¥ï¼');

          }

        }



        // æ–°å¢ï¼šåŠ è½½å­˜æ¡£åˆ—è¡¨

        loadSaveList() {

          this.loadAutoSaveList();

          this.loadManualSaveList();

        }



        // æ–°å¢ï¼šåŠ è½½è‡ªåŠ¨å­˜æ¡£åˆ—è¡¨

        loadAutoSaveList() {

          const container = document.getElementById('auto-save-container');

          if (!container) return;



          // è·å–æ‰€æœ‰è‡ªåŠ¨å­˜æ¡£

          const autoSaves = [];

          for (let i = 0; i < localStorage.length; i++) {

            const key = localStorage.key(i);

            if (key && key.startsWith('teresen-auto-save-')) {

              try {

                const saveData = JSON.parse(localStorage.getItem(key));

                autoSaves.push({ key, data: saveData });

              } catch (e) {

                console.warn('è§£æè‡ªåŠ¨å­˜æ¡£å¤±è´¥:', key, e);

              }

            }

          }



          // æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨å‰

          autoSaves.sort((a, b) => b.data.timestamp - a.data.timestamp);



          // åªæ˜¾ç¤ºæœ€è¿‘5ä¸ª

          const recentSaves = autoSaves.slice(0, 5);



          let html = '';

          if (recentSaves.length > 0) {

            html = recentSaves

              .map((save, index) => {

                const date = new Date(save.data.timestamp).toLocaleString('zh-CN');

                const summary = this._getDisplayText(save.data.message_content)

                  .replace(/[\n\r]+/g, ' ')

                  .trim();



                return `

                <div class="save-manager-item save-manager-auto-item" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; padding: 12px; margin-bottom: 8px; transition: all 0.2s;">

                  <div class="save-manager-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">

                    <div class="save-manager-title" style="display: flex; align-items: center; gap: 8px;">

                      <span style="color: #22c55e; font-size: 16px;">ğŸ”„</span>

                      <span style="font-weight: bold; color: #ffffff; font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">è‡ªåŠ¨å­˜æ¡£ #${index + 1}</span>

                    </div>

                    <div class="save-manager-time" style="color: #ffffff; font-size: 11px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${date}</div>

                  </div>

                  <div class="save-manager-content" style="margin-bottom: 10px;">

                    <div class="save-manager-summary" style="color: #ffffff; font-size: 12px; line-height: 1.4; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px; max-height: 60px; overflow: hidden; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">

                      ${summary ? summary : 'æ— æ­£æ–‡è®°å½•'}

                    </div>

                  </div>

                  <div class="save-manager-actions" style="display: flex; gap: 6px; justify-content: flex-end;">

                    <button class="save-button" onclick="n.loadAutoSave('${save.key}')" style="background: linear-gradient(135deg, #22c55e, #16a34a); border: 1px solid #22c55e; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">ğŸ“–</span>

                      <span>è¯»æ¡£</span>

                    </button>

                    <button class="save-button" onclick="n.viewSaveDetails('${save.key}')" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border: 1px solid #3b82f6; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">ğŸ‘ï¸</span>

                      <span>è¯¦æƒ…</span>

                    </button>

                  </div>

                </div>

              `;

              })

              .join('');

          } else {

            html =

              '<div class="save-manager-empty" style="text-align: center; color: #8b4513; padding: 1rem; font-size: 0.875rem; font-style: italic;">æš‚æ— è‡ªåŠ¨å­˜æ¡£</div>';

          }



          container.innerHTML = html;

        }



        // æ–°å¢ï¼šåŠ è½½æ‰‹åŠ¨å­˜æ¡£åˆ—è¡¨

        loadManualSaveList() {

          const container = document.getElementById('manual-save-container');

          if (!container) return;



          const saves = [];

          for (let i = 0; i < localStorage.length; i++) {

            const key = localStorage.key(i);

            if (key && key.startsWith('teresen_save_')) {

              try {

                const saveData = JSON.parse(localStorage.getItem(key));

                saves.push({ key, data: saveData });

              } catch (e) {

                console.warn('è§£æå­˜æ¡£å¤±è´¥:', key, e);

              }

            }

          }



          // æŒ‰æ—¶é—´æ’åº

          saves.sort((a, b) => b.data.timestamp - a.data.timestamp);



          let html = '';

          if (saves.length > 0) {

            html = saves

              .map(save => {

                const date = new Date(save.data.timestamp).toLocaleString('zh-CN');

                const summary = this._getDisplayText(save.data.message_content)

                  .replace(/[\n\r]+/g, ' ')

                  .trim();



                return `

                <div class="save-manager-item save-manager-manual-item" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; padding: 12px; margin-bottom: 8px; transition: all 0.2s;">

                  <div class="save-manager-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">

                    <div class="save-manager-title" style="display: flex; align-items: center; gap: 8px;">

                      <span style="color: #3b82f6; font-size: 16px;">ğŸ’¾</span>

                      <span style="font-weight: bold; color: #ffffff; font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${save.data.save_name}</span>

                    </div>

                    <div class="save-manager-time" style="color: #ffffff; font-size: 11px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${date}</div>

                  </div>

                  <div class="save-manager-content" style="margin-bottom: 10px;">

                    <div class="save-manager-summary" style="color: #ffffff; font-size: 12px; line-height: 1.4; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px; max-height: 60px; overflow: hidden; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">

                      ${summary ? summary : 'æ— æ­£æ–‡è®°å½•'}

                    </div>

                  </div>

                  <div class="save-manager-actions" style="display: flex; gap: 6px; justify-content: flex-end; flex-wrap: wrap;">

                    <button class="save-button" onclick="n.loadManualSave('${save.key}')" style="background: linear-gradient(135deg, #22c55e, #16a34a); border: 1px solid #22c55e; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">ğŸ“–</span>

                      <span>è¯»æ¡£</span>

                    </button>

                    <button class="save-button" onclick="n.renameSave('${save.key}', '${save.data.save_name}')" style="background: linear-gradient(135deg, #f59e0b, #d97706); border: 1px solid #f59e0b; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">âœï¸</span>

                      <span>é‡å‘½å</span>

                    </button>

                    <button class="save-button" onclick="n.viewSaveDetails('manual', '${save.key}')" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border: 1px solid #3b82f6; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">ğŸ‘ï¸</span>

                      <span>è¯¦æƒ…</span>

                    </button>

                    <button class="save-button" onclick="n.deleteManualSave('${save.key}')" style="background: linear-gradient(135deg, #ef4444, #dc2626); border: 1px solid #ef4444; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">ğŸ—‘ï¸</span>

                      <span>åˆ é™¤</span>

                    </button>

                  </div>

                </div>

              `;

              })

              .join('');

          } else {

            html =

              '<div class="save-manager-empty" style="text-align: center; color: #8b4513; padding: 1rem; font-size: 0.875rem; font-style: italic;">æš‚æ— æ‰‹åŠ¨å­˜æ¡£</div>';

          }



          container.innerHTML = html;

        }



        // æ–°å¢ï¼šåŠ è½½è‡ªåŠ¨å­˜æ¡£

        async loadAutoSave() {

          try {

            const autoSaveData = localStorage.getItem('teresen_auto_save');

            if (!autoSaveData) {

              alert('æ²¡æœ‰è‡ªåŠ¨å­˜æ¡£ï¼');

              return;

            }



            const saveData = JSON.parse(autoSaveData);

            await this.restoreSaveData(saveData);

            alert('è‡ªåŠ¨å­˜æ¡£åŠ è½½æˆåŠŸï¼');

            document.getElementById('saveManagerModal').remove();

          } catch (error) {

            console.error('åŠ è½½è‡ªåŠ¨å­˜æ¡£å¤±è´¥:', error);

            alert('åŠ è½½è‡ªåŠ¨å­˜æ¡£å¤±è´¥ï¼');

          }

        }



        // æ–°å¢ï¼šåŠ è½½æ‰‹åŠ¨å­˜æ¡£

        async loadManualSave(saveKey) {

          try {

            const savedData = localStorage.getItem(saveKey);

            if (!savedData) {

              alert('å­˜æ¡£ä¸å­˜åœ¨ï¼');

              return;

            }



            const saveData = JSON.parse(savedData);

            await this.restoreSaveData(saveData);

            alert('æ‰‹åŠ¨å­˜æ¡£åŠ è½½æˆåŠŸï¼');

            document.getElementById('saveManagerModal').remove();

          } catch (error) {

            console.error('åŠ è½½æ‰‹åŠ¨å­˜æ¡£å¤±è´¥:', error);

            alert('åŠ è½½æ‰‹åŠ¨å­˜æ¡£å¤±è´¥ï¼');

          }

        }



        // æ–°å¢ï¼šåˆ é™¤æ‰‹åŠ¨å­˜æ¡£

        deleteManualSave(saveKey) {

          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­˜æ¡£å—ï¼Ÿ')) return;



          try {

            localStorage.removeItem(saveKey);

            alert('åˆ é™¤æˆåŠŸï¼');

            this.loadManualSaveList();

          } catch (error) {

            console.error('åˆ é™¤å¤±è´¥:', error);

            alert('åˆ é™¤å¤±è´¥ï¼');

          }

        }



        // æ–°å¢ï¼šæ¢å¤å­˜æ¡£æ•°æ®çš„é€šç”¨æ–¹æ³•

        async restoreSaveData(saveData) {

          // æ¢å¤å˜é‡çŠ¶æ€

          if (saveData.mvu_data) {

                          // ç›´æ¥è®¾ç½®å˜é‡ï¼Œä¸è°ƒç”¨MVU
              this.currentMvuState = saveData.mvu_data;
              this.renderUI(this.currentMvuState.stat_data);

          }



          // æ¢å¤èŠå¤©æ¶ˆæ¯

          if (saveData.message_content) {

            const chatMessages = await getChatMessages(0);

            if (chatMessages && chatMessages.length > 0) {

              const firstMessage = chatMessages[0];

              firstMessage.message = saveData.message_content;

              firstMessage.data = saveData.mvu_data;

              await TavernHelper.setChatMessages([firstMessage], { refresh: 'none' });

            }

          }



          // æ›´æ–°ç•Œé¢

          await this.updateDynamicData();

        }



        // æ–°å¢ï¼šæŸ¥çœ‹å­˜æ¡£è¯¦æƒ…

        async viewSaveDetails(type, saveKey = null) {

          try {

            let saveData;

            if (type === 'auto') {

              const autoSaveData = localStorage.getItem('teresen_auto_save');

              if (!autoSaveData) {

                alert('æ²¡æœ‰è‡ªåŠ¨å­˜æ¡£ï¼');

                return;

              }

              saveData = JSON.parse(autoSaveData);

            } else {

              const savedData = localStorage.getItem(saveKey);

              if (!savedData) {

                alert('å­˜æ¡£ä¸å­˜åœ¨ï¼');

                return;

              }

              saveData = JSON.parse(savedData);

            }



            const date = new Date(saveData.timestamp).toLocaleString('zh-CN');

            const summary = this._getDisplayText(saveData.message_content);



            const detailsHtml = `

              <div style="max-width: 600px; max-height: 400px; overflow-y: auto; background: #2d1b1b; border: 2px solid #8b4513; border-radius: 8px; padding: 20px; color: #e0e0e0;">

                <h3 style="color: #e0e0e0; margin-bottom: 15px; text-align: center; border-bottom: 1px solid #8b4513; padding-bottom: 10px;">ğŸ“‹ å­˜æ¡£è¯¦æƒ…</h3>

                <div style="background: rgba(139, 69, 19, 0.2); padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid rgba(139, 69, 19, 0.5);">

                  <div style="margin-bottom: 10px;">

                    <strong style="color: #e0e0e0;">ğŸ“ å­˜æ¡£åç§°:</strong> 

                    <span style="color: #c0c0c0;">${saveData.save_name || 'è‡ªåŠ¨å­˜æ¡£'}</span>

                  </div>

                  <div style="margin-bottom: 10px;">

                    <strong style="color: #e0e0e0;">ğŸ• ä¿å­˜æ—¶é—´:</strong> 

                    <span style="color: #c0c0c0;">${date}</span>

                  </div>

                  <div style="margin-bottom: 10px;">

                    <strong style="color: #e0e0e0;">ğŸ·ï¸ å­˜æ¡£ç±»å‹:</strong> 

                    <span style="color: #c0c0c0;">${type === 'auto' ? 'è‡ªåŠ¨å­˜æ¡£' : 'æ‰‹åŠ¨å­˜æ¡£'}</span>

                  </div>

                </div>

                <div style="background: rgba(139, 69, 19, 0.2); padding: 15px; border-radius: 6px; border: 1px solid rgba(139, 69, 19, 0.5);">

                  <strong style="color: #e0e0e0; display: block; margin-bottom: 10px;">ğŸ’¬ å¯¹è¯å†…å®¹:</strong>

                  <div style="color: #c0c0c0; line-height: 1.6; white-space: pre-wrap; max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; font-size: 13px;">${summary || 'æ— å†…å®¹'}</div>

                </div>

              </div>

            `;



            // åˆ›å»ºä¸€ä¸ªæ¨¡æ€æ¡†æ¥æ˜¾ç¤ºè¯¦æƒ…ï¼Œè€Œä¸æ˜¯ç”¨alert

            const detailModalId = 'saveDetailModal';

            if (document.getElementById(detailModalId)) {

              document.getElementById(detailModalId).remove();

            }



            const detailModalHtml = `

              <div id="${detailModalId}" class="rules-modal" style="display: flex; z-index: 10001;">

                <div class="rules-modal-content" style="max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">

                  <div class="rules-modal-header">

                    <h2 class="rules-title">å­˜æ¡£è¯¦æƒ…</h2>

                    <button class="close-rules-btn" onclick="document.getElementById('${detailModalId}').remove()">Ã—</button>

                  </div>

                  <div class="rules-modal-body">

                    ${detailsHtml}

                  </div>

                </div>

              </div>

            `;



            document.body.insertAdjacentHTML('beforeend', detailModalHtml);



            // ç‚¹å‡»èƒŒæ™¯å…³é—­

            document.getElementById(detailModalId).addEventListener('click', e => {

              if (e.target.id === detailModalId) {

                document.getElementById(detailModalId).remove();

              }

            });

          } catch (error) {

            console.error('æŸ¥çœ‹å­˜æ¡£è¯¦æƒ…å¤±è´¥:', error);

            alert('æŸ¥çœ‹å­˜æ¡£è¯¦æƒ…å¤±è´¥ï¼');

          }

        }



        // æ–°å¢ï¼šé‡å‘½åå­˜æ¡£

        async renameSave(saveKey, currentName) {

          try {

            const newName = prompt('è¯·è¾“å…¥æ–°çš„å­˜æ¡£åç§°:', currentName);

            if (!newName || newName === currentName) return;



            const savedData = localStorage.getItem(saveKey);

            if (!savedData) {

              alert('å­˜æ¡£ä¸å­˜åœ¨ï¼');

              return;

            }



            const saveData = JSON.parse(savedData);

            saveData.save_name = newName;



            localStorage.setItem(saveKey, JSON.stringify(saveData));

            alert('é‡å‘½åæˆåŠŸï¼');



            // åˆ·æ–°åˆ—è¡¨

            this.loadSaveList();

          } catch (error) {

            console.error('é‡å‘½åå­˜æ¡£å¤±è´¥:', error);

            alert('é‡å‘½åå¤±è´¥ï¼');

          }

        }



        // æ–°å¢ï¼šè·å–æ˜¾ç¤ºæ–‡æœ¬çš„è¾…åŠ©æ–¹æ³•

        _getDisplayText(text) {

          if (!text) return '';



          // ç§»é™¤HTMLæ ‡ç­¾

          let cleanText = text.replace(/<[^>]*>/g, '');



          // ç§»é™¤å¤šä½™çš„ç©ºç™½å­—ç¬¦

          cleanText = cleanText.replace(/\s+/g, ' ').trim();



          // é™åˆ¶é•¿åº¦

          if (cleanText.length > 200) {

            cleanText = cleanText.substring(0, 200) + '...';

          }



          return cleanText;

        }



        // æ–°å¢ï¼šé‡æ–°ç”ŸæˆAIå›ç­”

        async performReroll() {

          try {

            // åŠ è½½è‡ªåŠ¨å­˜æ¡£

            const autoSaveData = localStorage.getItem('teresen_auto_save');

            if (!autoSaveData) {

              alert('æ²¡æœ‰è‡ªåŠ¨å­˜æ¡£ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆï¼');

              return;

            }



            const saveData = JSON.parse(autoSaveData);



            // æ¢å¤å­˜æ¡£çŠ¶æ€

            await this.restoreSaveData(saveData);



            // è·å–ä¸Šæ¬¡çš„æç¤ºè¯

            const lastPrompt = this.lastSentPrompt;

            if (!lastPrompt) {

              alert('æ²¡æœ‰æ‰¾åˆ°ä¸Šæ¬¡çš„æç¤ºè¯ï¼');

              return;

            }



            // è®¾ç½®è¾“å…¥æ¡†çš„å€¼

            const actionInput = document.getElementById('action-input');

            if (actionInput) {

              actionInput.value = lastPrompt;

            }



            // é‡æ–°æäº¤

            await this.handleActionSubmit();



            alert('é‡æ–°ç”ŸæˆæˆåŠŸï¼');

          } catch (error) {

            console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);

            alert('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼');

          }

        }

      })();

      if ('undefined' != typeof eventOn && void 0 !== window.tavern_events) {

        const e = window.tavern_events;

        eventOn(e.APP_READY, () => {

          (console.log('ğŸ¯ é…’é¦†ç¯å¢ƒå°±ç»ªï¼Œå¼€å§‹åˆå§‹åŒ–ç‰¹é›·æ£®ç•Œé¢...'), n.init());

        });

      } else

        (console.warn('âš ï¸ é…’é¦†äº‹ä»¶APIä¸å¯ç”¨ï¼Œä½¿ç”¨ä¼ ç»Ÿåˆå§‹åŒ–æ–¹å¼'),

          setTimeout(() => {

            n.init();

          }, 2e3));

    </script>

    <style>

      /* æ–°å¢ï¼šçŠ¶æ€åˆ¤å®šåŠ¨ç”»å’Œå¡”ç½—buffç³»ç»Ÿæ ·å¼ */
      
      /* çŠ¶æ€åŠ¨ç”»å®¹å™¨ */
      .status-animation-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      .status-animation-container.show {
        opacity: 1;
      }

      .status-animation {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid #d4af37;
        border-radius: 1rem;
        padding: 2rem;
        text-align: center;
        color: white;
        box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
        max-width: 500px;
        transform: scale(0.8);
        transition: transform 0.5s ease;
      }

      .status-animation-container.show .status-animation {
        transform: scale(1);
      }

      .status-title {
        font-size: 2rem;
        font-weight: bold;
        color: #d4af37;
        margin-bottom: 1rem;
        text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
      }

      .status-content {
        margin-bottom: 1rem;
      }





      .status-message {
        font-size: 1rem;
        color: #e5e7eb;
        margin-top: 1rem;
        font-style: italic;
      }

      .status-hint {
        font-size: 0.9rem;
        color: #d4af37;
        margin-top: 0.5rem;
        font-style: italic;
        opacity: 0.8;
      }

      /* ä¸åŒçŠ¶æ€ç±»å‹çš„ç‰¹æ®Šæ ·å¼ */
      .status-animation-container.critical .status-animation {
        border-color: #dc2626;
        box-shadow: 0 0 40px rgba(220, 38, 38, 0.6);
        animation: criticalShake 0.5s ease-in-out infinite;
      }

      .status-animation-container.stamina .status-animation {
        border-color: #ef4444;
        box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
      }

      .status-animation-container.sanity .status-animation {
        border-color: #8b5cf6;
        box-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
      }

      @keyframes criticalShake {
        0%, 100% { transform: scale(1) rotate(0deg); }
        25% { transform: scale(1.02) rotate(-1deg); }
        75% { transform: scale(1.02) rotate(1deg); }
      }

      /* Buffé€šçŸ¥æ ·å¼ */
      .buff-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid #d4af37;
        border-radius: 1rem;
        padding: 1.5rem;
        color: white;
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        z-index: 10000;
        max-width: 350px;
        transform: translateX(100%);
        transition: transform 0.5s ease;
      }

      .buff-notification.show {
        transform: translateX(0);
      }

      .buff-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #d4af37;
        margin-bottom: 1rem;
        text-align: center;
      }

      .buff-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .buff-item {
        padding: 0.5rem;
        border-radius: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .buff-item.courage { border-left: 3px solid #ef4444; }
      .buff-item.skill { border-left: 3px solid #3b82f6; }
      .buff-item.intuition { border-left: 3px solid #8b5cf6; }
      .buff-item.fertility { border-left: 3px solid #10b981; }
      .buff-item.authority { border-left: 3px solid #f59e0b; }
      .buff-item.harmony { border-left: 3px solid #06b6d4; }
      .buff-item.victory { border-left: 3px solid #dc2626; }
      .buff-item.strength { border-left: 3px solid #ea580c; }
      .buff-item.wisdom { border-left: 3px solid #7c3aed; }
      .buff-item.fortune { border-left: 3px solid #fbbf24; }

      .buff-name {
        display: block;
        font-weight: bold;
        color: #d4af37;
        margin-bottom: 0.25rem;
      }

      .buff-effect {
        display: block;
        font-size: 0.9rem;
        color: #e5e7eb;
        margin-bottom: 0.25rem;
      }

      .buff-duration {
        display: block;
        font-size: 0.8rem;
        color: #9ca3af;
      }



      .tarot-result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #d4af37;
        padding-bottom: 1rem;
      }

      .tarot-result-header h2 {
        color: #d4af37;
        margin: 0;
      }

      .tarot-result-header button {
        background: none;
        border: none;
        color: #d4af37;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s;
      }

      .tarot-result-header button:hover {
        background: rgba(212, 175, 55, 0.2);
      }

      .tarot-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .tarot-card {
        background: linear-gradient(135deg, #2d3748, #4a5568);
        border: 1px solid #d4af37;
        border-radius: 0.5rem;
        padding: 1rem;
        text-align: center;
        transition: transform 0.2s;
      }

      .tarot-card:hover {
        transform: translateY(-5px);
      }

      .tarot-card.reversed {
        border-color: #ef4444;
      }

      .card-name {
        font-size: 1.1rem;
        font-weight: bold;
        color: #d4af37;
        margin-bottom: 0.5rem;
      }

      .card-meaning {
        font-size: 0.9rem;
        color: #e5e7eb;
        margin-bottom: 0.5rem;
        line-height: 1.4;
      }

      .card-position {
        font-size: 0.8rem;
        color: #9ca3af;
        font-style: italic;
      }

      .tarot-advice {
        background: rgba(212, 175, 55, 0.1);
        border: 1px solid #d4af37;
        border-radius: 0.5rem;
        padding: 1rem;
      }

      .tarot-advice h3 {
        color: #d4af37;
        margin: 0 0 0.5rem 0;
      }

      .tarot-advice p {
        color: #e5e7eb;
        margin: 0;
        line-height: 1.5;
      }

      /* å¡”ç½—buffå¼¹çª— */
      .tarot-buffs-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .tarot-buffs-modal.show {
        opacity: 1;
      }

      .tarot-buffs-content {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid #d4af37;
        border-radius: 1rem;
        padding: 2rem;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.8);
        transition: transform 0.3s ease;
      }

      .tarot-buffs-modal.show .tarot-buffs-content {
        transform: scale(1);
      }

      .tarot-buffs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #d4af37;
        padding-bottom: 1rem;
      }

      .tarot-buffs-header h2 {
        color: #d4af37;
        margin: 0;
      }

      .tarot-buffs-header button {
        background: none;
        border: none;
        color: #d4af37;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s;
      }

      .tarot-buffs-header button:hover {
        background: rgba(212, 175, 55, 0.2);
      }

      .tarot-buffs-body {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .tarot-buffs-body .buff-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
        padding: 1rem;
      }

      .buff-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .buff-remaining {
        font-size: 0.8rem;
        color: #9ca3af;
        font-style: italic;
      }

      .buff-source {
        font-size: 0.8rem;
        color: #6b7280;
        font-style: italic;
        margin-top: 0.5rem;
      }

      /*! tailwindcss v4.1.12 | MIT License | https://tailwindcss.com */

      @layer properties {

        @supports ((-webkit-hyphens: none) and (not (margin-trim: inline))) or

          ((-moz-orient: inline) and (not (color: rgb(from red r g b)))) {

          *,

          :before,

          :after,

          ::backdrop {

            --tw-rotate-x: initial;

            --tw-rotate-y: initial;

            --tw-rotate-z: initial;

            --tw-skew-x: initial;

            --tw-skew-y: initial;

            --tw-border-style: solid;

            --tw-shadow: 0 0 #0000;

            --tw-shadow-color: initial;

            --tw-shadow-alpha: 100%;

            --tw-inset-shadow: 0 0 #0000;

            --tw-inset-shadow-color: initial;

            --tw-inset-shadow-alpha: 100%;

            --tw-ring-color: initial;

            --tw-ring-shadow: 0 0 #0000;

            --tw-inset-ring-color: initial;

            --tw-inset-ring-shadow: 0 0 #0000;

            --tw-ring-inset: initial;

            --tw-ring-offset-width: 0px;

            --tw-ring-offset-color: #fff;

            --tw-ring-offset-shadow: 0 0 #0000;

            --tw-outline-style: solid;

            --tw-backdrop-blur: initial;

            --tw-backdrop-brightness: initial;

            --tw-backdrop-contrast: initial;

            --tw-backdrop-grayscale: initial;

            --tw-backdrop-hue-rotate: initial;

            --tw-backdrop-invert: initial;

            --tw-backdrop-opacity: initial;

            --tw-backdrop-saturate: initial;

            --tw-backdrop-sepia: initial;

          }

        }

      }

      .absolute {

        position: absolute;

      }

      .fixed {

        position: fixed;

      }

      .block {

        display: block;

      }

      .flex {

        display: flex;

      }

      .hidden {

        display: none;

      }

      .flex-shrink {

        flex-shrink: 1;

      }

      .transform {

        transform: var(--tw-rotate-x,) var(--tw-rotate-y,) var(--tw-rotate-z,) var(--tw-skew-x,) var(--tw-skew-y,);

      }

      .resize {

        resize: both;

      }

      .flex-wrap {

        flex-wrap: wrap;

      }

      .border {

        border-style: var(--tw-border-style);

        border-width: 1px;

      }

      .ring {

        --tw-ring-shadow: var(--tw-ring-inset,) 0 0 0 calc(1px + var(--tw-ring-offset-width))

          var(--tw-ring-color, currentcolor);

        box-shadow:

          var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow),

          var(--tw-shadow);

      }

      .outline {

        outline-style: var(--tw-outline-style);

        outline-width: 1px;

      }

      .backdrop-filter {

        backdrop-filter: var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,)

          var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,)

          var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,);

      }

      .transition {

        transition-property:

          color, background-color, border-color, outline-color, text-decoration-color, fill, stroke, --tw-gradient-from,

          --tw-gradient-via, --tw-gradient-to, opacity, box-shadow, transform, translate, scale, rotate, filter,

          backdrop-filter, display, visibility, content-visibility, overlay, pointer-events;

        transition-timing-function: var(--tw-ease, ease);

        transition-duration: var(--tw-duration, 0s);

      }

      @layer base {

        html {

          font-family:

            Noto Sans SC,

            Georgia,

            Times New Roman,

            serif;

        }

        body {

          color: #2d2d2d;

          background: linear-gradient(135deg, #f8f2e6 0%, #f2e8d8 25%, #ecddc7 50%, #e6d3b6 75%, #e0c8a5 100%) fixed;

          margin: 0;

          padding: 0;

          font-family:

            Georgia,

            Times New Roman,

            serif;

        }

      }

      @layer components {

        .leather-journal {

          background: linear-gradient(145deg, #faf6f0 0%, #f5f0e8 50%, #f0eae0 100%);

          border: 2px solid #8b6914;

          min-height: 600px;

          position: relative;

          box-shadow:

            inset 0 0 20px #8b691433,

            0 4px 8px #0000004d;

        }

        .leather-journal:before {

          content: '';

          pointer-events: none;

          background-image:

            radial-gradient(circle at 15% 25%, #8b691414 1px, #0000 2px),

            radial-gradient(circle at 85% 75%, #6543210f 1px, #0000 2px),

            radial-gradient(circle at 45% 60%, #a086590a 1px, #0000 2px);

          background-size:

            40px 40px,

            60px 60px,

            80px 80px;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;

        }

        .connected-panels {

          z-index: 2;

          border-radius: 8px;

          grid-template-rows: auto 1fr auto;

          grid-template-columns: 250px 1fr 200px;

          gap: 0;

          width: 100%;

          max-width: 1600px;

          height: 575px;

          margin: auto;

          transition: all 0.3s;

          display: grid;

          position: relative;

          overflow: hidden;

          box-shadow: 0 8px 16px #00000080;

        }

        .connected-panels.fullscreen-active {

          z-index: 9999;

          border-radius: 0;

          width: 100vw;

          max-width: none;

          height: 100vh;

          margin: 0;

          position: fixed;

          top: 0;

          left: 0;

        }

        .connected-panels.fullscreen-active .panel-content {

          z-index: 10000;

        }

        .connected-panels.fullscreen-active .save-section {

          z-index: 10001;

          position: relative;

        }

        .connected-panels.fullscreen-active ~ .rules-modal {

          z-index: 10002;

        }

        .connected-panels.fullscreen-active ~ .rules-modal .rules-modal-content {

          z-index: 10003;

        }

        .connected-panels.fullscreen-active ~ .danger-modal,

        .connected-panels.fullscreen-active ~ #load-modal,

        .connected-panels.fullscreen-active ~ #rules-modal,

        .connected-panels.fullscreen-active ~ #command-modal {

          z-index: 10002;

        }

        .danger-modal,

        #load-modal,

        #rules-modal {

          z-index: 10000;

        }

        .parchment-page {

          color: #2d2d2d;

          background-color: #fdfbf7;

          border: 1px solid #8b6914;

          flex-direction: column;

          display: flex;

          position: relative;

          box-shadow: inset 0 0 20px #8b69141a;

        }

        .parchment-page:before {

          content: '';

          pointer-events: none;

          background-image:

            radial-gradient(circle at 20% 30%, #8b69140d 2px, #0000 4px),

            radial-gradient(circle at 80% 70%, #a086590a 1px, #0000 3px);

          background-size:

            60px 60px,

            40px 40px;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;

        }

        .left-panel {

          grid-area: 1/1/3;

          width: 100%;

          height: 100%;

          overflow: hidden auto;

        }

        .center-panel {

          flex-direction: column;

          grid-area: 1/2/3;

          width: 100%;

          height: 100%;

          display: flex;

          overflow: hidden auto;

        }

        .right-panel {

          flex-direction: column;

          grid-area: 1/3/3;

          gap: 0.75rem;

          width: 100%;

          height: 100%;

          display: flex;

          overflow: hidden auto;

        }

        .panel-content {

          z-index: 1;

          flex-direction: column;

          height: 100%;

          padding: 0.75rem;

          font-size: 1rem;

          display: flex;

          position: relative;

          overflow-y: auto;

        }

        .panel-divider {

          background: linear-gradient(#8b6914, #a0865a, #8b6914);

          width: 3px;

          height: 100%;

          position: relative;

          box-shadow:

            inset 0 0 4px #0000004d,

            0 0 8px #8b691433;

        }

        .panel-divider:before {

          content: '';

          background: linear-gradient(#0000 0%, #ffffff1a 50%, #0000 100%);

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;

        }

        .panel-divider:after {

          content: '';

          background: radial-gradient(circle, #a0865a, #8b6914);

          border-radius: 50%;

          width: 8px;

          height: 8px;

          position: absolute;

          top: 50%;

          left: 50%;

          transform: translate(-50%, -50%);

          box-shadow: 0 0 4px #0000004d;

        }

        .section-header {

          border-bottom: 1px solid #8b69144d;

          align-items: center;

          gap: 0.5rem;

          margin-bottom: 0.75rem;

          padding-bottom: 0.375rem;

          display: flex;

        }

        .section-header h3 {

          color: #2d2d2d;

          margin: 0;

          font-size: 0.9rem;

          font-weight: 600;

        }

        .icon {

          color: #8b4513;

          width: 1rem;

          height: 1rem;

        }

        .roster-btn {

          cursor: pointer;

          background: 0 0;

          border: none;

          border-radius: 0.25rem;

          margin-left: auto;

          padding: 0.25rem;

          font-size: 1rem;

          color: #8b4513;

          transition: all 0.2s ease;

        }

        .roster-btn:hover {

          background-color: #8b69141a;

          transform: scale(1.1);

        }

        /* é©¬å¨˜è®°åå†Œå¼¹çª—æ ·å¼ */
        .roster-modal {
          z-index: 1000;
          backdrop-filter: blur(4px);
          background: #000000b3;
          justify-content: center;
          align-items: center;
          width: 100%;
          height: 100%;
          display: flex;
          position: fixed;
          top: 0;
          left: 0;
        }

        .roster-content {
          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);
          border: 3px solid #8b6914;
          border-radius: 1rem;
          max-width: 600px;
          max-height: 80vh;
          width: 90%;
          overflow: hidden;
          box-shadow: 0 20px 40px #0000004d;
          position: relative;
        }

        .roster-content:before {
          content: '';
          pointer-events: none;
          background-image: radial-gradient(circle at 20% 30%, #8b69140d 2px, #0000 4px), radial-gradient(circle at 80% 70%, #a086590a 1px, #0000 3px);
          background-size: 60px 60px, 40px 40px;
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
        }

        .roster-header {
          background: linear-gradient(135deg, #8b6914, #a0865a);
          color: #fdfbf7;
          padding: 1rem 1.5rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 2px solid #654321;
        }

        .roster-header h2 {
          margin: 0;
          font-size: 1.2rem;
          font-weight: 600;
        }

        .roster-close-btn {
          background: none;
          border: none;
          color: white;
          font-size: 1.5rem;
          cursor: pointer;
          padding: 0;
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          transition: background-color 0.2s;
        }

        .roster-close-btn:hover {
          background-color: rgba(255, 255, 255, 0.2);
        }

        .roster-body {
          max-height: 60vh;
          padding: 1.5rem;
          overflow-y: auto;
        }

        .empty-roster {
          text-align: center;
          color: #8b4513;
          font-style: italic;
          padding: 2rem;
        }

        .roster-list {
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }

        .roster-item {
          background: white;
          border: 1px solid #d4af37;
          border-radius: 6px;
          padding: 1rem;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .roster-item-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.5rem;
          border-bottom: 1px solid #f0f0f0;
          padding-bottom: 0.5rem;
        }

        .roster-item-header h3 {
          margin: 0;
          color: #8b4513;
          font-size: 1.1rem;
          font-weight: 600;
        }

        .encounter-count {
          background: #8b4513;
          color: white;
          padding: 0.25rem 0.5rem;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: 500;
        }

        .roster-item-details {
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
        }

        .roster-detail {
          color: #2d2d2d;
          font-size: 0.9rem;
          line-height: 1.4;
        }

        .roster-detail strong {
          color: #8b4513;
          font-weight: 600;
        }

        .expand-btn {

          cursor: pointer;

          background: 0 0;

          border: none;

          border-radius: 0.25rem;

          margin-left: auto;

          padding: 0.25rem;

          transition: background-color 0.2s;

        }

        .expand-btn:hover {

          background-color: #8b69141a;

        }

        .save-section {

          gap: 0.5rem;

          margin-bottom: 1.5rem;

          display: flex;

        }

        .save-section .save-button {

          flex: 1;

          min-width: 0;

          padding: 0.375rem;

          font-size: 0.7rem;

        }

        .save-button {

          color: #e8d5d5;

          cursor: pointer;

          text-shadow: 0 1px 2px #00000080;

          background: linear-gradient(135deg, #2d1b1b, #3d2b2b);

          border: 1px solid #8b0000;

          border-radius: 0.25rem;

          justify-content: center;

          align-items: center;

          gap: 0.5rem;

          width: 100%;

          padding: 0.5rem;

          font-size: 0.75rem;

          font-weight: 500;

          transition: all 0.2s;

          display: flex;

          position: relative;

          box-shadow:

            inset 0 1px #ffffff1a,

            0 2px 4px #0006;

        }

        .save-button:before {

          content: '';

          opacity: 0;

          background: linear-gradient(135deg, #8b00001a, #0000);

          transition: opacity 0.2s;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;

        }

        .save-button:hover:before {

          opacity: 1;

        }

        .save-button:hover {

          color: #f0e0e0;

          background: linear-gradient(135deg, #3d2b2b, #4d3b3b);

          border-color: #a00000;

          box-shadow:

            inset 0 1px #ffffff26,

            0 3px 6px #00000080;

        }

        .save-button:active {

          background: linear-gradient(135deg, #1d0b0b, #2d1b1b);

          box-shadow:

            inset 0 2px 4px #0009,

            0 1px 2px #0000004d;

        }

        .status-section {

          margin-bottom: 1rem;

        }

        .status-item {

          margin-bottom: 0.5rem;

        }

        .status-header {

          justify-content: space-between;

          align-items: center;

          margin-bottom: 0.25rem;

          display: flex;

        }

        .status-label {

          color: #2d2d2d;

          font-size: 0.75rem;

          font-weight: 500;

        }

        .status-value {

          color: #8b4513;

          font-size: 0.75rem;

          font-weight: 600;

        }

        .progress-bar {

          background-color: #8b691433;

          border-radius: 9999px;

          height: 0.5rem;

          position: relative;

          overflow: hidden;

        }

        .progress-fill {

          background: linear-gradient(90deg, #059669 0%, #10b981 100%);

          border-radius: 9999px;

          height: 100%;

          transition: width 0.5s;

        }

        .progress-fill.danger {

          background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);

          animation: 3s ease-in-out infinite subtle-pulse;

        }

        .progress-fill.warning {

          background: linear-gradient(90deg, #d97706 0%, #f59e0b 100%);

        }



        .profile-section,

        .journey-section,

        .inventory-section {

          margin-bottom: 1rem;

        }

        .profile-basic,

        .journey-basic {

          font-size: 0.75rem;

        }

        .profile-item,

        .detail-item {

          justify-content: space-between;

          margin-bottom: 0.25rem;

          display: flex;

        }

        .label {

          color: #6b7280;

          font-weight: 400;

        }

        .value {

          color: #2d2d2d;

          font-weight: 500;

        }

        .status-excellent {

          color: #059669;

          font-weight: 600;

          text-shadow: 0 0 5px rgba(5, 150, 105, 0.3);

        }

        .status-good {

          color: #d97706;

          font-weight: 600;

          text-shadow: 0 0 5px rgba(217, 119, 6, 0.3);

        }

        .status-normal {

          color: #6b7280;

          font-weight: 500;

        }

        .status-bad {

          color: #dc2626;

          font-weight: 600;

          text-shadow: 0 0 5px rgba(220, 38, 38, 0.3);

        }

        .status-terrible {

          color: #7f1d1d;

          font-weight: 700;

          text-shadow: 0 0 8px rgba(127, 29, 29, 0.5);

          animation: 2s ease-in-out infinite subtle-pulse;

        }

        .profile-detail,

        .journey-detail {

          font-size: 0.75rem;

        }

        .detail-card {

          background-color: #8b69141a;

          border: 1px solid #8b6914;

          border-radius: 0.375rem;

          margin-bottom: 0.75rem;

          padding: 0.75rem;

        }

        .anomaly-card {

          background: linear-gradient(45deg, #8b00001a, #8b000033);

          border: 1px solid #8b0000;

          border-radius: 0.375rem;

          padding: 0.75rem;

        }

        .anomaly-card h4 {

          margin: 0 0 0.5rem;

          font-size: 0.875rem;

        }

        .anomaly-list {

          flex-direction: column;

          gap: 0.25rem;

          display: flex;

        }

        .anomaly-item {

          font-size: 0.75rem;

        }

        .profile-link,

        .journey-link {

          color: #8b4513;

          cursor: pointer;

          font-size: 0.75rem;

        }

        .journey-list {

          flex-direction: column;

          gap: 0.5rem;

          max-height: 200px;

          display: flex;

          overflow-y: auto;

        }

        .journey-entry {

          background-color: #8b69141a;

          border-left: 2px solid #8b6914;

          border-radius: 0.25rem;

          padding: 0.5rem;

        }

        .journey-header {

          justify-content: space-between;

          align-items: flex-start;

          margin-bottom: 0.25rem;

          display: flex;

        }

        .journey-day {

          color: #2d2d2d;

          font-weight: 600;

        }

        .journey-status {

          border-radius: 0.125rem;

          padding: 0.125rem 0.25rem;

          font-size: 0.625rem;

          font-weight: 600;

        }

        .journey-status.normal {

          color: #059669;

          background-color: #05966933;

        }

        .journey-status.confused {

          color: #d97706;

          background-color: #d9770633;

        }

        .journey-event {

          color: #8b4513;

          margin-bottom: 0.125rem;

          font-weight: 500;

        }

        .journey-desc {

          color: #654321;

          font-size: 0.625rem;

        }

        .sanity-change {

          margin-top: 0.25rem;

          font-size: 0.625rem;

        }

        .inventory-container {

          max-height: 200px;

          overflow-y: auto;

        }

        .empty-inventory,

        .empty-rules,

        .loading-uma {

          text-align: center;

          color: #8b4513;

          padding: 1rem;

          font-size: 0.75rem;

        }

        .story-container {

          flex: 1;

          padding: 1.5rem;

          overflow-y: auto;

        }

        .story-content {

          color: #2d2d2d;

          white-space: pre-wrap;

          font-family:

            Georgia,

            Times New Roman,

            serif;

          font-size: 1rem;

          line-height: 1.8;

        }

        .story-text {

          margin: 0;

        }

        .input-section {

          background-color: #fdfbf7;

          background-image:

            repeating-linear-gradient(0deg, #0000, #0000 23px, #8b691433 24px 25px, #0000 26px),

            linear-gradient(90deg, #0000 40px, #8b69144d 41px 42px, #0000 43px);

          background-size:

            100% 24px,

            100% 100%;

          border-top: 2px solid #8b6914;

          padding: 1rem;

        }

        .input-header {

          justify-content: space-between;

          align-items: center;

          margin-bottom: 0.75rem;

          display: flex;

        }

        .time-display {

          color: #8b4513;

          align-items: center;

          gap: 0.5rem;

          font-size: 0.75rem;

          font-weight: 600;

          display: flex;

        }

        .danger-level {

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: inline-flex;

        }

        .danger-details {

          color: #78350f;

          white-space: pre-line;

          background: #fef3c7e6;

          border: 1px solid #f59e0b;

          border-radius: 0.5rem;

          margin-top: 0.5rem;

          padding: 1rem;

          font-size: 0.8rem;

          line-height: 1.6;

        }

        .danger-modal {

          z-index: 1000;

          backdrop-filter: blur(4px);

          background: #000000b3;

          justify-content: center;

          align-items: center;

          width: 100%;

          height: 100%;

          display: flex;

          position: fixed;

          top: 0;

          left: 0;

        }

        .danger-modal-content {

          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);

          border: 3px solid #8b6914;

          border-radius: 1rem;

          width: 90%;

          max-width: 600px;

          max-height: 80vh;

          position: relative;

          overflow: hidden;

          box-shadow: 0 20px 40px #0000004d;

        }

        .danger-modal-content:before {

          content: '';

          pointer-events: none;

          background-image:

            radial-gradient(circle at 20% 30%, #8b69140d 2px, #0000 4px),

            radial-gradient(circle at 80% 70%, #a086590a 1px, #0000 3px);

          background-size:

            60px 60px,

            40px 40px;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;

        }

        .danger-modal-header {

          color: #fdfbf7;

          background: linear-gradient(135deg, #8b6914, #a0865a);

          border-bottom: 2px solid #654321;

          justify-content: space-between;

          align-items: center;

          padding: 1rem 1.5rem;

          display: flex;

        }

        .danger-modal-header h3 {

          text-shadow: 0 2px 4px #0000004d;

          margin: 0;

          font-family:

            Brush Script MT,

            cursive;

          font-size: 1.5rem;

          font-weight: 700;

          transform: rotate(-1deg);

        }

        .danger-modal-close {

          color: #fdfbf7;

          cursor: pointer;

          background: 0 0;

          border: none;

          border-radius: 0.25rem;

          padding: 0.25rem 0.5rem;

          font-size: 1.5rem;

          transition: all 0.2s;

        }

        .danger-modal-close:hover {

          background: #fff3;

        }

        .danger-modal-body {

          max-height: 60vh;

          padding: 1.5rem;

          overflow-y: auto;

        }

        .danger-current-period {

          text-align: center;

          color: #8b4513;

          background: #8b69141a;

          border: 2px solid #8b6914;

          border-radius: 0.5rem;

          margin-bottom: 1.5rem;

          padding: 1rem;

          font-family:

            Brush Script MT,

            cursive;

          font-size: 1.1rem;

          font-weight: 600;

        }

        .danger-details-content {

          color: #654321;

          white-space: pre-line;

          background: #fff6;

          border: 1px solid #8b691433;

          border-radius: 0.75rem;

          padding: 1.5rem;

          font-family:

            Georgia,

            Times New Roman,

            serif;

          font-size: 0.9rem;

          line-height: 1.8;

          box-shadow: inset 0 2px 4px #0000001a;

        }

        .danger-details-content strong {

          color: #8b4513;

          font-weight: 600;

        }

        .danger-details-content .danger-stars {

          color: #d4af37;

          margin: 0.5rem 0;

          font-size: 1.1rem;

        }

        .danger-details-content .danger-suggestion {

          background: #8b69141a;

          border-left: 3px solid #8b6914;

          border-radius: 0.25rem;

          margin: 0.75rem 0;

          padding: 0.75rem;

        }

        .danger-level.safe {

          color: #059669;

          background: linear-gradient(135deg, #0596691a, #10b9811a);

          border: 1px solid #059669;

        }

        .danger-level.low {

          color: #d97706;

          background: linear-gradient(135deg, #d977061a, #f59e0b1a);

          border: 1px solid #d97706;

        }

        .danger-level.medium {

          color: #ea580c;

          background: linear-gradient(135deg, #ea580c1a, #fb923c1a);

          border: 1px solid #ea580c;

        }

        .danger-level.high {

          color: #dc2626;

          background: linear-gradient(135deg, #dc26261a, #ef44441a);

          border: 1px solid #dc2626;

        }

        .danger-level.extreme {

          color: #1f2937;

          background: linear-gradient(135deg, #1f29371a, #3741511a);

          border: 1px solid #1f2937;

        }

        .danger-button {

          color: #8b0000;

          cursor: pointer;

          background-color: #8b00001a;

          border: 1px solid #8b0000;

          border-radius: 0.375rem;

          padding: 0.5rem 1rem;

          font-size: 0.75rem;

          font-weight: 600;

          transition: all 0.2s;

        }

        .danger-button:hover {

          background-color: #8b000033;

        }

        .input-container {

          background-color: #8b69141a;

          border: 1px solid #8b6914;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          padding: 0.75rem;

          display: flex;

        }

        .input-prompt {

          color: #8b4513;

          font-size: 1.125rem;

          font-weight: 700;

        }

        .action-input {

          color: #2d2d2d;

          resize: vertical;

          background: 0 0;

          border: none;

          outline: none;

          flex: 1;

          min-height: 60px;

          max-height: 120px;

          font-family:

            Georgia,

            Times New Roman,

            serif;

          font-size: 0.875rem;

          font-weight: 500;

          line-height: 1.5;

        }

        .input-controls {

          align-items: center;

          gap: 0.5rem;

          margin-top: 0.5rem;

          display: flex;

        }

        .send-button {

          color: #fdfbf7;

          cursor: pointer;

          background: linear-gradient(135deg, #8b6914, sienna);

          border: none;

          border-radius: 0.375rem;

          padding: 0.5rem 1rem;

          font-size: 0.875rem;

          font-weight: 600;

          transition: all 0.2s;

          box-shadow: 0 2px 4px #0003;

        }

        .send-button:hover {

          background: linear-gradient(135deg, sienna, #8b6914);

          transform: translateY(-1px);

          box-shadow: 0 4px 8px #0000004d;

        }

        .send-button:active {

          transform: translateY(0);

          box-shadow: 0 2px 4px #0003;

        }

        .action-input::placeholder {

          color: #8b4513;

        }

        .rules-section,

        .uma-section {

          margin-bottom: 1rem;

        }

        .uma-section-header {

          cursor: pointer;

          background: #8b69140d;

          border-bottom: 1px solid #8b6914;

          border-radius: 0.25rem;

          justify-content: space-between;

          align-items: center;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          display: flex;

        }

        .uma-section-header:hover {

          background-color: #8b69141a;

          border-radius: 0.25rem;

        }

        .uma-section-title {

          color: #2d2d2d;

          font-size: 0.875rem;

          font-weight: 600;

        }

        .uma-toggle {

          color: #8b6914;

          font-size: 0.75rem;

          transition: transform 0.2s;

        }

        .uma-content {

          max-height: 300px;

          margin-top: 0.5rem;

          overflow: hidden auto;

        }

        .rules-list,

        .uma-list {

          flex-direction: column;

          gap: 0.5rem;

          display: flex;

        }

        .rule-item {

          background: #fff9;

          border-left: 3px solid #d4af37;

          border-radius: 0.5rem;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          font-size: 0.75rem;

          line-height: 1.3;

          transition: all 0.3s;

          box-shadow: 0 2px 4px #0000001a;

        }

        .rule-item:hover {

          box-shadow: 0 4px 8px #00000026;

        }

        .rule-item.dangerous-rule {

          background: linear-gradient(135deg, #8b00001a, #8b000033);

          border-left: 3px solid #8b0000;

          box-shadow: 0 2px 8px #8b000033;

        }

        .rule-item.dangerous-rule:hover {

          box-shadow: 0 4px 12px #8b00004d;

        }

        .rule-number {

          color: #8b6914;

          text-shadow: 0 1px 2px #0000001a;

          margin-right: 0.75rem;

          font-size: 0.9rem;

          font-weight: 700;

        }

        .rule-text {

          color: #2d2d2d;

          font-weight: 500;

          line-height: 1.3;

        }

        .dangerous-rule .rule-number {

          color: #8b0000;

          text-shadow: 0 1px 3px #8b00004d;

        }

        .dangerous-rule .rule-text {

          color: #8b0000;

          text-shadow: 0 0 2px #8b000033;

        }

        .fixed-rule {

          background: linear-gradient(135deg, #8b69141a, #d4af371a);

          border-left: 3px solid #8b6914;

          border-radius: 0.5rem;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          font-size: 0.75rem;

          line-height: 1.3;

          transition: all 0.3s;

          box-shadow: 0 2px 4px #0000001a;

        }

        .fixed-rule:hover {

          background: linear-gradient(135deg, #8b691426, #d4af3726);

          box-shadow: 0 4px 8px #00000026;

        }

        .fixed-rule .rule-number {

          color: #8b6914;

          text-shadow: 0 1px 2px #0000001a;

          margin-right: 0.75rem;

          font-size: 0.9rem;

          font-weight: 700;

        }

        .fixed-rule .rule-text {

          color: #2d2d2d;

          font-weight: 500;

          line-height: 1.3;

        }

        .view-rules-button {

          color: #e8d5d5;

          cursor: pointer;

          text-shadow: 0 1px 2px #00000080;

          background: linear-gradient(135deg, #2d1b1b, #3d2b2b);

          border: 1px solid #8b0000;

          border-radius: 0.25rem;

          justify-content: center;

          align-items: center;

          gap: 0.5rem;

          width: 100%;

          padding: 0.5rem;

          font-size: 0.75rem;

          font-weight: 500;

          transition: all 0.2s;

          display: flex;

          position: relative;

          box-shadow:

            inset 0 1px #ffffff1a,

            0 2px 4px #0006;

        }

        .view-rules-button:before {

          content: '';

          opacity: 0;

          background: linear-gradient(135deg, #8b00001a, #0000);

          transition: opacity 0.2s;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;

        }

        .view-rules-button:hover:before {

          opacity: 1;

        }

        .view-rules-button:hover {

          color: #f0e0e0;

          background: linear-gradient(135deg, #3d2b2b, #4d3b3b);

          border-color: #a00000;

          box-shadow:

            inset 0 1px #ffffff26,

            0 3px 6px #00000080;

        }

        .view-rules-button:active {

          background: linear-gradient(135deg, #1d0b0b, #2d1b1b);

          box-shadow:

            inset 0 2px 4px #0009,

            0 1px 2px #0000004d;

        }

        .rules-modal {

          z-index: 1000;

          backdrop-filter: blur(4px);

          background: #000000b3;

          justify-content: center;

          align-items: center;

          width: 100%;

          height: 100%;

          display: flex;

          position: fixed;

          top: 0;

          left: 0;

        }

        .rules-modal-content {

          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);

          border: 3px solid #8b6914;

          border-radius: 1rem;

          width: 90%;

          max-width: 600px;

          max-height: 80vh;

          position: relative;

          overflow: hidden;

          box-shadow: 0 20px 40px #0000004d;

        }







        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */

        #talents-modal .current-talents::-webkit-scrollbar,

        #talents-modal .upgrade-options::-webkit-scrollbar {

          width: 8px;

        }



        #talents-modal .current-talents::-webkit-scrollbar-track,

        #talents-modal .upgrade-options::-webkit-scrollbar-track {

          background: rgba(139, 69, 19, 0.1);

          border-radius: 4px;

        }



        #talents-modal .current-talents::-webkit-scrollbar-thumb,

        #talents-modal .upgrade-options::-webkit-scrollbar-thumb {

          background: rgba(139, 69, 19, 0.3);

          border-radius: 4px;

        }



        #talents-modal .current-talents::-webkit-scrollbar-thumb:hover,

        #talents-modal .upgrade-options::-webkit-scrollbar-thumb:hover {

          background: rgba(139, 69, 19, 0.5);

        }



        /* å…¨å±€æ»šåŠ¨æ¡æ ·å¼ - é’ˆå¯¹é‚£äº›ç°è‰²çš„æ»šåŠ¨æ¡ */

        ::-webkit-scrollbar {

          width: 4px;

        }



        ::-webkit-scrollbar-track {

          background: rgba(240, 240, 240, 0.3);

          border-radius: 2px;

        }



        ::-webkit-scrollbar-thumb {

          background: rgba(180, 180, 180, 0.4);

          border-radius: 2px;

        }



        ::-webkit-scrollbar-thumb:hover {

          background: rgba(160, 160, 160, 0.6);

        }

        .rules-modal-content:before {

          content: '';

          pointer-events: none;

          background-image:

            radial-gradient(circle at 20% 30%, #8b69140d 2px, #0000 4px),

            radial-gradient(circle at 80% 70%, #a086590a 1px, #0000 3px);

          background-size:

            60px 60px,

            40px 40px;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;

        }

        .rules-modal-header {

          color: #fdfbf7;

          background: linear-gradient(135deg, #8b6914, #a0865a);

          border-bottom: 2px solid #654321;

          justify-content: space-between;

          align-items: center;

          padding: 1rem 1.5rem;

          display: flex;

        }

        .rules-title {

          text-shadow: 0 2px 4px #0000004d;

          margin: 0;

          font-family:

            Brush Script MT,

            cursive;

          font-size: 1.5rem;

          font-weight: 700;

          transform: rotate(-1deg);

        }

        .close-rules-btn {

          color: #fdfbf7;

          cursor: pointer;

          background: 0 0;

          border: none;

          border-radius: 0.25rem;

          padding: 0.25rem 0.5rem;

          font-size: 1.5rem;

          transition: all 0.2s;

        }

        .close-rules-btn:hover {

          background: #fff3;

        }

        .rules-modal-body {

          max-height: 60vh;

          padding: 1.5rem;

          overflow-y: auto;

        }

        .book-tab:hover {

          transform: translateY(-3px) !important;

          box-shadow: 0 -4px 16px rgba(139, 105, 20, 0.4) !important;

        }

        .book-page-content {

          position: relative;

          overflow: hidden;

        }

        .book-page-content::before {

          content: '';

          position: absolute;

          top: 0;

          left: 0;

          right: 0;

          height: 1px;

          background: linear-gradient(90deg, transparent, rgba(139, 105, 20, 0.3), transparent);

        }

        .book-page-content::after {

          content: '';

          position: absolute;

          bottom: 0;

          left: 0;

          right: 0;

          height: 1px;

          background: linear-gradient(90deg, transparent, rgba(139, 105, 20, 0.3), transparent);

        }

        .rules-section-fixed,

        .rules-section-random {

          margin-bottom: 2rem;

        }

        .rules-section-title {

          color: #8b4513;

          border-bottom: 2px solid #d4af37;

          margin-bottom: 1rem;

          padding-bottom: 0.5rem;

          font-family:

            Brush Script MT,

            cursive;

          font-size: 1.2rem;

          font-weight: 700;

          transform: rotate(1deg);

        }

        .rules-list-handwritten {

          color: #2d2d2d;

          text-shadow: 0 1px 1px #fffc;

          font-family:

            Segoe Script,

            Brush Script MT,

            Georgia,

            serif;

          font-size: 0.95rem;

          font-weight: 500;

          line-height: 1.7;

        }

        .rule-item-handwritten {

          background: #fff9;

          border-left: 3px solid #d4af37;

          border-radius: 0.25rem;

          gap: 0.75rem;

          margin-bottom: 0.75rem;

          padding: 0.5rem;

          transition: all 0.3s;

          display: flex;

        }

        .rule-item-handwritten:hover {

          background: #fffc;

          transform: translate(4px);

        }

        .rule-number-handwritten {

          color: #8b6914;

          min-width: 1.5rem;

          font-size: 1rem;

          font-weight: 700;

        }

        .rule-text-handwritten {

          flex: 1;

          font-style: normal;

          font-weight: 500;

        }

        
        /* è§„åˆ™è®°å½•åŠŸèƒ½æ ·å¼ */
        .rules-record-controls {
          display: flex;
          gap: 0.5rem;
          margin-bottom: 1rem;
        }
        
        .add-rule-btn, .clear-rules-btn {
          background: linear-gradient(135deg, #8b4513, #a0522d);
          color: white;
          border: 1px solid #d4af37;
          border-radius: 0.25rem;
          padding: 0.25rem 0.75rem;
          font-size: 0.8rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          font-family: 'Segoe Script', cursive;
        }
        
        .add-rule-btn:hover, .clear-rules-btn:hover {
          background: linear-gradient(135deg, #a0522d, #cd853f);
          transform: translateY(-1px);
          box-shadow: 0 2px 4px rgba(139, 69, 19, 0.3);
        }
        
        .clear-rules-btn {
          background: linear-gradient(135deg, #dc2626, #ef4444);
        }
        
        .clear-rules-btn:hover {
          background: linear-gradient(135deg, #ef4444, #f87171);
        }
        
        
        .rule-item-editable {
          position: relative;
          padding-right: 2rem;
        }
        
        .rule-edit-btn, .rule-delete-btn {
          position: absolute;
          right: 0.25rem;
          top: 50%;
          transform: translateY(-50%);
          background: none;
          border: none;
          color: #8b4513;
          cursor: pointer;
          font-size: 0.8rem;
          padding: 0.1rem;
          border-radius: 0.2rem;
          transition: all 0.2s;
        }
        
        .rule-edit-btn {
          right: 1.5rem;
        }
        
        .rule-edit-btn:hover, .rule-delete-btn:hover {
          background: rgba(139, 69, 19, 0.1);
          color: #a0522d;
        }
        
        .rule-delete-btn:hover {
          color: #dc2626;
        }
        
        .rule-input {
          width: 100%;
          background: #fff9;
          border: 1px solid #d4af37;
          border-radius: 0.25rem;
          padding: 0.25rem 0.5rem;
          font-family: 'Segoe Script', cursive;
          font-size: 0.9rem;
          color: #2d2d2d;
          resize: vertical;
          min-height: 2rem;
        }
        
        .rule-input:focus {
          outline: none;
          border-color: #8b4513;
          background: #fffc;
        }
        
        .empty-rules {
          color: #8b4513;
          font-style: italic;
          text-align: center;
          padding: 1rem;
          background: rgba(139, 69, 19, 0.1);
          border-radius: 0.25rem;
          border: 1px dashed #d4af37;
        }
        .location-display {

          color: #059669;

          background: linear-gradient(135deg, #0596691a, #10b9811a);

          border: 1px solid #059669;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;

        }

        .inventory-item {

          background: linear-gradient(145deg, #ffffffb3, #8b69141a);

          border: 1px solid #d4af37;

          border-radius: 0.5rem;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          transition: all 0.3s;

          position: relative;

          box-shadow: 0 2px 6px #0000001a;

        }

        .inventory-item:before {

          content: '';

          opacity: 0.6;

          background: linear-gradient(90deg, #d4af37, gold, #d4af37);

          height: 2px;

          position: absolute;

          top: 0;

          left: 0;

          right: 0;

        }

        .inventory-item:hover {

          border-color: gold;

          box-shadow: 0 4px 10px #00000026;

        }

        .uma-item {

          background: 

            linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(139, 105, 20, 0.1)),

            radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.15) 0%, transparent 60%),

            radial-gradient(circle at 20% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 60%),

            linear-gradient(45deg, transparent 30%, rgba(212, 175, 55, 0.05) 50%, transparent 70%) !important;

          background-color: transparent !important;

          border: 1px solid #d4af37 !important;

          border-radius: 0.5rem;

          margin-bottom: 0.75rem;

          padding: 0.75rem;

          transition: all 0.3s;

          position: relative;

          overflow: visible;

          box-shadow: 

            0 2px 8px rgba(0, 0, 0, 0.1),

            inset 0 1px 0 rgba(255, 255, 255, 0.2),

            inset 0 -1px 0 rgba(0, 0, 0, 0.05) !important;

        }



        /* å¼ºåˆ¶è¦†ç›–ä»»ä½•å¯èƒ½çš„èƒŒæ™¯è‰²è®¾ç½® */

        .uma-item[style*="background"] {

          background: 

            linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(139, 105, 20, 0.1)),

            radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.15) 0%, transparent 60%),

            radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 60%),

            linear-gradient(45deg, transparent 30%, rgba(212, 175, 55, 0.05) 50%, transparent 70%) !important;

        }



        /* æœ€é«˜ä¼˜å…ˆçº§å¼ºåˆ¶è®¾ç½® */

        div.uma-item,

        .uma-item,

        .uma-item[style],

        .parchment-page .uma-item,

        .panel-content .uma-item {

          background: 

            linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(139, 105, 20, 0.1)),

            radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.15) 0%, transparent 60%),

            radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 60%),

            linear-gradient(45deg, transparent 30%, rgba(212, 175, 55, 0.05) 50%, transparent 70%) !important;

          background-color: transparent !important;

        }





        .uma-item:before {

          content: '';

          opacity: 0.7;

          background: linear-gradient(90deg, #d4af37, gold, #d4af37);

          height: 2px;

          position: absolute;

          top: 0;

          left: 0;

          right: 0;

        }


        /* å¡”ç½—å åœæ ·å¼ */
        .tarot-divination {
          color: #8b6914;
          background: #ffffffe6;
          border: 1px solid #d4af37;
          border-radius: 0.375rem;
          align-items: center;
          gap: 0.5rem;
          min-width: -moz-fit-content;
          min-width: fit-content;
          padding: 0.25rem 0.75rem;
          font-size: 0.8rem;
          font-weight: 600;
          display: flex;
          cursor: pointer;
          transition: all 0.3s;
          box-shadow: 0 1px 2px rgba(139, 69, 19, 0.3);
        }
        
        .tarot-divination:hover {
          background: #ffffff;
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(139, 69, 19, 0.3);
          border-color: #8b6914;
        }
        
        .tarot-modal-content {
          max-width: 800px;
          max-height: 90vh;
        }
        
        .tarot-info {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.05));
          border: 1px solid rgba(139, 105, 20, 0.3);
          border-radius: 0.375rem;
          padding: 1rem;
          margin-bottom: 1rem;
          color: #8b4513;
        }
        
        .tarot-info p {
          margin: 0.25rem 0;
          font-weight: 600;
        }
        
        .spread-buttons {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
          margin-bottom: 1.5rem;
        }
        
        .spread-btn {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.05));
          border: 1px solid rgba(139, 105, 20, 0.3);
          border-radius: 0.375rem;
          padding: 1rem;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 0.5rem;
          color: #8b4513;
          font-weight: 600;
          position: relative;
        }
        
        .spread-btn:hover:not(.disabled) {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.2), rgba(139, 105, 20, 0.1));
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(139, 69, 19, 0.3);
          border-color: rgba(139, 105, 20, 0.5);
        }
        
        .spread-btn.disabled {
          opacity: 0.5;
          cursor: not-allowed;
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.05), rgba(139, 105, 20, 0.02));
        }
        
        .spread-btn.advanced {
          background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
          border-color: rgba(34, 197, 94, 0.3);
          color: #22c55e;
        }
        
        .spread-btn.advanced:hover:not(.disabled) {
          background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
          box-shadow: 0 4px 8px rgba(34, 197, 94, 0.3);
          border-color: rgba(34, 197, 94, 0.5);
        }
        
        .spread-icon {
          font-size: 1.5rem;
        }
        
        .spread-name {
          font-size: 0.9rem;
          font-weight: 700;
        }
        
        .spread-cost {
          font-size: 0.8rem;
          color: #6b7280;
        }
        
        .spread-requirement {
          font-size: 0.7rem;
          color: #f59e0b;
          font-weight: 600;
        }
        
        .tarot-result {
          background: linear-gradient(135deg, #4c1d951a, #7c3aed1a);
          border: 1px solid #a855f7;
          border-radius: 0.5rem;
          padding: 1rem;
          margin-top: 1rem;
        }
        
        .tarot-cards {
          display: flex;
          flex-wrap: wrap;
          gap: 1rem;
          margin-bottom: 1rem;
        }
        
        .tarot-card {
          background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
          border: 2px solid #d1d5db;
          border-radius: 0.5rem;
          padding: 1rem;
          min-width: 120px;
          text-align: center;
          position: relative;
          cursor: pointer;
          transition: all 0.3s;
        }
        
        .tarot-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .tarot-card.reversed {
          transform: rotate(180deg);
        }
        
        .tarot-card-name {
          font-weight: 700;
          color: #374151;
          margin-bottom: 0.5rem;
        }
        
        .tarot-card-meaning {
          font-size: 0.8rem;
          color: #6b7280;
        }
        
        .tarot-interpretation {
          background: #f9fafb;
          border: 1px solid #e5e7eb;
          border-radius: 0.5rem;
          padding: 1rem;
          margin-bottom: 1rem;
          color: #374151;
        }
        
        .tarot-effects {
          background: linear-gradient(135deg, #fef3c7, #fde68a);
          border: 1px solid #f59e0b;
          border-radius: 0.5rem;
          padding: 1rem;
          color: #92400e;
        }
        
        .tarot-effects h4 {
          margin: 0 0 0.5rem 0;
          color: #92400e;
        }
        
        .tarot-effects ul {
          margin: 0;
          padding-left: 1.5rem;
        }
        
        .tarot-effects li {
          margin: 0.25rem 0;
        }


        .uma-item::after {

          content: '';

          position: absolute;

          top: 0;

          left: 0;

          right: 0;

          bottom: 0;

          background: 

            radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 50%),

            radial-gradient(circle at 70% 80%, rgba(212, 175, 55, 0.06) 0%, transparent 50%),

            linear-gradient(45deg, transparent 40%, rgba(255, 255, 255, 0.02) 50%, transparent 60%);

          pointer-events: none;

          z-index: 1;

        }

        .uma-item:hover {

          border-color: gold;

          box-shadow: 

            0 4px 12px rgba(0, 0, 0, 0.15),

            inset 0 1px 0 rgba(255, 255, 255, 0.3),

            inset 0 -1px 0 rgba(0, 0, 0, 0.1);

          transform: translateY(-1px);

        }

        .uma-header {

          justify-content: space-between;

          align-items: center;

          margin-bottom: 0.5rem;

          display: flex;

          position: relative;

          z-index: 2;

        }

        .uma-info {

          align-items: center;

          gap: 0.5rem;

          display: flex;

        }



        .uma-name {

          color: #dc2626;

          text-shadow: 0 1px 2px #00000040;

          letter-spacing: 0.5px;

          font-size: 1rem;

          font-weight: 700;

          margin-bottom: 0.2rem;

        }



        .uma-text-info {

          display: flex;

          flex-direction: column;

          gap: 0.15rem;

          justify-content: center;

        }

        .uma-name {

          font-size: 1rem;

          font-weight: 600;

          line-height: 1.2;

          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);

        }



        .uma-status-text {

          font-size: 0.7rem;

          font-weight: 400;

          opacity: 0.9;

          transition: all 0.3s ease;

          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);

          border-radius: 0.3rem;

          padding: 0.1rem 0.3rem;

          background: rgba(255, 255, 255, 0.85);

          backdrop-filter: blur(3px);

          border: 1px solid rgba(212, 175, 55, 0.2);

          color: #ff69b4 !important;

          letter-spacing: 0.2px;

          box-shadow: 0 1px 3px rgba(212, 175, 55, 0.15);

        }

        /* ä¸åŒçŠ¶æ€æ–‡å­—çš„ç¾åŒ–æ ·å¼ */
        .uma-status-text[style*="color: #059669"] {

          background: linear-gradient(135deg, rgba(5, 150, 105, 0.12), rgba(5, 150, 105, 0.08));

          border-color: rgba(5, 150, 105, 0.25);

          color: #059669 !important;

          box-shadow: 0 1px 3px rgba(5, 150, 105, 0.15);

        }

        .uma-status-text[style*="color: #8b0000"] {

          background: linear-gradient(135deg, rgba(139, 0, 0, 0.12), rgba(139, 0, 0, 0.08));

          border-color: rgba(139, 0, 0, 0.25);

          color: #8b0000 !important;

          box-shadow: 0 1px 3px rgba(139, 0, 0, 0.15);

        }

        .uma-status-text[style*="color: #6b7280"] {

          background: linear-gradient(135deg, rgba(107, 114, 128, 0.12), rgba(107, 114, 128, 0.08));

          border-color: rgba(107, 114, 128, 0.25);

          color: #6b7280 !important;

          box-shadow: 0 1px 3px rgba(107, 114, 128, 0.15);

        }

        .uma-status-text[style*="color: #f59e0b"] {

          background: linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(245, 158, 11, 0.08));

          border-color: rgba(245, 158, 11, 0.25);

          color: #dc2626 !important;

          box-shadow: 0 1px 3px rgba(245, 158, 11, 0.15);

        }

        .uma-status-text[style*="color: #ef4444"] {

          background: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(239, 68, 68, 0.08));

          border-color: rgba(239, 68, 68, 0.25);

          color: #ef4444 !important;

          box-shadow: 0 1px 3px rgba(239, 68, 68, 0.15);

        }

        .uma-status-text[style*="color: #dc2626"] {

          background: linear-gradient(135deg, rgba(220, 38, 38, 0.15), rgba(185, 28, 28, 0.1));

          border-color: rgba(220, 38, 38, 0.3);

          color: #dc2626 !important;

          box-shadow: 0 1px 4px rgba(220, 38, 38, 0.2);

        }

        /* çŠ¶æ€æ–‡å­—æ‚¬åœæ•ˆæœ */
        .uma-status-text:hover {

          transform: translateY(-0.5px);

          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);

          transition: all 0.3s ease;

        }

        .uma-avatar-container {

          position: relative;

          display: inline-block;

        }

        .uma-avatar {

          width: 3rem;

          height: 3rem;

          border-radius: 50%;

          object-fit: cover;

          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);

        }

        .avatar-decoration {

          position: absolute;

          top: -0.5rem;

          right: -0.5rem;

          display: flex;

          align-items: center;

          justify-content: center;

          width: 1.2rem;

          height: 1.2rem;

          font-size: 0.8rem;

          border-radius: 50%;

          background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));

          backdrop-filter: blur(5px);

          border: 1px solid rgba(255, 255, 255, 0.3);

          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);

          z-index: 10;

          animation: decorationFloat 2s ease-in-out infinite;

        }

        .uma-status-decoration {

          position: absolute;

          top: 0.5rem;

          right: 0.5rem;

          display: flex;

          align-items: center;

          justify-content: center;

          width: 1.5rem;

          height: 1.5rem;

          font-size: 1rem;

          border-radius: 50%;

          background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));

          backdrop-filter: blur(10px);

          border: 1px solid rgba(255, 255, 255, 0.3);

          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);

          transition: all 0.3s ease;

          animation: decorationFloat 3s ease-in-out infinite;

          z-index: 10;

        }

        .uma-status-decoration:hover {

          transform: scale(1.1) rotate(5deg);

          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);

        }

        @keyframes decorationFloat {

          0%, 100% { transform: translateY(0px); }

          50% { transform: translateY(-3px); }

        }

        /* ä¸åŒçŠ¶æ€çš„å¤´åƒè£…é¥°æ ·å¼ */
        .uma-avatar-container.normal .avatar-decoration {

          background: linear-gradient(135deg, rgba(5, 150, 105, 0.9), rgba(5, 150, 105, 0.7));

          border-color: rgba(5, 150, 105, 0.3);

          color: #059669;

        }

        .uma-avatar-container.possessed .avatar-decoration {

          background: linear-gradient(135deg, rgba(139, 0, 0, 0.9), rgba(139, 0, 0, 0.7));

          border-color: rgba(139, 0, 0, 0.3);

          color: #8b0000;

          animation: decorationFloat 2s ease-in-out infinite, possessedGlow 1.5s ease-in-out infinite alternate;

        }

        .uma-avatar-container.missing .avatar-decoration {

          background: linear-gradient(135deg, rgba(107, 114, 128, 0.9), rgba(107, 114, 128, 0.7));

          border-color: rgba(107, 114, 128, 0.3);

          color: #6b7280;

        }

        .uma-avatar-container.confused .avatar-decoration {

          background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(245, 158, 11, 0.7));

          border-color: rgba(245, 158, 11, 0.3);

          color: #f59e0b;

          animation: decorationFloat 1.5s ease-in-out infinite, confusedSpin 3s linear infinite;

        }

        .uma-avatar-container.alert .avatar-decoration {

          background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(239, 68, 68, 0.7));

          border-color: rgba(239, 68, 68, 0.3);

          color: #ef4444;

          animation: decorationFloat 1s ease-in-out infinite, alertPulse 0.8s ease-in-out infinite;

        }

        .uma-avatar-container.yandere .avatar-decoration {

          background: linear-gradient(135deg, rgba(220, 38, 38, 0.9), rgba(185, 28, 28, 0.8));

          border-color: rgba(220, 38, 38, 0.4);

          color: #dc2626;

          animation: decorationFloat 0.8s ease-in-out infinite, yandereShake 0.5s ease-in-out infinite;

        }

        /* ä¸åŒçŠ¶æ€çš„è£…é¥°æ ·å¼ */
        .uma-status-decoration.normal {

          background: linear-gradient(135deg, rgba(5, 150, 105, 0.2), rgba(5, 150, 105, 0.1));

          border-color: rgba(5, 150, 105, 0.3);

          color: #059669;

        }

        .uma-status-decoration.possessed {

          background: linear-gradient(135deg, rgba(139, 0, 0, 0.2), rgba(139, 0, 0, 0.1));

          border-color: rgba(139, 0, 0, 0.3);

          color: #8b0000;

          animation: decorationFloat 2s ease-in-out infinite, possessedGlow 1.5s ease-in-out infinite alternate;

        }

        .uma-status-decoration.missing {

          background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(107, 114, 128, 0.1));

          border-color: rgba(107, 114, 128, 0.3);

          color: #6b7280;

        }

        .uma-status-decoration.confused {

          background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));

          border-color: rgba(245, 158, 11, 0.3);

          color: #f59e0b;

          animation: decorationFloat 1.5s ease-in-out infinite, confusedSpin 3s linear infinite;

        }

        .uma-status-decoration.alert {

          background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));

          border-color: rgba(239, 68, 68, 0.3);

          color: #ef4444;

          animation: decorationFloat 1s ease-in-out infinite, alertPulse 0.8s ease-in-out infinite;

        }

        .uma-status-decoration.yandere {

          background: linear-gradient(135deg, rgba(220, 38, 38, 0.3), rgba(185, 28, 28, 0.2));

          border-color: rgba(220, 38, 38, 0.4);

          color: #dc2626;

          animation: decorationFloat 0.8s ease-in-out infinite, yandereShake 0.5s ease-in-out infinite;

        }

        /* ç‰¹æ®ŠåŠ¨ç”»æ•ˆæœ */
        @keyframes possessedGlow {

          0%, 100% { box-shadow: 0 2px 8px rgba(139, 0, 0, 0.3); }

          50% { box-shadow: 0 2px 16px rgba(139, 0, 0, 0.6); }

        }

        @keyframes confusedSpin {

          0% { transform: translateY(0px) rotate(0deg); }

          50% { transform: translateY(-3px) rotate(180deg); }

          100% { transform: translateY(0px) rotate(360deg); }

        }

        @keyframes alertPulse {

          0%, 100% { transform: scale(1); }

          50% { transform: scale(1.1); }

        }

        @keyframes yandereShake {

          0%, 100% { transform: translateX(0px); }

          25% { transform: translateX(-2px); }

          75% { transform: translateX(2px); }

        }



        .uma-status-badge {

          text-transform: uppercase;

          letter-spacing: 0.5px;

          border-radius: 0.75rem;

          padding: 0.25rem 0.5rem;

          font-size: 0.7rem;

          font-weight: 600;

          box-shadow: 0 1px 3px #0003;

          transition: all 0.3s ease;

        }

        .uma-status {

          text-transform: uppercase;

          letter-spacing: 0.5px;

          border-radius: 0.75rem;

          padding: 0.25rem 0.5rem;

          font-size: 0.7rem;

          font-weight: 600;

          box-shadow: 0 1px 3px #0003;

        }

        .uma-status-badge.normal {

          color: #fff;

          background: linear-gradient(135deg, #059669cc, #05966999);

          border: 1px solid #0596694d;

        }

        .uma-status-badge.possessed {

          color: #fff;

          background: linear-gradient(135deg, #8b0000cc, #8b000099);

          border: 1px solid #8b00004d;

        }

        .uma-status-badge.missing {

          color: #fff;

          background: linear-gradient(135deg, #6b7280cc, #6b728099);

          border: 1px solid #6b72804d;

        }

        .uma-status-badge.confused {

          color: #fff;

          background: linear-gradient(135deg, #f59e0bcc, #f59e0b99);

          border: 1px solid #f59e0b4d;

        }

        .uma-status-badge.alert {

          color: #fff;

          background: linear-gradient(135deg, #ef4444cc, #ef444499);

          border: 1px solid #ef44444d;

        }

        .uma-status-badge.yandere {

          color: #fff;

          text-shadow: 0 1px 2px #00000080;

          background: linear-gradient(135deg, #dc2626e6, #b91c1ccc);

          border: 2px solid #dc262680;

          font-weight: 700;

          animation: 2s ease-in-out infinite yanderePulse;

          box-shadow: 0 0 10px #dc262666;

        }

        @keyframes yanderePulse {

          0%,

          to {

            box-shadow: 0 0 10px #dc262666;

          }

          50% {

            box-shadow:

              0 0 20px #dc2626b3,

              0 0 30px #dc26264d;

          }

        }

        @keyframes bloodGlow {

          0% {

            transform: rotate(0);

            box-shadow:

              0 0 20px #f00c,

              0 0 40px #f006,

              0 0 60px #f003;

          }

          25% {

            transform: rotate(90deg);

            box-shadow:

              0 0 25px #ff0000e6,

              0 0 50px #ff000080,

              0 0 75px #ff00004d;

          }

          50% {

            transform: rotate(180deg);

            box-shadow:

              0 0 20px #f00c,

              0 0 40px #f006,

              0 0 60px #f003;

          }

          75% {

            transform: rotate(270deg);

            box-shadow:

              0 0 25px #ff0000e6,

              0 0 50px #ff000080,

              0 0 75px #ff00004d;

          }

          to {

            transform: rotate(360deg);

            box-shadow:

              0 0 20px #f00c,

              0 0 40px #f006,

              0 0 60px #f003;

          }

        }

        .uma-status.worried {

          color: #fff;

          background: linear-gradient(135deg, #a855f7cc, #a855f799);

          border: 1px solid #a855f74d;

        }

        .uma-status.protect {

          color: #fff;

          background: linear-gradient(135deg, #22c55ecc, #22c55e99);

          border: 1px solid #22c55e4d;

        }

        .uma-desc {

          color: #654321;

          text-shadow: 0 1px 1px #ffffff80;

          margin: 0.5rem 0;

          font-size: 0.8rem;

          font-style: italic;

          line-height: 1.4;

          position: relative;

          z-index: 2;

        }

        .uma-hearts {

          justify-content: center;

          gap: 0.25rem;

          margin-top: 0.5rem;

          display: flex;

          position: relative;

          z-index: 2;

        }

        .heart {

          color: #dc2626;

          text-shadow: 0 2px 4px #dc26264d;

          font-size: 1rem;

          animation: 2s ease-in-out infinite heartBeat;

          display: inline-block;

        }

        .heart:nth-child(2) {

          animation-delay: 0.2s;

        }

        .heart:nth-child(3) {

          animation-delay: 0.4s;

        }

        .heart:nth-child(4) {

          animation-delay: 0.6s;

        }

        .heart:nth-child(5) {

          animation-delay: 0.8s;

        }

        @keyframes heartBeat {

          0%,

          to {

            transform: scale(1);

          }

          50% {

            transform: scale(1.1);

          }

        }

        .twisted-love-accent {

          color: #8b0000;

          text-shadow: 0 0 3px #8b000066;

          font-weight: 700;

        }

        .horror-glow {

          color: #8b0000;

          text-shadow: 0 0 4px #8b000099;

        }

        .typewriter-cursor {

          color: #8b0000;

          animation: 1.2s infinite blink;

        }

        @keyframes blink {

          0%,

          50% {

            opacity: 1;

          }

          51%,

          to {

            opacity: 0;

          }

        }

        @keyframes subtle-pulse {

          0%,

          to {

            opacity: 0.8;

            transform: scale(1);

          }

          50% {

            opacity: 1;

            transform: scale(1.02);

          }

        }

        .subtle-hover {

          transition: all 0.2s;

        }

        .subtle-hover:hover {

          transform: translateY(-1px);

          box-shadow: 0 2px 4px #0000004d;

        }

        .inventory-item {

          background: #ffffffb3;

          border: 1px solid #d4af37;

          border-radius: 0.375rem;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          box-shadow: 0 2px 4px #0000001a;

        }

        .item-header {

          cursor: pointer;

          z-index: 10;

          -webkit-user-select: none;

          user-select: none;

          justify-content: space-between;

          align-items: center;

          padding: 0.25rem 0;

          display: flex;

          position: relative;

        }

        .item-header:hover {

          background-color: #d4af371a;

          border-radius: 0.25rem;

        }

        .item-toggle {

          color: #8b6914;

          font-size: 0.75rem;

          transition: transform 0.2s;

        }

        .item-name {

          color: #8b6914;

          font-size: 0.875rem;

          font-weight: 600;

        }

        .item-details {

          border-top: 1px solid #d4af374d;

          margin-top: 0.5rem;

          padding-top: 0.5rem;

        }

        .item-detail-popup {

          z-index: 100;

          background: #fffffff2;

          border: 1px solid #d4af37;

          border-radius: 0.375rem;

          min-width: 180px;

          max-width: 250px;

          padding: 0.75rem;

          font-size: 0.75rem;

          position: absolute;

          top: -10px;

          left: 0;

          box-shadow: 0 2px 8px #0003;

        }



        .skill-detail-popup {

          z-index: 100;

          background: #fffffff2;

          border: 1px solid #805ad5;

          border-radius: 0.375rem;

          min-width: 150px;

          max-width: 200px;

          padding: 0.5rem;

          font-size: 0.75rem;

          position: absolute;

          top: -10px;

          left: 0;

          box-shadow: 0 2px 8px #0003;

        }



        .skill-popup:after {

          content: '';

          border-top: 5px solid #805ad5;

          border-left: 5px solid #0000;

          border-right: 5px solid #0000;

          width: 0;

          height: 0;

          position: absolute;

          top: 100%;

          left: 1rem;

        }



        .skill-desc {

          color: #654321;

          text-shadow: 0 1px 1px #ffffff80;

          margin-bottom: 0.5rem;

          font-size: 0.8rem;

          font-style: italic;

          line-height: 1.4;

        }


        .skill-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 12px;
          padding-bottom: 8px;
          border-bottom: 1px solid rgba(139, 69, 19, 0.2);
        }

        .skill-title {
          font-size: 16px;
          font-weight: bold;
          color: #8b4513;
        }


        .skill-use-btn {

          background: linear-gradient(135deg, #805ad5, #6b46c1);

          color: white;

          border: none;

          border-radius: 0.25rem;

          padding: 0.25rem 0.5rem;

          font-size: 0.7rem;

          cursor: pointer;

          margin: 0.25rem 0.25rem 0 0;

          transition: all 0.2s;

        }



        .skill-use-btn:hover {

          background: linear-gradient(135deg, #6b46c1, #553c9a);

          transform: translateY(-1px);

        }



        .item-popup.show {

          display: block;

        }

        .item-popup:after {

          content: '';

          border-top: 5px solid #d4af37;

          border-left: 5px solid #0000;

          border-right: 5px solid #0000;

          width: 0;

          height: 0;

          position: absolute;

          top: 100%;

          left: 1rem;

        }

        .item-desc {

          color: #654321;

          text-shadow: 0 1px 1px #ffffff80;

          margin-bottom: 0.75rem;

          font-size: 0.8rem;

          font-style: italic;

          line-height: 1.5;

        }

        .item-effect {

          color: #059669;

          text-shadow: 0 1px 1px #ffffff80;

          margin-bottom: 0.5rem;

          font-size: 0.8rem;

          font-weight: 600;

        }

        .item-rarity {

          border-radius: 0.375rem;

          padding: 0.25rem 0.5rem;

          font-size: 0.75rem;

          font-weight: 600;

          display: inline-block;

          text-align: center;

        }

        /* ç¨€æœ‰åº¦æ ·å¼ */

        .rarity-æ™®é€š {

          color: #696969;

          background: linear-gradient(135deg, #f5f5f5, #e0e0e0);

          border: 2px solid #b0b0b0;

          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);

        }



        .rarity-ç¨€æœ‰ {

          color: #2563eb;

          background: linear-gradient(135deg, #dbeafe, #bfdbfe);

          border: 2px solid #3b82f6;

          box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);

          text-shadow: 0 1px 2px rgba(59, 130, 246, 0.2);

        }



        .rarity-å²è¯— {

          color: #7c3aed;

          background: linear-gradient(135deg, #ede9fe, #ddd6fe);

          border: 2px solid #8b5cf6;

          box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);

          text-shadow: 0 1px 2px rgba(139, 92, 246, 0.2);

        }



        .rarity-ä¼ è¯´ {

          color: #d97706;

          background: linear-gradient(135deg, #fef3c7, #fde68a);

          border: 2px solid #f59e0b;

          box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);

          text-shadow: 0 1px 3px rgba(217, 119, 6, 0.3);

          animation: legendary-glow 2s ease-in-out infinite alternate;

        }



        @keyframes legendary-glow {

          from {

            box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);

          }

          to {

            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.6);

          }

        }

        .rules-section-header {

          cursor: pointer;

          border-bottom: 1px solid #d4af37;

          justify-content: space-between;

          align-items: center;

          margin: 0.75rem 0 0.5rem;

          padding: 0.5rem 0;

          display: flex;

        }

        .rules-section-header:hover {

          background-color: #d4af371a;

          border-radius: 0.25rem;

        }

        .rules-section-title {

          color: #8b6914;

          font-size: 0.875rem;

          font-weight: 600;

        }

        .rules-toggle {

          color: #8b6914;

          font-size: 0.75rem;

          transition: transform 0.2s;

        }

        .rules-content {

          margin-top: 0.5rem;

        }

        .currency-section {

          color: #8b6914;

          background: #ffffffe6;

          border: 1px solid #d4af37;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;

        }

        .bottom-panel {

          white-space: nowrap;

          background-color: #fdfbf7;

          border-top: 2px solid #8b6914;

          flex-wrap: nowrap;

          grid-area: 3/1/4/4;

          justify-content: space-between;

          align-items: center;

          gap: 1rem;

          height: 40px;

          padding: 0.5rem;

          display: flex;

          overflow: hidden;

        }

        .bottom-group {

          flex-shrink: 0;

          align-items: center;

          gap: 0.5rem;

          display: flex;

        }

        .festival-notice {

          color: #b8860b;

          background: linear-gradient(135deg, #ffd7001a, #ffc1071a);

          border: 1px solid gold;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;

        }

        .rules-countdown {

          color: #dc2626;

          background: linear-gradient(135deg, #8b00001a, #dc26261a);

          border: 1px solid #dc2626;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;

        }

        .reply-timer {

          color: #16a34a;

          background: linear-gradient(135deg, #22c55e1a, #16a34a1a);

          border: 1px solid #16a34a;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          transition: all 0.3s;

          display: flex;

        }

        .reply-timer.warning {

          color: #d97706;

          background: linear-gradient(135deg, #f59e0b1a, #d977061a);

          border-color: #d97706;

        }

        .reply-timer.danger {

          color: #dc2626;

          background: linear-gradient(135deg, #ef44441a, #dc26261a);

          border-color: #dc2626;

          animation: 1s ease-in-out infinite pulse;

        }

        @keyframes pulse {

          0%,

          to {

            opacity: 1;

          }

          50% {

            opacity: 0.7;

          }

        }

        .gacha-coin {

          color: #b8860b;

          background: linear-gradient(135deg, #b8860b1a, #ffd7001a);

          border: 1px solid #b8860b;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;

        }

        .hot-spring-ticket {

          color: #059669;

          background: linear-gradient(135deg, #0596691a, #10b9811a);

          border: 1px solid #059669;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;

        }

        .save-button,

        .view-rules-button {

          color: #2d2d2d;

          cursor: pointer;

          background: linear-gradient(135deg, #f5f0e8, #e8d5c4);

          border: 2px solid #8b4513;

          border-radius: 0.375rem;

          padding: 0.5rem 1rem;

          font-size: 0.875rem;

          font-weight: 600;

          transition: all 0.3s;

          position: relative;

          overflow: hidden;

        }

        .save-button:before,

        .view-rules-button:before {

          content: '';

          opacity: 0;

          border-radius: inherit;

          background: linear-gradient(135deg, #8b00001a, #0000);

          transition: opacity 0.3s;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;

        }

        .save-button:after,

        .view-rules-button:after {

          content: '';

          background: radial-gradient(circle, #8b00004d 0%, #0000 70%);

          border-radius: 50%;

          width: 0;

          height: 0;

          transition: all 0.4s;

          position: absolute;

          top: 50%;

          left: 50%;

          transform: translate(-50%, -50%);

        }

        .save-button:hover,

        .view-rules-button:hover {

          transform: translateY(-2px);

          box-shadow: 0 4px 12px #8b00004d;

        }

        .save-button:hover:before,

        .view-rules-button:hover:before {

          opacity: 1;

        }

        .save-button:hover:after,

        .view-rules-button:hover:after {

          width: 200px;

          height: 200px;

        }

        .save-button:active,

        .view-rules-button:active {

          transform: translateY(0);

          box-shadow: 0 2px 8px #8b000066;

        }

        .save-button:active:after,

        .view-rules-button:active:after {

          background: radial-gradient(circle, #8b000080 0%, #0000 60%);

          width: 300px;

          height: 300px;

        }

      }

      @property --tw-rotate-x {

        syntax: '*';

        inherits: false;

      }

      @property --tw-rotate-y {

        syntax: '*';

        inherits: false;

      }

      @property --tw-rotate-z {

        syntax: '*';

        inherits: false;

      }

      @property --tw-skew-x {

        syntax: '*';

        inherits: false;

      }

      @property --tw-skew-y {

        syntax: '*';

        inherits: false;

      }

      @property --tw-border-style {

        syntax: '*';

        inherits: false;

        initial-value: solid;

      }

      @property --tw-shadow {

        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;

      }

      @property --tw-shadow-color {

        syntax: '*';

        inherits: false;

      }

      @property --tw-shadow-alpha {

        syntax: '<percentage>';

        inherits: false;

        initial-value: 100%;

      }

      @property --tw-inset-shadow {

        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;

      }

      @property --tw-inset-shadow-color {

        syntax: '*';

        inherits: false;

      }

      @property --tw-inset-shadow-alpha {

        syntax: '<percentage>';

        inherits: false;

        initial-value: 100%;

      }

      @property --tw-ring-color {

        syntax: '*';

        inherits: false;

      }

      @property --tw-ring-shadow {

        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;

      }

      @property --tw-inset-ring-color {

        syntax: '*';

        inherits: false;

      }

      @property --tw-inset-ring-shadow {

        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;

      }

      @property --tw-ring-inset {

        syntax: '*';

        inherits: false;

      }

      @property --tw-ring-offset-width {

        syntax: '<length>';

        inherits: false;

        initial-value: 0;

      }

      @property --tw-ring-offset-color {

        syntax: '*';

        inherits: false;

        initial-value: #fff;

      }

      @property --tw-ring-offset-shadow {

        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;

      }

      @property --tw-outline-style {

        syntax: '*';

        inherits: false;

        initial-value: solid;

      }

      @property --tw-backdrop-blur {

        syntax: '*';

        inherits: false;

      }

      @property --tw-backdrop-brightness {

        syntax: '*';

        inherits: false;

      }

      @property --tw-backdrop-contrast {

        syntax: '*';

        inherits: false;

      }

      @property --tw-backdrop-grayscale {

        syntax: '*';

        inherits: false;

      }

      @property --tw-backdrop-hue-rotate {

        syntax: '*';

        inherits: false;

      }

      @property --tw-backdrop-invert {

        syntax: '*';

        inherits: false;

      }

      @property --tw-backdrop-opacity {

        syntax: '*';

        inherits: false;

      }

      @property --tw-backdrop-saturate {

        syntax: '*';

        inherits: false;

      }

      /* æ–‡æœ¬æ ¼å¼ç¾åŒ–æ ·å¼ */
      body, .story-text, .story-content {
        color: #000000 !important;
      }

      .dialogue-text {
        color: #000000 !important;
      }

      .psychology-text {
        color: #000000 !important;
      }

      .scenery-text {
        color: #000000 !important;
      }

      @property --tw-backdrop-sepia {

        syntax: '*';

        inherits: false;

      }

    </style>

  </head>

  <body>

    <div class="connected-panels">

      <!-- å·¦ä¾§é¢æ¿ï¼šè®­ç»ƒå‘˜ä¿¡æ¯ -->

      <div class="parchment-page left-panel">

        <div class="panel-content">

          <!-- å­˜æ¡£è¯»æ¡£æŒ‰é’® -->

          <div class="save-section">

            <button id="save-load-btn" class="save-button subtle-hover">

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path

                  d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h-1v5.586l-2.293-2.293z"

                />

              </svg>

              <span>å­˜æ¡£/è¯»æ¡£</span>

            </button>

            <button id="fullscreen-btn" class="save-button subtle-hover">

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path

                  d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z"

                />

              </svg>

              <span>å…¨å±</span>

            </button>

          </div>



          <!-- çŠ¶æ€æ¡ -->

          <div class="status-section">

            <div class="status-item">

              <div class="status-header">

                <span class="status-label">ç†æ™ºå€¼</span>

                <span class="status-value" id="sanity-value">0</span>

              </div>

              <div class="progress-bar">

                <div class="progress-fill" id="sanity-bar" style="width: 0%"></div>

              </div>

            </div>



            <div class="status-item">

              <div class="status-header">

                <span class="status-label">ä½“åŠ›</span>

                <span class="status-value" id="stamina-value">0</span>

              </div>

              <div class="progress-bar">

                <div class="progress-fill" id="stamina-bar" style="width: 0%"></div>

              </div>

            </div>



            <div class="status-item">

              <div class="status-header">

                <span class="status-label">è¿æ°”</span>

                <span class="status-value" id="luck-value">0</span>

              </div>

              <div class="progress-bar">

                <div class="progress-fill" id="luck-bar" style="width: 0%"></div>

              </div>

            </div>

          </div>



          <!-- ä¸ªäººæ¡£æ¡ˆ -->

          <div class="profile-section">

            <div class="section-header">

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" />

              </svg>

              <h3>ä¸ªäººæ¡£æ¡ˆ</h3>

              <button class="expand-btn" id="profile-expand">

                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                  <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />

                </svg>

              </button>

            </div>



            <div class="profile-basic" id="profile-basic">

              <div class="profile-link">ç‚¹å‡»æŸ¥çœ‹å®Œæ•´æ¡£æ¡ˆ...</div>

            </div>



            <div class="profile-detail" id="profile-detail" style="display: none">

              <div class="detail-card">

                <div class="detail-item">

                  <span class="label">èº«ä»½:</span>

                  <span class="value">è®­ç»ƒå‘˜</span>

                </div>

                <div class="detail-item">

                  <span class="label">èƒŒæ™¯:</span>

                  <span class="value" id="trainer-background">æ— </span>

                </div>



                <div class="detail-item">

                  <span class="label">çŠ¶æ€:</span>

                  <span class="value" id="trainer-status">æ­£å¸¸</span>

                </div>

                <div class="detail-item">

                  <span class="label">åœ¨æ ¡å¤©æ•°:</span>

                  <span class="value" id="days-in-park">0å¤©</span>

                </div>

              </div>

            </div>

          </div>



          <!-- äººç‰©å†ç¨‹ -->

          <div class="journey-section">

            <div class="section-header">

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path

                  d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"

                />

              </svg>

              <h3>äººç‰©å†ç¨‹</h3>

              <button class="expand-btn" id="journey-history-btn">

                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                  <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />

                </svg>

              </button>

            </div>



            <div class="journey-basic" id="journey-basic">

              <div class="journey-link">ç‚¹å‡»æŸ¥çœ‹å®Œæ•´å†ç¨‹è®°å½•...</div>

            </div>



            <div class="journey-detail" id="journey-detail" style="display: none">

              <div class="journey-list">

                <div class="journey-entry">

                  <div class="journey-header">

                    <span class="journey-day">ç¬¬1å¤©</span>

                    <span class="journey-status normal">æ­£å¸¸</span>

                  </div>

                  <div class="journey-event">åˆå…¥è®­ç»ƒåœº</div>

                  <div class="journey-desc">ç¬¬ä¸€æ¬¡è§åˆ°äº†é‚£äº›ç¾ä¸½çš„èµ›é©¬å¨˜ä»¬ï¼Œå¿ƒä¸­å……æ»¡æœŸå¾…</div>

                </div>

                <div class="journey-entry">

                  <div class="journey-header">

                    <span class="journey-day">ç¬¬15å¤©</span>

                    <span class="journey-status confused">å›°æƒ‘</span>

                  </div>

                  <div class="journey-event">åˆå¤œçš„å‘¼å”¤</div>

                  <div class="journey-desc">æ·±å¤œå¬åˆ°äº†ä¸åº”è¯¥å­˜åœ¨çš„é©¬è¹„å£°ï¼Œå¼€å§‹æ„Ÿåˆ°ä¸å®‰</div>

                  <div class="sanity-change horror-glow">ç†æ™ºå€¼ -10</div>

                </div>

              </div>

            </div>

          </div>



          <!-- ç‰©å“æ  -->

          <div class="inventory-section">

            <div class="section-header">

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" />

              </svg>

              <h3>ç‰©å“æ </h3>

              <div class="command-manager-dot" id="command-manager-dot" style="display: none">

                <span class="dot-icon">ğŸ“‹</span>

                <span class="dot-count">0</span>

              </div>

            </div>



            <div class="inventory-container" id="inventory-list">

              <div class="empty-inventory">ç‰©å“æ ä¸ºç©º</div>

            </div>

          </div>

        </div>

      </div>



      <!-- åˆ†éš”çº¿ -->

      <div class="panel-divider"></div>



      <!-- ä¸­å¤®é¢æ¿ï¼šæ­£æ–‡å†…å®¹ -->

      <div class="parchment-page center-panel">

        <div class="story-container">

          <div class="story-content" id="story-content">

            <p class="story-text">ç­‰å¾…æ•…äº‹å†…å®¹åŠ è½½...</p>

            <span class="typewriter-cursor">|</span>

          </div>

        </div>



        <div class="input-section ruled-paper">

          <div class="input-header">

            <div class="time-display">

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path

                  fill-rule="evenodd"

                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"

                />

              </svg>

              <span id="current-time">ç­‰å¾…æ—¶é—´åŠ è½½...</span>

            </div>

            

            <!-- æŠ€èƒ½æŒ‰é’®åŒºåŸŸ -->

            <div class="skills-section" id="skills-section" style="display: none;">

              <!-- æŠ€èƒ½æŒ‰é’®å°†æ ¹æ®å½“å‰å¤§å¤©èµ‹åŠ¨æ€ç”Ÿæˆ -->
            </div>

            

            <button id="danger-btn" class="danger-button twisted-love-accent">å±é™©æ—¶æ®µ</button>

          </div>



          <div class="input-container">

            <span class="input-prompt">{">"}</span>

            <textarea id="action-input" placeholder="è¾“å…¥ä½ çš„è¡ŒåŠ¨..." class="action-input"></textarea>

            <div class="input-controls">

              <button id="btn-send-action" class="send-button">å‘é€</button>

            </div>

          </div>

        </div>

      </div>



      <!-- åˆ†éš”çº¿ -->

      <div class="panel-divider"></div>



      <!-- å³ä¾§é¢æ¿ï¼šç¦å¿Œè§„åˆ™å’Œèµ›é©¬å¨˜çŠ¶æ€ -->

      <div class="parchment-page right-panel">

        <div class="panel-content">

          <!-- æŸ¥çœ‹è§„åˆ™æŒ‰é’® -->

          <div class="rules-section">

            <button id="view-rules-btn" class="view-rules-button">

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />

              </svg>

              <span>æŸ¥çœ‹è§„åˆ™</span>

            </button>

          </div>



          <!-- å¤©èµ‹ç®¡ç†æŒ‰é’® -->

          <div class="rules-section">

            <button id="manage-talents-btn" class="view-rules-button">

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path

                  fill-rule="evenodd"

                  d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"

                  clip-rule="evenodd"

                />

              </svg>

              <span>å¤©èµ‹ç®¡ç†</span>

            </button>

          </div>



          <!-- èµ›é©¬å¨˜çŠ¶æ€ -->

          <div class="uma-section">

            <div class="section-header">

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path

                  fill-rule="evenodd"

                  d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"

                />

              </svg>

              <h3>èµ›é©¬å¨˜çŠ¶æ€</h3>

              <button class="roster-btn" id="uma-roster-btn" title="é©¬å¨˜è®°åå†Œ" onclick="window.teresenDebug.openUmaRoster()">

                ğŸ“–

              </button>

            </div>



            <div class="uma-list" id="uma-status">

              <div class="loading-uma">ç­‰å¾…çŠ¶æ€åŠ è½½...</div>

            </div>

          </div>



          <!-- QTEæŒ£æ‰åŒºåŸŸ -->

          <div class="qte-section" id="qte-section" style="display: none">

            <div class="section-header">

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z" />

              </svg>

              <h3>æŒ£æ‰é€‰é¡¹</h3>

            </div>



            <div class="qte-container">

              <div class="qte-info">

                <p class="qte-description">ä½ è¢«é©¬å¨˜æŸç¼šäº†ï¼</p>

                <p class="qte-subtitle">é€‰æ‹©ä½ çš„è¡ŒåŠ¨...</p>

              </div>



              <div class="qte-options">

                <button

                  class="qte-btn struggle-btn"

                  id="qte-struggle-btn"

                  onclick="window.teresenDebug.triggerQTE('struggle')"

                >

                  <span class="qte-icon">ğŸ’ª</span>

                  <span class="qte-text">å¥‹åŠ›æŒ£æ‰</span>

                  <span class="qte-desc">å°è¯•æŒ£è„±æŸç¼š</span>

                </button>



                <button

                  class="qte-btn submit-btn"

                  id="qte-submit-btn"

                  onclick="window.teresenDebug.triggerQTE('submit')"

                >

                  <span class="qte-icon">ğŸ˜Œ</span>

                  <span class="qte-text">ä¸åæŠ—</span>

                  <span class="qte-desc">æ¥å—ç°çŠ¶</span>

                </button>

              </div>

            </div>

          </div>

        </div>

      </div>



      <!-- åº•éƒ¨é¢æ¿ï¼šè´§å¸ç³»ç»Ÿã€èŠ‚æ—¥é€šçŸ¥ã€è§„åˆ™å€’è®¡æ—¶ -->

      <div class="bottom-panel">

        <!-- è´§å¸ç›¸å…³ -->

        <div class="bottom-group">

          <div class="currency-section">

            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

              <path

                d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"

              />

              <path

                fill-rule="evenodd"

                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z"

                clip-rule="evenodd"

              />

            </svg>

            <span>å®éªŒç‚¹æ•°: <span id="currency-value">0</span></span>

          </div>



          <div class="gacha-coin" id="gacha-coin">

            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

              <path

                fill-rule="evenodd"

                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z"

                clip-rule="evenodd"

              />

            </svg>

            <span id="gacha-coin-text">æ‰­è›‹å¸: 0</span>

          </div>



          <div class="tarot-divination" id="tarot-divination">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

              <path

                fill-rule="evenodd"

                d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"

              />

            </svg>

            <span id="tarot-divination-text">å¡”ç½—å åœ</span>
          </div>

        </div>



        <!-- æ—¶é—´ç›¸å…³ -->

        <div class="bottom-group">

          <div class="festival-notice" id="festival-notice" style="display: none">

            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

              <path

                d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"

              />

            </svg>

            <span id="festival-text">èŠ‚æ—¥é€šçŸ¥</span>

          </div>







          <div class="reply-timer" id="reply-timer">

            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

              <path

                fill-rule="evenodd"

                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"

              />

            </svg>

            <span id="reply-timer-text">å›å¤æ—¶é—´: --:--</span>

          </div>

        </div>

      </div>

    </div>



    <!-- è§„åˆ™é¡µé¢æ¨¡æ€æ¡† -->

    <div id="rules-modal" class="rules-modal" style="display: none">

      <div class="rules-modal-content">

        <div class="rules-modal-header">

          <h2 class="rules-title">ç‰¹é›·æ£®è§„åˆ™æ€ªè°ˆ</h2>

          <div class="music-controls" style="display: flex; align-items: center; gap: 10px; margin-right: 10px;">
            <button id="music-controller" class="music-btn" style="background: rgba(139, 105, 20, 0.8); border: 1px solid #8b6914; color: #fdfbf7; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="ç‚¹å‡»åˆ‡æ¢éŸ³ä¹ (å…±2é¦–ï¼Œç¬¬3æ¬¡ç‚¹å‡»å…³é—­)">ğŸµ éŸ³ä¹æ§åˆ¶</button>
          </div>

          <button id="close-rules-btn" class="close-rules-btn">Ã—</button>

        </div>

        <div class="rules-modal-body">

          <div class="rules-section-fixed">

            <h3 class="rules-section-title">ç”Ÿå­˜è§„åˆ™</h3>

            <div id="fixed-rules-list" class="rules-list-handwritten"></div>

          </div>

          <div class="rules-section-random">

            <h3 class="rules-section-title">è§„åˆ™è®°å½•</h3>
            <div class="rules-record-controls">
              <button id="add-rule-btn" class="add-rule-btn">+ æ·»åŠ è§„åˆ™</button>
              <button id="clear-rules-btn" class="clear-rules-btn">æ¸…ç©ºè®°å½•</button>
            </div>
            <div id="random-rules-list" class="rules-list-handwritten"></div>

          </div>

        </div>

      </div>

    </div>





    <!-- è¯»æ¡£æ¨¡æ€æ¡† -->

    <div id="load-modal" class="rules-modal" style="display: none">

      <div class="rules-modal-content">

        <div class="rules-modal-header">

          <h2 class="rules-title">è¯»å–å­˜æ¡£</h2>

          <button id="close-load-btn" class="close-rules-btn">Ã—</button>

        </div>

        <div class="rules-modal-body">

          <div class="load-section">

            <h3 class="rules-section-title">æœ¬åœ°å­˜æ¡£ (localStorage)</h3>

            <div id="local-saves-list" class="saves-list"></div>

            <h3 class="rules-section-title">ä¸–ç•Œä¹¦å­˜æ¡£ (TavernHelper)</h3>

            <div id="worldbook-saves-list" class="saves-list"></div>

          </div>

        </div>

      </div>

    </div>



    <!-- å†å²è®°å½•æ¨¡æ€æ¡† -->

    <div id="history-modal" class="rules-modal" style="display: none">

      <div class="rules-modal-content">

        <div class="rules-modal-header">

          <h2 class="rules-title">å†å²è®°å½•</h2>

          <button id="close-history-btn" class="close-rules-btn">Ã—</button>

        </div>

        <div class="rules-modal-body">

          <div class="history-section">

            <h3 class="rules-section-title">äººç‰©å†ç¨‹</h3>

            <div id="current-journey-list" class="journey-list"></div>

          </div>

        </div>

      </div>

    </div>


    <!-- å¡”ç½—å åœæ¨¡æ€æ¡† -->
    <div id="tarot-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content tarot-modal-content">
        <div class="rules-modal-header">
          <h2 class="rules-title">ç‰¹é›·æ£®å­¦é™¢å¡”ç½—å åœ</h2>
          <button id="close-tarot-btn" class="close-rules-btn">Ã—</button>
        </div>
        <div class="rules-modal-body">
          <div class="tarot-section">
            <div class="tarot-info">
              <p>ä»Šæ—¥å‰©ä½™å åœæ¬¡æ•°: <span id="tarot-remaining">3</span></p>
              <p>å½“å‰ç†æ™º: <span id="tarot-sanity">--</span></p>
            </div>
            
            <div class="tarot-spreads">
              <h3 class="rules-section-title">åŸºç¡€å åœ</h3>
              <div class="spread-buttons">
                <button class="spread-btn" data-spread="single" data-cost="5">
                  <span class="spread-icon">ğŸ”®</span>
                  <span class="spread-name">å•å¼ ç‰Œå åœ</span>
                  <span class="spread-cost">æ¶ˆè€—5ç†æ™º</span>
                </button>
                <button class="spread-btn" data-spread="timeline" data-cost="10">
                  <span class="spread-icon">â°</span>
                  <span class="spread-name">æ—¶é—´ä¹‹æµ</span>
                  <span class="spread-cost">æ¶ˆè€—10ç†æ™º</span>
                </button>
                <button class="spread-btn" data-spread="choice" data-cost="8">
                  <span class="spread-icon">âš–ï¸</span>
                  <span class="spread-name">äºŒé€‰ä¸€</span>
                  <span class="spread-cost">æ¶ˆè€—8ç†æ™º</span>
                </button>
              </div>
              
              <h3 class="rules-section-title">é«˜çº§å åœ</h3>
              <div class="spread-buttons">
                <button class="spread-btn advanced" data-spread="hexagram" data-cost="15" data-requirement="7">
                  <span class="spread-icon">â­</span>
                  <span class="spread-name">å…­èŠ’æ˜Ÿå åœ</span>
                  <span class="spread-cost">æ¶ˆè€—15ç†æ™º</span>
                  <span class="spread-requirement">éœ€è¦åœ¨æ ¡å¤©æ•°â‰¥7</span>
                </button>
                <button class="spread-btn advanced" data-spread="celtic" data-cost="20" data-requirement="14">
                  <span class="spread-icon">ğŸ•¯ï¸</span>
                  <span class="spread-name">å‡¯å°”ç‰¹åå­—</span>
                  <span class="spread-cost">æ¶ˆè€—20ç†æ™º</span>
                  <span class="spread-requirement">éœ€è¦åœ¨æ ¡å¤©æ•°â‰¥14</span>
                </button>
                <button class="spread-btn advanced" data-spread="zodiac" data-cost="25" data-requirement="21">
                  <span class="spread-icon">ğŸŒŸ</span>
                  <span class="spread-name">é»„é“åäºŒå®«</span>
                  <span class="spread-cost">æ¶ˆè€—25ç†æ™º</span>
                  <span class="spread-requirement">éœ€è¦åœ¨æ ¡å¤©æ•°â‰¥21</span>
                </button>
              </div>
            </div>
            
            <div class="tarot-result" id="tarot-result" style="display: none">
              <h3 class="rules-section-title">å åœç»“æœ</h3>
              <div id="tarot-cards" class="tarot-cards"></div>
              <div id="tarot-interpretation" class="tarot-interpretation"></div>
              <div id="tarot-effects" class="tarot-effects"></div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- æŒ‡ä»¤ç®¡ç†æ¨¡æ€æ¡† -->

    <div id="command-modal" class="rules-modal" style="display: none">

      <div class="rules-modal-content">

        <div class="rules-modal-header">

          <h2 class="rules-title">æŒ‡ä»¤ç®¡ç†</h2>

          <button id="close-command-btn" class="close-rules-btn">Ã—</button>

        </div>

        <div class="rules-modal-body">

          <div class="command-section">

            <div class="command-list">

              <!-- æŒ‡ä»¤åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->

            </div>

            <div class="command-footer">

              <button class="clear-all-btn">æ¸…é™¤å…¨éƒ¨</button>

            </div>

          </div>

        </div>

      </div>

    </div>







    <!-- éŸ³æ•ˆ -->

    <audio id="page-flip-sound" preload="auto">

      <source src="https://files.catbox.moe/5ppdp9.mp3" type="audio/mpeg" />

    </audio>



    <audio id="talent-sound" preload="auto">

      <source src="https://files.catbox.moe/5091vt.mp3" type="audio/mpeg" />

    </audio>


    <audio id="tarot-shuffle" preload="auto">

      <source src="https://files.catbox.moe/b4b019.mp3" type="audio/mpeg" />

    </audio>

    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bgm-track1" class="music-source" src="https://files.catbox.moe/umai3u.m4a" loop preload="auto"></audio>
    <audio id="bgm-track2" class="music-source" src="https://files.catbox.moe/j0qaqf.m4a" loop preload="auto"></audio>


    <audio id="save-load-sound" preload="auto">

      <source src="https://files.catbox.moe/m9h2z4.mp3" type="audio/mpeg" />

    </audio>



    <audio id="danger-rules-sound" preload="auto">

      <source src="https://files.catbox.moe/zxb18s.mp3" type="audio/mpeg" />

    </audio>



    <audio id="item-detail-sound" preload="auto">

      <source src="https://files.catbox.moe/412btp.mp3" type="audio/mpeg" />

    </audio>



    <audio id="uma-roster-sound" preload="auto">

      <source src="https://files.catbox.moe/zxb18s.mp3" type="audio/mpeg" />

    </audio>



    <audio id="journey-history-sound" preload="auto">

      <source src="https://files.catbox.moe/zxb18s.mp3" type="audio/mpeg" />

    </audio>



    <!-- å˜é‡ç®¡ç†å™¨è„šæœ¬ -->



    <!-- é“å…·ç³»ç»Ÿå‡çº§è„šæœ¬ -->

    <script>

      // é“å…·ç³»ç»Ÿå‡çº§åŠŸèƒ½

      let pendingActions = [];

      let giftSelectionMode = null;

      let skillSelectionMode = null;



      // æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä¾›MVUç®¡ç†å™¨ä½¿ç”¨

      window.pendingActions = pendingActions;



      // åˆå§‹åŒ–

      $(document).ready(function () {

        loadPendingActions();

        updateActionIcons();

        updateInventoryCommandManager();



        // å®šæœŸæ›´æ–°ç‰©å“æ ç®¡ç†åŠŸèƒ½

        setInterval(function () {

          updateInventoryCommandManager();

        }, 2000);

      });



      // æ·»åŠ å¾…æ‰§è¡ŒæŒ‡ä»¤

      function addPendingAction(action, itemName, extraData = {}) {

        const actionObj = {

          action: action,

          itemName: itemName,

          ...extraData,

        };



        pendingActions.push(actionObj);

        savePendingActions();

        updateActionIcons();

        updateInventoryCommandManager();



        // åŒæ­¥åˆ°å…¨å±€

        window.pendingActions = pendingActions;

      }



      // ç§»é™¤æŒ‡å®šæŒ‡ä»¤

      function removeAction(index) {

        pendingActions.splice(index, 1);

        savePendingActions();

        updateActionIcons();

        updateInventoryCommandManager();

      }



      // æ¸…é™¤æ‰€æœ‰æŒ‡ä»¤

      function clearAllActions() {

        if (pendingActions.length === 0) {

          return;

        }



        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¾…æ‰§è¡ŒæŒ‡ä»¤å—ï¼Ÿ')) {

          pendingActions = [];

          savePendingActions();

          updateActionIcons();

          updateInventoryCommandManager();

        }

      }



      // åˆ‡æ¢é“å…·é”å®šçŠ¶æ€

      function toggleItemLock(itemName, button) {

        const isLocked = button.text() === 'è§£é”';

        button.text(isLocked ? 'é”å®š' : 'è§£é”');

        button.css('background', isLocked ? '#4a5568' : '#e53e3e');



        // æ›´æ–°ä¸¢å¼ƒæŒ‰é’®çŠ¶æ€

        const discardBtn = button.siblings('.item-discard-btn');

        if (isLocked) {

          discardBtn.prop('disabled', false).css('opacity', '1');

        } else {

          discardBtn.prop('disabled', true).css('opacity', '0.5');

        }

      }



      // å¼€å§‹èµ é€é€‰æ‹©

      function startGiftSelection(itemName) {

        showGiftHint();

        highlightCharacterCards();



        giftSelectionMode = {

          active: true,

          itemName: itemName,

          startTime: Date.now(),

        };



        // 30ç§’è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ

        setTimeout(() => {

          if (giftSelectionMode?.active) {

            cancelGiftSelection();

          }

        }, 30000);

      }



      // æ˜¾ç¤ºèµ é€æç¤º

      function showGiftHint() {

        // å…ˆç§»é™¤ç°æœ‰çš„æç¤º

        $('.gift-selection-hint').remove();

        

        const hint = $('<div class="gift-selection-hint">').html(`

            <div class="hint-content">

              <span class="hint-icon">ğŸ</span>

              <span class="hint-text">è¯·ç‚¹å‡»è¦èµ é€çš„é©¬å¨˜å¡ç‰‡</span>

              <button class="hint-close" onclick="$(this).closest('.gift-selection-hint').remove()">Ã—</button>

            </div>

          `);



        $('body').append(hint);



        // 3ç§’åè‡ªåŠ¨ç§»é™¤

        setTimeout(() => {

          hint.remove();

        }, 3000);

      }



      // é«˜äº®é©¬å¨˜å¡ç‰‡

      function highlightCharacterCards() {

        $('.character-card, .uma-item, .character-item').addClass('gift-selectable skill-selectable');

      }



      // å¤„ç†é©¬å¨˜å¡ç‰‡ç‚¹å‡»ï¼ˆç”¨äºèµ é€é€‰æ‹©ï¼‰

      $(document).on('click', '.gift-selectable', function () {

        if (!giftSelectionMode?.active) return;



        const characterName = getCharacterNameFromCard($(this));

        const characterId = getCharacterIdFromCard($(this));



        addPendingAction('gift', giftSelectionMode.itemName, {

          characterName: characterName,

          characterId: characterId,

        });



        cancelGiftSelection();



        // é˜²æ­¢é‡å¤ç‚¹å‡»

        $(this).off('click');

      });



      // å¤„ç†é©¬å¨˜å¡ç‰‡ç‚¹å‡»ï¼ˆç”¨äºæŠ€èƒ½é€‰æ‹©ï¼‰

      $(document).on('click', '.skill-selectable', function () {

        if (!skillSelectionMode?.active) return;



        const characterName = getCharacterNameFromCard($(this));

        const characterId = getCharacterIdFromCard($(this));



        addPendingAction('skill', skillSelectionMode.skillName, {

          skillType: skillSelectionMode.skillType,

          target: 'uma',

          characterName: characterName,

          characterId: characterId,

        });



        cancelSkillSelection();



        // é˜²æ­¢é‡å¤ç‚¹å‡»

        $(this).off('click');

      });



      // å–æ¶ˆèµ é€é€‰æ‹©

      function cancelGiftSelection() {

        clearGiftSelectionMode();

        giftSelectionMode = null;

      }



      // æ¸…é™¤èµ é€é€‰æ‹©æ¨¡å¼

      function clearGiftSelectionMode() {

        $('.gift-selectable').removeClass('gift-selectable');

        $('.skill-selectable').removeClass('skill-selectable');

      }



      // å¼€å§‹æŠ€èƒ½é€‰æ‹©

      function startSkillSelection(skillName, skillType) {

        showSkillHint();

        highlightCharacterCards();



        skillSelectionMode = {

          active: true,

          skillName: skillName,

          skillType: skillType,

          startTime: Date.now(),

        };



        // 30ç§’è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ

        setTimeout(() => {

          if (skillSelectionMode?.active) {

            cancelSkillSelection();

          }

        }, 30000);

      }



      // æ˜¾ç¤ºæŠ€èƒ½æç¤º

      function showSkillHint() {

        // å…ˆç§»é™¤ç°æœ‰çš„æç¤º

        $('.skill-selection-hint').remove();

        

        const hint = $('<div class="skill-selection-hint">').html(`

            <div class="hint-content">

              <span class="hint-icon">âš¡</span>

              <span class="hint-text">è¯·ç‚¹å‡»è¦å¯¹é©¬å¨˜ä½¿ç”¨æŠ€èƒ½çš„ç›®æ ‡</span>

              <button class="hint-close" onclick="$(this).closest('.skill-selection-hint').remove()">Ã—</button>

            </div>

          `);



        $('body').append(hint);



        // 3ç§’åè‡ªåŠ¨ç§»é™¤

        setTimeout(() => {

          hint.remove();

        }, 3000);

      }



      // å–æ¶ˆæŠ€èƒ½é€‰æ‹©

      function cancelSkillSelection() {

        clearSkillSelectionMode();

        skillSelectionMode = null;

      }



      // æ¸…é™¤æŠ€èƒ½é€‰æ‹©æ¨¡å¼

      function clearSkillSelectionMode() {

        $('.skill-selectable').removeClass('skill-selectable');

      }



      // ä»å¡ç‰‡è·å–è§’è‰²åç§°

      function getCharacterNameFromCard(card) {

        const nameElement = card.find('.character-name, .uma-name, .name');

        return nameElement.length ? nameElement.text().trim() : 'æœªçŸ¥è§’è‰²';

      }



      // ä»å¡ç‰‡è·å–è§’è‰²ID

      function getCharacterIdFromCard(card) {

        return card.data('character-id') || card.attr('id') || 'unknown';

      }



      // ä¿å­˜æŒ‡ä»¤åˆ°æœ¬åœ°å­˜å‚¨

      function savePendingActions() {

        localStorage.setItem('item_pending_actions', JSON.stringify(pendingActions));

      }



      // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æŒ‡ä»¤

      function loadPendingActions() {

        const saved = localStorage.getItem('item_pending_actions');

        pendingActions = saved ? JSON.parse(saved) : [];

      }



      // æ›´æ–°æŒ‡ä»¤å›¾æ ‡æ˜¾ç¤º

      function updateActionIcons() {

        const timeLocationBar = $('.time-location-bar');

        if (!timeLocationBar.length) return;



        // ç§»é™¤ç°æœ‰å›¾æ ‡

        timeLocationBar.find('.action-icons-container').remove();



        if (pendingActions.length === 0) return;



        // ç»Ÿè®¡å„ç§æ“ä½œçš„æ•°é‡

        const actionCounts = { use: 0, discard: 0, gift: 0, lock: 0, skill: 0 };

        pendingActions.forEach(action => {

          if (actionCounts.hasOwnProperty(action.action)) {

            actionCounts[action.action]++;

          }

        });



        // ç”Ÿæˆå›¾æ ‡HTML

        const icons = [];

        if (actionCounts.use > 0) {

          icons.push(

            `<span class="action-icon use-icon" title="ä½¿ç”¨ ${actionCounts.use} ä¸ªé“å…·"> (${actionCounts.use})</span>`,

          );

        }

        if (actionCounts.discard > 0) {

          icons.push(

            `<span class="action-icon discard-icon" title="ä¸¢å¼ƒ ${actionCounts.discard} ä¸ªé“å…·">ğŸ—‘ï¸ (${actionCounts.discard})</span>`,

          );

        }

        if (actionCounts.gift > 0) {

          icons.push(

            `<span class="action-icon gift-icon" title="èµ é€ ${actionCounts.gift} ä¸ªé“å…·">ğŸ (${actionCounts.gift})</span>`,

          );

        }

        if (actionCounts.lock > 0) {

          icons.push(

            `<span class="action-icon lock-icon" title="é”å®š ${actionCounts.lock} ä¸ªé“å…·">ğŸ”’ (${actionCounts.lock})</span>`,

          );

        }

        if (actionCounts.skill > 0) {

          icons.push(

            `<span class="action-icon skill-icon" title="ä½¿ç”¨ ${actionCounts.skill} ä¸ªæŠ€èƒ½">âš¡ (${actionCounts.skill})</span>`,

          );

        }



        if (icons.length > 0) {

          const iconsContainer = $('<div class="action-icons-container">').html(icons.join(''));

          timeLocationBar.find('.current-location').after(iconsContainer);

        }

      }



      // æ›´æ–°ç‰©å“æ ç®¡ç†æŒ‡ä»¤åŠŸèƒ½

      function updateInventoryCommandManager() {

        const commandDot = $('#command-manager-dot');



        if (pendingActions.length > 0) {

          commandDot.show();

          commandDot.find('.dot-count').text(pendingActions.length);



          // ç»‘å®šç‚¹å‡»äº‹ä»¶

          commandDot.off('click').on('click', function () {

            toggleCommandManager();

          });

        } else {

          commandDot.hide();

        }

      }



      // åˆ‡æ¢æŒ‡ä»¤ç®¡ç†å™¨æ˜¾ç¤º

      function toggleCommandManager() {

        const commandModal = $('#command-modal');

        const isVisible = commandModal.is(':visible');



        if (isVisible) {

          commandModal.hide();

        } else {

          commandModal.show();

          updateCommandList();

        }

      }



      // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶

      $(document).on('click', '#close-command-btn', function () {

        $('#command-modal').hide();

      });



      // ç»‘å®šç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—äº‹ä»¶

      $(document).on('click', '#command-modal', function (e) {

        if (e.target === this) {

          $('#command-modal').hide();

        }

      });



      // ç»‘å®šæ¸…é™¤å…¨éƒ¨æŒ‰é’®äº‹ä»¶

      $(document).on('click', '.clear-all-btn', function () {

        clearAllActions();

        updateCommandList();

      });



      // æ›´æ–°æŒ‡ä»¤åˆ—è¡¨

      function updateCommandList() {

        const commandList = $('#command-modal .command-list');



        if (pendingActions.length === 0) {

          commandList.html('<div class="empty-command">æš‚æ— å¾…æ‰§è¡ŒæŒ‡ä»¤</div>');

          return;

        }



        const commandItems = pendingActions

          .map(

            (action, index) => `

                <div class="command-item">

                  <div class="command-content">

                    <span class="command-icon">${getActionIcon(action.action)}</span>

                    <span class="command-text">${formatActionText(action)}</span>

                  </div>

                  <button class="remove-command-btn" onclick="removeAction(${index}); updateCommandList();">Ã—</button>

                </div>

              `,

          )

          .join('');



        commandList.html(commandItems);

      }



      // è·å–æ“ä½œå›¾æ ‡

      function getActionIcon(action) {

        const icons = {

          use: ' ',

          discard: 'ğŸ—‘ï¸',

          gift: 'ğŸ',

          lock: 'ğŸ”’',

          skill: 'âš¡',

        };

        return icons[action] || 'ğŸ“';

      }



      // æ ¼å¼åŒ–æŒ‡ä»¤æ–‡æœ¬

      function formatActionText(action) {

        switch (action.action) {

          case 'use':
            let useText = `ä½¿ç”¨é“å…· [${action.itemName}]`;
            if (action.itemData) {
              useText += `\næ•ˆæœ: ${action.itemData.æ•ˆæœ || 'æ— æ•ˆæœè¯´æ˜'}`;
              useText += `\nç¨€æœ‰åº¦: ${action.itemData.ç¨€æœ‰åº¦ || 'æ™®é€š'}`;
            }
            return useText;

          case 'discard':
            let discardText = `ä¸¢å¼ƒé“å…· [${action.itemName}]`;
            if (action.itemData) {
              discardText += `\næè¿°: ${action.itemData.æè¿° || 'æ— æè¿°'}`;
            }
            return discardText;

          case 'gift':
            let giftText = `èµ é€é“å…· [${action.itemName}] ç»™ [${action.characterName || action.target}]`;
            if (action.itemData) {
              giftText += `\næ•ˆæœ: ${action.itemData.æ•ˆæœ || 'æ— æ•ˆæœè¯´æ˜'}`;
            }
            return giftText;

          case 'lock':
            let lockText = `é”å®šé“å…· [${action.itemName}]`;
            if (action.itemData) {
              lockText += `\næè¿°: ${action.itemData.æè¿° || 'æ— æè¿°'}`;
            }
            return lockText;

          case 'skill':

            // è·å–æŠ€èƒ½è¯¦ç»†ä¿¡æ¯
            let skillInfo = '';
            if (action.skillType && action.majorTalent) {
              // æ ¹æ®æŠ€èƒ½ç±»å‹è·å–è¯¦ç»†ä¿¡æ¯
              const skillDetails = {
                // å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰
                'defense': { name: 'é˜²å¾¡æŠ€èƒ½', description: 'åŸºäºå¼ºåŒ–ç³»å¤©èµ‹çš„é˜²å¾¡èƒ½åŠ›ï¼Œå¯ä»¥å¼ºåŒ–è‡ªèº«é˜²å¾¡åŠ›ã€‚' },
                'rule_enhance': { name: 'è§„åˆ™æ´å¯Ÿ', description: 'åŸºäºå¼ºåŒ–ç³»å¤©èµ‹çš„æ´å¯Ÿèƒ½åŠ›ï¼Œå¯ä»¥çœ‹ç©¿è§„åˆ™çš„æœ¬è´¨ã€‚' },
                'chain_enhance': { name: 'é”é“¾æ§åˆ¶', description: 'åŸºäºå¼ºåŒ–ç³»å¤©èµ‹çš„æ§åˆ¶èƒ½åŠ›ï¼Œå¯ä»¥å¼ºåŒ–é”é“¾çš„æŸç¼šæ•ˆæœã€‚' },
                // å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰
                'rule_change': { name: 'è§„åˆ™ä¿®æ”¹', description: 'åŸºäºå˜åŒ–ç³»å¤©èµ‹çš„ä¿®æ”¹èƒ½åŠ›ï¼Œå¯ä»¥ä¸´æ—¶æ”¹å˜è§„åˆ™ã€‚' },
                'emotion': { name: 'æƒ…æ„Ÿæ“æ§', description: 'åŸºäºå˜åŒ–ç³»å¤©èµ‹çš„æ“æ§èƒ½åŠ›ï¼Œå¯ä»¥æ“æ§ç›®æ ‡çš„æƒ…æ„Ÿã€‚' },
                'shadow': { name: 'å½±å­æ“æ§', description: 'åŸºäºå˜åŒ–ç³»å¤©èµ‹çš„å½±å­èƒ½åŠ›ï¼Œå¯ä»¥æ“æ§å½±å­è¿›è¡Œæ”»å‡»ã€‚' },
                // æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰
                'emotion_release': { name: 'æƒ…ç»ªé‡Šæ”¾', description: 'åŸºäºæ”¾å‡ºç³»å¤©èµ‹çš„é‡Šæ”¾èƒ½åŠ›ï¼Œå¯ä»¥é‡Šæ”¾å¼ºçƒˆçš„æƒ…æ„Ÿèƒ½é‡ã€‚' },
                'sacrifice': { name: 'ç”Ÿå‘½çŒ®ç¥­', description: 'åŸºäºæ”¾å‡ºç³»å¤©èµ‹çš„çŒ®ç¥­èƒ½åŠ›ï¼Œå¯ä»¥ç‰ºç‰²ç”Ÿå‘½æˆ–è®°å¿†è·å¾—åŠ›é‡ã€‚' },
                'phantom': { name: 'åˆ†èº«å…·ç°', description: 'åŸºäºæ”¾å‡ºç³»å¤©èµ‹çš„åˆ†èº«èƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–å¹»å½±åˆ†èº«ã€‚' },
                // æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰
                'suggestion': { name: 'å¿ƒç†æš—ç¤º', description: 'åŸºäºæ“ä½œç³»å¤©èµ‹çš„å¿ƒç†æš—ç¤ºèƒ½åŠ›ï¼Œå¯ä»¥æ¤å…¥æ€æƒ³æ§åˆ¶ç›®æ ‡ã€‚' },
                'control': { name: 'ç²¾ç¥æ“æ§', description: 'åŸºäºæ“ä½œç³»å¤©èµ‹çš„ç²¾ç¥æ“æ§èƒ½åŠ›ï¼Œå¯ä»¥ç›´æ¥æ§åˆ¶æ•Œäººè¡ŒåŠ¨ã€‚' },
                'absorption': { name: 'çˆ±æ„å¸æ”¶', description: 'åŸºäºæ“ä½œç³»å¤©èµ‹çš„å¸æ”¶èƒ½åŠ›ï¼Œå¯ä»¥å¸æ”¶ä»–äººçš„çˆ±æ„è·å¾—åŠ›é‡ã€‚' },
                // å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰
                'armor': { name: 'ç†æƒ³ç›”ç”²', description: 'åŸºäºå…·ç°åŒ–ç³»å¤©èµ‹çš„ç›”ç”²èƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–å®Œç¾çš„é˜²æŠ¤è£…å¤‡ã€‚' },
                'ring': { name: 'æ‰¿è¯ºæˆ’æŒ‡', description: 'åŸºäºå…·ç°åŒ–ç³»å¤©èµ‹çš„æˆ’æŒ‡èƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–æ‹¥æœ‰å¼ºå¤§åŠ›é‡çš„æˆ’æŒ‡ã€‚' },
                'npc': { name: 'å®Œç¾NPC', description: 'åŸºäºå…·ç°åŒ–ç³»å¤©èµ‹çš„NPCèƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–å®Œç¾çš„åŠ©æ‰‹ã€‚' },
                // ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰
                'contract': { name: 'æ€ªè°ˆå¥‘çº¦', description: 'åŸºäºç‰¹è´¨ç³»å¤©èµ‹çš„å¥‘çº¦èƒ½åŠ›ï¼Œå¯ä»¥ä¸è§„åˆ™æ€ªè°ˆç­¾è®¢å¥‘çº¦ã€‚' },
                'resonance': { name: 'æƒ…ç»ªå…±é¸£', description: 'åŸºäºç‰¹è´¨ç³»å¤©èµ‹çš„å…±é¸£èƒ½åŠ›ï¼Œå¯ä»¥ä¸ç›®æ ‡è¿›è¡Œæƒ…ç»ªå…±é¸£ã€‚' },
                'chaos': { name: 'æ··æ²Œæ··åˆ', description: 'åŸºäºç‰¹è´¨ç³»å¤©èµ‹çš„æ··åˆèƒ½åŠ›ï¼Œå¯ä»¥æ··åˆä¸åŒçˆ±æ„åˆ›é€ æ–°æŠ€èƒ½ã€‚' }
              };
              
              const skillDetail = skillDetails[action.skillType];
              if (skillDetail) {
                skillInfo = `ä½¿ç”¨å¤§å¤©èµ‹æŠ€èƒ½ [${skillDetail.name}] (${action.majorTalent})\næŠ€èƒ½æè¿°: ${skillDetail.description}`;
              }
            }

            if (action.target === 'self') {
              return `${skillInfo}\nä½¿ç”¨ç›®æ ‡: è‡ªå·±`;
            } else if (action.target === 'uma' && action.characterName) {
              return `${skillInfo}\nä½¿ç”¨ç›®æ ‡: ${action.characterName}`;
            } else {
              return `${skillInfo}\nä½¿ç”¨ç›®æ ‡: æœªæŒ‡å®š`;
            }

          default:

            return JSON.stringify(action);

        }

      }



      // æ˜¾ç¤ºä¸´æ—¶æ¶ˆæ¯

      function showTemporaryMessage(message) {

        const messageDiv = $('<div class="temporary-message">').text(message);

        $('body').append(messageDiv);



        setTimeout(() => {

          messageDiv.remove();

        }, 2000);

      }



      // è·å–å¾…æ‰§è¡ŒæŒ‡ä»¤ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰

      window.getPendingActions = function () {

        return pendingActions;

      };



      // æ¸…é™¤æ‰€æœ‰æŒ‡ä»¤ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰

      window.clearAllPendingActions = function () {

        clearAllActions();

      };



      // ESCé”®å–æ¶ˆèµ é€é€‰æ‹©

      $(document).on('keydown', function (e) {

        if (e.key === 'Escape' && giftSelectionMode?.active) {

          cancelGiftSelection();

        }

        if (e.key === 'Escape' && skillSelectionMode?.active) {

          cancelSkillSelection();

        }

      });

    </script>



    <!-- é“å…·ç³»ç»Ÿæ ·å¼ -->

    <style>

      /* é“å…·å¼¹çª—æŒ‰é’®æ ·å¼ */

      .item-info-row {

        display: flex;

        justify-content: space-between;

        align-items: center;

        margin-top: 0.5rem;

      }



      .item-actions {

        display: flex;

        gap: 4px;

        align-items: center;

      }



      .item-use-btn,

      .item-discard-btn,

      .item-lock-btn,

      .item-gift-btn {

        padding: 6px;

        border: none;

        border-radius: 50%;

        font-size: 14px;

        font-weight: bold;

        cursor: pointer;

        transition: all 0.2s;

        width: 28px;

        height: 28px;

        display: flex;

        align-items: center;

        justify-content: center;

        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);

      }



      .item-use-btn:hover,

      .item-discard-btn:hover,

      .item-lock-btn:hover,

      .item-gift-btn:hover {

        transform: scale(1.1);

        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);

      }



      .item-use-btn {

        background: #38a169;

        color: white;

      }



      .item-use-btn:hover {

        background: #2f855a;

      }



      .item-discard-btn {

        background: #e53e3e;

        color: white;

      }



      .item-discard-btn:hover {

        background: #c53030;

      }

      .item-discard-btn:disabled {

        opacity: 0.5;

        cursor: not-allowed;

      }



      .item-lock-btn {

        background: #4a5568;

        color: white;

      }



      .item-lock-btn:hover {

        background: #2d3748;

      }



      .item-gift-btn {

        background: #d69e2e;

        color: white;

      }



      .item-gift-btn:hover {

        background: #b7791f;

      }



      /* æŒ‡ä»¤å›¾æ ‡æ ·å¼ */

      .action-icons-container {

        display: flex;

        align-items: center;

        gap: 8px;

        margin: 0 15px;

      }



      .action-icon {

        display: inline-flex;

        align-items: center;

        padding: 3px 6px;

        border-radius: 12px;

        font-size: 11px;

        font-weight: bold;

        cursor: pointer;

        transition: all 0.2s;

        border: 1px solid transparent;

      }



      .action-icon:hover {

        transform: scale(1.1);

      }



      .use-icon {

        background: #38a169;

        color: white;

        border-color: #2f855a;

      }



      .discard-icon {

        background: #e53e3e;

        color: white;

        border-color: #c53030;

      }



      .gift-icon {

        background: #d69e2e;

        color: white;

        border-color: #b7791f;

      }



      .lock-icon {

        background: #4a5568;

        color: white;

        border-color: #2d3748;

      }



      .skill-icon {

        background: #805ad5;

        color: white;

        border-color: #6b46c1;

      }



      /* èµ é€é€‰æ‹©æç¤ºæ ·å¼ */

      .gift-selection-hint {

        position: fixed;

        top: 20px;

        right: 20px;

        background: rgba(0, 0, 0, 0.9);

        color: white;

        padding: 15px 20px;

        border-radius: 8px;

        font-size: 14px;

        z-index: 1001;

        animation: fadeInOut 2s ease-in-out;

      }



      .hint-content {

        display: flex;

        align-items: center;

        gap: 10px;

      }



      .hint-icon {

        font-size: 18px;

      }



      .hint-close {

        background: none;

        border: none;

        color: white;

        font-size: 16px;

        cursor: pointer;

        margin-left: 10px;

      }



      /* æŠ€èƒ½é€‰æ‹©æç¤ºæ ·å¼ */

      .skill-selection-hint {

        position: fixed;

        top: 20px;

        right: 20px;

        background: rgba(128, 90, 213, 0.9);

        color: white;

        padding: 15px 20px;

        border-radius: 8px;

        font-size: 14px;

        z-index: 1001;

        animation: fadeInOut 2s ease-in-out;

      }



      /* æŠ€èƒ½ç³»ç»Ÿæ ·å¼ */

      .skills-section {

        display: flex;

        gap: 8px;

        align-items: center;

        margin: 0 15px;

      }



      .skill-btn {

        display: flex;

        align-items: center;

        justify-content: center;

        padding: 2px 4px;

        border: 1px solid #8b4513;

        border-radius: 4px;

        background: linear-gradient(135deg, #2d1b1b, #1a0f0f);

        color: #ffffff;

        cursor: pointer;

        transition: all 0.3s ease;

        width: 24px;

        height: 24px;

        box-shadow: 0 1px 2px rgba(139, 69, 19, 0.3);

      }



      .skill-btn:hover {

        transform: translateY(-2px);

        box-shadow: 0 4px 16px rgba(139, 69, 19, 0.5);

        border-color: #a0522d;

      }



      .skill-btn:active {

        transform: translateY(0);

      }



      .skill-icon {

        font-size: 12px;

        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));

      }



      .no-skills-message {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2px 8px;
        border: 1px solid rgba(139, 69, 19, 0.3);
        border-radius: 4px;
        background: linear-gradient(135deg, rgba(45, 27, 27, 0.6), rgba(26, 15, 15, 0.6));
        color: rgba(139, 69, 19, 0.9);
        font-size: 11px;
        font-style: italic;
        width: 120px;
        height: 24px;
        box-shadow: 0 1px 3px rgba(139, 69, 19, 0.3);
        opacity: 1;
        transition: all 0.3s ease;
      }

      .no-skills-message:hover {
        opacity: 1;
        border-color: rgba(139, 69, 19, 0.5);
        box-shadow: 0 2px 4px rgba(139, 69, 19, 0.3);
      }





      .skill-use-btn {

        background: linear-gradient(135deg, #805ad5, #6b46c1);

        color: white;

        border: none;

        border-radius: 0.25rem;

        padding: 0.25rem 0.5rem;

        font-size: 0.7rem;

        cursor: pointer;

        margin: 0.25rem 0.25rem 0 0;

        transition: all 0.2s;

      }



      .skill-use-btn:hover {

        background: linear-gradient(135deg, #6b46c1, #553c9a);

        transform: translateY(-1px);

      }



      @keyframes fadeInOut {

        0%,

        100% {

          opacity: 0;

        }

        20%,

        80% {

          opacity: 1;

        }

      }



      /* å¯é€‰æ‹©çš„é©¬å¨˜å¡ç‰‡æ ·å¼ */

      .gift-selectable {

        cursor: pointer;

      }



      .skill-selectable {

        cursor: pointer;

        transform: scale(1.05);

        box-shadow: 0 0 20px rgba(128, 90, 213, 0.6);

        transition: all 0.3s ease;

      }



      .skill-selectable:hover {

        transform: scale(1.1);

        box-shadow: 0 0 30px rgba(128, 90, 213, 0.8);

      }



      /* ä¸´æ—¶æ¶ˆæ¯æ ·å¼ */

      .temporary-message {

        position: fixed;

        top: 20px;

        right: 20px;

        background: rgba(0, 0, 0, 0.8);

        color: white;

        padding: 10px 15px;

        border-radius: 6px;

        font-size: 12px;

        z-index: 1002;

        animation: slideIn 0.3s ease-out;

      }



      @keyframes slideIn {

        from {

          transform: translateX(100%);

          opacity: 0;

        }

        to {

          transform: translateX(0);

          opacity: 1;

        }

      }


      @keyframes tarotResultFadeIn {
        from {
          opacity: 0;
          transform: scale(0.8) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .tarot-result-card:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 8px 25px rgba(168, 85, 247, 0.5);
      }

      .tarot-result-card.reversed:hover {
        transform: rotate(180deg) translateY(-5px) scale(1.05);
      }

      @keyframes tarotStartPulse {
        0%, 100% { opacity: 0.8; }
        50% { opacity: 1; }
      }

      @keyframes tarotIconFloat {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
      }

      @keyframes tarotDotPulse {
        0%, 100% { 
          transform: scale(1);
          opacity: 0.6;
        }
        50% { 
          transform: scale(1.2);
          opacity: 1;
        }
      }

      @keyframes tarotFloat {
        0%, 100% { 
          transform: translateY(0px) rotate(0deg);
          opacity: 0.3;
        }
        50% { 
          transform: translateY(-15px) rotate(5deg);
          opacity: 0.6;
        }
      }


      /* ç‰©å“æ æŒ‡ä»¤ç®¡ç†å™¨æ ·å¼ - å‚è€ƒä¸ªäººæ¡£æ¡ˆå’Œäººç‰©å†ç¨‹çš„å¼¹çª—è®¾è®¡ */

      .command-manager-dot {

        display: inline-flex;

        align-items: center;

        margin-left: auto;

        cursor: pointer;

        background: #e53e3e;

        color: white;

        border-radius: 12px;

        padding: 2px 6px;

        font-size: 11px;

        font-weight: bold;

        transition: all 0.2s;

        animation: pulse 1.5s infinite;

      }



      .command-manager-dot:hover {

        background: #c53030;

        transform: scale(1.1);

      }



      .dot-icon {

        margin-right: 3px;

      }



      .dot-count {

        font-size: 10px;

      }



      @keyframes pulse {

        0%,

        100% {

          opacity: 1;

        }

        50% {

          opacity: 0.7;

        }

      }



      .command-section {

        margin-bottom: 1rem;

      }



      .command-list {

        flex-direction: column;

        gap: 0.5rem;

        max-height: 300px;

        display: flex;

        overflow-y: auto;

        margin-bottom: 1rem;

      }



      .command-item {

        background-color: #8b69141a;

        border-left: 2px solid #8b6914;

        border-radius: 0.25rem;

        padding: 0.5rem;

        display: flex;

        align-items: center;

        justify-content: space-between;

      }



      .command-content {

        display: flex;

        align-items: center;

        flex: 1;

      }



      .command-icon {

        margin-right: 0.5rem;

        font-size: 0.875rem;

      }



      .command-text {

        flex: 1;

        font-size: 0.75rem;

        color: #654321;

        font-weight: 500;

      }



      .remove-command-btn {

        background: #e53e3e;

        color: white;

        border: none;

        width: 16px;

        height: 16px;

        border-radius: 50%;

        cursor: pointer;

        font-size: 10px;

        line-height: 1;

        transition: all 0.2s;

        margin-left: 0.5rem;

      }



      .remove-command-btn:hover {

        background: #c53030;

        transform: scale(1.1);

      }



      .command-footer {

        text-align: center;

        padding-top: 0.5rem;

        margin-top: 0.5rem;

        border-top: 1px solid #8b691433;

      }



      .clear-all-btn {

        background: #e53e3e;

        color: white;

        border: none;

        border-radius: 0.375rem;

        padding: 0.5rem 1rem;

        font-size: 0.875rem;

        font-weight: 600;

        cursor: pointer;

        transition: all 0.2s;

      }



      .clear-all-btn:hover {

        background: #c53030;

        transform: translateY(-1px);

      }



      .empty-command {

        text-align: center;

        color: #8b4513;

        padding: 1rem;

        font-size: 0.75rem;

      }



      /* å­˜æ¡£æ ·å¼ */

      .save-item {

        background: rgba(139, 105, 20, 0.1);

        border: 1px solid rgba(139, 105, 20, 0.3);

        border-radius: 0.375rem;

        padding: 0.75rem;

        margin-bottom: 0.5rem;

        cursor: pointer;

        transition: all 0.2s;

      }



      .save-item:hover {

        background: rgba(139, 105, 20, 0.2);

        border-color: rgba(139, 105, 20, 0.5);

        transform: translateY(-1px);

      }



      /* æ‰‹åŠ¨å­˜æ¡£æ ·å¼ */

      .manual-save-item {

        background: rgba(59, 130, 246, 0.1);

        border: 1px solid rgba(59, 130, 246, 0.3);

      }



      .manual-save-item:hover {

        background: rgba(59, 130, 246, 0.2);

        border-color: rgba(59, 130, 246, 0.5);

      }



      /* è‡ªåŠ¨å­˜æ¡£æ ·å¼ */

      .auto-save-item {

        background: rgba(34, 197, 94, 0.1);

        border: 1px solid rgba(34, 197, 94, 0.3);

        position: relative;

      }



      .auto-save-item:hover {

        background: rgba(34, 197, 94, 0.2);

        border-color: rgba(34, 197, 94, 0.5);

      }



      /* ä¸–ç•Œä¹¦å­˜æ¡£æ ·å¼ */

      .worldbook-save-item {

        background: rgba(168, 85, 247, 0.1);

        border: 1px solid rgba(168, 85, 247, 0.3);

      }



      .worldbook-save-item:hover {

        background: rgba(168, 85, 247, 0.2);

        border-color: rgba(168, 85, 247, 0.5);

      }



      .save-type {

        font-size: 0.75rem;

        font-weight: 600;

        margin-top: 0.25rem;

      }



      .manual-save-item .save-type {

        color: #3b82f6;

      }



      .auto-save-item .save-type {

        color: #22c55e;

      }



      .worldbook-save-item .save-type {

        color: #a855f7;

      }



      .save-name {

        font-weight: bold;

        margin-bottom: 0.25rem;

        color: #e0e0e0;

      }



      .save-content {

        font-size: 0.8rem;

        color: #c0c0c0;

        margin-bottom: 0.25rem;

        line-height: 1.3;

        max-height: 2.6rem;

        overflow: hidden;

        text-overflow: ellipsis;

        display: -webkit-box;

        -webkit-line-clamp: 2;  /* WebKitæµè§ˆå™¨ */

        line-clamp: 2;          /* æ ‡å‡†å±æ€§ï¼Œæé«˜å…¼å®¹æ€§ */

        -webkit-box-orient: vertical;

      }



      .save-time {

        font-size: 0.75rem;

        color: #a0a0a0;

      }



      .empty-save {

        text-align: center;

        color: #8b4513;

        padding: 1rem;

        font-size: 0.875rem;

        font-style: italic;

      }



      /* QTEæŒ£æ‰åŒºåŸŸæ ·å¼ */

      .qte-section {

        margin-top: 15px;

        padding: 15px;

        background: rgba(139, 69, 19, 0.05);

        border: 2px dashed rgba(139, 69, 19, 0.3);

        border-radius: 8px;

        animation: qtePulse 2s ease-in-out infinite;

      }



      @keyframes qtePulse {

        0%,

        100% {

          border-color: rgba(139, 69, 19, 0.3);

        }

        50% {

          border-color: rgba(139, 69, 19, 0.6);

        }

      }



      .qte-container {

        text-align: center;

      }



      .qte-info {

        margin-bottom: 15px;

      }



      .qte-description {

        font-size: 1.1em;

        font-weight: bold;

        color: #8b4513;

        margin: 0 0 5px 0;

        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);

      }



      .qte-subtitle {

        font-size: 0.9em;

        color: #654321;

        margin: 0;

        font-style: italic;

      }



      .qte-options {

        display: flex;

        gap: 10px;

        justify-content: center;

        flex-wrap: wrap;

      }



      .qte-btn {

        display: flex;

        flex-direction: column;

        align-items: center;

        padding: 12px 16px;

        border: 2px solid #8b4513;

        border-radius: 8px;

        background: rgba(244, 241, 232, 0.9);

        cursor: pointer;

        transition: all 0.3s ease;

        min-width: 100px;

        box-shadow: 0 2px 8px rgba(139, 69, 19, 0.2);

      }



      .qte-btn:hover {

        transform: translateY(-2px);

        box-shadow: 0 4px 12px rgba(139, 69, 19, 0.4);

        background: rgba(244, 241, 232, 1);

      }



      .qte-btn:active {

        transform: translateY(0);

      }



      .qte-icon {

        font-size: 1.5em;

        margin-bottom: 5px;

      }



      .qte-text {

        font-weight: bold;

        color: #8b4513;

        font-size: 0.9em;

        margin-bottom: 3px;

      }



      .qte-desc {

        font-size: 0.75em;

        color: #654321;

        opacity: 0.8;

      }



      .struggle-btn:hover {

        border-color: #dc2626;

        background: rgba(220, 38, 38, 0.1);

      }



              .submit-btn:hover {

          border-color: #059669;

          background: rgba(5, 150, 105, 0.1);

        }





    </style>



    <!-- å¤©èµ‹ç®¡ç†æ¨¡æ€æ¡† -->

          <div id="talents-modal" class="rules-modal" style="display: none; justify-content: center; align-items: center;">

              <div class="rules-modal-content" style="max-width: 1200px; width: 95%; max-height: 90vh; background: linear-gradient(135deg, #2d1b1b, #1a0f0f); border: 2px solid #8b4513;">

        <div class="rules-modal-header" style="background: linear-gradient(135deg, #8b6914, #a0865a); padding: 2px 20px; border-bottom: 1px solid #654321; display: flex; justify-content: flex-end; position: relative; min-height: 30px;">

          <button id="close-talents-btn" class="close-rules-btn" style="background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); color: #ffffff; font-size: 14px; padding: 3px 6px; border-radius: 3px; cursor: pointer; position: absolute; top: 6px; right: 20px; transition: all 0.2s ease;">Ã—</button>

        </div>

        <div class="rules-modal-body" style="padding: 20px 30px 30px 30px; background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%); min-height: 500px; max-height: calc(90vh - 80px); overflow-y: auto;">

          <!-- ä¹¦é¡µç¿»é¡µæ§åˆ¶ - åº•éƒ¨ä¹¦ç­¾å¼è®¾è®¡ -->

          <div class="book-controls" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; align-items: center; gap: 20px; z-index: 10;">

            <button id="prev-page-btn" class="page-btn book-tab" onclick="window.teresenDebug.prevTalentPage()" style="background: linear-gradient(135deg, #8b6914, #a0865a); border: 2px solid #654321; color: #ffffff; padding: 8px 16px; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 12px; font-weight: bold; transition: all 0.3s; display: flex; align-items: center; gap: 6px; box-shadow: 0 -2px 8px rgba(139, 105, 20, 0.3); transform: translateY(0);">

              <span style="font-size: 14px;">â—€</span>

              <span>ä¸Šä¸€é¡µ</span>

            </button>

            

            <div class="page-indicator book-tab" style="background: linear-gradient(135deg, rgba(139, 105, 20, 0.15), rgba(160, 134, 90, 0.08)); border: 2px solid rgba(139, 105, 20, 0.4); border-radius: 8px 8px 0 0; padding: 8px 16px; text-align: center; box-shadow: 0 -2px 12px rgba(139, 105, 20, 0.2); transform: translateY(0);">

              <div id="current-page-title" style="color: #8b4513; font-size: 13px; font-weight: bold; margin-bottom: 2px;">ğŸ“– ç¬¬ <span id="page-number">1</span> é¡µ</div>

              <div style="color: #666666; font-size: 10px;">å…± 7 é¡µ</div>

            </div>

            

            <button id="next-page-btn" class="page-btn book-tab" onclick="window.teresenDebug.nextTalentPage()" style="background: linear-gradient(135deg, #8b6914, #a0865a); border: 2px solid #654321; color: #ffffff; padding: 8px 16px; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 12px; font-weight: bold; transition: all 0.3s; display: flex; align-items: center; gap: 6px; box-shadow: 0 -2px 8px rgba(139, 105, 20, 0.3); transform: translateY(0);">

              <span>ä¸‹ä¸€é¡µ</span>

              <span style="font-size: 14px;">â–¶</span>

            </button>

          </div>



          <!-- ä¹¦é¡µå†…å®¹ - çœŸæ­£çš„ä¹¦é¡µç¿»é¡µæ•ˆæœ -->

          <div class="book-content" style="position: relative; overflow: hidden; min-height: 600px;">

            <div id="book-pages-container" style="display: flex; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); height: 100%;">

              <!-- å½“å‰å¤©èµ‹é¡µé¢ -->

              <div class="book-page" style="min-width: 100%; flex-shrink: 0; padding: 20px;">

                <div class="book-page-content" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(245, 240, 232, 0.9)); border: 2px solid rgba(139, 105, 20, 0.3); border-radius: 16px; padding: 30px; min-height: 500px; box-shadow: 0 8px 32px rgba(139, 105, 20, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.8); max-width: 800px; margin: 0 auto; position: relative;">

                  <!-- ä¹¦é¡µè£…é¥°è§’ -->

                  <div style="position: absolute; top: 15px; right: 15px; width: 20px; height: 20px; background: linear-gradient(135deg, transparent 50%, rgba(139, 105, 20, 0.2) 50%); border-radius: 0 16px 0 0;"></div>

                  <div style="position: absolute; bottom: 15px; left: 15px; width: 20px; height: 20px; background: linear-gradient(135deg, rgba(139, 105, 20, 0.2) 50%, transparent 50%); border-radius: 0 0 0 16px;"></div>

                  

                  <h3 style="color: #8b4513; font-size: 20px; font-weight: bold; margin-bottom: 25px; text-align: center; text-shadow: 0 2px 4px rgba(139, 105, 20, 0.2); font-family: 'Georgia', serif;">ğŸŒŸ å½“å‰å¤©èµ‹</h3>

                  <div id="current-talents-list" class="talents-list" style="min-height: 350px"></div>

                </div>

              </div>



              <!-- èŒèŠ½é¡µé¢ -->

              <div class="book-page" style="min-width: 100%; flex-shrink: 0; padding: 20px;">

                <div class="book-page-content" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(245, 240, 232, 0.9)); border: 2px solid rgba(139, 69, 19, 0.3); border-radius: 16px; padding: 30px; min-height: 500px; box-shadow: 0 8px 32px rgba(139, 69, 19, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.8); max-width: 800px; margin: 0 auto; position: relative;">

                  <!-- ä¹¦é¡µè£…é¥°è§’ -->

                  <div style="position: absolute; top: 15px; right: 15px; width: 20px; height: 20px; background: linear-gradient(135deg, transparent 50%, rgba(139, 69, 19, 0.2) 50%); border-radius: 0 16px 0 0;"></div>

                  <div style="position: absolute; bottom: 15px; left: 15px; width: 20px; height: 20px; background: linear-gradient(135deg, rgba(139, 69, 19, 0.2) 50%, transparent 50%); border-radius: 0 0 0 16px;"></div>

                  

                  <h3 style="color: #8b4513; font-size: 20px; font-weight: bold; margin-bottom: 25px; text-align: center; text-shadow: 0 2px 4px rgba(139, 69, 19, 0.2); font-family: 'Georgia', serif;">ğŸŒ± èŒèŠ½ (The Seed)</h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto;">

                    <!-- å·¦ä¾§ï¼šæ•…äº‹æè¿° -->

                    <div style="width: 300px; background: linear-gradient(135deg, rgba(75, 0, 0, 0.12), rgba(50, 0, 0, 0.06)); border: 2px solid rgba(75, 0, 0, 0.35); border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(75, 0, 0, 0.2);">

                      <h4 style="color: #dc2626; font-size: 16px; font-weight: bold; margin-bottom: 12px; text-align: center;">ğŸ“– æ•…äº‹èƒŒæ™¯</h4>

                                              <p style="color: #000000; font-size: 13px; line-height: 1.6; text-align: center; font-style: italic; margin: 0; word-wrap: break-word; overflow-wrap: break-word; font-weight: 600; text-shadow: none; letter-spacing: 0.3px;">"ä½ åªæ˜¯åœ¨ç»å¢ƒä¸­ï¼Œæ— æ„è¯†åœ°æŠ“ä½äº†æ±‚ç”Ÿçš„ç¨»è‰ã€‚è¿™ä»½åŠ›é‡å¾®å¼±ã€ä¸å—æ§åˆ¶ï¼Œæ˜¯ä½ åœ¨è¿™åˆ«æ ·ä¸–ç•Œä¸­å‘å‡ºçš„ç¬¬ä¸€å£°å¾®å¼±çš„å•¼å“­ã€‚"</p>

                    </div>

                    <!-- å³ä¾§ï¼šå¤©èµ‹é€‰æ‹© -->

                    <div style="flex: 1; max-width: 550px; background: rgba(139, 69, 19, 0.08); border: 2px solid rgba(139, 69, 19, 0.25); border-radius: 16px; padding: 20px;">

                      <h4 style="color: #8b4513; font-size: 16px; font-weight: bold; margin-bottom: 12px; text-align: center;">ğŸ¯ é€‰æ‹©ä½ çš„é“è·¯</h4>

                      <div id="seed-options" style="max-height: 250px; overflow-y: auto;"></div>

                    </div>

                  </div>

                </div>

              </div>



              <!-- ç”Ÿé•¿é¡µé¢ -->

              <div class="book-page" style="min-width: 100%; flex-shrink: 0;">

                <div style="background: rgba(139, 69, 19, 0.08); border: 2px solid rgba(139, 69, 19, 0.25); border-radius: 12px; padding: 20px; min-height: 400px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);">

                  <h3 style="color: #8b4513; font-size: 18px; font-weight: bold; margin-bottom: 16px; text-align: center; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);">ğŸŒ¿ ç”Ÿé•¿ (The Growth)</h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto;">

                    <!-- å·¦ä¾§ï¼šæ•…äº‹æè¿° -->

                    <div style="width: 300px; background: linear-gradient(135deg, rgba(139, 0, 0, 0.15), rgba(75, 0, 0, 0.08)); border: 2px solid rgba(139, 0, 0, 0.4); border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(139, 0, 0, 0.2);">

                      <h4 style="color: #dc2626; font-size: 16px; font-weight: bold; margin-bottom: 12px; text-align: center;">ğŸ“– æ•…äº‹èƒŒæ™¯</h4>

                      <p style="color: #000000; font-size: 13px; line-height: 1.6; text-align: center; font-style: italic; margin: 0; word-wrap: break-word; overflow-wrap: break-word; font-weight: 600; letter-spacing: 0.3px;">"ä½ å¼€å§‹ç†è§£å¹¶æœ‰æ„è¯†åœ°è¿ç”¨è¿™ä»½åŠ›é‡ï¼Œå°†å…¶ä½œä¸ºè§£å†³é—®é¢˜çš„å·¥å…·ã€‚ä½ ä»è¢«åŠ¨çš„å—å®³è€…ï¼Œè½¬å˜ä¸ºä¸€ä¸ªèƒ½åœ¨æ£‹ç›˜ä¸Šè°¨æ…è½å­çš„å‚ä¸è€…ã€‚"</p>

                    </div>

                    <!-- å³ä¾§ï¼šå¤©èµ‹é€‰æ‹© -->

                    <div style="flex: 1; max-width: 550px; background: rgba(139, 69, 19, 0.08); border: 2px solid rgba(139, 69, 19, 0.25); border-radius: 16px; padding: 20px;">

                      <h4 style="color: #8b4513; font-size: 16px; font-weight: bold; margin-bottom: 12px; text-align: center;">ğŸ¯ é€‰æ‹©ä½ çš„é“è·¯</h4>

                      <div id="growth-options" style="max-height: 250px; overflow-y: auto;"></div>

                    </div>

                  </div>

                </div>

              </div>



              <!-- ç•¸å˜é¡µé¢ -->

              <div class="book-page" style="min-width: 100%; flex-shrink: 0;">

                <div style="background: rgba(139, 69, 19, 0.08); border: 2px solid rgba(139, 69, 19, 0.25); border-radius: 12px; padding: 20px; min-height: 400px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);">

                  <h3 style="color: #8b4513; font-size: 18px; font-weight: bold; margin-bottom: 16px; text-align: center; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);">ğŸŒ€ ç•¸å˜ (The Aberration)</h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto;">

                    <!-- å·¦ä¾§ï¼šæ•…äº‹æè¿° -->

                    <div style="width: 300px; background: linear-gradient(135deg, rgba(75, 0, 130, 0.18), rgba(45, 0, 80, 0.10)); border: 2px solid rgba(75, 0, 130, 0.5); border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(75, 0, 130, 0.25);">

                      <h4 style="color: #8b5cf6; font-size: 16px; font-weight: bold; margin-bottom: 12px; text-align: center;">ğŸ“– æ•…äº‹èƒŒæ™¯</h4>

                      <p style="color: #000000; font-size: 13px; line-height: 1.6; text-align: center; font-style: italic; margin: 0; word-wrap: break-word; overflow-wrap: break-word; font-weight: 600; letter-spacing: 0.3px;">"åŠ›é‡å¼€å§‹åè¿‡æ¥å½±å“ä½ çš„å¿ƒæ™ºå’Œè¡Œä¸ºã€‚ä½ è·å¾—äº†æ›´å¼ºå¤§çš„èƒ½åŠ›ï¼Œä½†ä¹Ÿæ„Ÿå—åˆ°äº†å…¶èƒŒåé‚£ä»¤äººæˆ˜æ —çš„ç”œç¾ä¸ç–¯ç‹‚ã€‚"</p>

                    </div>

                    <!-- å³ä¾§ï¼šå¤©èµ‹é€‰æ‹© -->

                    <div style="flex: 1; max-width: 550px; background: rgba(139, 69, 19, 0.08); border: 2px solid rgba(139, 69, 19, 0.25); border-radius: 16px; padding: 20px;">

                      <h4 style="color: #8b4513; font-size: 16px; font-weight: bold; margin-bottom: 12px; text-align: center;">ğŸ¯ é€‰æ‹©ä½ çš„é“è·¯</h4>

                      <div id="mutation-options" style="max-height: 250px; overflow-y: auto;"></div>

                    </div>

                  </div>

                </div>

              </div>



              <!-- æƒæŸ„é¡µé¢ -->

              <div class="book-page" style="min-width: 100%; flex-shrink: 0;">

                <div style="background: rgba(139, 69, 19, 0.08); border: 2px solid rgba(139, 69, 19, 0.25); border-radius: 12px; padding: 20px; min-height: 400px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);">

                  <h3 style="color: #8b4513; font-size: 18px; font-weight: bold; margin-bottom: 16px; text-align: center; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);">ğŸ‘‘ æƒæŸ„ (The Authority)</h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto;">

                    <!-- å·¦ä¾§ï¼šæ•…äº‹æè¿° -->

                    <div style="width: 300px; background: linear-gradient(135deg, rgba(139, 0, 0, 0.22), rgba(100, 0, 0, 0.12)); border: 2px solid rgba(139, 0, 0, 0.6); border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(139, 0, 0, 0.3);">

                      <h4 style="color: #ef4444; font-size: 16px; font-weight: bold; margin-bottom: 12px; text-align: center;">ğŸ“– æ•…äº‹èƒŒæ™¯</h4>

                      <p style="color: #000000; font-size: 13px; line-height: 1.6; text-align: center; font-style: italic; margin: 0; word-wrap: break-word; overflow-wrap: break-word; font-weight: 600; letter-spacing: 0.3px;">"åœ¨ç»å†äº†å†…å¿ƒçš„æŒ£æ‰åï¼Œä½ åšå‡ºäº†é€‰æ‹©ã€‚ä½ ä¸å†è§†å…¶ä¸ºè¯…å’’ï¼Œè€Œæ˜¯å¼€å§‹äº«å—è¿™ä»½åŠ›é‡ï¼Œå¹¶ä¸»åŠ¨å°†å…¶é”»é€ æˆå±äºè‡ªå·±çš„'æƒæŸ„'ã€‚"</p>

                    </div>

                    <!-- å³ä¾§ï¼šå¤©èµ‹é€‰æ‹© -->

                    <div style="flex: 1; max-width: 550px; background: rgba(139, 69, 19, 0.08); border: 2px solid rgba(139, 69, 19, 0.25); border-radius: 16px; padding: 20px;">

                      <h4 style="color: #8b4513; font-size: 16px; font-weight: bold; margin-bottom: 12px; text-align: center;">ğŸ¯ é€‰æ‹©ä½ çš„é“è·¯</h4>

                      <div id="authority-options" style="max-height: 250px; overflow-y: auto;"></div>

                    </div>

                  </div>

                </div>

              </div>



              <!-- æ·±æ¸Šé¡µé¢ -->

              <div class="book-page" style="min-width: 100%; flex-shrink: 0;">

                <div style="background: rgba(139, 69, 19, 0.08); border: 2px solid rgba(139, 69, 19, 0.25); border-radius: 12px; padding: 20px; min-height: 400px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);">

                  <h3 style="color: #8b4513; font-size: 18px; font-weight: bold; margin-bottom: 16px; text-align: center; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);">ğŸŒŒ æ·±æ¸Š (The Abyss)</h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto;">

                    <!-- å·¦ä¾§ï¼šæ•…äº‹æè¿° -->

                    <div style="width: 300px; background: linear-gradient(135deg, rgba(0, 0, 0, 0.25), rgba(20, 20, 20, 0.15)); border: 2px solid rgba(0, 0, 0, 0.7); border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);">

                      <h4 style="color: #6b7280; font-size: 16px; font-weight: bold; margin-bottom: 12px; text-align: center;">ğŸ“– æ•…äº‹èƒŒæ™¯</h4>

                      <p style="color: #000000; font-size: 13px; line-height: 1.6; text-align: center; font-style: italic; margin: 0; word-wrap: break-word; overflow-wrap: break-word; font-weight: 600; letter-spacing: 0.3px;">"ä½ èµ°åˆ°äº†è¿™æ¡è·¯çš„ç»ˆç‚¹ã€‚ä½ ä¸æ‰€é€‰çš„'ä¸å‡¡ä¹‹çˆ±'å½»åº•èä¸ºä¸€ä½“ï¼Œæˆä¸ºäº†ä¸€ä¸ªæ–°çš„'æ¦‚å¿µ'ã€ä¸€ä¸ªæ–°çš„'è§„åˆ™æ€ªè°ˆ'ã€‚"</p>

                    </div>

                    <!-- å³ä¾§ï¼šå¤©èµ‹é€‰æ‹© -->

                    <div style="flex: 1; max-width: 550px; background: rgba(139, 69, 19, 0.08); border: 2px solid rgba(139, 69, 19, 0.25); border-radius: 16px; padding: 20px;">

                      <h4 style="color: #8b4513; font-size: 16px; font-weight: bold; margin-bottom: 12px; text-align: center;">ğŸ¯ é€‰æ‹©ä½ çš„é“è·¯</h4>

                      <div id="abyss-options" style="max-height: 250px; overflow-y: auto;"></div>

                    </div>

                  </div>

                </div>

              </div>



              <!-- å‡çº§è®°å½•é¡µé¢ -->

              <div class="book-page" style="min-width: 100%; flex-shrink: 0;">

                <div style="background: rgba(139, 69, 19, 0.08); border: 2px solid rgba(139, 69, 19, 0.25); border-radius: 12px; padding: 20px; min-height: 400px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);">

                  <h3 style="color: #8b4513; font-size: 18px; font-weight: bold; margin-bottom: 16px; text-align: center; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);">ğŸ“š å‡çº§è®°å½•</h3>

                  <div id="upgrade-history" style="min-height: 300px">

                    <div style="text-align: center; color: #666666; font-style: italic; padding: 50px;">æš‚æ— å‡çº§è®°å½•</div>

                  </div>

                </div>

              </div>

            </div>

          </div>

        </div>

      </div>

    </div>



    <!-- æš´éœ²å…¨å±€å‡½æ•°ä¾›MVUç®¡ç†å™¨ä½¿ç”¨ -->

    <script>

      // æš´éœ²é“å…·ç³»ç»Ÿå‡½æ•°åˆ°å…¨å±€

      window.savePendingActions = savePendingActions;

      window.updateActionIcons = updateActionIcons;

      window.updateInventoryCommandManager = updateInventoryCommandManager;

    </script>



    <!-- æŠ€èƒ½ç³»ç»Ÿè„šæœ¬ -->

    <script>

      // æŠ€èƒ½ç³»ç»Ÿ

      class SkillSystem {

        constructor() {

          this.currentSkill = null;

          this.skillData = {

            // å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰çš„ä¸‰ä¸ªæŠ€èƒ½æ–¹å‘
            'defense': {

              icon: 'ğŸ›¡ï¸',

              name: 'é˜²å¾¡æŠ€èƒ½',

              description: 'åŸºäºå¼ºåŒ–ç³»å¤©èµ‹çš„é˜²å¾¡èƒ½åŠ›ï¼Œå¯ä»¥æå‡è‡ªèº«æˆ–ç›®æ ‡çš„é˜²å¾¡åŠ›ã€‚',

              majorTalent: 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰'

            },

            'rule_enhance': {
              icon: 'ğŸ“œ',

              name: 'è§„åˆ™æ´å¯Ÿ',
              description: 'åŸºäºå¼ºåŒ–ç³»å¤©èµ‹çš„è§„åˆ™æ´å¯Ÿèƒ½åŠ›ï¼Œå¯ä»¥çœ‹ç©¿è§„åˆ™æ¼æ´å¹¶åŠ ä»¥åˆ©ç”¨ã€‚',
              majorTalent: 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰'
            },
            'chain_enhance': {
              icon: 'ğŸ”—',

              name: 'é”é“¾æ§åˆ¶',
              description: 'åŸºäºå¼ºåŒ–ç³»å¤©èµ‹çš„é”é“¾æ§åˆ¶èƒ½åŠ›ï¼Œå¯ä»¥æŸç¼šæˆ–é”å®šç›®æ ‡ã€‚',
              majorTalent: 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰'
            },
            
            // å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰çš„ä¸‰ä¸ªæŠ€èƒ½æ–¹å‘
            'rule_change': {
              icon: 'ğŸ“',
              name: 'è§„åˆ™ä¿®æ”¹',
              description: 'åŸºäºå˜åŒ–ç³»å¤©èµ‹çš„è§„åˆ™ä¿®æ”¹èƒ½åŠ›ï¼Œå¯ä»¥ä¸´æ—¶æ”¹å˜è§„åˆ™å†…å®¹ã€‚',
              majorTalent: 'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰'
            },
            'emotion': {
              icon: 'ğŸ’­',
              name: 'æƒ…æ„Ÿæ“æ§',
              description: 'åŸºäºå˜åŒ–ç³»å¤©èµ‹çš„æƒ…æ„Ÿæ“æ§èƒ½åŠ›ï¼Œå¯ä»¥å°†è°è¨€å…·è±¡åŒ–ä¸ºæƒ…æ„Ÿæ­¦å™¨ã€‚',
              majorTalent: 'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰'
            },
            'shadow': {
              icon: 'ğŸ‘¤',
              name: 'å½±å­æ“æ§',
              description: 'åŸºäºå˜åŒ–ç³»å¤©èµ‹çš„å½±å­æ“æ§èƒ½åŠ›ï¼Œå¯ä»¥åˆ›é€ å’Œæ§åˆ¶è™šå‡å½±å­ã€‚',
              majorTalent: 'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰'
            },
            
            // æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰çš„ä¸‰ä¸ªæŠ€èƒ½æ–¹å‘
            'emotion_release': {
              icon: 'ğŸ’”',
              name: 'æƒ…ç»ªé‡Šæ”¾',
              description: 'åŸºäºæ”¾å‡ºç³»å¤©èµ‹çš„æƒ…ç»ªé‡Šæ”¾èƒ½åŠ›ï¼Œå¯ä»¥ç‰ºç‰²æƒ…æ„Ÿå½±å“æ•Œäººã€‚',
              majorTalent: 'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰'
            },
            'sacrifice': {
              icon: 'âš°ï¸',
              name: 'ç”Ÿå‘½çŒ®ç¥­',
              description: 'åŸºäºæ”¾å‡ºç³»å¤©èµ‹çš„çŒ®ç¥­èƒ½åŠ›ï¼Œå¯ä»¥ç‰ºç‰²ç”Ÿå‘½æˆ–è®°å¿†è·å¾—åŠ›é‡ã€‚',
              majorTalent: 'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰'
            },
            'phantom': {
              icon: 'ğŸ‘»',
              name: 'åˆ†èº«å…·ç°',
              description: 'åŸºäºæ”¾å‡ºç³»å¤©èµ‹çš„åˆ†èº«èƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–å¹»å½±åˆ†èº«ã€‚',
              majorTalent: 'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰'
            },
            
            // æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰çš„ä¸‰ä¸ªæŠ€èƒ½æ–¹å‘
            'suggestion': {
              icon: 'ğŸ§ ',
              name: 'å¿ƒç†æš—ç¤º',
              description: 'åŸºäºæ“ä½œç³»å¤©èµ‹çš„å¿ƒç†æš—ç¤ºèƒ½åŠ›ï¼Œå¯ä»¥æ¤å…¥æ€æƒ³æ§åˆ¶ç›®æ ‡ã€‚',
              majorTalent: 'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰'

            },
            'control': {
              icon: 'ğŸ®',
              name: 'ç²¾ç¥æ“æ§',
              description: 'åŸºäºæ“ä½œç³»å¤©èµ‹çš„ç²¾ç¥æ“æ§èƒ½åŠ›ï¼Œå¯ä»¥ç›´æ¥æ§åˆ¶æ•Œäººè¡ŒåŠ¨ã€‚',
              majorTalent: 'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰'
            },
            'absorption': {
              icon: 'ğŸ’•',
              name: 'çˆ±æ„å¸æ”¶',
              description: 'åŸºäºæ“ä½œç³»å¤©èµ‹çš„å¸æ”¶èƒ½åŠ›ï¼Œå¯ä»¥å¸æ”¶ä»–äººçš„çˆ±æ„è·å¾—åŠ›é‡ã€‚',
              majorTalent: 'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰'
            },
            
            // å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰çš„ä¸‰ä¸ªæŠ€èƒ½æ–¹å‘
            'armor': {
              icon: 'ğŸ›¡ï¸',
              name: 'ç†æƒ³ç›”ç”²',
              description: 'åŸºäºå…·ç°åŒ–ç³»å¤©èµ‹çš„ç›”ç”²èƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–å®Œç¾çš„é˜²æŠ¤è£…å¤‡ã€‚',
              majorTalent: 'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰'
            },
            'ring': {
              icon: 'ğŸ’',
              name: 'æ‰¿è¯ºæˆ’æŒ‡',
              description: 'åŸºäºå…·ç°åŒ–ç³»å¤©èµ‹çš„æˆ’æŒ‡èƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–æ‹¥æœ‰å¼ºå¤§åŠ›é‡çš„æˆ’æŒ‡ã€‚',
              majorTalent: 'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰'
            },
            'npc': {
              icon: 'ğŸ¤–',
              name: 'å®Œç¾NPC',
              description: 'åŸºäºå…·ç°åŒ–ç³»å¤©èµ‹çš„NPCèƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–å®Œç¾çš„åŠ©æ‰‹ã€‚',
              majorTalent: 'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰'
            },
            
            // ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰çš„ä¸‰ä¸ªæŠ€èƒ½æ–¹å‘
            'contract': {
              icon: 'ğŸ“‹',
              name: 'æ€ªè°ˆå¥‘çº¦',
              description: 'åŸºäºç‰¹è´¨ç³»å¤©èµ‹çš„å¥‘çº¦èƒ½åŠ›ï¼Œå¯ä»¥ä¸è§„åˆ™æ€ªè°ˆç­¾è®¢å¥‘çº¦ã€‚',
              majorTalent: 'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰'
            },
            'resonance': {
              icon: 'ğŸµ',
              name: 'æƒ…ç»ªå…±é¸£',
              description: 'åŸºäºç‰¹è´¨ç³»å¤©èµ‹çš„å…±é¸£èƒ½åŠ›ï¼Œå¯ä»¥ä¸ç›®æ ‡è¿›è¡Œæƒ…ç»ªå…±é¸£ã€‚',
              majorTalent: 'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰'
            },
            'chaos': {
              icon: 'ğŸŒ€',
              name: 'æ··æ²Œæ··åˆ',
              description: 'åŸºäºç‰¹è´¨ç³»å¤©èµ‹çš„æ··åˆèƒ½åŠ›ï¼Œå¯ä»¥æ··åˆä¸åŒçˆ±æ„åˆ›é€ æ–°æŠ€èƒ½ã€‚',
              majorTalent: 'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰'
            }

          };

          

          this.init();

        }



        init() {

          this.bindEvents();

          this.checkSkillUnlock();

        }



        bindEvents() {

          // æŠ€èƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - åŠ¨æ€ç»‘å®š
          $(document).on('click', '.skill-btn', (e) => {
            const skillType = $(e.currentTarget).data('skill-type');
            if (skillType) {
              this.showSkillPopup(skillType, e);
            }
          });


          // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­æŠ€èƒ½å¼¹çª—

          $(document).on('click', (e) => {

            if (!$(e.target).closest('.skill-detail-popup').length && !$(e.target).closest('.skill-btn').length) {

              this.hideSkillPopup();

            }

          });

        }



        checkSkillUnlock() {

          // æ£€æŸ¥æ˜¯å¦è§£é”äº†èŒèŠ½å±‚å¤©èµ‹

          try {

            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {

              const mvuData = Mvu.getMvuData({ type: 'chat' });

              const seedTalent = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.èŒèŠ½[0]', { default_value: null });

              

              if (seedTalent && seedTalent !== '') {

                // è§£é”æŠ€èƒ½æŒ‰é’®

                $('#skills-section').show();

                this.updateSkillButtons();
                console.log('ğŸ¯ æŠ€èƒ½ç³»ç»Ÿå·²è§£é”');

              } else {

                $('#skills-section').hide();

              }

            }

          } catch (error) {

            console.error('æ£€æŸ¥æŠ€èƒ½è§£é”çŠ¶æ€å¤±è´¥:', error);

            $('#skills-section').hide();

          }

        }


        updateSkillButtons() {
          // è·å–å½“å‰å¤§å¤©èµ‹
          let majorTalent = 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰';
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              majorTalent = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name[0]', { default_value: 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰' });
            }
          } catch (error) {
            console.warn('è·å–å¤§å¤©èµ‹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
          }

          // æ ¹æ®å¤§å¤©èµ‹è·å–å¯¹åº”çš„3ä¸ªæŠ€èƒ½
          const skills = this.getSkillsByMajorTalent(majorTalent);
          
          // æ›´æ–°æŠ€èƒ½æŒ‰é’®
          const container = $('#skills-section');
          container.empty();
          
          if (skills.length === 0) {
            // æ²¡æœ‰æŠ€èƒ½æ—¶æ˜¾ç¤ºæç¤º
            container.html('<div class="no-skills-message">æ½œèƒ½æœªè§‰é†’ï¼Œæš‚æ— æŠ€èƒ½</div>');
          } else {
            skills.forEach(skill => {
              const button = $(`
                <button class="skill-btn" data-skill-type="${skill.type}" title="${skill.name}">
                  <span class="skill-icon">${skill.icon}</span>
                </button>
              `);
              container.append(button);
            });
          }
        }

        getSkillsByMajorTalent(majorTalent) {
          const skillMapping = {
            'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰': [
              { type: 'defense', icon: 'ğŸ›¡ï¸', name: 'é˜²å¾¡æŠ€èƒ½' },
              { type: 'rule_enhance', icon: 'ğŸ“œ', name: 'è§„åˆ™æ´å¯Ÿ' },
              { type: 'chain_enhance', icon: 'ğŸ”—', name: 'é”é“¾æ§åˆ¶' }
            ],
            'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰': [
              { type: 'rule_change', icon: 'ğŸ“', name: 'è§„åˆ™ä¿®æ”¹' },
              { type: 'emotion', icon: 'ğŸ’­', name: 'æƒ…æ„Ÿæ“æ§' },
              { type: 'shadow', icon: 'ğŸ‘¤', name: 'å½±å­æ“æ§' }
            ],
            'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰': [
              { type: 'emotion_release', icon: 'ğŸ’”', name: 'æƒ…ç»ªé‡Šæ”¾' },
              { type: 'sacrifice', icon: 'âš°ï¸', name: 'ç”Ÿå‘½çŒ®ç¥­' },
              { type: 'phantom', icon: 'ğŸ‘»', name: 'åˆ†èº«å…·ç°' }
            ],
            'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰': [
              { type: 'suggestion', icon: 'ğŸ§ ', name: 'å¿ƒç†æš—ç¤º' },
              { type: 'control', icon: 'ğŸ®', name: 'ç²¾ç¥æ“æ§' },
              { type: 'absorption', icon: 'ğŸ’•', name: 'çˆ±æ„å¸æ”¶' }
            ],
            'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰': [
              { type: 'armor', icon: 'ğŸ›¡ï¸', name: 'ç†æƒ³ç›”ç”²' },
              { type: 'ring', icon: 'ğŸ’', name: 'æ‰¿è¯ºæˆ’æŒ‡' },
              { type: 'npc', icon: 'ğŸ¤–', name: 'å®Œç¾NPC' }
            ],
            'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰': [
              { type: 'contract', icon: 'ğŸ“‹', name: 'æ€ªè°ˆå¥‘çº¦' },
              { type: 'resonance', icon: 'ğŸµ', name: 'æƒ…ç»ªå…±é¸£' },
              { type: 'chaos', icon: 'ğŸŒ€', name: 'æ··æ²Œæ··åˆ' }
            ]
          };
          
          return skillMapping[majorTalent] || skillMapping['å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰'];
        }


        showSkillPopup(skillType, event) {

          const skill = this.skillData[skillType];

          if (!skill) return;



          this.currentSkill = skillType;



          // ç§»é™¤ç°æœ‰çš„æŠ€èƒ½å¼¹çª—

          $('.skill-detail-popup').remove();



          // åˆ›å»ºæŠ€èƒ½å¼¹çª—

          const popup = $(`

            <div class="skill-detail-popup">

              <div class="skill-header">
                <span class="skill-icon">${skill.icon}</span>
                <span class="skill-title">${skill.name}</span>
              </div>
              <div class="skill-desc">${skill.description}</div>

              <div>

                <button class="skill-use-btn" data-target="self">ğŸ‘¤ å¯¹è‡ªå·±ä½¿ç”¨</button>

                <button class="skill-use-btn" data-target="uma">ğŸ å¯¹é©¬å¨˜ä½¿ç”¨</button>

              </div>

            </div>

          `);



          // ç»‘å®šæŒ‰é’®äº‹ä»¶

          popup.find('.skill-use-btn').on('click', (e) => {

            const target = $(e.target).data('target');

            this.useSkill(target);

          });



          // å®šä½å¼¹çª—

          const button = $(event.target).closest('.skill-btn');

          const buttonOffset = button.offset();

          popup.css({

            position: 'absolute',

            top: buttonOffset.top - popup.outerHeight() - 10,

            left: buttonOffset.left

          });



          // æ·»åŠ åˆ°é¡µé¢

          $('body').append(popup);

          

          // æ’­æ”¾éŸ³æ•ˆ

          const skillSound = document.getElementById('item-detail-sound');

          if (skillSound) {

            skillSound.currentTime = 0;

            skillSound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));

          }

        }



        hideSkillPopup() {

          $('.skill-detail-popup').remove();

          this.currentSkill = null;

        }



        useSkill(target) {

          if (!this.currentSkill) return;



          const skill = this.skillData[this.currentSkill];



          if (target === 'self') {

            const actionText = `[ä½¿ç”¨æŠ€èƒ½: ${skill.name}]`;

            

            // æ·»åŠ åˆ°æŒ‡ä»¤é˜Ÿåˆ—

            addPendingAction('skill', skill.name, {

              skillType: this.currentSkill,

              target: target,

              majorTalent: skill.majorTalent

            });



            // å…³é—­å¼¹çª—

            this.hideSkillPopup();



            // æ˜¾ç¤ºæç¤º

            this.showTemporaryMessage(`å·²å°† ${actionText} åŠ å…¥æŒ‡ä»¤é˜Ÿåˆ—`);

          } else if (target === 'uma') {

            // å…³é—­å¼¹çª—

            this.hideSkillPopup();

            

            // å¼€å§‹æŠ€èƒ½é€‰æ‹©æ¨¡å¼

            startSkillSelection(skill.name, this.currentSkill);

          }

        }



        showTemporaryMessage(message) {

          const messageDiv = $('<div class="temporary-message">')

            .text(message)

            .css({

              position: 'fixed',

              top: '50%',

              left: '50%',

              transform: 'translate(-50%, -50%)',

              background: 'rgba(0, 0, 0, 0.8)',

              color: 'white',

              padding: '10px 20px',

              borderRadius: '8px',

              fontSize: '14px',

              zIndex: 1000,

              animation: 'fadeInOut 2s ease-in-out'

            });



          $('body').append(messageDiv);



          setTimeout(() => {

            messageDiv.remove();

          }, 2000);

        }

      }



      // åˆå§‹åŒ–æŠ€èƒ½ç³»ç»Ÿ

      $(document).ready(function() {

        window.skillSystem = new SkillSystem();

        
        // ç›‘å¬å¤©èµ‹å˜åŒ–ï¼Œæ›´æ–°æŠ€èƒ½æŒ‰é’®
        if (window.teresenDebug && window.teresenDebug.updateInterface) {
          const originalUpdateInterface = window.teresenDebug.updateInterface;
          window.teresenDebug.updateInterface = function() {
            originalUpdateInterface.call(this);
            if (window.skillSystem) {
              window.skillSystem.checkSkillUnlock();
            }
          };
                }

        // ç®€å•ç›´æ¥çš„éŸ³ä¹æ’­æ”¾åŠŸèƒ½
        function setupMusicControls() {
          console.log('ğŸµ åˆå§‹åŒ–éŸ³ä¹æ§åˆ¶');
          
          // ç›´æ¥ç”¨jQueryç»‘å®šç‚¹å‡»äº‹ä»¶
          $('#music-controller').on('click', function() {
            console.log('ğŸµ éŸ³ä¹æŒ‰é’®è¢«ç‚¹å‡»');
            
            const audio1 = document.getElementById('bgm-track1');
            const audio2 = document.getElementById('bgm-track2');
            
            // è®¾ç½®éŸ³é‡
            if (audio1) audio1.volume = 0.3;
            if (audio2) audio2.volume = 0.3;
            
            // æ£€æŸ¥å½“å‰çŠ¶æ€å¹¶åˆ‡æ¢
            if (audio1 && audio1.paused && audio2 && audio2.paused) {
              // éƒ½æ²¡æ’­æ”¾ï¼Œæ’­æ”¾ç¬¬ä¸€é¦–
              audio1.play().then(() => {
                console.log('ğŸµ å¼€å§‹æ’­æ”¾éŸ³ä¹1');
                $(this).text('ğŸµ æ’­æ”¾ä¸­1');
              }).catch(e => console.log('æ’­æ”¾å¤±è´¥:', e));
            } else if (audio1 && !audio1.paused) {
              // ç¬¬ä¸€é¦–åœ¨æ’­æ”¾ï¼Œåˆ‡æ¢åˆ°ç¬¬äºŒé¦–
              audio1.pause();
              audio1.currentTime = 0;
              audio2.play().then(() => {
                console.log('ğŸµ å¼€å§‹æ’­æ”¾éŸ³ä¹2');
                $(this).text('ğŸµ æ’­æ”¾ä¸­2');
              }).catch(e => console.log('æ’­æ”¾å¤±è´¥:', e));
            } else if (audio2 && !audio2.paused) {
              // ç¬¬äºŒé¦–åœ¨æ’­æ”¾ï¼Œåœæ­¢æ‰€æœ‰
              audio2.pause();
              audio2.currentTime = 0;
              console.log('ğŸµ åœæ­¢æ’­æ”¾');
              $(this).text('ğŸµ éŸ³ä¹æ§åˆ¶');
            }
          });
        }

        // è°ƒç”¨éŸ³ä¹æ§åˆ¶åˆå§‹åŒ–
        setupMusicControls();
      });
      
      // å¡”ç½—å åœç³»ç»Ÿ
      class TarotDivinationSystem {
        constructor() {
          console.log('ğŸ´ å¡”ç½—å åœç³»ç»Ÿæ„é€ å‡½æ•°å¼€å§‹');
          this.tarotCards = [
            { name: "æ„šè€…", meaning: "æ–°çš„å¼€å§‹ï¼Œå†’é™©ç²¾ç¥", reversed: "é²è½ï¼Œä¸è´Ÿè´£ä»»" },
            { name: "é­”æœ¯å¸ˆ", meaning: "åˆ›é€ åŠ›ï¼ŒæŠ€èƒ½æŒæ¡", reversed: "æŠ€èƒ½ä¸è¶³ï¼Œæœºä¼šæµªè´¹" },
            { name: "å¥³ç¥­å¸", meaning: "ç›´è§‰ï¼Œç¥ç§˜çŸ¥è¯†", reversed: "éšè—çš„çœŸç›¸ï¼Œè¡¨é¢ç°è±¡" },
            { name: "å¥³çš‡", meaning: "ä¸°æ”¶ï¼Œæ¯æ€§ï¼Œåˆ›é€ åŠ›", reversed: "ä¾èµ–ï¼Œè¿‡åº¦ä¿æŠ¤" },
            { name: "çš‡å¸", meaning: "æƒå¨ï¼Œé¢†å¯¼åŠ›ï¼Œç¨³å®š", reversed: "ä¸“åˆ¶ï¼Œç¼ºä¹çµæ´»æ€§" },
            { name: "æ•™çš‡", meaning: "ä¼ ç»Ÿï¼Œç²¾ç¥æŒ‡å¯¼", reversed: "æ•™æ¡ï¼Œé™åˆ¶" },
            { name: "æ‹äºº", meaning: "çˆ±æƒ…ï¼Œé€‰æ‹©ï¼Œå’Œè°", reversed: "ä¸å’Œè°ï¼Œé”™è¯¯é€‰æ‹©" },
            { name: "æˆ˜è½¦", meaning: "èƒœåˆ©ï¼Œæ„å¿—åŠ›ï¼Œæ§åˆ¶", reversed: "å¤±æ§ï¼Œå¤±è´¥" },
            { name: "åŠ›é‡", meaning: "å†…åœ¨åŠ›é‡ï¼Œå‹‡æ°”", reversed: "è½¯å¼±ï¼Œç¼ºä¹ä¿¡å¿ƒ" },
            { name: "éšè€…", meaning: "æ™ºæ…§ï¼Œå†…çœï¼ŒæŒ‡å¯¼", reversed: "å­¤ç‹¬ï¼Œæ‹’ç»å¸®åŠ©" },
            { name: "å‘½è¿ä¹‹è½®", meaning: "å˜åŒ–ï¼Œå‘½è¿è½¬æŠ˜", reversed: "åè¿æ°”ï¼Œåœæ»" },
            { name: "æ­£ä¹‰", meaning: "å…¬å¹³ï¼ŒçœŸç†ï¼Œå¹³è¡¡", reversed: "ä¸å…¬ï¼Œåè§" },
            { name: "å€’åŠäºº", meaning: "ç‰ºç‰²ï¼Œæ–°è§†è§’", reversed: "æ— æ„ä¹‰çš„ç‰ºç‰²" },
            { name: "æ­»ç¥", meaning: "ç»“æŸï¼Œè½¬å˜ï¼Œé‡ç”Ÿ", reversed: "åœæ»ï¼Œæ‹’ç»æ”¹å˜" },
            { name: "èŠ‚åˆ¶", meaning: "å¹³è¡¡ï¼Œé€‚åº¦ï¼Œå’Œè°", reversed: "è¿‡åº¦ï¼Œä¸å¹³è¡¡" },
            { name: "æ¶é­”", meaning: "æŸç¼šï¼Œç‰©è´¨æ¬²æœ›", reversed: "æ‘†è„±æŸç¼šï¼Œè§‰é†’" },
            { name: "å¡”", meaning: "çªç„¶å˜åŒ–ï¼Œå¯ç¤º", reversed: "é¿å…ç¾éš¾ï¼Œé‡å»º" },
            { name: "æ˜Ÿæ˜Ÿ", meaning: "å¸Œæœ›ï¼Œçµæ„Ÿï¼Œä¿¡å¿ƒ", reversed: "å¤±æœ›ï¼Œç¼ºä¹ä¿¡å¿ƒ" },
            { name: "æœˆäº®", meaning: "ç›´è§‰ï¼Œå¹»æƒ³ï¼Œææƒ§", reversed: "é‡Šæ”¾ææƒ§ï¼ŒçœŸç›¸" },
            { name: "å¤ªé˜³", meaning: "æˆåŠŸï¼Œå¿«ä¹ï¼Œæ´»åŠ›", reversed: "æš‚æ—¶çš„å›°éš¾" },
            { name: "å®¡åˆ¤", meaning: "é‡ç”Ÿï¼Œå†…åœ¨å¬å”¤", reversed: "è‡ªæˆ‘æ€€ç–‘ï¼Œæ‹’ç»æ”¹å˜" },
            { name: "ä¸–ç•Œ", meaning: "å®Œæˆï¼Œå’Œè°ï¼ŒæˆåŠŸ", reversed: "æœªå®Œæˆï¼Œå»¶è¿Ÿ" }
          ];

          this.tarotItems = {
            "èµ«å°”å¢¨æ–¯ç¾½æ¯›": {
              "æè¿°": "ä¿¡ä½¿ç¥èµ«å°”å¢¨æ–¯ç¿…è†€ä¸Šçš„ä¸€ç‰‡ç¾½æ¯›ï¼Œèƒ½å¸¦æ¥å¥½è¿",
              "æ•ˆæœ": "è¿æ°”+8ï¼Œè§£é”1ä¸ªéšè—å¯¹è¯",
              "ç¨€æœ‰åº¦": "ç¨€æœ‰",
              "ç‰¹æ€§": "ä¿¡ä½¿ä¹‹ç¿¼"
            },
            "æ™ºæ…§ä¹‹æ³‰": {
              "æè¿°": "æ¥è‡ªåŒ—æ¬§ç¥è¯æ™ºæ…§ä¹‹æ³‰çš„ä¸€æ»´æ°´ç ",
              "æ•ˆæœ": "ç†æ™º+10ï¼Œè·å¾—1ä¸ªç‰¹æ®ŠçŸ¥è¯†",
              "ç¨€æœ‰åº¦": "ç¨€æœ‰",
              "ç‰¹æ€§": "æ™ºæ…§å¯è¿ª"
            },
            "å‡€åŒ–ä¹‹é•œ": {
              "æè¿°": "èƒ½é©±æ•£è´Ÿé¢èƒ½é‡çš„ç¥ç§˜é•œå­",
              "æ•ˆæœ": "å‡€åŒ–1ä¸ªè´Ÿé¢çŠ¶æ€ï¼Œè¿æ°”+5",
              "ç¨€æœ‰åº¦": "ç¨€æœ‰",
              "ç‰¹æ€§": "å‡€åŒ–ä¹‹å…‰"
            },
            "å‘½è¿ç¡¬å¸": {
              "æè¿°": "èƒ½æ”¹å˜ä¸€æ¬¡éšæœºäº‹ä»¶ç»“æœçš„ç¥ç§˜ç¡¬å¸",
              "æ•ˆæœ": "ä¸‹æ¬¡éšæœºäº‹ä»¶ç»“æœ+20%",
              "ç¨€æœ‰åº¦": "ç¨€æœ‰",
              "ç‰¹æ€§": "å‘½è¿ç¿»è½¬"
            },
            "çµé­‚ç¢ç‰‡": {
              "æè¿°": "æ¥è‡ªç¥ç§˜çµé­‚çš„å¾®å°ç¢ç‰‡",
              "æ•ˆæœ": "éšæœºé©¬å¨˜å¥½æ„Ÿåº¦+8ï¼Œç†æ™º+3",
              "ç¨€æœ‰åº¦": "ç¨€æœ‰",
              "ç‰¹æ€§": "çµé­‚å…±é¸£"
            },
            "æ—¶é—´æ²™ç²’": {
              "æè¿°": "æ¥è‡ªæ—¶é—´é•¿æ²³çš„ä¸€ç²’æ²™",
              "æ•ˆæœ": "åœ¨æ ¡å¤©æ•°+1ï¼Œä½“åŠ›+10",
              "ç¨€æœ‰åº¦": "ç¨€æœ‰",
              "ç‰¹æ€§": "æ—¶é—´æ“æ§"
            }
          };

          this.bindEvents();
          console.log('ğŸ´ å¡”ç½—å åœç³»ç»Ÿæ„é€ å‡½æ•°å®Œæˆ');
        }

        bindEvents() {
          console.log('ğŸ´ ç»‘å®šå¡”ç½—å åœäº‹ä»¶');
          
          // ç»‘å®šå¡”ç½—å åœæŒ‰é’®ç‚¹å‡»äº‹ä»¶
          $(document).on('click', '#tarot-divination', (e) => {
            console.log('ğŸ´ å¡”ç½—å åœæŒ‰é’®è¢«ç‚¹å‡»');
            // æ’­æ”¾å¡”ç½—å£°éŸ³
            const sound = document.getElementById('tarot-shuffle');
            if (sound) {
              sound.currentTime = 0;
              sound.play().catch(e => console.log('å¡”ç½—éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
            }
            e.preventDefault();
            e.stopPropagation();
            this.openTarotModal();
          });

          // ç»‘å®šæ¨¡æ€æ¡†å…³é—­äº‹ä»¶
          $(document).on('click', '#close-tarot-btn', (e) => {
            console.log('ğŸ´ å…³é—­å¡”ç½—å åœæ¨¡æ€æ¡†');
            e.preventDefault();
            e.stopPropagation();
            this.closeTarotModal();
          });

          // ç»‘å®šå åœæŒ‰é’®äº‹ä»¶
          $(document).on('click', '.spread-btn:not(.disabled)', (e) => {
            console.log('ğŸ´ å åœæŒ‰é’®è¢«ç‚¹å‡»');
            e.preventDefault();
            e.stopPropagation();
            const spreadType = $(e.currentTarget).data('spread');
            const cost = $(e.currentTarget).data('cost');
            this.performDivination(spreadType, cost);
          });
          
          console.log('ğŸ´ å¡”ç½—å åœäº‹ä»¶ç»‘å®šå®Œæˆ');
        }

        openTarotModal() {
          console.log('ğŸ´ æ‰“å¼€å¡”ç½—å åœæ¨¡æ€æ¡†');
          this.updateTarotInfo();
          this.updateSpreadButtons();
          $('#tarot-modal').show();
          console.log('ğŸ´ å¡”ç½—å åœæ¨¡æ€æ¡†å·²æ˜¾ç¤º');
        }

        closeTarotModal() {
          $('#tarot-modal').hide();
          $('#tarot-result').hide();
        }

        updateTarotInfo() {
          console.log('ğŸ´ æ›´æ–°å¡”ç½—å åœä¿¡æ¯');
          
          // å‚è€ƒå¤©èµ‹ç³»ç»Ÿçš„å®ç°æ–¹å¼
          let sanity = 100;
          let gameDay = 1;
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              sanity = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç†æ™º[0]', { default_value: 100 });
              gameDay = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°[0]', { default_value: 1 });
              console.log('ğŸ´ MVUç†æ™ºå€¼è·å–æˆåŠŸ:', sanity);
              console.log('ğŸ´ æ¸¸æˆå¤©æ•°è·å–æˆåŠŸ:', gameDay);
            }
          } catch (error) {
            console.warn('ğŸ´ è·å–ç†æ™ºå€¼å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
          }
          
          const remaining = this.getDailyRemaining();
          console.log('ğŸ´ ç†æ™º:', sanity, 'æ¸¸æˆå¤©æ•°:', gameDay, 'å‰©ä½™æ¬¡æ•°:', remaining);
          
          // æ˜¾ç¤ºç†æ™ºå€¼
          $('#tarot-sanity').text(sanity);
          
          // æ˜¾ç¤ºæ¸¸æˆå¤©æ•°å’Œå‰©ä½™æ¬¡æ•°
          const remainingText = `æ¸¸æˆç¬¬${gameDay}å¤© - å‰©ä½™æ¬¡æ•°: ${remaining}`;
          $('#tarot-remaining').text(remainingText);
          
          // å¦‚æœæ¬¡æ•°ç”¨å®Œï¼Œæ·»åŠ æç¤º
          if (remaining === 0) {
            $('#tarot-remaining').append('<br><small style="color: #ef4444; font-size: 0.8rem;">éœ€è¦ç­‰åˆ°æ¸¸æˆå†…ä¸‹ä¸€å¤©æ‰èƒ½ç»§ç»­ä½¿ç”¨</small>');
          }
        }

        updateSpreadButtons() {
          console.log('ğŸ´ æ›´æ–°å åœæŒ‰é’®çŠ¶æ€');
          
          // å‚è€ƒå¤©èµ‹ç³»ç»Ÿçš„å®ç°æ–¹å¼
          // ä½¿ç”¨å’Œä¸ªäººæ¡£æ¡ˆç›¸åŒçš„å˜é‡è·å–æ–¹å¼
          let sanity = 100;
          let schoolDays = 0;
          try {
            const allVars = this.getAllVariables();
            sanity = this.getVariable(allVars, 'stat_data.è®­ç»ƒå‘˜.ç†æ™º[0]', 100);
            schoolDays = this.getVariable(allVars, 'stat_data.è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°[0]', 1);
            console.log('ğŸ´ ä½¿ç”¨getAllVariablesè·å–å˜é‡æˆåŠŸ:', { sanity, schoolDays });
          } catch (error) {
            console.warn('ğŸ´ è·å–å˜é‡å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
          }
          
          console.log('ğŸ´ ç†æ™º:', sanity, 'åœ¨æ ¡å¤©æ•°:', schoolDays);
          console.log('ğŸ´ getGameDay()è¿”å›:', this.getGameDay());

          $('.spread-btn').each((index, button) => {
            const $btn = $(button);
            const cost = $btn.data('cost');
            const requirement = $btn.data('requirement');

            let disabled = false;
            let reason = '';

            if (sanity < cost) {
              disabled = true;
              reason = 'ç†æ™ºä¸è¶³';
            } else if (requirement && schoolDays < requirement) {
              disabled = true;
              reason = 'åœ¨æ ¡å¤©æ•°ä¸è¶³';
            }

            if (disabled) {
              $btn.addClass('disabled');
              $btn.attr('title', reason);
            } else {
              $btn.removeClass('disabled');
              $btn.attr('title', '');
            }
          });
          console.log('ğŸ´ å åœæŒ‰é’®çŠ¶æ€æ›´æ–°å®Œæˆ');
        }

        async performDivination(spreadType, cost) {
          console.log('ğŸ´ å¼€å§‹å åœ:', spreadType, 'æ¶ˆè€—:', cost);
          
          // æ£€æŸ¥æ¯æ—¥å‰©ä½™æ¬¡æ•°ï¼ˆåŸºäºæ¸¸æˆå¤©æ•°ï¼‰
          const dailyRemaining = this.getDailyRemaining();
          if (dailyRemaining <= 0) {
            const gameDay = this.getGameDay();
            alert(`æ¸¸æˆç¬¬${gameDay}å¤©çš„å åœæ¬¡æ•°å·²ç”¨å®Œï¼Œéœ€è¦ç­‰åˆ°æ¸¸æˆå†…ä¸‹ä¸€å¤©æ‰èƒ½ç»§ç»­ä½¿ç”¨ï¼`);
            return;
          }
          
          // å‚è€ƒå¤©èµ‹ç³»ç»Ÿçš„å®ç°æ–¹å¼è·å–ç†æ™ºå€¼
          let currentSanity = 100;
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              currentSanity = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç†æ™º[0]', { default_value: 100 });
              console.log('ğŸ´ å½“å‰ç†æ™ºå€¼:', currentSanity);
            }
          } catch (error) {
            console.warn('ğŸ´ è·å–ç†æ™ºå€¼å¤±è´¥:', error);
          }
          
          // æ£€æŸ¥ç†æ™ºæ˜¯å¦è¶³å¤Ÿ
          if (currentSanity < cost) {
            alert('ç†æ™ºä¸è¶³ï¼Œæ— æ³•è¿›è¡Œå åœï¼');
            return;
          }

          // æ¶ˆè€—ç†æ™º - å‚è€ƒå¤©èµ‹ç³»ç»Ÿçš„å®ç°æ–¹å¼
          const newSanity = currentSanity - cost;
          try {
            if (typeof Mvu !== 'undefined' && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              await Mvu.setMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç†æ™º[0]', newSanity, {
                reason: 'å¡”ç½—å åœæ¶ˆè€—',
                is_recursive: true,
              });
              await Mvu.replaceMvuData(mvuData, { type: 'chat' });
              console.log('ğŸ´ ç†æ™ºå€¼æ‰£é™¤æˆåŠŸ:', currentSanity, '->', newSanity);
            }
          } catch (error) {
            console.error('ğŸ´ æ‰£é™¤ç†æ™ºå€¼å¤±è´¥:', error);
            alert('æ‰£é™¤ç†æ™ºå€¼å¤±è´¥ï¼');
            return;
          }

          // æ˜¾ç¤ºå åœå¼€å§‹åŠ¨ç”»
          this.showDivinationStartAnimation(spreadType);
          
          // å»¶è¿Ÿç”Ÿæˆç»“æœï¼Œå¢åŠ ç¥ç§˜æ„Ÿ
          setTimeout(async () => {
            // ç”Ÿæˆå åœç»“æœ
            const result = await this.generateDivinationResult(spreadType);
            
            // éšè—å¼€å§‹åŠ¨ç”»
            $('.tarot-start-animation').fadeOut(500, () => {
              $('.tarot-start-animation').remove();
            });
            
            // æ˜¾ç¤ºç»“æœ
            this.showTarotResultPopup(result);
          }, 2000);
          
          // æ›´æ–°ç•Œé¢
          this.updateTarotInfo();
          this.updateSpreadButtons();
          
          // è®°å½•ä½¿ç”¨æ¬¡æ•°
          this.recordDailyUsage();
        }

        async generateDivinationResult(spreadType) {
          const cards = [];
          const cardCount = this.getCardCount(spreadType);
          
          for (let i = 0; i < cardCount; i++) {
            const card = this.getRandomCard();
            cards.push(card);
          }

          const result = await this.interpretCards(cards, spreadType);
          return { cards, result };
        }

        getCardCount(spreadType) {
          const counts = {
            'single': 1,
            'timeline': 3,
            'choice': 2,
            'hexagram': 6,
            'celtic': 10,
            'zodiac': 12
          };
          return counts[spreadType] || 1;
        }

        getRandomCard() {
          const card = this.tarotCards[Math.floor(Math.random() * this.tarotCards.length)];
          const isReversed = Math.random() < 0.3; // 30%æ¦‚ç‡é€†ä½
          return {
            ...card,
            reversed: isReversed,
            meaning: isReversed ? card.reversed : card.meaning
          };
        }

        async interpretCards(cards, spreadType) {
          const result = {
            type: this.determineResultType(cards),
            luckChange: 0,
            reasonChange: 0,
            canGetItem: false,
            affectionChange: 0,
            interpretation: '',
            effects: []
          };

          // æ ¹æ®å¡ç‰Œå’Œç‰Œé˜µç±»å‹ç”Ÿæˆç»“æœ
          switch (spreadType) {
            case 'single':
              result.luckChange = this.calculateLuckChange(cards);
              result.reasonChange = this.calculateReasonChange(cards);
              result.canGetItem = Math.random() < 0.15;
              result.affectionChange = this.calculateAffectionChange(cards);
              break;
            case 'timeline':
              result.luckChange = this.calculateLuckChange(cards) * 1.5;
              result.reasonChange = this.calculateReasonChange(cards) * 1.5;
              result.canGetItem = Math.random() < 0.20;
              result.affectionChange = this.calculateAffectionChange(cards) * 1.5;
              break;
            case 'choice':
              result.luckChange = this.calculateLuckChange(cards) * 0.8;
              result.reasonChange = this.calculateReasonChange(cards) * 0.8;
              result.canGetItem = Math.random() < 0.12;
              result.affectionChange = this.calculateAffectionChange(cards) * 0.8;
              break;
            default:
              result.luckChange = this.calculateLuckChange(cards) * 2;
              result.reasonChange = this.calculateReasonChange(cards) * 2;
              result.canGetItem = Math.random() < 0.25;
              result.affectionChange = this.calculateAffectionChange(cards) * 2;
          }

          // ç”Ÿæˆè§£é‡Šæ–‡æœ¬
          result.interpretation = this.generateInterpretation(cards, spreadType);
          
          // åº”ç”¨æ•ˆæœ
          await this.applyDivinationEffects(result);

          return result;
        }

        determineResultType(cards) {
          const positiveCards = cards.filter(card => !card.reversed).length;
          const totalCards = cards.length;
          const positiveRatio = positiveCards / totalCards;

          if (positiveRatio >= 0.8) return 'ç¥è¿¹æ˜¾ç°';
          if (positiveRatio >= 0.6) return 'æ™ºæ…§å¯è¿ª';
          if (positiveRatio >= 0.4) return 'å‘½è¿æ³¢åŠ¨';
          if (positiveRatio >= 0.2) return 'è¿·é›¾ç¬¼ç½©';
          if (positiveRatio >= 0.1) return 'æ··æ²Œå›å“';
          return 'æ·±æ¸Šä½è¯­';
        }

        calculateLuckChange(cards) {
          let change = 0;
          cards.forEach(card => {
            if (card.reversed) {
              change -= 3 + Math.random() * 5;
            } else {
              change += 3 + Math.random() * 5;
            }
          });
          return Math.round(change / cards.length);
        }

        calculateReasonChange(cards) {
          let change = 0;
          cards.forEach(card => {
            if (card.reversed) {
              change -= 2 + Math.random() * 3;
            } else {
              change += 2 + Math.random() * 3;
            }
          });
          return Math.round(change / cards.length);
        }

        calculateAffectionChange(cards) {
          let change = 0;
          cards.forEach(card => {
            if (card.reversed) {
              change -= 2 + Math.random() * 3;
            } else {
              change += 2 + Math.random() * 3;
            }
          });
          return Math.round(change / cards.length);
        }

        generateInterpretation(cards, spreadType) {
          const spreadNames = {
            'single': 'å•å¼ ç‰Œå åœ',
            'timeline': 'æ—¶é—´ä¹‹æµå åœ',
            'choice': 'äºŒé€‰ä¸€å åœ',
            'hexagram': 'å…­èŠ’æ˜Ÿå åœ',
            'celtic': 'å‡¯å°”ç‰¹åå­—å åœ',
            'zodiac': 'é»„é“åäºŒå®«å åœ'
          };

          const spreadDescriptions = {
            'single': 'åœ¨ç¥ç§˜çš„æœˆå…‰ä¸‹ï¼Œä½ æŠ½å‡ºäº†å‘½è¿ä¹‹ç‰Œã€‚è¿™å¼ ç‰Œå¦‚åŒå¤œç©ºä¸­çš„åŒ—ææ˜Ÿï¼Œä¸ºä½ æŒ‡æ˜å‰è¿›çš„æ–¹å‘...',
            'timeline': 'æ—¶é—´çš„é•¿æ²³åœ¨ä½ é¢å‰å±•å¼€ï¼Œè¿‡å»ã€ç°åœ¨ä¸æœªæ¥äº¤ç»‡æˆå‘½è¿çš„ç»‡é”¦ã€‚æ¯ä¸€å¼ ç‰Œéƒ½æ‰¿è½½ç€æ—¶å…‰çš„é‡é‡...',
            'choice': 'å‘½è¿åœ¨ä½ é¢å‰æ‘†å‡ºäº†ä¸¤æ¡é“è·¯ï¼Œå¦‚åŒåå­—è·¯å£çš„é€‰æ‹©ã€‚æ¯ä¸€æ¡è·¯éƒ½é€šå‘ä¸åŒçš„æœªæ¥...',
            'hexagram': 'å…­èŠ’æ˜Ÿçš„å¤è€ç¬¦å·åœ¨è™šç©ºä¸­é—ªçƒï¼Œå…­å¼ ç‰Œå¦‚åŒæ˜Ÿè¾°èˆ¬æ’åˆ—ï¼Œæ­ç¤ºç€æ·±å±‚çš„å‘½è¿å¯†ç ...',
            'celtic': 'å‡¯å°”ç‰¹åå­—çš„å¤è€æ™ºæ…§åœ¨ä½ é¢å‰å±•å¼€ï¼Œåå¼ ç‰Œå¦‚åŒç”Ÿå‘½ä¹‹æ ‘çš„æå¶ï¼Œå±•ç°ç€å†…å¿ƒçš„æ·±å±‚ç»“æ„...',
            'zodiac': 'é»„é“åäºŒå®«çš„æ˜Ÿè±¡åœ¨ä½ å‘¨å›´æ—‹è½¬ï¼ŒåäºŒå¼ ç‰Œå¦‚åŒå®‡å®™çš„å’Œè°ä¹ç« ï¼Œæ˜ å°„ç€å¤©åœ°çš„å¹³è¡¡...'
          };

          let interpretation = spreadDescriptions[spreadType] || 'åœ¨ç¥ç§˜çš„å åœä»ªå¼ä¸­ï¼Œå‘½è¿çš„å¥¥ç§˜åœ¨ä½ é¢å‰ç¼“ç¼“å±•å¼€...';
          
          interpretation += '\n\n';
          
          cards.forEach((card, index) => {
            const cardNumber = index + 1;
            const positionText = card.reversed ? 'é€†ä½' : 'æ­£ä½';
            const positionDesc = card.reversed ? 'è¿™å¼ ç‰Œä»¥é€†ä½å‡ºç°ï¼Œæš—ç¤ºç€æŒ‘æˆ˜ä¸è­¦ç¤º' : 'è¿™å¼ ç‰Œä»¥æ­£ä½å‡ºç°ï¼Œå¸¦æ¥ç¥ç¦ä¸æŒ‡å¼•';
            
            interpretation += `ç¬¬${cardNumber}å¼ ç‰Œï¼š${card.name}ï¼ˆ${positionText}ï¼‰\n`;
            interpretation += `${positionDesc}ã€‚${card.meaning}\n\n`;
          });

          // æ·»åŠ æ€»ç»“æ€§çš„è¯è¯­
          const positiveCards = cards.filter(card => !card.reversed).length;
          const totalCards = cards.length;
          const positiveRatio = positiveCards / totalCards;

          if (positiveRatio >= 0.8) {
            interpretation += 'ğŸŒŸ å‘½è¿ä¹‹é•œæ˜¾ç¤ºï¼Œä½ çš„æœªæ¥å……æ»¡å…‰æ˜ä¸å¸Œæœ›ã€‚å‹‡æ•¢åœ°å‘å‰è¿ˆè¿›å§ï¼';
          } else if (positiveRatio >= 0.6) {
            interpretation += 'âœ¨ è™½ç„¶å‰è·¯æœ‰äº›æ³¢æŠ˜ï¼Œä½†æ™ºæ…§ä¸å‹‡æ°”å°†æŒ‡å¼•ä½ èµ°å‘æˆåŠŸã€‚';
          } else if (positiveRatio >= 0.4) {
            interpretation += 'ğŸŒ™ å‘½è¿ä¹‹è½®æ­£åœ¨è½¬åŠ¨ï¼Œä¿æŒè€å¿ƒä¸åšæŒï¼Œè½¬æœºå³å°†åˆ°æ¥ã€‚';
          } else if (positiveRatio >= 0.2) {
            interpretation += 'âš¡ æŒ‘æˆ˜ä¸æœºé‡å¹¶å­˜ï¼Œè°¨æ…è¡Œäº‹ï¼Œæ™ºæ…§å°†åŠ©ä½ åº¦è¿‡éš¾å…³ã€‚';
          } else {
            interpretation += 'ğŸ”® é»‘æš—ä¸­çš„æ˜Ÿå…‰æœ€ä¸ºçè´µï¼Œä¿æŒå¸Œæœ›ï¼Œå‘½è¿ç»ˆå°†çœ·é¡¾å‹‡æ•¢è€…ã€‚';
          }

          return interpretation;
        }

        async applyDivinationEffects(result) {
          console.log('ğŸ´ åº”ç”¨å åœæ•ˆæœ');
          
          // å‚è€ƒå¤©èµ‹ç³»ç»Ÿçš„å®ç°æ–¹å¼
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              
              // åº”ç”¨è¿æ°”å˜åŒ–
              const currentLuck = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.è¿æ°”[0]', { default_value: 50 });
              const newLuck = Math.max(0, Math.min(100, currentLuck + result.luckChange));
              await Mvu.setMvuVariable(mvuData, 'è®­ç»ƒå‘˜.è¿æ°”[0]', newLuck, {
                reason: 'å¡”ç½—å åœæ•ˆæœ',
                is_recursive: true,
              });
              result.effects.push(`è¿æ°”${result.luckChange > 0 ? '+' : ''}${result.luckChange}`);

              // åº”ç”¨ç†æ™ºå˜åŒ–
              const currentReason = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç†æ™º[0]', { default_value: 100 });
              const newReason = Math.max(0, Math.min(100, currentReason + result.reasonChange));
              await Mvu.setMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç†æ™º[0]', newReason, {
                reason: 'å¡”ç½—å åœæ•ˆæœ',
                is_recursive: true,
              });
              result.effects.push(`ç†æ™º${result.reasonChange > 0 ? '+' : ''}${result.reasonChange}`);
              
              // ä¿å­˜æ›´æ–°åçš„æ•°æ®
              await Mvu.replaceMvuData(mvuData, { type: 'chat' });
              console.log('ğŸ´ å åœæ•ˆæœåº”ç”¨æˆåŠŸ');
            }
          } catch (error) {
            console.error('ğŸ´ åº”ç”¨å åœæ•ˆæœå¤±è´¥:', error);
          }

          // å¤„ç†ç‰©å“è·å–
          if (result.canGetItem) {
            const itemCheck = this.canGetTarotItem();
            if (itemCheck.canGet) {
              const item = this.getRandomTarotItem();
              if (item) {
                await this.addTarotItem(item, this.tarotItems[item]);
                result.effects.push(`è·å¾—ç¥ç§˜ç‰©å“ï¼š${item}`);
                this.recordItemAcquisition();
              }
            }
          }

          // å¤„ç†é©¬å¨˜å¥½æ„Ÿåº¦
          if (result.affectionChange !== 0) {
            const affectionResult = await this.affectRandomHorseGirlAffection(result.affectionChange);
            if (affectionResult) {
              result.effects.push(`${affectionResult.name}å¥½æ„Ÿåº¦${result.affectionChange > 0 ? '+' : ''}${result.affectionChange}`);
            }
          }
        }

        showTarotResultPopup(result) {
          console.log('ğŸ´ æ˜¾ç¤ºå åœç»“æœ:', result);
          
          // è°ƒè¯•ï¼šæ£€æŸ¥resultç»“æ„
          if (!result || !result.cards || !result.result) {
            console.error('ğŸ´ resultæ•°æ®ç»“æ„é”™è¯¯:', result);
            alert('å åœæ•°æ®ç”Ÿæˆå¤±è´¥ï¼result=' + JSON.stringify(result));
            return;
          }
          
          // ç§»é™¤ç°æœ‰çš„ç»“æœå¼¹çª—
          $('.tarot-result-modal').remove();
          
          // åˆ›å»ºç¥ç§˜ä¼˜ç¾çš„å åœç»“æœå¼¹çª—
          const resultModal = $(`
            <div class="tarot-result-modal" style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.8);
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 10000;
              backdrop-filter: blur(5px);
            ">
              <div class="tarot-result-content" style="
                background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
                border: 2px solid #a855f7;
                border-radius: 20px;
                padding: 30px;
                max-width: 800px;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
                box-shadow: 0 0 50px rgba(168, 85, 247, 0.5);
                animation: tarotResultFadeIn 0.8s ease-out;
              ">
                <!-- å…³é—­æŒ‰é’® -->
                <button class="tarot-result-close" style="
                  position: absolute;
                  top: 15px;
                  right: 20px;
                  background: none;
                  border: none;
                  color: #a855f7;
                  font-size: 24px;
                  cursor: pointer;
                  z-index: 10001;
                ">Ã—</button>
                
                <!-- ç¥ç§˜æ ‡é¢˜ -->
                <div class="tarot-result-header" style="
                  text-align: center;
                  margin-bottom: 25px;
                  padding-bottom: 20px;
                  border-bottom: 2px solid rgba(168, 85, 247, 0.3);
                ">
                  <h2 style="
                    color: #a855f7;
                    font-size: 28px;
                    margin: 0;
                    text-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
                    font-family: 'Times New Roman', serif;
                  ">ğŸ”® å‘½è¿ä¹‹é•œ ğŸ”®</h2>
                  <p style="
                    color: #cbd5e1;
                    font-size: 16px;
                    margin: 10px 0 0 0;
                    font-style: italic;
                  ">${result.result.type}</p>
                </div>
                
                <!-- å¡ç‰Œå±•ç¤ºåŒºåŸŸ -->
                <div class="tarot-cards-display" style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                  gap: 15px;
                  margin-bottom: 25px;
                ">
                  ${result.cards.map((card, index) => `
                    <div class="tarot-result-card ${card.reversed ? 'reversed' : ''}" style="
                      background: linear-gradient(135deg, #2d1b69, #4c1d95);
                      border: 2px solid ${card.reversed ? '#ef4444' : '#a855f7'};
                      border-radius: 12px;
                      padding: 15px;
                      text-align: center;
                      position: relative;
                      transform: ${card.reversed ? 'rotate(180deg)' : 'none'};
                      transition: all 0.3s ease;
                      box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
                    ">
                      <div class="card-number" style="
                        position: absolute;
                        top: 5px;
                        left: 10px;
                        color: #a855f7;
                        font-size: 12px;
                        font-weight: bold;
                      ">${index + 1}</div>
                      <div class="card-name" style="
                        color: #f3f4f6;
                        font-size: 14px;
                        font-weight: bold;
                        margin-bottom: 8px;
                        text-shadow: 0 0 5px rgba(168, 85, 247, 0.5);
                      ">${card.name}</div>
                      <div class="card-meaning" style="
                        color: #cbd5e1;
                        font-size: 12px;
                        line-height: 1.4;
                        font-style: italic;
                      ">${card.meaning}</div>
                      ${card.reversed ? '<div style="position: absolute; top: 5px; right: 10px; color: #ef4444; font-size: 12px;">é€†ä½</div>' : ''}
                    </div>
                  `).join('')}
                </div>
                
                <!-- ç¥ç§˜è§£è¯» -->
                <div class="tarot-interpretation-section" style="
                  background: rgba(168, 85, 247, 0.1);
                  border: 1px solid rgba(168, 85, 247, 0.3);
                  border-radius: 12px;
                  padding: 20px;
                  margin-bottom: 25px;
                ">
                  <h3 style="
                    color: #a855f7;
                    font-size: 20px;
                    margin: 0 0 15px 0;
                    text-align: center;
                    font-family: 'Times New Roman', serif;
                  ">ğŸŒŸ ç¥ç§˜è§£è¯» ğŸŒŸ</h3>
                  <div class="interpretation-text" style="
                    color: #e2e8f0;
                    font-size: 14px;
                    line-height: 1.6;
                    text-align: justify;
                    font-family: 'Georgia', serif;
                  ">${result.result.interpretation}</div>
                </div>
                
                <!-- å‘½è¿å½±å“ -->
                <div class="tarot-effects-section" style="
                  background: rgba(34, 197, 94, 0.1);
                  border: 1px solid rgba(34, 197, 94, 0.3);
                  border-radius: 12px;
                  padding: 20px;
                ">
                  <h3 style="
                    color: #22c55e;
                    font-size: 20px;
                    margin: 0 0 15px 0;
                    text-align: center;
                    font-family: 'Times New Roman', serif;
                  ">âœ¨ å‘½è¿å½±å“ âœ¨</h3>
                  <div class="effects-list" style="
                    display: grid;
                    gap: 8px;
                  ">
                    ${result.result.effects.map(effect => `
                      <div class="effect-item" style="
                        background: rgba(34, 197, 94, 0.1);
                        border: 1px solid rgba(34, 197, 94, 0.2);
                        border-radius: 8px;
                        padding: 10px;
                        color: #22c55e;
                        font-size: 14px;
                        text-align: center;
                        font-weight: 500;
                      ">${effect}</div>
                    `).join('')}
                  </div>
                </div>
                
                <!-- ç¥ç§˜è£…é¥° -->
                <div style="
                  position: absolute;
                  top: 10px;
                  left: 10px;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                ">ğŸŒ™</div>
                <div style="
                  position: absolute;
                  top: 10px;
                  right: 50px;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                ">â­</div>
                <div style="
                  position: absolute;
                  bottom: 10px;
                  left: 10px;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                ">ğŸ”®</div>
                <div style="
                  position: absolute;
                  bottom: 10px;
                  right: 10px;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                ">âœ¨</div>
              </div>
            </div>
          `);
          
          // ç»‘å®šå…³é—­äº‹ä»¶
          resultModal.find('.tarot-result-close').on('click', () => {
            resultModal.fadeOut(300, () => resultModal.remove());
          });
          
          // ç‚¹å‡»èƒŒæ™¯å…³é—­
          resultModal.on('click', (e) => {
            if (e.target === resultModal[0]) {
              resultModal.fadeOut(300, () => resultModal.remove());
            }
          });
          
          // æ·»åŠ åˆ°é¡µé¢å¹¶æ˜¾ç¤º
          $('body').append(resultModal);
          
          // æ’­æ”¾ç¥ç§˜éŸ³æ•ˆï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
          const tarotSound = document.getElementById('tarot-result-sound');
          if (tarotSound) {
            tarotSound.currentTime = 0;
            tarotSound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
          }
          
          console.log('ğŸ´ å åœç»“æœå¼¹çª—å·²æ˜¾ç¤º');
        }

        showDivinationStartAnimation(spreadType) {
          console.log('ğŸ´ æ˜¾ç¤ºå åœå¼€å§‹åŠ¨ç”»');
          
          // ç§»é™¤ç°æœ‰çš„å¼€å§‹åŠ¨ç”»
          $('.tarot-start-animation').remove();
          
          const spreadNames = {
            'single': 'å•å¼ ç‰Œå åœ',
            'timeline': 'æ—¶é—´ä¹‹æµå åœ',
            'choice': 'äºŒé€‰ä¸€å åœ',
            'hexagram': 'å…­èŠ’æ˜Ÿå åœ',
            'celtic': 'å‡¯å°”ç‰¹åå­—å åœ',
            'zodiac': 'é»„é“åäºŒå®«å åœ'
          };
          
          const spreadIcons = {
            'single': 'ğŸ”®',
            'timeline': 'â°',
            'choice': 'âš–ï¸',
            'hexagram': 'â­',
            'celtic': 'ğŸ•¯ï¸',
            'zodiac': 'ğŸŒŸ'
          };
          
          // åˆ›å»ºç¥ç§˜çš„å¼€å¯åŠ¨ç”»
          const startAnimation = $(`
            <div class="tarot-start-animation" style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: radial-gradient(circle, rgba(0,0,0,0.9) 0%, rgba(26,26,46,0.95) 100%);
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 9999;
              backdrop-filter: blur(10px);
            ">
              <div class="animation-content" style="
                text-align: center;
                color: #a855f7;
                animation: tarotStartPulse 2s ease-in-out infinite;
              ">
                <div class="mystical-icon" style="
                  font-size: 80px;
                  margin-bottom: 20px;
                  text-shadow: 0 0 30px rgba(168, 85, 247, 0.8);
                  animation: tarotIconFloat 3s ease-in-out infinite;
                ">${spreadIcons[spreadType] || 'ğŸ”®'}</div>
                
                <h2 style="
                  font-size: 32px;
                  margin: 0 0 15px 0;
                  text-shadow: 0 0 20px rgba(168, 85, 247, 0.6);
                  font-family: 'Times New Roman', serif;
                ">${spreadNames[spreadType] || 'ç¥ç§˜å åœ'}</h2>
                
                <p style="
                  font-size: 18px;
                  margin: 0 0 30px 0;
                  color: #cbd5e1;
                  font-style: italic;
                ">å‘½è¿ä¹‹é•œæ­£åœ¨æ­ç¤ºä½ çš„æœªæ¥...</p>
                
                <div class="loading-dots" style="
                  display: flex;
                  justify-content: center;
                  gap: 8px;
                ">
                  <div class="dot" style="
                    width: 12px;
                    height: 12px;
                    background: #a855f7;
                    border-radius: 50%;
                    animation: tarotDotPulse 1.5s ease-in-out infinite;
                  "></div>
                  <div class="dot" style="
                    width: 12px;
                    height: 12px;
                    background: #a855f7;
                    border-radius: 50%;
                    animation: tarotDotPulse 1.5s ease-in-out infinite 0.2s;
                  "></div>
                  <div class="dot" style="
                    width: 12px;
                    height: 12px;
                    background: #a855f7;
                    border-radius: 50%;
                    animation: tarotDotPulse 1.5s ease-in-out infinite 0.4s;
                  "></div>
                </div>
                
                <!-- ç¥ç§˜è£…é¥°å…ƒç´  -->
                <div style="
                  position: absolute;
                  top: 20%;
                  left: 10%;
                  font-size: 24px;
                  color: rgba(168, 85, 247, 0.3);
                  animation: tarotFloat 4s ease-in-out infinite;
                ">ğŸŒ™</div>
                <div style="
                  position: absolute;
                  top: 30%;
                  right: 15%;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                  animation: tarotFloat 4s ease-in-out infinite 1s;
                ">â­</div>
                <div style="
                  position: absolute;
                  bottom: 25%;
                  left: 15%;
                  font-size: 22px;
                  color: rgba(168, 85, 247, 0.3);
                  animation: tarotFloat 4s ease-in-out infinite 2s;
                ">âœ¨</div>
                <div style="
                  position: absolute;
                  bottom: 35%;
                  right: 10%;
                  font-size: 26px;
                  color: rgba(168, 85, 247, 0.3);
                  animation: tarotFloat 4s ease-in-out infinite 3s;
                ">ğŸ”®</div>
              </div>
            </div>
          `);
          
          // æ·»åŠ åˆ°é¡µé¢
          $('body').append(startAnimation);
          
          // æ’­æ”¾ç¥ç§˜éŸ³æ•ˆï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
          const tarotStartSound = document.getElementById('tarot-start-sound');
          if (tarotStartSound) {
            tarotStartSound.currentTime = 0;
            tarotStartSound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
          }
          
          console.log('ğŸ´ å åœå¼€å§‹åŠ¨ç”»å·²æ˜¾ç¤º');
        }

        // ç‰©å“ç›¸å…³æ–¹æ³•
        canGetTarotItem() {
          const lastItemTime = localStorage.getItem('tarot_last_item_time');
          const itemCount = parseInt(localStorage.getItem('tarot_item_count') || '0');
          
          if (itemCount >= 3) {
            return { canGet: false, reason: 'å·²è¾¾åˆ°æœ€å¤§ç‰©å“æ•°é‡é™åˆ¶' };
          }
          
          if (lastItemTime) {
            const hoursSinceLastItem = (Date.now() - parseInt(lastItemTime)) / (1000 * 60 * 60);
            if (hoursSinceLastItem < 24) {
              return { canGet: false, reason: 'ç‰©å“è·å–å†·å´ä¸­' };
            }
          }
          
          return { canGet: true };
        }

        getRandomTarotItem() {
          const items = Object.keys(this.tarotItems);
          const rand = Math.random();
          if (rand < 0.15) { // 15%æ¦‚ç‡è·å¾—ç‰©å“
            return items[Math.floor(Math.random() * items.length)];
          }
          return null;
        }

        async addTarotItem(itemName, itemData) {
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              const currentItems = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç‰©å“æ ', { default_value: {} });
              currentItems[itemName] = itemData;
              
              await Mvu.setMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç‰©å“æ ', currentItems, {
                reason: 'å¡”ç½—å åœè·å¾—ç‰©å“',
                is_recursive: true,
              });
              await Mvu.replaceMvuData(mvuData, { type: 'chat' });
              console.log('ğŸ´ ç‰©å“æ·»åŠ æˆåŠŸ:', itemName);
            }
          } catch (error) {
            console.error('ğŸ´ æ·»åŠ ç‰©å“å¤±è´¥:', error);
          }
        }

        recordItemAcquisition() {
          localStorage.setItem('tarot_last_item_time', Date.now().toString());
          localStorage.setItem('tarot_item_count', 
            (parseInt(localStorage.getItem('tarot_item_count') || '0') + 1).toString());
        }

        // é©¬å¨˜ç›¸å…³æ–¹æ³•
        getExistingHorseGirls() {
          const horseGirls = this.getVariable('é©¬å¨˜', {});
          return Object.keys(horseGirls).filter(name => name !== '$meta');
        }

        getRandomExistingHorseGirl() {
          const existingGirls = this.getExistingHorseGirls();
          if (existingGirls.length === 0) return null;
          return existingGirls[Math.floor(Math.random() * existingGirls.length)];
        }

        async affectRandomHorseGirlAffection(affectionChange) {
          const horseGirlName = this.getRandomExistingHorseGirl();
          if (!horseGirlName) return null;
          
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              const currentHorseGirls = Mvu.getMvuVariable(mvuData, 'é©¬å¨˜', { default_value: {} });
              const currentAffection = currentHorseGirls[horseGirlName]?.å¥½æ„Ÿåº¦?.[0] || 0;
              const newAffection = Math.max(0, Math.min(100, currentAffection + affectionChange));
              
              // æ›´æ–°é©¬å¨˜å¥½æ„Ÿåº¦
              if (!currentHorseGirls[horseGirlName]) {
                currentHorseGirls[horseGirlName] = { å¥½æ„Ÿåº¦: [0] };
              }
              currentHorseGirls[horseGirlName].å¥½æ„Ÿåº¦[0] = newAffection;
              
              await Mvu.setMvuVariable(mvuData, 'é©¬å¨˜', currentHorseGirls, {
                reason: 'å¡”ç½—å åœé©¬å¨˜å¥½æ„Ÿåº¦å˜åŒ–',
                is_recursive: true,
              });
              await Mvu.replaceMvuData(mvuData, { type: 'chat' });
              
              return { 
                name: horseGirlName, 
                oldAffection: currentAffection, 
                newAffection: newAffection,
                change: affectionChange 
              };
            }
          } catch (error) {
            console.error('ğŸ´ æ›´æ–°é©¬å¨˜å¥½æ„Ÿåº¦å¤±è´¥:', error);
          }
          return null;
        }

        // æ¯æ—¥é™åˆ¶ç›¸å…³æ–¹æ³•
        getDailyRemaining() {
          try {
            // ä½¿ç”¨æ¸¸æˆå†…å¤©æ•°è€Œä¸æ˜¯ç°å®å¤©æ•°
            const gameDay = this.getGameDay();
            const lastUsedDay = localStorage.getItem('tarot_last_used_day');
            const gameDayKey = `tarot_usage_day_${gameDay}`;
            const usageCount = parseInt(localStorage.getItem(gameDayKey) || '0');
            
            // æ£€æµ‹æ–°å¼€å±€æˆ–æ–°çš„æ¸¸æˆå¤©æ•°
            const lastUsedDayNum = parseInt(lastUsedDay) || -1;
            
            // å¦‚æœå½“å‰å¤©æ•°å°äºä¸Šæ¬¡è®°å½•çš„å¤©æ•°ï¼Œè¯´æ˜æ˜¯æ–°å¼€å±€
            if (gameDay < lastUsedDayNum) {
              console.log(`ğŸ´ æ£€æµ‹åˆ°æ–°å¼€å±€: å½“å‰å¤©æ•°=${gameDay}, ä¸Šæ¬¡å¤©æ•°=${lastUsedDayNum}`);
              this.resetTarotData();
              return 3;
            }
            
            // å¦‚æœæ˜¯æ–°çš„æ¸¸æˆå¤©æ•°ï¼Œé‡ç½®ä½¿ç”¨æ¬¡æ•°
            if (lastUsedDay !== gameDay.toString()) {
              console.log(`ğŸ´ æ–°çš„æ¸¸æˆå¤©æ•°: ä»ç¬¬${lastUsedDay}å¤©åˆ°ç¬¬${gameDay}å¤©`);
              localStorage.setItem('tarot_last_used_day', gameDay.toString());
              // æ¸…ç†æ—§å¤©æ•°çš„æ•°æ®
              this.cleanupOldUsageData();
              return 3;
            }
            
            return Math.max(0, 3 - usageCount);
          } catch (error) {
            console.warn('ğŸ´ è·å–æ¯æ—¥å‰©ä½™æ¬¡æ•°å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', error);
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç°å®å¤©æ•°
            const today = new Date().toDateString();
            const lastUsage = localStorage.getItem('tarot_last_usage');
            const usageCount = parseInt(localStorage.getItem('tarot_usage_count') || '0');
            
            if (lastUsage !== today) {
              localStorage.setItem('tarot_last_usage', today);
              localStorage.setItem('tarot_usage_count', '0');
              return 3;
            }
            
            return Math.max(0, 3 - usageCount);
          }
        }

        // æ¸…ç†æ—§å¤©æ•°çš„ä½¿ç”¨æ•°æ®
        cleanupOldUsageData() {
          try {
            const currentGameDay = this.getGameDay();
            // æ¸…ç†30å¤©å‰çš„æ•°æ®
            for (let i = 1; i <= 30; i++) {
              const oldDay = currentGameDay - i;
              if (oldDay > 0) {
                localStorage.removeItem(`tarot_usage_day_${oldDay}`);
              }
            }
            console.log('ğŸ´ å·²æ¸…ç†æ—§å¤©æ•°çš„å¡”ç½—å åœä½¿ç”¨æ•°æ®');
          } catch (error) {
            console.warn('ğŸ´ æ¸…ç†æ—§æ•°æ®å¤±è´¥:', error);
          }
        }

        // é‡ç½®æ‰€æœ‰å¡”ç½—ç‰Œæ•°æ®ï¼ˆæ–°å¼€å±€æ—¶ä½¿ç”¨ï¼‰
        resetTarotData() {
          try {
            // æ¸…é™¤æ‰€æœ‰å¡”ç½—ç‰Œç›¸å…³çš„localStorageæ•°æ®
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith('tarot_')) {
                keysToRemove.push(key);
              }
            }
            
            keysToRemove.forEach(key => {
              localStorage.removeItem(key);
              console.log(`ğŸ´ æ¸…é™¤å¡”ç½—ç‰Œæ•°æ®: ${key}`);
            });
            
            console.log('ğŸ´ å·²é‡ç½®æ‰€æœ‰å¡”ç½—ç‰Œæ•°æ®ï¼ˆæ–°å¼€å±€ï¼‰');
          } catch (error) {
            console.warn('ğŸ´ é‡ç½®å¡”ç½—ç‰Œæ•°æ®å¤±è´¥:', error);
          }
        }

        recordDailyUsage() {
          // ä½¿ç”¨æ¸¸æˆå†…å¤©æ•°è€Œä¸æ˜¯ç°å®å¤©æ•°
          try {
            // è·å–æ¸¸æˆå†…å½“å‰å¤©æ•°
            const gameDay = this.getGameDay();
            const gameDayKey = `tarot_usage_day_${gameDay}`;
            const currentCount = parseInt(localStorage.getItem(gameDayKey) || '0');
            localStorage.setItem(gameDayKey, (currentCount + 1).toString());
            
            // è®°å½•æœ€åä¸€æ¬¡ä½¿ç”¨çš„æ¸¸æˆå¤©æ•°
            localStorage.setItem('tarot_last_used_day', gameDay.toString());
            
            console.log(`ğŸ´ å¡”ç½—å åœä½¿ç”¨è®°å½•ï¼šæ¸¸æˆç¬¬${gameDay}å¤©ï¼Œä½¿ç”¨${currentCount + 1}æ¬¡`);
          } catch (error) {
            console.warn('ğŸ´ è®°å½•å¡”ç½—å åœä½¿ç”¨å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', error);
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç°å®å¤©æ•°
            const today = new Date().toDateString();
            const currentCount = parseInt(localStorage.getItem('tarot_usage_count') || '0');
            localStorage.setItem('tarot_usage_count', (currentCount + 1).toString());
          }
        }

        // è·å–æ¸¸æˆå†…å¤©æ•° - ä½¿ç”¨å’ŒrenderUIç›¸åŒçš„æ–¹æ³•
        getGameDay() {
          try {
            // ä½¿ç”¨å’ŒupdateTarotInfoç›¸åŒçš„å˜é‡è·å–æ–¹å¼
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              const gameDay = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°[0]', { default_value: 1 });
              const day = parseInt(gameDay) || 1;
              console.log(`ğŸ´ ä½¿ç”¨MVUè·å–åœ¨æ ¡å¤©æ•°: ${gameDay} -> ${day}`);
              return day;
            }
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨getAllVariables
            const allVars = this.getAllVariables();
            const schoolDays = this.getVariable(allVars, 'stat_data.è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°[0]', 1);
            const day = parseInt(schoolDays) || 1;
            console.log(`ğŸ´ ä½¿ç”¨getAllVariablesè·å–åœ¨æ ¡å¤©æ•°: ${schoolDays} -> ${day}`);
            return day;
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä»localStorageè·å–
            const savedDay = localStorage.getItem('game_current_day');
            if (savedDay) {
              return parseInt(savedDay) || 1;
            }
            
            // é»˜è®¤è¿”å›ç¬¬1å¤©
            return 1;
          } catch (error) {
            console.warn('ğŸ´ è·å–æ¸¸æˆå¤©æ•°å¤±è´¥:', error);
            return 1;
          }
        }

        // å·¥å…·æ–¹æ³•
        getVariable(path, defaultValue = null) {
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              return Mvu.getMvuVariable(mvuData, path, { default_value: defaultValue });
            }
            return defaultValue;
          } catch (e) {
            console.warn('è·å–å˜é‡å¤±è´¥:', path, e);
            return defaultValue;
          }
        }

        setVariable(path, value) {
          try {
            if (typeof Mvu !== 'undefined' && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              Mvu.setMvuVariable(mvuData, path, value, {
                reason: 'å¡”ç½—å åœæ•ˆæœ',
                is_recursive: true,
              });
              Mvu.replaceMvuData(mvuData, { type: 'chat' });
            }
          } catch (e) {
            console.error('è®¾ç½®å˜é‡å¤±è´¥:', path, e);
          }
        }
      }

      // é©¬å¨˜è®°åå†Œç³»ç»Ÿ
      class UmaRosterSystem {
        constructor() {
          this.rosterKey = 'uma_roster';
          this.init();
        }

        init() {
          // åˆå§‹åŒ–è®°åå†Œæ•°æ®
          if (!localStorage.getItem(this.rosterKey)) {
            localStorage.setItem(this.rosterKey, JSON.stringify({}));
          }
        }

        // è·å–è®°åå†Œæ•°æ®
        getUmaRoster() {
          try {
            const rosterData = localStorage.getItem(this.rosterKey);
            return rosterData ? JSON.parse(rosterData) : {};
          } catch (error) {
            console.error('è·å–é©¬å¨˜è®°åå†Œå¤±è´¥:', error);
            return {};
          }
        }

        // æ·»åŠ é©¬å¨˜åˆ°è®°åå†Œ
        addUmaToRoster(umaName, details = {}) {
          try {
            const roster = this.getUmaRoster();
            const now = new Date().toISOString();
            
            if (!roster[umaName]) {
              roster[umaName] = {
                name: umaName,
                encounter_count: 1,
                first_met: now,
                last_met: now,
                notes: details.notes || '',
                personality: details.personality || '',
                abilities: details.abilities || ''
              };
            } else {
              roster[umaName].encounter_count += 1;
              roster[umaName].last_met = now;
              if (details.notes) roster[umaName].notes = details.notes;
              if (details.personality) roster[umaName].personality = details.personality;
              if (details.abilities) roster[umaName].abilities = details.abilities;
            }
            
            localStorage.setItem(this.rosterKey, JSON.stringify(roster));
            console.log(`ğŸ“– å·²æ·»åŠ  ${umaName} åˆ°é©¬å¨˜è®°åå†Œ`);
            return true;
          } catch (error) {
            console.error('æ·»åŠ é©¬å¨˜åˆ°è®°åå†Œå¤±è´¥:', error);
            return false;
          }
        }

        // æ‰“å¼€è®°åå†Œç•Œé¢
        openUmaRoster() {
          // æ’­æ”¾é©¬å¨˜è®°åå†ŒéŸ³æ•ˆ
          const sound = document.getElementById('uma-roster-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('æ’­æ”¾é©¬å¨˜è®°åå†ŒéŸ³æ•ˆå¤±è´¥:', e));
          }
          
          const roster = this.getUmaRoster();
          const umaList = Object.values(roster);
          
          let rosterHtml = `
            <div class="roster-modal" id="roster-modal">
              <div class="roster-content">
                <div class="roster-header">
                  <h2>ğŸ“– é©¬å¨˜è®°åå†Œ</h2>
                  <button class="roster-close-btn" onclick="this.closest('.roster-modal').remove()">Ã—</button>
                </div>
                <div class="roster-body">
          `;
          
          if (umaList.length === 0) {
            rosterHtml += '<div class="empty-roster">è¿˜æ²¡æœ‰é‡åˆ°ä»»ä½•é©¬å¨˜...</div>';
          } else {
            rosterHtml += '<div class="roster-list">';
            umaList.forEach(uma => {
              const firstMet = new Date(uma.first_met).toLocaleDateString('zh-CN');
              const lastMet = new Date(uma.last_met).toLocaleDateString('zh-CN');
              
              rosterHtml += `
                <div class="roster-item">
                  <div class="roster-item-header">
                    <h3>${uma.name}</h3>
                    <span class="encounter-count">é‡åˆ° ${uma.encounter_count} æ¬¡</span>
                  </div>
                  <div class="roster-item-details">
                    <div class="roster-detail">
                      <strong>é¦–æ¬¡é‡åˆ°:</strong> ${firstMet}
                    </div>
                    <div class="roster-detail">
                      <strong>æœ€åé‡åˆ°:</strong> ${lastMet}
                    </div>
                    ${uma.personality ? `<div class="roster-detail"><strong>æ€§æ ¼:</strong> ${uma.personality}</div>` : ''}
                    ${uma.abilities ? `<div class="roster-detail"><strong>èƒ½åŠ›:</strong> ${uma.abilities}</div>` : ''}
                    ${uma.notes ? `<div class="roster-detail"><strong>å¤‡æ³¨:</strong> ${uma.notes}</div>` : ''}
                  </div>
                </div>
              `;
            });
            rosterHtml += '</div>';
          }
          
          rosterHtml += `
                </div>
              </div>
            </div>
          `;
          
          // ç§»é™¤ç°æœ‰çš„è®°åå†Œå¼¹çª—
          $('.roster-modal').remove();
          
          // æ·»åŠ æ–°çš„è®°åå†Œå¼¹çª—
          $('body').append(rosterHtml);
        }
        
        // æ–°å¢ï¼šçŠ¶æ€è§¦å‘ç³»ç»Ÿ
        checkStatusTriggers() {
          try {
            // é˜²æ­¢é‡å¤è§¦å‘
            if (this.statusAnimationActive) {
              console.log('ğŸ­ çŠ¶æ€åŠ¨ç”»å·²æ¿€æ´»ï¼Œè·³è¿‡æ£€æŸ¥');
              return;
            }
            
            const variables = this.getAllVariables();
            const trainer = variables?.stat_data?.è®­ç»ƒå‘˜;
            
            if (!trainer) return;
            
            const stamina = trainer.ä½“åŠ›?.[0] || 0;
            const sanity = trainer.ç†æ™º?.[0] || 0;
            
            console.log('ğŸ­ æ£€æŸ¥çŠ¶æ€è§¦å‘ - ä½“åŠ›:', stamina, 'ç†æ™º:', sanity);
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘çŠ¶æ€åˆ¤å®š
            if (stamina <= 0 || sanity <= 0) {
              console.log('ğŸ­ è§¦å‘çŠ¶æ€åŠ¨ç”» - ä½“åŠ›:', stamina, 'ç†æ™º:', sanity);
              this.triggerStatusAnimation(stamina, sanity);
            }
          } catch (error) {
            console.warn('çŠ¶æ€è§¦å‘æ£€æŸ¥å¤±è´¥:', error);
          }
        }

        // æ–°å¢ï¼šçŠ¶æ€åŠ¨ç”»æ¼”å‡º
        triggerStatusAnimation(stamina, sanity) {
          console.log('ğŸ­ è§¦å‘çŠ¶æ€åŠ¨ç”»æ¼”å‡º');
          
          // è®¾ç½®çŠ¶æ€æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤è§¦å‘
          this.statusAnimationActive = true;
          
          // åˆ¤æ–­çŠ¶æ€ç±»å‹
          let statusType = 'normal';
          let statusTitle = 'çŠ¶æ€å˜åŒ–';
          let statusMessage = 'AIå°†ä¸ºä½ åˆ¤å®šæ–°çš„çŠ¶æ€...';
          
          if (stamina <= 0 && sanity <= 0) {
            statusType = 'critical';
            statusTitle = 'âš ï¸ åŒé‡å´©æºƒ';
            statusMessage = 'ä½“åŠ›ä¸ç†æ™ºåŒæ—¶å´©æºƒï¼AIå°†åˆ¤å®šä½ çš„å‘½è¿...';
          } else if (stamina <= 0) {
            statusType = 'stamina';
            statusTitle = 'ğŸ’ª ä½“åŠ›å´©æºƒ';
            statusMessage = 'ä½“åŠ›è€—å°½ï¼è¿™æ˜¯è€ƒéªŒæ„å¿—çš„æ—¶åˆ»...';
          } else if (sanity <= 0) {
            statusType = 'sanity';
            statusTitle = 'ğŸ§  ç†æ™ºå´©æºƒ';
            statusMessage = 'ç†æ™ºå´©æºƒï¼ç–¯ç‹‚ä¸­è•´å«ç€åŠ›é‡...';
          }
          
          // åˆ›å»ºçŠ¶æ€åŠ¨ç”»å®¹å™¨
          const animationContainer = document.createElement('div');
          animationContainer.className = `status-animation-container ${statusType}`;
          animationContainer.innerHTML = `
            <div class="status-animation">
              <div class="status-title">${statusTitle}</div>
              <div class="status-content">
                ${stamina <= 0 ? `<div class="status-item stamina">ä½“åŠ›: ${stamina}</div>` : ''}
                ${sanity <= 0 ? `<div class="status-item sanity">ç†æ™º: ${sanity}</div>` : ''}
              </div>
              <div class="status-message">${statusMessage}</div>
              <div class="status-hint">ç­‰å¾…AIçš„åˆ¤å®š...</div>
            </div>
          `;
          
          // æ·»åŠ åˆ°é¡µé¢
          document.body.appendChild(animationContainer);
          
          // æ’­æ”¾åŠ¨ç”»
          setTimeout(() => {
            animationContainer.classList.add('show');
          }, 100);
          
          // 5ç§’åè‡ªåŠ¨ç§»é™¤
          setTimeout(() => {
            animationContainer.classList.remove('show');
            setTimeout(() => {
              if (animationContainer.parentNode) {
                animationContainer.parentNode.removeChild(animationContainer);
              }
              // é‡ç½®çŠ¶æ€æ ‡å¿—
              this.statusAnimationActive = false;
            }, 500);
          }, 5000);
        }

        // å·²åˆ é™¤é‡å¤çš„å¡”ç½—å åœç³»ç»Ÿ
      }

      // åˆå§‹åŒ–é©¬å¨˜è®°åå†Œç³»ç»Ÿ
      $(document).ready(function() {
        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
        setTimeout(() => {
          window.umaRosterSystem = new UmaRosterSystem();
          console.log('ğŸ“– é©¬å¨˜è®°åå†Œç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }, 100);
      });

      // åˆå§‹åŒ–å¡”ç½—å åœç³»ç»Ÿ
      $(document).ready(function() {
        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
        setTimeout(() => {
          window.tarotSystem = new TarotDivinationSystem();
          console.log('ğŸ´ å¡”ç½—å åœç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }, 100);
      });

    </script>

  </body>

</html>

<!--
================================================================================
  ç‰¹é›·æ£®è§„åˆ™æ€ªè°ˆ - è®­ç»ƒå‘˜ç”Ÿå­˜æŒ‡å— (ç»“æŸ)
  
  ä½œè€…: Eternal zz
  åˆ›æ„æ”¯æŒï¼ŒæŠ€æœ¯æ”¯æŒ
  Discord ID: eternalzz0840
  
  æ„Ÿè°¢ä½¿ç”¨æœ¬é¡¹ç›®ï¼
  
  ç‰ˆæƒå£°æ˜:
  - ç¦æ­¢å•†ç”¨
  - ç¦æ­¢äºŒåˆ›  
  - åªèƒ½åœ¨ç±»è„‘ã€æ—…ç¨‹äºŒä¼ 
================================================================================
-->



