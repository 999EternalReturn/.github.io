
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>特雷森学院怪谈 - 开局选择</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Times New Roman', 'SimSun', serif;
        background:
          linear-gradient(135deg, #f4f1e8 0%, #e8e0d0 25%, #d4c8b8 50%, #e8e0d0 75%, #f4f1e8 100%),
          url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><defs><pattern id="paper" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><rect width="100" height="100" fill="%23f4f1e8"/><circle cx="20" cy="20" r="1" fill="%23d4c8b8" opacity="0.3"/><circle cx="80" cy="40" r="0.5" fill="%23d4c8b8" opacity="0.2"/><circle cx="60" cy="80" r="0.8" fill="%23d4c8b8" opacity="0.25"/></pattern></defs><rect width="100" height="100" fill="url(%23paper)"/></svg>');
        color: #2c1810;
        min-height: 100vh;
        padding: 20px;
        position: relative;
      }

      /* 初始界面样式 */
      .initial-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f4f1e8 0%, #e8e0d0 50%, #f4f1e8 100%);
        position: relative;
        overflow: hidden;
      }

      .initial-screen::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
          radial-gradient(circle at 20% 20%, rgba(139, 69, 19, 0.05) 0%, transparent 50%),
          radial-gradient(circle at 80% 80%, rgba(184, 134, 11, 0.05) 0%, transparent 50%),
          radial-gradient(circle at 40% 60%, rgba(139, 69, 19, 0.03) 0%, transparent 50%),
          radial-gradient(circle at 70% 30%, rgba(139, 69, 19, 0.03) 0%, transparent 50%);
        pointer-events: none;
        z-index: -1;
      }

      .initial-content {
        text-align: center;
        max-width: 800px;
        padding: 60px 40px;
        background: rgba(244, 241, 232, 0.95);
        border: 3px solid #8b4513;
        border-radius: 0;
        box-shadow:
          0 8px 32px rgba(139, 69, 19, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.8);
        position: relative;
        animation: fadeInUp 1s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .initial-header h1 {
        font-size: 3.5em;
        margin-bottom: 20px;
        color: #8b4513;
        text-shadow: 3px 3px 6px rgba(139, 69, 19, 0.4);
        font-weight: bold;
        letter-spacing: 2px;
        font-family: 'Times New Roman', serif;
      }

      .initial-header .subtitle {
        font-size: 1.4em;
        color: #654321;
        font-style: italic;
        margin-bottom: 40px;
        letter-spacing: 1px;
      }

      .author-info {
        margin: 40px 0;
        padding: 30px;
        background: rgba(139, 69, 19, 0.1);
        border: 2px solid #8b4513;
        border-radius: 0;
        text-align: left;
      }

      .author-info p {
        margin: 8px 0;
        font-size: 1.1em;
        color: #654321;
        line-height: 1.6;
      }

      .author-info p strong {
        color: #8b4513;
        font-weight: bold;
      }

      .start-button-container {
        margin-top: 50px;
      }

      .start-game-btn {
        background: linear-gradient(135deg, #8b4513, #654321);
        border: 3px solid #654321;
        padding: 20px 40px;
        font-size: 1.3em;
        color: #f4f1e8;
        border-radius: 0;
        cursor: pointer;
        transition: all 0.4s ease;
        box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
        font-weight: bold;
        letter-spacing: 1px;
        position: relative;
        overflow: hidden;
        font-family: 'Times New Roman', serif;
      }

      .start-game-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.6s ease;
      }

      .start-game-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(139, 69, 19, 0.6);
        background: linear-gradient(135deg, #654321, #8b4513);
      }

      .start-game-btn:hover::before {
        left: 100%;
      }

      .start-game-btn:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(139, 69, 19, 0.5);
      }

      /* 加载动画 */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(244, 241, 232, 0.3);
        border-radius: 50%;
        border-top-color: #f4f1e8;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(244, 241, 232, 0.3);
        border-radius: 50%;
        border-top-color: #f4f1e8;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }

      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background:
          radial-gradient(circle at 30% 70%, rgba(44, 24, 16, 0.05) 0%, transparent 50%),
          radial-gradient(circle at 70% 30%, rgba(139, 69, 19, 0.03) 0%, transparent 50%);
        pointer-events: none;
        z-index: -1;
      }

      .container {
        max-width: 1000px;
        max-height: 90vh;
        margin: 0 auto;
        background: rgba(244, 241, 232, 0.95);
        border: 2px solid #8b4513;
        border-radius: 0;
        padding: 25px;
        box-shadow:
          0 4px 20px rgba(139, 69, 19, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.8);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(139, 69, 19, 0.4), transparent);
      }

      .header {
        text-align: center;
        margin-bottom: 25px;
      }

      .header h1 {
        font-size: 2.2em;
        margin-bottom: 12px;
        color: #8b4513;
        text-shadow: 2px 2px 4px rgba(139, 69, 19, 0.3);
        font-weight: bold;
        letter-spacing: 1px;
        font-family: 'Times New Roman', serif;
        text-align: center;
      }

      .header p {
        font-size: 1em;
        opacity: 0.8;
        color: #654321;
        font-weight: normal;
        letter-spacing: 0.3px;
        text-align: center;
        font-style: italic;
        margin: 0;
      }

      /* 步骤导航 - 古朴风格 */
      .step-nav {
        display: flex;
        justify-content: space-around;
        margin-bottom: 25px;
        flex-wrap: wrap;
        position: relative;
        padding: 12px 0;
        border-bottom: 2px solid #8b4513;
      }

      .step-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
        padding: 8px;
        border-radius: 8px;
      }

      .step-item:hover {
        background: rgba(139, 69, 19, 0.1);
        transform: translateY(-2px);
      }

      .step-number {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 5px;
        transition: all 0.3s ease;
        font-size: 14px;
      }

      .step-item.active .step-number {
        background: #8b4513;
        color: #f4f1e8;
        box-shadow: 0 2px 8px rgba(139, 69, 19, 0.4);
        border: 2px solid #654321;
        transform: scale(1.1);
      }

      .step-item.completed .step-number {
        background: #654321;
        color: #f4f1e8;
        border: 2px solid #8b4513;
        box-shadow: 0 1px 4px rgba(139, 69, 19, 0.3);
      }

      .step-item:not(.active):not(.completed) .step-number {
        background: #d4c8b8;
        color: #8b4513;
        border: 2px solid #b8860b;
      }

      .step-label {
        font-size: 0.8em;
        opacity: 0.8;
        color: #654321;
        font-weight: normal;
        text-align: center;
      }

      .step-item.active .step-label {
        opacity: 1;
        font-weight: bold;
        color: #8b4513;
      }

      /* 内容区域 */
      .content-area {
        min-height: 350px;
        max-height: 500px;
        overflow-y: auto;
        position: relative;
        padding: 15px;
        border: 2px solid #8b4513;
        border-radius: 8px;
        background: rgba(244, 241, 232, 0.95);
        box-shadow: inset 0 2px 8px rgba(139, 69, 19, 0.1);
        flex: 1;
      }

      /* 自定义滚动条样式 */
      .content-area::-webkit-scrollbar {
        width: 8px;
      }

      .content-area::-webkit-scrollbar-track {
        background: #e8e0d0;
        border-radius: 4px;
      }

      .content-area::-webkit-scrollbar-thumb {
        background: #8b4513;
        border-radius: 4px;
        border: 1px solid #654321;
      }

      .content-area::-webkit-scrollbar-thumb:hover {
        background: #654321;
      }

      /* 步骤标题样式 */
      .scroll-header,
      .bookshelf-header,
      .map-header,
      .clock-header,
      .mystery-header,
      .treasure-header {
        text-align: center;
        margin-bottom: 20px;
        padding: 12px;
        border-bottom: 2px solid #8b4513;
      }

      .scroll-header h2,
      .bookshelf-header h2,
      .map-header h2,
      .clock-header h2,
      .mystery-header h2,
      .treasure-header h2 {
        font-size: 1.6em;
        color: #8b4513;
        margin-bottom: 6px;
        font-family: 'Times New Roman', serif;
        font-weight: bold;
      }

      .scroll-subtitle,
      .bookshelf-subtitle,
      .map-subtitle,
      .clock-subtitle,
      .mystery-subtitle,
      .treasure-subtitle {
        font-size: 0.9em;
        color: #654321;
        font-style: italic;
        opacity: 0.8;
      }

      /* 卷轴容器 */
      .scroll-container {
        background: linear-gradient(90deg, #f4f1e8 0%, #e8e0d0 50%, #f4f1e8 100%);
        border: 2px solid #8b4513;
        border-radius: 0;
        padding: 15px;
        box-shadow: inset 0 2px 4px rgba(139, 69, 19, 0.2);
      }

      /* 书架容器 */
      .bookshelf-container {
        background: linear-gradient(135deg, #8b4513 0%, #654321 100%);
        border: 3px solid #654321;
        border-radius: 0;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(139, 69, 19, 0.4);
      }

      /* 地图容器 */
      .map-container {
        background:
          linear-gradient(45deg, #f4f1e8 25%, transparent 25%), linear-gradient(-45deg, #f4f1e8 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, #f4f1e8 75%), linear-gradient(-45deg, transparent 75%, #f4f1e8 75%);
        background-size: 20px 20px;
        background-position:
          0 0,
          0 10px,
          10px -10px,
          -10px 0px;
        border: 2px solid #8b4513;
        border-radius: 0;
        padding: 15px;
      }

      /* 地图弹窗样式 */
      .map-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
      }

      .map-modal-content {
        background: rgba(244, 241, 232, 0.95);
        margin: 5% auto;
        padding: 20px;
        border: 3px solid #8b4513;
        border-radius: 0;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(139, 69, 19, 0.5);
        position: relative;
      }

      .map-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #8b4513;
      }

      .map-modal-title {
        font-size: 1.5em;
        color: #8b4513;
        font-weight: bold;
        margin: 0;
      }

      .map-modal-close {
        background: #dc2626;
        color: #f4f1e8;
        border: 2px solid #dc2626;
        padding: 8px 16px;
        border-radius: 0;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
      }

      .map-modal-close:hover {
        background: #b91c1c;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
      }

      .map-preview-container {
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid #8b4513;
        border-radius: 8px;
      }

      .map-preview-btn {
        background: linear-gradient(135deg, #8b4513, #654321);
        color: #f4f1e8;
        border: 2px solid #8b4513;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
      }

      .map-preview-btn:hover {
        background: linear-gradient(135deg, #654321, #8b4513);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(139, 69, 19, 0.4);
      }

      .map-image {
        max-width: 100%;
        max-height: 70vh;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(139, 69, 19, 0.2);
        display: block;
        margin: 0 auto;
      }

      /* 时钟容器 */
      .clock-container {
        background: radial-gradient(circle, #f4f1e8 0%, #e8e0d0 70%, #d4c8b8 100%);
        border: 2px solid #8b4513;
        border-radius: 50%;
        padding: 25px;
        box-shadow: 0 4px 16px rgba(139, 69, 19, 0.3);
        max-width: 600px;
        margin: 0 auto;
      }

      /* 神秘容器 */
      .mystery-container {
        background:
          radial-gradient(circle at 30% 30%, rgba(139, 69, 19, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 70% 70%, rgba(184, 134, 11, 0.1) 0%, transparent 50%);
        border: 2px solid #b8860b;
        border-radius: 0;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(184, 134, 11, 0.3);
      }

      /* 宝箱容器 */
      .treasure-container {
        background: linear-gradient(135deg, #f4f1e8 0%, #e8e0d0 25%, #d4c8b8 50%, #e8e0d0 75%, #f4f1e8 100%);
        border: 3px solid #b8860b;
        border-radius: 0;
        padding: 15px;
        box-shadow:
          0 4px 16px rgba(184, 134, 11, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.8);
      }

      .step-content {
        display: none;
        animation: fadeIn 0.5s ease;
      }

      .step-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 选择卡片样式 - 古朴自然布局 */
      .selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
        margin-bottom: 15px;
      }

      .selection-card {
        background: rgba(244, 241, 232, 0.9);
        border: 2px solid #8b4513;
        border-radius: 0;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        box-shadow:
          0 2px 8px rgba(139, 69, 19, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.8);
        min-height: 110px;
      }

      .selection-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(139, 69, 19, 0.4), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .selection-card:hover {
        transform: translateY(-3px);
        box-shadow:
          0 6px 16px rgba(139, 69, 19, 0.3),
          0 0 0 1px rgba(139, 69, 19, 0.5);
        background: rgba(244, 241, 232, 1);
        border-color: #654321;
        z-index: 5;
      }

      .selection-card:hover::before {
        opacity: 1;
      }

      .selection-card.selected {
        background: rgba(255, 255, 255, 0.9) !important;
        border-color: #8b4513;
        border-width: 3px;
        box-shadow:
          0 0 15px rgba(139, 69, 19, 0.5),
          0 4px 12px rgba(139, 69, 19, 0.4),
          0 0 0 2px rgba(139, 69, 19, 0.6);
        transform: scale(1.02);
        z-index: 3;
        position: relative;
      }

      .selection-card.selected::before {
        opacity: 1;
        background: linear-gradient(90deg, transparent, rgba(139, 69, 19, 0.6), transparent);
      }

      .selection-card.selected::after {
        content: '✓';
        position: absolute;
        top: 10px;
        right: 10px;
        background: #8b4513;
        color: #f4f1e8;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        box-shadow: 0 2px 4px rgba(139, 69, 19, 0.3);
        z-index: 4;
      }

      .card-icon {
        font-size: 1.8em;
        margin-bottom: 8px;
        text-align: center;
        filter: drop-shadow(1px 1px 2px rgba(139, 69, 19, 0.3));
        transition: all 0.3s ease;
        display: block;
      }

      .selection-card:hover .card-icon {
        transform: scale(1.1);
        filter: drop-shadow(2px 2px 4px rgba(139, 69, 19, 0.4));
      }

      .selection-card.selected .card-icon {
        transform: scale(1.15);
        filter: drop-shadow(2px 2px 6px rgba(139, 69, 19, 0.5));
      }

      .card-title {
        font-size: 1em;
        font-weight: bold;
        margin-bottom: 6px;
        text-align: center;
        color: #8b4513;
        text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.2);
        letter-spacing: 0.3px;
        line-height: 1.2;
        font-family: 'Times New Roman', serif;
      }

      .card-description {
        font-size: 0.85em;
        opacity: 0.8;
        line-height: 1.3;
        text-align: center;
        color: #654321;
        font-weight: normal;
        letter-spacing: 0.2px;
        margin-bottom: 10px;
      }

      .card-effects {
        margin-top: 10px;
        border-top: 1px solid rgba(139, 69, 19, 0.3);
        padding-top: 8px;
      }

      .positive-effect,
      .negative-effect {
        margin-bottom: 6px;
        text-align: left;
      }

      .effect-label {
        font-size: 0.75em;
        font-weight: bold;
        display: block;
        margin-bottom: 2px;
      }

      .positive-effect .effect-label {
        color: #059669;
      }

      .negative-effect .effect-label {
        color: #dc2626;
      }

      .effect-text {
        font-size: 0.75em;
        line-height: 1.2;
        color: #654321;
        opacity: 0.9;
        display: block;
      }

      /* 抽奖区域 - 古朴风格 */
      .gacha-area {
        text-align: center;
        padding: 25px 20px;
        position: relative;
        background: linear-gradient(135deg, #f4f1e8 0%, #e8e0d0 50%, #f4f1e8 100%);
        border: 3px solid #8b4513;
        border-radius: 0;
        margin: 20px 0;
        box-shadow:
          0 4px 16px rgba(139, 69, 19, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.8);
      }

      .gacha-area::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(139, 69, 19, 0.05) 50%, transparent 70%);
        pointer-events: none;
      }

      .gacha-button {
        background: #8b4513;
        border: 2px solid #654321;
        padding: 6px 16px;
        font-size: 0.85em;
        color: #f4f1e8;
        border-radius: 0;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
        font-weight: bold;
        letter-spacing: 0.3px;
        position: relative;
        overflow: hidden;
        font-family: 'Times New Roman', serif;
      }

      .gacha-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
      }

      .gacha-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(139, 69, 19, 0.4);
        background: #654321;
      }

      .gacha-button:hover::before {
        left: 100%;
      }

      .gacha-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .gacha-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
      }

      .skip-button {
        background: #6b7280;
        border: 2px solid #4b5563;
        padding: 6px 16px;
        font-size: 0.85em;
        color: #f4f1e8;
        border-radius: 0;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        font-weight: bold;
        letter-spacing: 0.3px;
        position: relative;
        overflow: hidden;
        font-family: 'Times New Roman', serif;
      }

      .skip-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
      }

      .skip-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(107, 114, 128, 0.4);
        background: #4b5563;
      }

      .skip-button:hover::before {
        left: 100%;
      }

      .skip-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* 时间滑动条样式 */
      .time-slider-container {
        padding: 20px 15px;
        background: linear-gradient(135deg, #f4f1e8 0%, #e8e0d0 50%, #f4f1e8 100%);
        border: 3px solid #8b4513;
        border-radius: 0;
        margin: 15px 0;
        box-shadow:
          0 4px 16px rgba(139, 69, 19, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.8);
        position: relative;
      }

      .time-slider-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(139, 69, 19, 0.05) 50%, transparent 70%);
        pointer-events: none;
      }

      .time-slider {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: linear-gradient(to right, #e8e0d0, #d4c4a8);
        outline: none;
        -webkit-appearance: none;
        appearance: none;
        border: 2px solid #8b4513;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 2;
      }

      .time-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b4513, #654321);
        cursor: pointer;
        border: 3px solid #f4f1e8;
        box-shadow:
          0 2px 8px rgba(139, 69, 19, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }

      .time-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow:
          0 4px 12px rgba(139, 69, 19, 0.6),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }

      .time-slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b4513, #654321);
        cursor: pointer;
        border: 3px solid #f4f1e8;
        box-shadow:
          0 2px 8px rgba(139, 69, 19, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }

      .time-slider::-moz-range-thumb:hover {
        transform: scale(1.1);
        box-shadow:
          0 4px 12px rgba(139, 69, 19, 0.6),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }

      .time-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 12px;
        padding: 0 8px;
        position: relative;
        z-index: 2;
      }

      .time-label {
        text-align: center;
        font-size: 0.8em;
        color: #8b4513;
        font-weight: bold;
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .time-label:hover {
        color: #654321;
        transform: translateY(-2px);
      }

      .time-label.active {
        color: #654321;
        font-size: 0.9em;
        text-shadow: 0 2px 4px rgba(139, 69, 19, 0.3);
      }

      .time-display {
        text-align: center;
        margin: 15px 0;
        padding: 12px;
        background: rgba(244, 241, 232, 0.9);
        border: 2px solid #8b4513;
        border-radius: 0;
        box-shadow: 0 2px 8px rgba(139, 69, 19, 0.2);
        position: relative;
        z-index: 2;
      }

      .time-display h3 {
        margin: 0 0 8px 0;
        color: #8b4513;
        font-size: 1.2em;
        font-weight: bold;
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
      }

      .time-display p {
        margin: 4px 0;
        color: #654321;
        font-size: 0.9em;
        line-height: 1.3;
      }

      .gacha-result {
        margin-top: 20px;
        padding: 20px;
        background: rgba(244, 241, 232, 0.95);
        border: 2px solid #8b4513;
        border-radius: 0;
        display: none;
        box-shadow:
          0 4px 16px rgba(139, 69, 19, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.8);
        position: relative;
        transform: scale(0.95);
        animation: resultAppear 0.5s ease forwards;
      }

      @keyframes resultAppear {
        to {
          transform: scale(1);
        }
      }

      /* 抽奖选项悬停效果 */
      .gacha-option:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
        border-color: #654321;
        background: rgba(244, 241, 232, 1);
      }

      /* 按钮区域 */
      .button-area {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        padding: 12px 0;
        border-top: 2px solid #8b4513;
      }

      .btn {
        padding: 6px 16px;
        border: 2px solid #8b4513;
        border-radius: 0;
        font-size: 0.85em;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
        letter-spacing: 0.2px;
        position: relative;
        overflow: hidden;
        font-family: 'Times New Roman', serif;
      }

      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.4s ease;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn-prev {
        background: #f4f1e8;
        color: #8b4513;
        border: 2px solid #8b4513;
      }

      .btn-prev:hover {
        background: #e8e0d0;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(139, 69, 19, 0.3);
      }

      .btn-next {
        background: #8b4513;
        color: #f4f1e8;
        border: 2px solid #8b4513;
      }

      .btn-next:hover {
        background: #654321;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(139, 69, 19, 0.4);
      }

      .btn-start {
        background: #b8860b;
        color: #f4f1e8;
        font-size: 1em;
        padding: 10px 25px;
        border: 2px solid #b8860b;
        box-shadow: 0 2px 8px rgba(184, 134, 11, 0.3);
      }

      .btn-start:hover {
        background: #daa520;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(184, 134, 11, 0.4);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* 进度条 */
      .progress-bar {
        width: 100%;
        height: 4px;
        background: #e8e0d0;
        border-radius: 0;
        margin-bottom: 25px;
        overflow: hidden;
        border: 1px solid #8b4513;
        position: relative;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #8b4513 0%, #654321 50%, #8b4513 100%);
        border-radius: 0;
        transition: width 0.5s ease;
        width: 0%;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3);
        position: relative;
        overflow: hidden;
      }

      .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        .header h1 {
          font-size: 1.8em;
        }

        .step-nav {
          flex-direction: column;
          align-items: center;
          gap: 10px;
        }

        .step-item {
          margin: 5px 0;
        }

        .selection-grid {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .selection-card {
          margin-bottom: 10px;
        }

        .button-area {
          flex-direction: column;
          gap: 10px;
        }

        .btn {
          width: 100%;
        }

        .clock-container {
          border-radius: 0;
          max-width: 100%;
        }
      }

      /* 加载动画 */
      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(139, 69, 19, 0.2);
        border-radius: 50%;
        border-top-color: #8b4513;
        animation: spin 1s ease infinite;
        box-shadow: 0 0 4px rgba(139, 69, 19, 0.2);
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* 添加一些微妙的动画效果 */
      .step-content {
        animation: fadeInUp 0.5s ease;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 标题动画 */
      .header h1 {
        animation: titleGlow 4s ease-in-out infinite alternate;
      }

      @keyframes titleGlow {
        from {
          filter: drop-shadow(1px 1px 2px rgba(139, 69, 19, 0.3));
        }
        to {
          filter: drop-shadow(2px 2px 4px rgba(139, 69, 19, 0.5));
        }
      }
    </style>
  </head>
  <body>
    <!-- 初始界面 -->
    <div class="initial-screen" id="initialScreen">
      <div class="initial-content">
        <div class="initial-header">
          <h1>🎭 特雷森学院怪谈</h1>
          <p class="subtitle">扭曲的爱意，永恒的轮回</p>
        </div>

        <div class="author-info">
          <p><strong>我是Eternal zz</strong></p>
          <p>本卡是围绕特雷森学院构建的世界观</p>
          <p>⚠️ 禁止商用，禁止二创，可二传仅限类脑、旅程</p>
          <p>本卡免费游玩</p>
          <p>discord id: eternalzz0840</p>
        </div>

        <div class="start-button-container">
          <button class="start-game-btn" id="showGameBtn">🚀 开始游戏</button>
        </div>
      </div>
    </div>

    <!-- 游戏界面 -->
    <div class="container" id="gameContainer" style="display: none">
      <div class="header">
        <h1>🎭 特雷森学院怪谈</h1>
        <p>选择你的开局配置，开始你的训练员生涯</p>
      </div>

      <!-- 进度条 -->
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <!-- 步骤导航 -->
      <div class="step-nav">
        <div class="step-item active" data-step="1">
          <div class="step-number">1</div>
          <div class="step-label">天赋选择</div>
        </div>
        <div class="step-item" data-step="2">
          <div class="step-number">2</div>
          <div class="step-label">背景选择</div>
        </div>
        <div class="step-item" data-step="3">
          <div class="step-number">3</div>
          <div class="step-label">地点选择</div>
        </div>
        <div class="step-item" data-step="4">
          <div class="step-number">4</div>
          <div class="step-label">时间选择</div>
        </div>
        <div class="step-item" data-step="5">
          <div class="step-number">5</div>
          <div class="step-label">马娘抽奖</div>
        </div>
        <div class="step-item" data-step="6">
          <div class="step-number">6</div>
          <div class="step-label">道具选择</div>
        </div>
      </div>

      <!-- 内容区域 -->
      <div class="content-area">
        <!-- 步骤1: 天赋选择 - 卷轴风格 -->
        <div class="step-content active" id="step1">
          <div class="scroll-header">
            <h2>📜 天赋卷轴</h2>
            <p class="scroll-subtitle">选择你的核心能力，这将决定你在特雷森学院的训练方向</p>
          </div>
          <div class="scroll-container">
            <div class="selection-grid" id="talentGrid">
              <!-- 天赋卡片将通过JavaScript动态生成 -->
            </div>
          </div>
        </div>

        <!-- 步骤2: 背景选择 - 书架风格 -->
        <div class="step-content" id="step2">
          <div class="bookshelf-header">
            <h2>📚 背景书架</h2>
            <p class="bookshelf-subtitle">翻开你的过往，选择你的起点</p>
          </div>
          <div class="bookshelf-container">
            <div class="selection-grid" id="backgroundGrid">
              <!-- 背景卡片将通过JavaScript动态生成 -->
            </div>
          </div>
        </div>

        <!-- 步骤3: 地点选择 - 地图风格 -->
        <div class="step-content" id="step3">
          <div class="map-header">
            <h2>🗺️ 学院地图</h2>
            <p class="map-subtitle">选择你的起始位置，每个地点都有不同的机遇与挑战</p>
          </div>
          <div class="map-container">
            <div class="map-preview-container">
              <button
                type="button"
                class="map-preview-btn"
                onclick="document.getElementById('mapModal').style.display = 'block';"
              >
                🗺️ 点击预览地图
              </button>
            </div>
            <div class="selection-grid" id="locationGrid">
              <!-- 地点卡片将通过JavaScript动态生成 -->
            </div>
          </div>
        </div>

        <!-- 步骤4: 时间选择 - 时钟风格 -->
        <div class="step-content" id="step4">
          <div class="clock-header">
            <h2>🕰️ 时光沙漏</h2>
            <p class="clock-subtitle">选择你的开局时刻，时间将影响一切</p>
          </div>
          <div class="clock-container">
            <div class="selection-grid" id="timeGrid">
              <!-- 时间卡片将通过JavaScript动态生成 -->
            </div>
          </div>
        </div>

        <!-- 步骤5: 马娘抽奖 - 神秘盒子风格 -->
        <div class="step-content" id="step5">
          <div class="mystery-header">
            <h2>🎁 神秘宝盒</h2>
            <p class="mystery-subtitle">打开宝盒，邂逅你的第一位马娘伙伴，或选择跳过</p>
          </div>
          <div class="mystery-container">
            <div class="gacha-area">
              <div class="gacha-buttons">
                <button class="gacha-button" id="gachaButton">🎰 开启宝盒</button>
                <button class="skip-button" id="skipButton">⏭️ 跳过抽奖</button>
              </div>
              <div class="gacha-result" id="gachaResult">
                <!-- 抽奖结果将在这里显示 -->
              </div>
            </div>
          </div>
        </div>

        <!-- 步骤6: 道具选择 - 宝箱风格 -->
        <div class="step-content" id="step6">
          <div class="treasure-header">
            <h2>💎 宝物宝箱</h2>
            <p class="treasure-subtitle">选择三件宝物，它们将成为你的初始装备</p>
          </div>
          <div class="treasure-container">
            <div class="selection-grid" id="itemGrid">
              <!-- 道具卡片将通过JavaScript动态生成 -->
            </div>
          </div>
        </div>
      </div>

      <!-- 按钮区域 -->
      <div class="button-area">
        <button class="btn btn-prev" id="prevBtn" style="display: none">← 上一步</button>
        <button class="btn btn-next" id="nextBtn">下一步 →</button>
        <button class="btn btn-start" id="startBtn" style="display: none">🚀 开始游戏</button>
      </div>
    </div>

    <!-- 地图弹窗 -->
    <div id="mapModal" class="map-modal">
      <div class="map-modal-content">
        <div class="map-modal-header">
          <h3 class="map-modal-title">🗺️ 特雷森学院地图</h3>
          <button class="map-modal-close" onclick="document.getElementById('mapModal').style.display = 'none';">
            ❌ 关闭
          </button>
        </div>
        <img src="https://files.catbox.moe/egokpv.png" alt="特雷森学院地图" class="map-image" />
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />

    <script>
      // 地图弹窗点击外部关闭
      window.onclick = function (event) {
        const modal = document.getElementById('mapModal');
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      };
    </script>

    <script>
      // 特雷森学院怪谈 - 开局选择系统
      class OpeningSelector {
        constructor() {
          this.currentStep = 1;
          this.totalSteps = 6;
          this.selections = {
            talent: null,
            background: null,
            location: null,
            time: null,
            umaMusume: null,
            items: [],
          };

          this.init();
        }

        init() {
          this.setupEventListeners();
          this.loadData();

          // 确保初始界面显示，游戏界面隐藏
          $('#initialScreen').show();
          $('#gameContainer').hide();

          // 只有在游戏界面显示时才初始化步骤
          if ($('#gameContainer').is(':visible')) {
            this.renderCurrentStep();
            this.updateProgress();
            this.updateButtons();
          }
        }

        // 设置事件监听器
        setupEventListeners() {
          // 初始界面按钮
          $('#showGameBtn').on('click', () => this.showGameInterface());

          // 步骤导航点击
          $('.step-item').on('click', e => {
            const step = parseInt($(e.currentTarget).data('step'));
            if (this.canNavigateToStep(step)) {
              this.goToStep(step);
            }
          });

          // 按钮事件
          $('#prevBtn').on('click', () => this.prevStep());
          $('#nextBtn').on('click', () => this.nextStep());
          $('#startBtn').on('click', () => this.startGame());

          // 抽奖按钮
          $('#gachaButton').on('click', () => this.performGacha());

          // 跳过按钮
          $('#skipButton').on('click', () => this.skipGacha());

          // 卡片选择事件
          $(document).on('click', '.selection-card', e => {
            this.handleCardSelection(e);
          });
        }

        // 显示游戏界面
        showGameInterface() {
          const btn = $('#showGameBtn');
          btn.prop('disabled', true).html('<span class="loading-spinner"></span> 加载中...');

          // 模拟加载时间
          setTimeout(() => {
            $('#initialScreen').fadeOut(800, () => {
              $('#gameContainer').fadeIn(800, () => {
                // 游戏界面显示后初始化步骤
                this.renderCurrentStep();
                this.updateProgress();
                this.updateButtons();
                btn.prop('disabled', false).text('🚀 开始游戏');
              });
            });
          }, 1500);
        }

        // 加载数据
        loadData() {
          this.talents = this.getTalentData();
          this.backgrounds = this.getBackgroundData();
          this.locations = this.getLocationData();
          this.times = this.getTimeData();
          this.umaMusumes = this.getUmaMusumeData();
          this.items = this.getItemData();
        }

        // 天赋数据 - 扭曲之爱系统
        getTalentData() {
          return [
            {
              id: 'possession_love',
              icon: '🔒',
              name: '强化系（占有之爱）',
              description: '通过独占和控制来强化自身。力量源于对某物的强烈占有欲。',
              positive: '能够看穿规则漏洞，找到隐藏弱点；短时间内大幅提升防御力；具现化无形锁链锁定目标。',
              negative:
                '能力越强，对"爱人"的依赖和束缚越深，最终失去自我；视野变得狭窄；每次使用留下"伤痕"；锁链会反噬自身。',
              category: 'possession',
            },
            {
              id: 'deception_love',
              icon: '🎭',
              name: '变化系（谎言之爱）',
              description: '将谎言和欺骗转化为现实。力量是不稳定的，随着欺骗而改变。',
              positive: '暂时修改规则描述使其有利；将谎言具象化为麻痹敌人的情感；创造虚假"影子"承受伤害。',
              negative:
                '所说的一切谎言都会扭曲具现化成为新的危险；规则变得不稳定可能反噬；谎言被识破时情感变为致命毒药；影子承受的伤害会叠加爆发。',
              category: 'deception',
            },
            {
              id: 'sacrifice_love',
              icon: '💔',
              name: '放出系（牺牲之爱）',
              description: '通过自我牺牲来影响他人或环境。力量是无私的，却以自己的"失去"为代价。',
              positive: '释放情绪使敌人失去攻击性；消耗生命或记忆修改规则；具现化分身执行任务。',
              negative:
                '每一次牺牲都会永久削弱自身；精神力上限永久降低；修改的规则会以更强形态回归；分身被摧毁时一同死亡。',
              category: 'sacrifice',
            },
            {
              id: 'control_love',
              icon: '🎪',
              name: '操作系（控制之爱）',
              description: '通过精神控制和情感操纵来奴役他人。力量源于对他人的绝对控制。',
              positive: '给NPC施加心理暗示使其服从；操控被击败的敌人为你战斗；吸收NPC"爱意"获得特殊能力。',
              negative:
                '控制的越多自身情感越麻木；NPC意识到被操纵时引发强烈反噬；必须专注操控无法使用其他能力；吸收的"爱意"留下扭曲印记成为弱点。',
              category: 'control',
            },
            {
              id: 'ideal_love',
              icon: '💎',
              name: '具现化系（理想之爱）',
              description: '将想象中的完美之爱具现化为实物。力量来源于对完美的幻想。',
              positive: '具现化轻型盔甲吸收伤害；具现化戒指获得强大力量；具现化完美NPC无条件帮助。',
              negative:
                '具现化物品只对"爱意"反应并逐渐取代现实；盔甲逐渐变重限制行动；违背承诺戒指化为枷锁；完美NPC消耗大量"爱"且无法理解真实情感。',
              category: 'ideal',
            },
            {
              id: 'twisted_love',
              icon: '🌀',
              name: '特质系（扭曲之爱）',
              description: '拥有独一无二的、超越常规的扭曲能力。力量是不可预知的，通常是以上五种爱意的混合或变异。',
              positive: '与强大规则怪谈签订契约获得瞬间巨大力量；与NPC情绪共鸣复制其能力。',
              negative: '能力伴随最不可控的风险和最深的异化；必须以某部分为代价；共鸣结束时承受所有痛苦。',
              category: 'twisted',
            },
          ];
        }

        // 背景数据 - 缺陷身份系统
        getBackgroundData() {
          return [
            {
              id: 'no_background',
              icon: '⚪',
              name: '无背景',
              description: '没有任何特殊背景，从零开始',
              positive: '无正面效果',
              negative: '无负面效果',
            },
            {
              id: 'failed_trainer',
              icon: '🏆',
              name: '落魄的前训练员',
              description: '曾经是其他学院的训练员，但带着不光彩的过去',
              positive: '拥有基础的训练经验，初始马娘的"适应性"略微提升',
              negative:
                '因为某些不光彩的原因离开上一个学院，导致初期在特雷森学院的人际关系很差，难以获得其他训练员的帮助',
            },
            {
              id: 'anxious_psychologist',
              icon: '🧠',
              name: '焦躁的心理学研究者',
              description: '精通心理学，但自身精神状态不稳定',
              positive: '精通心理学，能更早发现马娘的心理问题，避免理智值大幅下降',
              negative: '自身理智值上限较低，且容易受到负面事件的影响，比其他身份更容易陷入"san值归零"状态',
            },
            {
              id: 'retired_therapist',
              icon: '🏥',
              name: '退役的物理治疗师',
              description: '擅长处理身体损伤，但社交能力很差',
              positive: '擅长处理身体损伤，马娘训练受伤的几率降低，且受伤后的恢复速度更快',
              negative: '专注于身体，导致社交能力很差，马娘的"心情值"初始较低，需要更多努力才能提升',
            },
            {
              id: 'failed_consultant',
              icon: '💼',
              name: '失败的商业顾问',
              description: '有丰富的管理经验，但缺乏体育专业知识',
              positive: '擅长资源管理，初始拥有一些基础的资金或道具',
              negative: '缺乏体育领域的专业知识，初期训练效果较低，需要投入更多时间和精力去学习',
            },
            {
              id: 'archive_manager',
              icon: '🎓',
              name: '学院档案管理员',
              description: '你是学院的档案管理员，沉迷于翻阅旧文件，发现了许多被掩盖的马娘训练事故和怪谈记录',
              positive: '你能获得一些隐藏线索，但对学院的正常运作知之甚少',
              negative: '难以获得他人的信任，社交能力较差',
            },
            {
              id: 'loser_follower',
              icon: '🏆',
              name: '败者追随者',
              description:
                '你曾是一名马娘的忠实粉丝，但她始终无法获得胜利。你相信她失败的真正原因并非能力，而是某种"诅咒"',
              positive: '你对失败有独特的理解，能够更早发现马娘的负面状态',
              negative: '你内心对失败的恐惧也让你更容易陷入理智危机',
            },
            {
              id: 'anonymous_writer',
              icon: '🧠',
              name: '匿名信件代笔人',
              description: '你曾为许多马娘和训练员代写情书或告白信，自认为是最懂"爱意"的人',
              positive: '你能更好地理解马娘的心情',
              negative: '你自身的社交能力极差，常常无法表达真实的想法',
            },
            {
              id: 'cafeteria_chef',
              icon: '🥗',
              name: '学院食堂厨师',
              description: '你是学院食堂的一名厨师，日复一日地观察着马娘们的饮食习惯和情绪变化',
              positive: '你能通过制作特殊料理来小幅影响马娘的心情',
              negative: '你缺乏专业的训练知识',
            },
            {
              id: 'unlicensed_therapist',
              icon: '🏥',
              name: '无执照的物理治疗师',
              description: '你曾经是一名物理治疗师的学徒，但未能通过考核。你对治愈马娘的执念让你来到这里',
              positive: '你能更早发现马娘的身体损伤',
              negative: '但如果被发现没有执照，你的声望将大幅下降',
            },
            {
              id: 'retired_educator',
              icon: '👨‍🏫',
              name: '退休的马娘教育家',
              description: '你曾经是一名马娘的教育家，但因某种理念冲突而退休。你认为现在学院的教育方式太过功利',
              positive: '你能让马娘理智值下降的速度变慢',
              negative: '你的固执也让你难以接受新的训练方法',
            },
            {
              id: 'bankrupt_owner',
              icon: '💼',
              name: '破产的训练员事务所老板',
              description: '你曾经经营一家训练员事务所，但因经营不善而破产。你认为自己的失败源于某些"不可抗力"',
              positive: '你拥有一些基础的资源管理能力',
              negative: '你的理智值上限较低，无法承受太大的压力',
            },
            {
              id: 'maintenance_worker',
              icon: '🛠️',
              name: '学院维修工',
              description:
                '你是学院的维修工，总是在夜晚工作，修复各种破损的设施。你相信，学院的"怪谈"都源于某些地方的能量泄露',
              positive: '你能修复一些损坏的道具',
              negative: '你无法直接与马娘交流，也很难获得她们的信任',
            },
            {
              id: 'diary_seeker',
              icon: '📜',
              name: '遗失日记的寻找者',
              description:
                '你在网上发现了一本遗失的训练员日记，日记中充满了对某个马娘的扭曲情感。你被日记的内容深深吸引',
              positive: '你能更快地发现与日记相关的线索',
              negative: '你的理智值会随着线索的增多而下降',
            },
            {
              id: 'portrait_artist',
              icon: '🖼️',
              name: '马娘肖像画师',
              description: '你是一名专门为马娘画肖像的画师。在绘画过程中，你无意中捕捉到了她们内心最深处的执念',
              positive: '你能通过观察更早地发现马娘的心理问题',
              negative: '你的行动速度会变得较慢',
            },
            {
              id: 'retired_actor',
              icon: '🎭',
              name: '剧团退役演员',
              description:
                '你曾是小剧团的一名演员，善于扮演各种角色。你来到特雷森学院，试图通过扮演"完美训练员"来掩盖内心的空虚',
              positive: '你能更好地伪装自己，在特定场合骗过他人',
              negative: '你自身的真实情感会变得模糊不清',
            },
            {
              id: 'paranormal_researcher',
              icon: '💻',
              name: '网络灵异研究员',
              description:
                '你是在网络上小有名气的灵异研究者，专门调查关于马娘的都市传说和怪谈。你认为特雷森学院是所有怪谈的源头',
              positive: '你拥有一些关于超自然现象的基础知识',
              negative: '你在学院内毫无声望，没有人会相信你',
            },
            {
              id: 'music_therapist',
              icon: '🎤',
              name: '音乐治疗师',
              description:
                '你是一名音乐治疗师，相信音乐能抚平马娘内心的创伤。你来到学院，想用自己的音乐帮助那些被"怪谈"困扰的马娘',
              positive: '你能用音乐来小幅恢复马娘的理智值',
              negative: '你的体能很差，无法进行高强度的训练',
            },
            {
              id: 'night_observer',
              icon: '🌃',
              name: '夜晚的旁观者',
              description:
                '你因为某些原因只能在夜间行动。你亲眼目睹了学院在夜晚发生的各种怪异事件，成为了一个无声的旁观者',
              positive: '你对夜晚事件有更高的存活率',
              negative: '你在白天无法进行任何训练，也无法与其他NPC正常互动',
            },
            {
              id: 'rope_artist',
              icon: '🪢',
              name: '结绳艺术家',
              description:
                '你是一名擅长结绳的艺术家，认为绳结能连接情感和命运。你来到学院，试图用绳结来"捆绑"马娘的执念',
              positive: '你能用绳结来暂时封印一些负面效果',
              negative: '每次使用都会消耗珍贵的材料',
            },
            {
              id: 'stalker',
              icon: '📸',
              name: '偷拍者',
              description:
                '你是一名狂热的摄影爱好者，沉迷于拍摄马娘训练时的瞬间。在偷拍过程中，你无意中捕捉到了某些怪谈的影像',
              positive: '你能通过拍摄来发现隐藏的线索',
              negative: '但如果被发现，你的声望将大幅下降',
            },
            {
              id: 'puzzle_lover',
              icon: '🧩',
              name: '谜题爱好者',
              description:
                '你是一个对谜题和解密有着病态执念的人。你认为特雷森学院的怪谈就像一个巨大的谜题，每一个线索都让你兴奋',
              positive: '你在解谜和破译方面有天赋',
              negative: '你对直觉性的判断很差，常常陷入困境',
            },
            {
              id: 'near_death_experiencer',
              icon: '👻',
              name: '濒死体验者',
              description:
                '你曾有过一次濒死体验，在那一刻你仿佛看到了一个扭曲的世界。你来到特雷森，试图寻找那个世界的入口',
              positive: '你能听到常人听不到的声音，这有时会提供有用的信息',
              negative: '大多数时候只会消耗你的理智值',
            },
            {
              id: 'warehouse_keeper',
              icon: '📦',
              name: '仓库保管员',
              description:
                '你是学院仓库的保管员，负责整理和发放训练道具。你在仓库里发现了许多被废弃的、带有不祥气息的物品',
              positive: '你能更早发现负面道具，并且可以免疫它们的某些负面效果',
              negative: '你无法使用那些强大的正面道具',
            },
            {
              id: 'none',
              icon: '⚪',
              name: '无',
              description: '没有任何特殊背景，你只是一个普通的训练员',
              positive: '无',
              negative: '无',
            },
          ];
        }

        // 地点数据
        getLocationData() {
          return [
            {
              id: 'central_plaza',
              icon: '🏛️',
              name: '中央广场',
              description: '三女神雕像喷泉所在地，马娘们聚集的地方',
            },
            {
              id: 'outdoor_track',
              icon: '🏃‍♀️',
              name: '室外训练场',
              description: '广阔的2000米跑道，马娘们日常训练的地方',
            },
            { id: 'indoor_gym', icon: '🏋️', name: '室内训练场', description: '跑步机、特制哑铃等训练器材齐全' },
            { id: 'cafeteria', icon: '🍽️', name: '食堂', description: '空间宽阔、菜品多样的免费食堂' },
            { id: 'activity_building', icon: '🎨', name: '活动楼', description: '美术室、音乐室、舞蹈室等' },
            { id: 'dance_studio', icon: '💃', name: '舞蹈室', description: '胜者舞台舞蹈训练室，满墙落地镜' },
            { id: 'swimming_pool', icon: '🏊', name: '游泳馆', description: '开阔泳池，通常用于游泳训练' },
            { id: 'classroom_building', icon: '📚', name: '教学楼', description: '马娘们学习文化课的地方' },
            {
              id: 'administrative_building',
              icon: '🏢',
              name: '行政楼',
              description: '理事长办公室、教师办公室和训练员室',
            },
            { id: 'trainer_office', icon: '👨‍💼', name: '训练员室', description: '训练员制定训练计划的单间办公室' },
            {
              id: 'student_dormitory',
              icon: '🏠',
              name: '学生宿舍',
              description: '美浦寮和栗东寮，双人间，有门禁时间',
            },
            { id: 'small_forest', icon: '🌳', name: '小树林', description: '学院内的小树林，环境幽静' },
          ];
        }

        // 时间数据
        getTimeData() {
          return [
            {
              id: 'morning',
              icon: '🌅',
              name: '清晨',
              time: '6:00-8:00',
              description: '相对安全，马娘刚起床',
              danger: '低',
            },
            { id: 'forenoon', icon: '☀️', name: '上午', time: '8:00-12:00', description: '正常训练时间', danger: '低' },
            {
              id: 'afternoon',
              icon: '🌞',
              name: '午后',
              time: '12:00-17:00',
              description: '马娘活跃时间',
              danger: '中',
            },
            {
              id: 'evening',
              icon: '🌆',
              name: '傍晚',
              time: '17:00-20:00',
              description: '危险时段，欲望高峰',
              danger: '高',
            },
            {
              id: 'night',
              icon: '🌙',
              name: '深夜',
              time: '20:00-6:00',
              description: '极度危险，狩猎本能',
              danger: '极高',
            },
          ];
        }

        // 马娘数据
        getUmaMusumeData() {
          return [
            '爱丽数码',
            '爱丽速子',
            '爱慕织姬',
            '爱如往昔',
            '八重无敌',
            '北部玄驹',
            '北港火山',
            '草上飞',
            '超级小海湾',
            '成田白仁',
            '成田路',
            '创升',
            '创世驹',
            '春田乌拉拉',
            '大和赤骥',
            '大鸣大放',
            '大树快车',
            '大拓太阳神',
            '待兼福来',
            '帝王光环',
            '第一红宝石',
            '东海帝王',
            '东商变革',
            '多旺达',
            '伏特加',
            '高尚骏逸',
            '葛城王牌',
            '贵妇人',
            '好歌剧',
            '荒漠英雄',
            '黄金城市',
            '黄金船',
            '黄金巨匠',
            '极峰',
            '金镇之光',
            '骏川手纲',
            '凯旋芭蕾',
            '里见光钻',
            '里见皇冠',
            '菱钻奇宝',
            '鲁道夫象征',
            '曼城茶座',
            '美妙姿势',
            '美浦波旁',
            '梦之旅',
            '迷人景致',
            '米浴',
            '名将怒涛',
            '摩耶重炮',
            '谋勇兼备',
            '目白阿尔丹',
            '目白多伯',
            '目白高峰',
            '目白光明',
            '目白麦昆',
            '目白善信',
            '奇锐骏',
            '气槽',
            '千明代表',
            '强击',
            '青云天空',
            '秋川弥生',
            '荣进闪耀',
            '森林宝穴',
            '神鹰',
            '双涡轮',
            '特别周',
            '天狼星象征',
            '丸善斯基',
            '无声铃鹿',
            '西野花',
            '小栗帽',
            '小林厉奇',
            '新宇宙',
            '杏目',
            '樱花千代王',
            '玉藻十字',
            '真弓快车',
            '真机伶',
            '中山庆典',
            '周日宁静',
            '卓芙',
            '达利阿拉伯',
            '高多芬阿拉伯',
            '黄金旅程',
            '艾尼斯风神',
            '富士奇石',
            '菱亚马逊',
          ];
        }

        // 获取马娘头像
        getUmaAvatar(name) {
          const avatars = {
            爱丽数码: 'https://files.catbox.moe/d70ku1.png',
            爱丽速子: 'https://files.catbox.moe/3r2gqv.png',
            爱慕织姬: 'https://files.catbox.moe/wc144f.png',
            爱如往昔: 'https://files.catbox.moe/j7set1.png',
            八重无敌: 'https://files.catbox.moe/fuvyvk.png',
            北部玄驹: 'https://files.catbox.moe/d7990k.png',
            北港火山: 'https://files.catbox.moe/21rq96.png',
            草上飞: 'https://files.catbox.moe/jevm3a.png',
            超级小海湾: 'https://files.catbox.moe/x3ee0m.png',
            成田白仁: 'https://files.catbox.moe/75oai9.png',
            成田路: 'https://files.catbox.moe/90ws3a.png',
            创升: 'https://files.catbox.moe/19o3se.png',
            创世驹: 'https://files.catbox.moe/1xs8sb.png',
            春田乌拉拉: 'https://files.catbox.moe/nvz9k4.png',
            大和赤骥: 'https://files.catbox.moe/8ffgfq.png',
            大鸣大放: 'https://files.catbox.moe/unxq4t.png',
            大树快车: 'https://files.catbox.moe/5jg2l4.png',
            大拓太阳神: 'https://files.catbox.moe/c7z8tt.png',
            待兼福来: 'https://files.catbox.moe/v4dt95.png',
            帝王光环: 'https://files.catbox.moe/b04n2e.png',
            第一红宝石: 'https://files.catbox.moe/j5as90.png',
            东海帝王: 'https://files.catbox.moe/r0i1vk.png',
            东商变革: 'https://files.catbox.moe/02229w.png',
            多旺达: 'https://files.catbox.moe/8smudh.png',
            伏特加: 'https://files.catbox.moe/mef00p.png',
            高尚骏逸: 'https://files.catbox.moe/jp4src.png',
            葛城王牌: 'https://files.catbox.moe/twqi3m.png',
            贵妇人: 'https://files.catbox.moe/9myg2p.png',
            好歌剧: 'https://files.catbox.moe/ymxboj.png',
            荒漠英雄: 'https://files.catbox.moe/y61wwa.png',
            黄金城市: 'https://files.catbox.moe/832mml.png',
            黄金船: 'https://files.catbox.moe/puxu1y.png',
            黄金巨匠: 'https://files.catbox.moe/lg6d5i.png',
            极峰: 'https://files.catbox.moe/j282j7.png',
            金镇之光: 'https://files.catbox.moe/4lx5nv.png',
            骏川手纲: 'https://files.catbox.moe/7apiow.png',
            凯旋芭蕾: 'https://files.catbox.moe/rdldum.png',
            里见光钻: 'https://files.catbox.moe/meq8kw.png',
            里见皇冠: 'https://files.catbox.moe/mvmeuq.png',
            菱钻奇宝: 'https://files.catbox.moe/xm3tws.png',
            鲁道夫象征: 'https://files.catbox.moe/zogjie.png',
            曼城茶座: 'https://files.catbox.moe/8s8ow2.png',
            美妙姿势: 'https://files.catbox.moe/j4gt6b.png',
            美浦波旁: 'https://files.catbox.moe/1dtwml.png',
            梦之旅: 'https://files.catbox.moe/1k3mhi.png',
            迷人景致: 'https://files.catbox.moe/8x3cjc.png',
            米浴: 'https://files.catbox.moe/c3gtgi.png',
            名将怒涛: 'https://files.catbox.moe/xwghd4.png',
            摩耶重炮: 'https://files.catbox.moe/czbbvd.png',
            谋勇兼备: 'https://files.catbox.moe/eq4zkw.png',
            目白阿尔丹: 'https://files.catbox.moe/ob99q8.png',
            目白多伯: 'https://files.catbox.moe/gbvkte.png',
            目白高峰: 'https://files.catbox.moe/iysgye.png',
            目白光明: 'https://files.catbox.moe/8d1iwy.png',
            目白麦昆: 'https://files.catbox.moe/tpep4q.png',
            目白善信: 'https://files.catbox.moe/p7t876.png',
            奇锐骏: 'https://files.catbox.moe/6asj2q.png',
            气槽: 'https://files.catbox.moe/bk7n8x.png',
            千明代表: 'https://files.catbox.moe/0q627d.png',
            强击: 'https://files.catbox.moe/vzxfrt.png',
            青云天空: 'https://files.catbox.moe/5xrxk5.png',
            秋川弥生: 'https://files.catbox.moe/2mr9zz.png',
            荣进闪耀: 'https://files.catbox.moe/87lcsh.png',
            森林宝穴: 'https://files.catbox.moe/50rq7n.png',
            神鹰: 'https://files.catbox.moe/1bch4y.png',
            双涡轮: 'https://files.catbox.moe/ffi15d.png',
            特别周: 'https://files.catbox.moe/waylx3.png',
            天狼星象征: 'https://files.catbox.moe/457y2f.png',
            丸善斯基: 'https://files.catbox.moe/jujcy2.png',
            无声铃鹿: 'https://files.catbox.moe/s6pnkl.png',
            西野花: 'https://files.catbox.moe/4qzhsz.png',
            小栗帽: 'https://files.catbox.moe/nmgyj9.png',
            小林厉奇: 'https://files.catbox.moe/sd03xi.png',
            新宇宙: 'https://files.catbox.moe/zaad8r.png',
            杏目: 'https://files.catbox.moe/vejrmc.png',
            樱花千代王: 'https://files.catbox.moe/a3g3gf.png',
            玉藻十字: 'https://files.catbox.moe/5g6z60.png',
            真弓快车: 'https://files.catbox.moe/unihzk.png',
            真机伶: 'https://files.catbox.moe/5y8jxf.png',
            中山庆典: 'https://files.catbox.moe/x8az97.png',
            周日宁静: 'https://files.catbox.moe/uccqyf.png',
            卓芙: 'https://files.catbox.moe/syhdp7.png',
            达利阿拉伯: 'https://files.catbox.moe/c2ldl4.png',
            高多芬阿拉伯: 'https://files.catbox.moe/x2unca.png',
            黄金旅程: 'https://files.catbox.moe/ebrxrn.png',
            艾尼斯风神: 'https://files.catbox.moe/nnd19a.png',
            富士奇石: 'https://files.catbox.moe/2p60gy.png',
            菱亚马逊: 'https://files.catbox.moe/xeeyrl.png',
            胜利奖券: 'https://files.catbox.moe/lnhtai.png',
          };
          return avatars[name] || null;
        }

        // 道具数据 - 高风险道具系统
        getItemData() {
          return [
            {
              id: 'no_item',
              icon: '❌',
              name: '不带道具',
              description: '不携带任何道具，轻装上阵',
              positive: '无正面效果',
              negative: '无负面效果',
            },
            {
              id: 'worn_clover',
              icon: '🍀',
              name: '磨损的四叶草',
              description: '只有第一次遇到随机事件时，才小幅提升有利结果的几率',
              positive: '第一次随机事件有利结果几率提升',
              negative: '仅限一次使用，之后失效',
            },
            {
              id: 'broken_phone',
              icon: '📱',
              name: '故障的赛马娘手机',
              description: '手机功能不完整，只能查看马娘的部分想法',
              positive: '可以查看马娘的部分想法',
              negative: '功能不完整，会随机跳出无意义的对话',
            },
            {
              id: 'expired_drink',
              icon: '🥤',
              name: '过期能量饮料',
              description: '恢复少量体力，但有一定几率让马娘进入"腹泻"状态',
              positive: '恢复少量体力',
              negative: '有一定几率让马娘进入"腹泻"状态，短期内无法进行剧烈训练',
            },
            {
              id: 'unknown_potion',
              icon: '🧪',
              name: '未知药水',
              description: '一瓶未知的药水，喝下后可能随机获得一种能力，也可能触发一个负面效果',
              positive: '可能随机获得一种能力',
              negative: '也可能触发一个负面效果，完全随机',
            },
            {
              id: 'cursed_charm',
              icon: '🔮',
              name: '诅咒护身符',
              description: '提供基础保护，但会逐渐消耗使用者的理智',
              positive: '提供基础保护，减少危险事件',
              negative: '会逐渐消耗使用者的理智，长期使用可能导致san值归零',
            },
            {
              id: 'broken_clock',
              icon: '⏰',
              name: '破损的闹钟',
              description: '可以回溯时间，但每次使用都会让时间变得更加混乱',
              positive: '可以回溯时间到当天任意时刻',
              negative: '每次使用都会让时间变得更加混乱，可能导致时间线错乱',
            },
            {
              id: 'fragile_mirror',
              icon: '🪞',
              name: '易碎的镜子',
              description: '可以反射伤害，但每次使用都有碎裂的风险',
              positive: '可以反射一次伤害攻击',
              negative: '每次使用都有碎裂的风险，碎裂后完全失效',
            },
            {
              id: 'poisoned_apple',
              icon: '🍎',
              name: '毒苹果',
              description: '看似普通的苹果，吃下后可能获得力量，也可能中毒',
              positive: '可能获得临时力量提升',
              negative: '也可能中毒，导致理智值大幅下降',
            },
            {
              id: 'cursed_dice',
              icon: '🎲',
              name: '诅咒骰子',
              description: '掷骰子决定事件结果，但结果总是偏向负面',
              positive: '可以重新决定一次事件结果',
              negative: '结果总是偏向负面，且无法预测',
            },
            {
              id: 'broken_compass',
              icon: '🧭',
              name: '破损的指南针',
              description: '指向的不是北方，而是危险的方向',
              positive: '可以找到隐藏的危险区域',
              negative: '指向的都是危险方向，可能引导到陷阱',
            },
            {
              id: 'haunted_whistle',
              icon: '📯',
              name: '鬼魂哨子',
              description: '吹响后可以召唤帮助，但也会吸引危险',
              positive: '可以召唤一次帮助',
              negative: '也会吸引危险生物，风险极高',
            },
            {
              id: 'cursed_coin',
              icon: '🪙',
              name: '诅咒硬币',
              description: '正面带来好运，反面带来厄运，但总是反面朝上',
              positive: '理论上可以带来好运',
              negative: '总是反面朝上，带来厄运',
            },
            {
              id: 'broken_umbrella',
              icon: '☂️',
              name: '破损的雨伞',
              description: '可以遮挡雨水，但会漏雨，且可能被风吹走',
              positive: '可以遮挡部分雨水',
              negative: '会漏雨，且可能被风吹走，失去保护',
            },
            {
              id: 'cursed_book',
              icon: '📖',
              name: '诅咒书籍',
              description: '包含有用的知识，但阅读会消耗理智',
              positive: '包含有用的知识和线索',
              negative: '阅读会消耗理智，可能导致san值下降',
            },
            {
              id: 'broken_lamp',
              icon: '🪔',
              name: '破损的油灯',
              description: '可以照明，但油量有限，且可能引起火灾',
              positive: '可以在黑暗中照明',
              negative: '油量有限，且可能引起火灾，风险很高',
            },
            {
              id: 'cursed_ring',
              icon: '💍',
              name: '诅咒戒指',
              description: '戴上后获得力量，但无法取下，会逐渐腐蚀',
              positive: '戴上后获得临时力量',
              negative: '无法取下，会逐渐腐蚀佩戴者',
            },
            {
              id: 'broken_sword',
              icon: '⚔️',
              name: '破损的剑',
              description: '可以攻击敌人，但容易断裂，且可能伤到自己',
              positive: '可以攻击敌人',
              negative: '容易断裂，且可能伤到自己',
            },
            {
              id: 'cursed_scroll',
              icon: '📜',
              name: '诅咒卷轴',
              description: '包含强大的魔法，但使用后会反噬使用者',
              positive: '包含强大的魔法效果',
              negative: '使用后会反噬使用者，造成伤害',
            },
            {
              id: 'broken_shield',
              icon: '🛡️',
              name: '破损的盾牌',
              description: '可以防御攻击，但防御力有限，且可能碎裂',
              positive: '可以防御一次攻击',
              negative: '防御力有限，且可能碎裂，失去保护',
            },
            {
              id: 'cursed_potion',
              icon: '🧪',
              name: '诅咒药水',
              description: '可以治愈伤口，但会留下永久的疤痕',
              positive: '可以治愈伤口',
              negative: '会留下永久的疤痕，影响外观',
            },
            {
              id: 'broken_armor',
              icon: '🥋',
              name: '破损的护甲',
              description: '可以提供保护，但重量很大，影响行动',
              positive: '可以提供基础保护',
              negative: '重量很大，影响行动速度',
            },
            {
              id: 'cursed_amulet',
              icon: '🔮',
              name: '诅咒护身符',
              description: '可以驱邪，但会吸引更多的邪灵',
              positive: '可以驱除一次邪灵',
              negative: '会吸引更多的邪灵，风险增加',
            },
            {
              id: 'broken_bow',
              icon: '🏹',
              name: '破损的弓箭',
              description: '可以远程攻击，但准确度很低，且可能反弹',
              positive: '可以进行远程攻击',
              negative: '准确度很低，且可能反弹伤到自己',
            },
            {
              id: 'cursed_staff',
              icon: '🪄',
              name: '诅咒法杖',
              description: '可以施法，但会消耗使用者的生命力',
              positive: '可以施放强大的魔法',
              negative: '会消耗使用者的生命力，风险很高',
            },
            {
              id: 'broken_helm',
              icon: '⛑️',
              name: '破损的头盔',
              description: '可以保护头部，但视野受限，且可能卡住',
              positive: '可以保护头部免受伤害',
              negative: '视野受限，且可能卡住无法取下',
            },
          ];
        }

        // 渲染当前步骤
        renderCurrentStep() {
          // 隐藏所有步骤内容
          $('.step-content').removeClass('active');

          // 显示当前步骤
          $(`#step${this.currentStep}`).addClass('active');

          // 更新步骤导航
          $('.step-item').removeClass('active completed');
          $('.step-item').each((index, element) => {
            const stepNum = parseInt($(element).data('step'));
            if (stepNum < this.currentStep) {
              $(element).addClass('completed');
            } else if (stepNum === this.currentStep) {
              $(element).addClass('active');
            }
          });

          // 渲染当前步骤的内容
          this.renderStepContent();
        }

        // 渲染步骤内容
        renderStepContent() {
          switch (this.currentStep) {
            case 1:
              this.renderTalents();
              break;
            case 2:
              this.renderBackgrounds();
              break;
            case 3:
              this.renderLocations();
              break;
            case 4:
              this.renderTimes();
              break;
            case 5:
              this.renderGacha();
              break;
            case 6:
              this.renderItems();
              break;
          }
        }

        // 渲染天赋选择
        renderTalents() {
          const grid = $('#talentGrid');
          grid.empty();

          this.talents.forEach(talent => {
            const isSelected = this.selections.talent === talent.id;
            const card = `
              <div class="selection-card ${isSelected ? 'selected' : ''}" data-id="${talent.id}">
                <div class="card-icon">${talent.icon}</div>
                <div class="card-title">${talent.name}</div>
                <div class="card-description">${talent.description}</div>
                <div class="card-effects">
                  <div class="positive-effect">
                    <span class="effect-label">✅ 正面效果:</span>
                    <span class="effect-text">${talent.positive}</span>
                  </div>
                  <div class="negative-effect">
                    <span class="effect-label">❌ 负面效果:</span>
                    <span class="effect-text">${talent.negative}</span>
                  </div>
                </div>
              </div>
            `;
            grid.append(card);
          });
        }

        // 渲染背景选择
        renderBackgrounds() {
          const grid = $('#backgroundGrid');
          grid.empty();

          this.backgrounds.forEach(background => {
            const isSelected = this.selections.background === background.id;
            const card = `
              <div class="selection-card ${isSelected ? 'selected' : ''}" data-id="${background.id}">
                <div class="card-icon">${background.icon}</div>
                <div class="card-title">${background.name}</div>
                <div class="card-description">${background.description}</div>
                <div class="card-effects">
                  <div class="positive-effect">
                    <span class="effect-label">✅ 优势:</span>
                    <span class="effect-text">${background.positive}</span>
                  </div>
                  <div class="negative-effect">
                    <span class="effect-label">❌ 缺陷:</span>
                    <span class="effect-text">${background.negative}</span>
                  </div>
                </div>
              </div>
            `;
            grid.append(card);
          });
        }

        // 渲染地点选择
        renderLocations() {
          const grid = $('#locationGrid');
          grid.empty();

          this.locations.forEach(location => {
            const isSelected = this.selections.location === location.id;
            const card = `
                          <div class="selection-card ${isSelected ? 'selected' : ''}" data-id="${location.id}">
                              <div class="card-icon">${location.icon}</div>
                              <div class="card-title">${location.name}</div>
                              <div class="card-description">${location.description}</div>
                          </div>
                      `;
            grid.append(card);
          });
        }

        // 渲染时间选择
        renderTimes() {
          const grid = $('#timeGrid');
          grid.empty();

          // 创建滑动条容器
          const sliderContainer = `
            <div class="time-slider-container">
              <div class="time-display">
                <h3>⏰ 选择游戏开始时间</h3>
                <p id="selectedTimeInfo">请拖动滑动条选择时间</p>
              </div>

              <input type="range" class="time-slider" id="timeSlider" min="0" max="4" value="0" step="1">

              <div class="time-labels">
                <div class="time-label" data-index="0">🌅<br>清晨</div>
                <div class="time-label" data-index="1">☀️<br>上午</div>
                <div class="time-label" data-index="2">🌞<br>午后</div>
                <div class="time-label" data-index="3">🌆<br>傍晚</div>
                <div class="time-label" data-index="4">🌙<br>深夜</div>
              </div>
            </div>
          `;

          grid.append(sliderContainer);

          // 设置初始值
          this.updateTimeDisplay(0);
          this.selections.time = this.times[0].id; // 设置默认选择

          // 绑定事件
          this.bindTimeSliderEvents();
        }

        // 绑定时间滑动条事件
        bindTimeSliderEvents() {
          const slider = $('#timeSlider');
          const labels = $('.time-label');

          // 滑动条变化事件
          slider.on('input', e => {
            const value = parseInt(e.target.value);
            this.selections.time = this.times[value].id;
            this.updateTimeDisplay(value);
            this.updateTimeLabels(value);
          });

          // 标签点击事件
          labels.on('click', e => {
            const index = parseInt($(e.currentTarget).data('index'));
            slider.val(index);
            this.selections.time = this.times[index].id;
            this.updateTimeDisplay(index);
            this.updateTimeLabels(index);
          });
        }

        // 更新时间显示
        updateTimeDisplay(index) {
          const time = this.times[index];
          const dangerColors = {
            低: '#4ade80',
            中: '#fbbf24',
            高: '#f97316',
            极高: '#ef4444',
          };

          $('#selectedTimeInfo').html(`
            <strong>${time.icon} ${time.name} (${time.time})</strong><br>
            <span style="color: ${dangerColors[time.danger]};">危险等级: ${time.danger}</span><br>
            ${time.description}
          `);
        }

        // 更新时间标签状态
        updateTimeLabels(activeIndex) {
          $('.time-label').removeClass('active');
          $(`.time-label[data-index="${activeIndex}"]`).addClass('active');
        }

        // 跳过抽奖方法
        skipGacha() {
          // 随机抽取三个不同的马娘
          const shuffled = [...this.umaMusumes].sort(() => 0.5 - Math.random());
          const threeUma = shuffled.slice(0, 3);

          // 显示三个选项供选择
          this.renderGachaOptions(threeUma);

          // 显示跳过提示
          $('#gachaResult').append(`
            <div style="margin-top: 15px; padding: 10px; background: rgba(107, 114, 128, 0.1); border: 1px solid #6b7280; border-radius: 4px;">
              <p style="margin: 0; color: #6b7280; font-size: 0.9em;">🎲 已随机生成三个选项，请选择一个</p>
            </div>
          `);

          // 禁用两个按钮
          $('#gachaButton').prop('disabled', true).text('已跳过');
          $('#skipButton').prop('disabled', true).text('已跳过');
        }

        // 渲染抽奖界面
        renderGacha() {
          const result = $('#gachaResult');
          if (this.selections.umaMusume) {
            const selectedAvatar = this.getUmaAvatar(this.selections.umaMusume);
            result
              .html(
                `
                          <h3>🎉 恭喜获得马娘伙伴！</h3>
                          <div style="text-align: center; margin: 20px 0;">
                            <div style="display: flex; flex-direction: column; align-items: center;">
                              ${
                                selectedAvatar
                                  ? `<img src="${selectedAvatar}" alt="${this.selections.umaMusume}" style="
                                width: 100px;
                                height: 100px;
                                border-radius: 50%;
                                border: 4px solid #d4af37;
                                box-shadow: 0 6px 16px rgba(139, 69, 19, 0.4);
                                margin-bottom: 15px;
                                display: block;
                              ">`
                                  : ''
                              }
                              <div style="
                                font-size: 1.4em;
                                font-weight: bold;
                                color: #8b4513;
                                text-shadow: 2px 2px 4px rgba(139, 69, 19, 0.3);
                                letter-spacing: 2px;
                                display: block;
                              ">${this.selections.umaMusume}</div>
                            </div>
                          </div>
                          <p style="font-size: 1.1em; color: #654321; line-height: 1.6; text-align: center;">
                            她将成为你的第一个马娘伙伴，陪伴你度过特雷森学院的时光。
                          </p>
                      `,
              )
              .show();
            $('#gachaButton').prop('disabled', true).text('已抽奖');
          } else {
            result.hide();
            $('#gachaButton').prop('disabled', false).text('🎰 开始抽奖');
          }
        }

        // 渲染道具选择
        renderItems() {
          const grid = $('#itemGrid');
          grid.empty();

          this.items.forEach(item => {
            const isSelected = this.selections.items.includes(item.id);
            const card = `
              <div class="selection-card ${isSelected ? 'selected' : ''}" data-id="${item.id}">
                <div class="card-icon">${item.icon}</div>
                <div class="card-title">${item.name}</div>
                <div class="card-description">${item.description}</div>
                <div class="card-effects">
                  <div class="positive-effect">
                    <span class="effect-label">✅ 效果:</span>
                    <span class="effect-text">${item.positive}</span>
                  </div>
                  <div class="negative-effect">
                    <span class="effect-label">❌ 风险:</span>
                    <span class="effect-text">${item.negative}</span>
                  </div>
                </div>
              </div>
            `;
            grid.append(card);
          });
        }

        // 处理卡片选择
        handleCardSelection(e) {
          const card = $(e.currentTarget);
          const id = card.data('id');

          // 根据当前步骤处理选择
          switch (this.currentStep) {
            case 1: // 天赋选择
              this.selections.talent = id;
              $('.selection-card').removeClass('selected');
              card.addClass('selected');
              break;
            case 2: // 背景选择
              this.selections.background = id;
              $('.selection-card').removeClass('selected');
              card.addClass('selected');
              break;
            case 3: // 地点选择
              this.selections.location = id;
              $('.selection-card').removeClass('selected');
              card.addClass('selected');
              break;
            case 4: // 时间选择 - 现在使用滑动条，不需要处理卡片选择
              break;
            case 6: {
              // 道具选择
              if (id === 'no_item') {
                // 选择"不带道具"时，清空其他选择
                this.selections.items = ['no_item'];
                $('.selection-card').removeClass('selected');
                card.addClass('selected');
              } else {
                // 如果选择了其他道具，移除"不带道具"选项
                const noItemIndex = this.selections.items.indexOf('no_item');
                if (noItemIndex > -1) {
                  this.selections.items.splice(noItemIndex, 1);
                  $('.selection-card[data-id="no_item"]').removeClass('selected');
                }

                const index = this.selections.items.indexOf(id);
                if (index > -1) {
                  // 取消选择
                  this.selections.items.splice(index, 1);
                  card.removeClass('selected');
                } else if (this.selections.items.length < 3) {
                  // 添加选择
                  this.selections.items.push(id);
                  card.addClass('selected');
                } else {
                  toastr.warning('最多只能选择3个道具');
                }
              }
              break;
            }
          }

          this.updateButtons();
        }

        // 执行抽奖
        performGacha() {
          if (this.selections.umaMusume) {
            toastr.info('已经抽奖过了');
            return;
          }

          const gachaBtn = $('#gachaButton');
          gachaBtn.prop('disabled', true).html('<span class="loading-spinner"></span> 抽奖中...');

          // 模拟抽奖动画
          setTimeout(() => {
            // 随机抽取三个不同的马娘
            const shuffled = [...this.umaMusumes].sort(() => 0.5 - Math.random());
            const threeUma = shuffled.slice(0, 3);

            // 显示三个选项供选择
            this.renderGachaOptions(threeUma);

            gachaBtn.prop('disabled', true).text('已抽奖');
            this.updateButtons();
          }, 2000);
        }

        // 渲染马娘选择选项
        renderGachaOptions(umaList) {
          const result = $('#gachaResult');
          let optionsHtml = '<h3>🎉 请选择一个马娘伙伴：</h3>';

          umaList.forEach((uma, index) => {
            const avatar = this.getUmaAvatar(uma);
            optionsHtml += `
              <div class="gacha-option" data-uma="${uma}" style="
                display: inline-block;
                margin: 10px;
                padding: 20px;
                border: 2px solid #8b4513;
                border-radius: 12px;
                background: linear-gradient(135deg, rgba(244, 241, 232, 0.95) 0%, rgba(232, 224, 208, 0.9) 100%);
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: center;
                min-width: 160px;
                box-shadow: 0 4px 12px rgba(139, 69, 19, 0.2);
                position: relative;
                overflow: hidden;
                vertical-align: top;
              ">
                <div style="display: flex; flex-direction: column; align-items: center;">
                  ${
                    avatar
                      ? `<img src="${avatar}" alt="${uma}" style="
                    width: 80px;
                    height: 80px;
                    border-radius: 50%;
                    margin-bottom: 12px;
                    border: 3px solid #d4af37;
                    box-shadow: 0 4px 8px rgba(139, 69, 19, 0.3);
                    display: block;
                  ">`
                      : ''
                  }
                  <div style="
                    font-size: 1.2em;
                    font-weight: bold;
                    color: #8b4513;
                    text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
                    margin-bottom: 8px;
                    letter-spacing: 1px;
                    display: block;
                  ">${uma}</div>
                  <div style="
                    font-size: 0.9em;
                    color: #654321;
                    font-style: italic;
                    opacity: 0.8;
                    display: block;
                  ">点击选择</div>
                </div>
              </div>
            `;
          });

          result.html(optionsHtml).show();

          // 绑定选择事件
          $('.gacha-option').on('click', e => {
            const selectedUma = $(e.currentTarget).data('uma');
            this.selections.umaMusume = selectedUma;

            // 更新显示
            const selectedAvatar = this.getUmaAvatar(selectedUma);
            result.html(`
              <h3>🎉 恭喜获得马娘伙伴！</h3>
              <div style="text-align: center; margin: 20px 0;">
                <div style="display: flex; flex-direction: column; align-items: center;">
                  ${
                    selectedAvatar
                      ? `<img src="${selectedAvatar}" alt="${selectedUma}" style="
                    width: 100px;
                    height: 100px;
                    border-radius: 50%;
                    border: 4px solid #d4af37;
                    box-shadow: 0 6px 16px rgba(139, 69, 19, 0.4);
                    margin-bottom: 15px;
                    display: block;
                  ">`
                      : ''
                  }
                  <div style="
                    font-size: 1.4em;
                    font-weight: bold;
                    color: #8b4513;
                    text-shadow: 2px 2px 4px rgba(139, 69, 19, 0.3);
                    letter-spacing: 2px;
                    display: block;
                  ">${selectedUma}</div>
                </div>
              </div>
              <p style="font-size: 1.1em; color: #654321; line-height: 1.6; text-align: center;">
                她将成为你的第一个马娘伙伴，陪伴你度过特雷森学院的时光。
              </p>
            `);

            this.updateButtons();
            toastr.success(`恭喜选择马娘：${selectedUma}！`);
          });

          // 添加悬停效果
          $('.gacha-option').hover(
            function () {
              $(this).css({
                transform: 'translateY(-3px)',
                'box-shadow': '0 6px 20px rgba(139, 69, 19, 0.4)',
                'border-color': '#d4af37',
              });
            },
            function () {
              $(this).css({
                transform: 'translateY(0)',
                'box-shadow': '0 4px 12px rgba(139, 69, 19, 0.2)',
                'border-color': '#8b4513',
              });
            },
          );
        }

        // 更新进度条
        updateProgress() {
          const progress = ((this.currentStep - 1) / (this.totalSteps - 1)) * 100;
          $('#progressFill').css('width', `${progress}%`);
        }

        // 更新按钮状态
        updateButtons() {
          const canGoNext = this.canGoToNextStep();
          const canGoPrev = this.currentStep > 1;
          const isLastStep = this.currentStep === this.totalSteps;

          $('#prevBtn').toggle(canGoPrev);
          $('#nextBtn').toggle(!isLastStep && canGoNext);
          $('#startBtn').toggle(isLastStep && canGoNext);
        }

        // 检查是否可以进入下一步
        canGoToNextStep() {
          switch (this.currentStep) {
            case 1:
              return this.selections.talent !== null;
            case 2:
              return this.selections.background !== null;
            case 3:
              return this.selections.location !== null;
            case 4:
              return this.selections.time !== null;
            case 5:
              return this.selections.umaMusume !== null;
            case 6:
              return this.selections.items.length >= 0; // 允许选择不带道具
            default:
              return false;
          }
        }

        // 检查是否可以导航到指定步骤
        canNavigateToStep(step) {
          // 只能导航到已完成的步骤或当前步骤
          return step <= this.currentStep || this.isStepCompleted(step - 1);
        }

        // 检查步骤是否完成
        isStepCompleted(step) {
          switch (step) {
            case 1:
              return this.selections.talent !== null;
            case 2:
              return this.selections.background !== null;
            case 3:
              return this.selections.location !== null;
            case 4:
              return this.selections.time !== null;
            case 5:
              return this.selections.umaMusume !== null;
            default:
              return false;
          }
        }

        // 下一步
        nextStep() {
          if (this.canGoToNextStep() && this.currentStep < this.totalSteps) {
            this.currentStep++;
            this.renderCurrentStep();
            this.updateProgress();
            this.updateButtons();
          }
        }

        // 上一步
        prevStep() {
          if (this.currentStep > 1) {
            this.currentStep--;
            this.renderCurrentStep();
            this.updateProgress();
            this.updateButtons();
          }
        }

        // 跳转到指定步骤
        goToStep(step) {
          if (this.canNavigateToStep(step)) {
            this.currentStep = step;
            this.renderCurrentStep();
            this.updateProgress();
            this.updateButtons();
          }
        }

        // 开始游戏
        async startGame() {
          if (!this.canGoToNextStep()) {
            toastr.error('请完成所有选择后再开始游戏');
            return;
          }

          try {
            const startBtn = $('#startBtn');
            startBtn.prop('disabled', true).html('<span class="loading-spinner"></span> 正在启动游戏...');

            // 1. 注入变量到角色
            await this.injectVariables();

            // 2. 控制世界书开关
            await this.controlWorldbook();

            // 3. 生成开场剧情
            await this.generateOpeningStory();

            toastr.success('开局配置已注入，游戏启动成功！');

            // 延迟跳转到主页面
            setTimeout(() => {
              // 这里可以添加跳转逻辑或与主页面联动的代码
              console.log('开局选择完成，准备进入主游戏');
              startBtn.prop('disabled', false).text('✅ 游戏启动成功');
            }, 2000);
          } catch (error) {
            console.error('游戏启动失败:', error);
            toastr.error('游戏启动失败，请重试');
            $('#startBtn').prop('disabled', false).text('🚀 开始游戏');
          }
        }

        // 注入变量到角色
        async injectVariables() {
          try {
            // console.log removed

            // 使用 MVU API 注入变量
            if (typeof Mvu !== 'undefined' && Mvu.getMvuData && Mvu.setMvuVariable) {
              // 获取当前的 MVU 数据
              const mvuData = Mvu.getMvuData({ type: 'chat' });

              // 修改现有变量的值
              const variableUpdates = [
                // 天赋
                {
                  path: '训练员.天赋.大天赋.name[0]',
                  value: this.talents.find(t => t.id === this.selections.talent)?.name || '',
                },
                // 背景
                {
                  path: '训练员.背景[0]',
                  value: this.backgrounds.find(b => b.id === this.selections.background)?.name || '',
                },
                // 位置
                {
                  path: '训练员.位置[0]',
                  value: this.locations.find(l => l.id === this.selections.location)?.name || '',
                },
                // 时间
                {
                  path: '世界.当前时间[0]',
                  value: (() => {
                    const selectedTime = this.times.find(t => t.id === this.selections.time);
                    if (selectedTime) {
                      const timeStart = selectedTime.time.split('-')[0];
                      // 确保格式为 HH:MM
                      return timeStart.length === 4 ? '0' + timeStart : timeStart;
                    }
                    return '06:00';
                  })(),
                },
                // 在校天数
                { path: '训练员.在校天数[0]', value: 1 },
              ];

              // 逐个更新变量
              for (const variable of variableUpdates) {
                await Mvu.setMvuVariable(mvuData, variable.path, variable.value, {
                  reason: '开局选择',
                  is_recursive: true,
                });
                // console.log removed
              }

              // 添加马娘 - 在现有马娘结构中添加新马娘
              if (this.selections.umaMusume) {
                const umaName = this.selections.umaMusume;
                let initialGoodwill = 15;
                let initialExclusivity = 25;

                // 特殊马娘设置
                if (umaName === '爱如往昔') {
                  initialGoodwill = 100;
                  initialExclusivity = 100;
                }

                // 添加新马娘到马娘对象
                const umaData = {
                  好感度: [initialGoodwill, `${umaName}对训练员的好感度，范围0-100`],
                  独占度: [initialExclusivity, `${umaName}对训练员的独占欲望，范围0-100`],
                  状态: ['正常', '当前状态'],
                };

                await Mvu.setMvuVariable(mvuData, `马娘.${umaName}`, umaData, {
                  reason: '开局选择马娘',
                  is_recursive: true,
                });
                // console.log removed
              }

              // 添加道具到物品栏
              if (this.selections.items && this.selections.items.length > 0) {
                for (const itemId of this.selections.items) {
                  const selectedItem = this.items.find(item => item.id === itemId);
                  if (selectedItem) {
                    const itemPath = `训练员.物品栏.${selectedItem.name}`;
                    const itemData = {
                      描述: selectedItem.description,
                      效果: selectedItem.positive,
                      稀有度: '普通',
                      特性: selectedItem.negative,
                    };

                    await Mvu.setMvuVariable(mvuData, itemPath, itemData, {
                      reason: '开局选择道具',
                      is_recursive: true,
                    });
                    // console.log removed
                  }
                }
              }

              // 保存更新后的数据
              await Mvu.replaceMvuData(mvuData, { type: 'chat' });

              // console.log removed
            } else {
              console.warn('⚠️ MVU API 不可用，跳过变量注入');
            }
          } catch (error) {
            console.error('❌ 变量注入失败:', error);
            throw error;
          }
        }

        // 控制世界书开关
        async controlWorldbook() {
          try {
            // console.log removed
            // 注意：由于需要世界书条目的UID而不是名字，这里暂时跳过世界书控制
            // 实际使用时需要先通过 /findentry 命令获取条目的UID，然后使用 /setentryfield 命令
            // console.log removed
            // console.log removed
            // TODO: 实现正确的世界书控制逻辑
            // 1. 使用 /findentry 命令查找条目UID
            // 2. 使用 /setentryfield 命令设置 disable 字段
          } catch (error) {
            console.error('世界书控制失败:', error);
            throw error;
          }
        }

        // 生成开场剧情
        async generateOpeningStory() {
          try {
            // console.log removed

            // 构建开场剧情提示词
            const openingPrompt = `
        </开局设定>
        # 开局剧情生成

        请根据以下开局设定，生成一段开场剧情，描述训练员在特雷森学院的初次入校体验。

        ## 开局设定
        - 背景：${(() => {
          const selectedBackground = this.backgrounds.find(bg => bg.id === this.selections.background);
          if (selectedBackground) {
            return `${selectedBackground.name} - ${selectedBackground.description} (正面：${selectedBackground.positive} | 负面：${selectedBackground.negative})`;
          }
          return '';
        })()}
        - 地点：${(() => {
          const selectedLocation = this.locations.find(loc => loc.id === this.selections.location);
          if (selectedLocation) {
            return `${selectedLocation.name} - ${selectedLocation.description}`;
          }
          return '';
        })()}
        - 时间：${(() => {
          const selectedTime = this.times.find(t => t.id === this.selections.time);
          if (selectedTime) {
            return `${selectedTime.name} - ${selectedTime.description}`;
          }
          return '';
        })()}
        - 马娘：${this.selections.umaMusume} - 初遇的马娘
        - 道具：${(() => {
          const selectedItems = this.selections.items.map(itemId => {
            const item = this.items.find(item => item.id === itemId);
            if (item) {
              return `${item.name} - ${item.description} (效果：${item.positive} | 特性：${item.negative})`;
            }
            return itemId;
          });
          return selectedItems.join(', ');
        })()}

        ## 重要提醒
        剧情必须完全基于以上设定，体现背景身份特点，在指定地点和时间展开，重点描写与选择马娘的互动，融入选择的道具。不要随意改变系统的设定。
        
        ## 要求
        1. 剧情要符合特雷森怪谈世界观
        2. 体现训练员的天赋和背景特点
        3. 描述与初遇马娘的互动
        4. 营造在平静的校园生活里面隐藏着的神秘、略带扭曲的氛围
        5. 为后续剧情发展埋下伏笔
        6. 训练员没有那么全知全能知道一切,甚至是一个被卷入的普通人

        ## 格式要求
        **1.你必须使用<content></content>包裹正文**
        **2.严格按照以下格式输出<content>即可，必须严格按照格式分行输出**
        ## 需要生成的变量
        初始物品: 根据背景和天赋，以及选择的道具酌情生成初始物品 
        <content> 
        [请在这里生成开场剧情内容]
        </content>

        </开局设定>`;

            // 使用 TavernHelper.generate 生成剧情
            if (typeof TavernHelper !== 'undefined' && TavernHelper.generate) {
              // console.log removed

              const generateConfig = {
                injects: [
                  {
                    role: 'user',
                    content: openingPrompt,
                    position: 'before_char',
                    should_write_to_chat: false,
                    should_scan: true,
                  },
                ],
                should_stream: false,
              };

              const openingStory = await TavernHelper.generate(generateConfig);

              if (!openingStory) {
                throw new Error('AI未能生成开场剧情。');
              }

              // 手动写入到第0层消息
              const messages = await getChatMessages(0);
              if (!messages || messages.length === 0) {
                throw new Error('无法获取到第0层消息，无法写入开场剧情。');
              }
              const messageZero = messages[0];

              messageZero.message = openingStory;
              messageZero.data = {};

              await TavernHelper.setChatMessages([messageZero], { refresh: 'all' });

              // console.log removed
              console.log('AI回复内容预览:', openingStory.substring(0, 200) + '...');
            } else {
              console.warn('⚠️ TavernHelper.generate 不可用，跳过开场剧情生成');
            }
          } catch (error) {
            console.error('生成开场剧情失败:', error);
            throw error;
          }
        }
      }

      // 页面加载完成后初始化
      $(document).ready(() => {
        // 配置toastr
        toastr.options = {
          closeButton: true,
          progressBar: true,
          positionClass: 'toast-top-right',
          timeOut: 3000,
        };

        // 初始化开局选择器
        window.openingSelector = new OpeningSelector();

        // console.log removed
      });
    </script>
  </body>
</html>


